<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FiceCal — FinOps &amp; Cloud Economics Calculator</title>
<meta name="description" content="FiceCal is an interactive FinOps and cloud economics calculator for break-even, pricing floor, CCER posture, AI token economics, and prioritized optimization actions.">
<link rel="canonical" href="https://duksh.github.io/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="FiceCal">
<meta property="og:title" content="FiceCal — FinOps &amp; Cloud Economics Calculator">
<meta property="og:description" content="Quantify break-even, minimum viable pricing, CCER, AI token economics, and cloud efficiency with the live FiceCal model.">
<meta property="og:url" content="https://duksh.github.io/">
<meta property="og:image" content="https://duksh.github.io/github-finops-cal-image-01.jpg">
<meta property="og:image:width" content="1280">
<meta property="og:image:height" content="640">
<meta property="og:image:alt" content="Preview card for FiceCal with model outputs and charts.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="FiceCal — FinOps &amp; Cloud Economics Calculator">
<meta name="twitter:description" content="Interactive model for break-even, pricing floor, CCER, AI token economics, and FinOps recommendations.">
<meta name="twitter:image" content="https://duksh.github.io/github-finops-cal-image-01.jpg">
<meta name="twitter:image:alt" content="Preview card for FiceCal.">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z2K1ZEDJV2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-Z2K1ZEDJV2');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ─── RESET & TOKENS ────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #f5f7fc;
  --surface:   #ffffff;
  --border:    #d6deeb;
  --text:      #1b2136;
  --muted:     #5f6b84;
  --light:     #eef3fb;

  --accent-blue: #0072b2;
  --accent-cyan: #00a5c8;
  --accent-green: #009e73;
  --accent-amber: #e69f00;
  --accent-rose: #d55e00;

  /* Okabe-Ito colorblind-safe */
  --dev:       #d55e00;
  --infra-raw: #009e73;
  --infra-cud: #009e73;
  --total:     #444444;
  --total-rel: #8a3d00;
  --revenue:   #0072b2;
  --profit:    #7b2d8b;
  --profit-rel:#b33f7a;
  --price-min: #555555;

  --page-pad-x: clamp(10px, 3vw, 24px);
  --page-pad-y: clamp(12px, 3vw, 40px);
  --sticky-nav-h: 54px;
  --radius: 8px;
  --shadow: 0 2px 16px rgba(0,0,0,0.07);

  --font-size-base: clamp(16px, 0.22vw + 15px, 18px);
  --font-size-sm: clamp(13px, 0.16vw + 12px, 14px);
  --font-size-xs: clamp(12px, 0.12vw + 11px, 13px);
  --font-size-2xs: clamp(11px, 0.1vw + 10px, 12px);
}

html {
  font-size: var(--font-size-base);
  scroll-behavior: smooth;
  scroll-padding-top: calc(var(--sticky-nav-h) + 18px);
}

body {
  background:
    radial-gradient(circle at 10% 0%, rgba(86,180,233,0.14) 0%, rgba(86,180,233,0) 28%),
    radial-gradient(circle at 92% 18%, rgba(0,158,115,0.12) 0%, rgba(0,158,115,0) 30%),
    radial-gradient(circle at 80% 92%, rgba(230,159,0,0.12) 0%, rgba(230,159,0,0) 28%),
    linear-gradient(180deg, #f7fbff 0%, var(--bg) 38%, #fff8ef 100%);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-weight: 400;
  line-height: 1.58;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  padding: calc(var(--page-pad-y) + var(--sticky-nav-h) + 8px) var(--page-pad-x) 48px;
}
body.modal-open,
body.chart-focus-open,
body.cfo-focus-open { overflow: hidden; }
body.chart-focus-open::before,
body.cfo-focus-open::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: 158;
  background: rgba(10, 20, 36, 0.58);
  backdrop-filter: blur(2px);
}

button:focus-visible,
a:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}

.skip-link {
  position: fixed;
  top: 8px;
  left: var(--page-pad-x);
  z-index: 120;
  transform: translateY(-140%);
  background: #0e3358;
  color: #fff;
  text-decoration: none;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  transition: transform 0.18s ease;
}
.skip-link:focus-visible {
  transform: translateY(0);
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}

.sticky-top-nav {
  position: fixed;
  top: max(8px, env(safe-area-inset-top));
  left: var(--page-pad-x);
  right: var(--page-pad-x);
  z-index: 110;
}
.sticky-top-nav-inner {
  max-width: 1200px;
  margin: 0 auto;
  min-height: var(--sticky-nav-h);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border: 1px solid rgba(22, 36, 64, 0.2);
  border-radius: 12px;
  background: linear-gradient(120deg, rgba(255,255,255,0.94) 0%, rgba(241,250,255,0.9) 48%, rgba(244,255,249,0.9) 100%);
  backdrop-filter: blur(7px);
  box-shadow: 0 10px 24px rgba(18, 30, 55, 0.16);
}
.sticky-top-brand {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  border-radius: 999px;
  padding: 4px 7px;
  flex-shrink: 0;
  transition: background 0.18s ease;
}
.sticky-top-brand:hover { background: rgba(0, 114, 178, 0.08); }
.sticky-top-brand:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.sticky-top-logo {
  width: 28px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.sticky-top-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.sticky-top-brand-text {
  flex-shrink: 0;
  font-size: var(--font-size-xs);
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #27425c;
}
.sticky-top-nav-list {
  list-style: none;
  display: flex;
  align-items: center;
  gap: 6px;
  overflow-x: auto;
  padding: 1px;
  margin: 0;
  scrollbar-width: none;
}
.sticky-top-nav-list::-webkit-scrollbar { display: none; }
.sticky-top-nav-link {
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  text-decoration: none;
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: #33405b;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 6px 11px;
  transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
}
.sticky-top-nav-link:hover {
  background: rgba(0, 114, 178, 0.08);
  color: #005b90;
}
.sticky-top-nav-link.is-active,
.sticky-top-nav-link[aria-current='page'] {
  border-color: rgba(0, 114, 178, 0.35);
  background: rgba(0, 114, 178, 0.12);
  color: #00507d;
}
.sticky-top-nav-link:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.glossary-term-link {
  color: inherit;
  text-decoration: underline;
  text-decoration-style: dotted;
  text-decoration-color: rgba(0, 114, 178, 0.55);
  text-underline-offset: 2px;
  font-weight: 600;
}
.glossary-term-link:hover {
  color: #005b90;
  text-decoration-color: #005b90;
}
.glossary-term-link:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
  border-radius: 3px;
}
.glossary-hover-panel {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 2600;
  width: min(420px, calc(100vw - 20px));
  border: 1px solid rgba(8, 32, 54, 0.28);
  border-radius: 10px;
  background: linear-gradient(180deg, rgba(5, 25, 42, 0.98) 0%, rgba(8, 34, 58, 0.98) 100%);
  color: #edf7ff;
  box-shadow: 0 18px 36px rgba(3, 16, 30, 0.35);
  padding: 10px 12px;
  font-size: 12px;
  line-height: 1.5;
  opacity: 0;
  transform: translateY(-2px);
  transition: opacity 0.14s ease, transform 0.14s ease;
  pointer-events: none;
}
.glossary-hover-panel::after {
  content: '';
  position: absolute;
  left: var(--glossary-arrow-left, 50%);
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
}
.glossary-hover-panel.is-above::after {
  top: 100%;
  border-top: 7px solid rgba(8, 34, 58, 0.98);
}
.glossary-hover-panel.is-below::after {
  bottom: 100%;
  border-bottom: 7px solid rgba(5, 25, 42, 0.98);
}
.glossary-hover-panel[aria-hidden='true'] {
  visibility: hidden;
}
.glossary-hover-panel.is-open {
  opacity: 1;
  transform: translateY(0);
}
.glossary-hover-title {
  margin: 0 0 4px;
  font-weight: 700;
  color: #8ed9ff;
}
.glossary-hover-body {
  margin: 0;
}
@media (max-width: 780px) {
  .sticky-top-brand-text { display: none; }
  .sticky-top-nav-inner { padding: 7px 8px; }
}

.section-anchor { scroll-margin-top: calc(var(--sticky-nav-h) + 22px); }

/* ─── PAPER ─────────────────────────────────────────────────────── */
.paper {
  max-width: 1200px;
  margin: 0 auto;
  background: linear-gradient(180deg, #ffffff 0%, #fcfdff 100%);
  border: 1px solid rgba(17, 38, 74, 0.12);
  border-radius: 12px;
  box-shadow: 0 24px 54px rgba(19, 37, 68, 0.14);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}
.paper::before {
  content: '';
  position: absolute;
  inset: 0 0 auto 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-cyan) 30%, var(--accent-green) 62%, var(--accent-amber) 100%);
  z-index: 1;
  pointer-events: none;
}

/* ─── LANDING FLOW ORDER ────────────────────────────────────────── */
.paper > .landing-intro { order: 1; }
.paper > .finops-2026-section { order: 2; }
.paper > .credibility-section { order: 3; }
.paper > .cta-band { order: 4; }
.paper > .mcp-section { order: 5; }
.paper > .calc-section { order: 6; }
.paper > .fig-header { order: 7; }
.paper > .controls { order: 8; }
.paper > .chart-section { order: 9; }
.paper > .zones-strip { order: 10; }
.paper > .formulas-section { order: 11; }
.paper > .fig-footer { order: 12; }

/* ─── LANDING INTRO ─────────────────────────────────────────────── */
.landing-intro {
  position: relative;
  overflow: hidden;
  padding: clamp(20px, 4vw, 40px) clamp(16px, 4vw, 36px);
  background:
    radial-gradient(circle at 88% 8%, rgba(0,114,178,0.22) 0%, transparent 40%),
    radial-gradient(circle at 8% 88%, rgba(0,158,115,0.22) 0%, transparent 38%),
    linear-gradient(135deg, #eef7ff 0%, #f3fbf7 45%, #fff4ea 100%);
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
}
.landing-intro::before,
.landing-intro::after {
  content: '';
  position: absolute;
  border-radius: 999px;
  pointer-events: none;
}
.landing-intro::before {
  width: 220px;
  height: 220px;
  top: -95px;
  right: -70px;
  background: radial-gradient(circle, rgba(66,133,244,0.28) 0%, rgba(66,133,244,0) 70%);
}
.landing-intro::after {
  width: 210px;
  height: 210px;
  bottom: -110px;
  left: -90px;
  background: radial-gradient(circle, rgba(52,168,83,0.22) 0%, rgba(52,168,83,0) 72%);
}
.landing-kicker {
  display: inline-flex;
  align-items: center;
  border: 1px solid rgba(0,114,178,0.28);
  border-radius: 999px;
  padding: 5px 10px;
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(3px);
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1.1vw, 10px);
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #0072b2;
  margin-bottom: 10px;
}
.landing-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(24px, 4vw, 42px);
  line-height: 1.12;
  font-weight: 400;
  color: #171b33;
  text-wrap: balance;
  max-width: 900px;
}
.landing-subtitle {
  margin-top: 10px;
  max-width: 880px;
  font-size: clamp(12px, 1.4vw, 15px);
  color: #3f4658;
  line-height: 1.65;
}
.landing-grid {
  margin-top: clamp(16px, 2.8vw, 26px);
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}
@media (max-width: 900px) {
  .landing-grid { grid-template-columns: 1fr; }
}
.landing-card {
  position: relative;
  border: 1px solid rgba(28, 39, 72, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(2px);
  box-shadow: 0 8px 22px rgba(20, 33, 58, 0.07);
  padding: 13px 14px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.landing-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(20, 33, 58, 0.12);
}
.landing-card::before {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 3px;
  border-radius: 10px 10px 0 0;
}
.landing-card:nth-child(1) {
  background: linear-gradient(180deg, rgba(0,114,178,0.08) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(1)::before {
  background: linear-gradient(90deg, #0072b2, #56b4e9);
}
.landing-card:nth-child(2) {
  background: linear-gradient(180deg, rgba(0,158,115,0.08) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(2)::before {
  background: linear-gradient(90deg, #009e73, #34a853);
}
.landing-card:nth-child(3) {
  background: linear-gradient(180deg, rgba(230,159,0,0.1) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(3)::before {
  background: linear-gradient(90deg, #e69f00, #ff8f1f);
}
.landing-card-title {
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: #1f2a49;
  margin-bottom: 8px;
}
.landing-card:nth-child(1) .landing-card-title { color: #005a8f; }
.landing-card:nth-child(2) .landing-card-title { color: #0f7358; }
.landing-card:nth-child(3) .landing-card-title { color: #8f5f00; }
.landing-card-list {
  list-style: none;
  display: grid;
  gap: 7px;
}
.landing-card-list li {
  position: relative;
  padding-left: 14px;
  font-size: 12px;
  color: #44495a;
  line-height: 1.55;
}
.landing-card-list li::before {
  content: '•';
  position: absolute;
  left: 0;
  color: #009e73;
  font-weight: 700;
}
.landing-card:nth-child(1) .landing-card-list li::before { color: #0072b2; }
.landing-card:nth-child(3) .landing-card-list li::before { color: #e69f00; }
.landing-card-link {
  margin-top: 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  padding: 5px 10px;
  border: 1px solid rgba(0,114,178,0.28);
  background: rgba(255,255,255,0.86);
  color: #005a8f;
  transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease;
}
.landing-card-link:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
  filter: brightness(1.02);
}
.landing-card-link.features {
  border-color: rgba(0,158,115,0.34);
  color: #0f7358;
}
.landing-card-link.users {
  border-color: rgba(230,159,0,0.4);
  color: #8f5f00;
}

/* ─── ICON SYSTEM (UI READABILITY) ──────────────────────────────── */
.iconized-heading {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.info-icon-badge {
  width: 18px;
  height: 18px;
  border-radius: 6px;
  border: 1px solid transparent;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.info-icon {
  width: 11px;
  height: 11px;
  stroke-width: 1.9;
}
.info-icon-badge.blue {
  color: #005a8f;
  border-color: rgba(0,114,178,0.34);
  background: rgba(0,114,178,0.1);
}
.info-icon-badge.green {
  color: #0d6d55;
  border-color: rgba(0,158,115,0.35);
  background: rgba(0,158,115,0.1);
}
.info-icon-badge.amber {
  color: #8a5a00;
  border-color: rgba(230,159,0,0.42);
  background: rgba(230,159,0,0.12);
}
.info-icon-badge.purple {
  color: #58468c;
  border-color: rgba(106,81,163,0.34);
  background: rgba(106,81,163,0.12);
}
.info-icon-badge.red {
  color: #9a3d00;
  border-color: rgba(213,94,0,0.38);
  background: rgba(213,94,0,0.12);
}

/* ─── FINOPS 2026 SECTION ───────────────────────────────────────── */
.finops-2026-section {
  padding: clamp(16px, 3vw, 26px) clamp(16px, 4vw, 36px);
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
  background:
    radial-gradient(circle at 86% 14%, rgba(0,158,115,0.16) 0%, rgba(0,158,115,0) 34%),
    radial-gradient(circle at 14% 86%, rgba(0,114,178,0.14) 0%, rgba(0,114,178,0) 34%),
    linear-gradient(150deg, #f3fffa 0%, #eff8ff 52%, #fff8ed 100%);
}
.finops-2026-shell {
  border: 1px solid rgba(13, 94, 74, 0.2);
  border-radius: 14px;
  background: rgba(255,255,255,0.9);
  box-shadow: 0 14px 28px rgba(15, 49, 83, 0.1);
  padding: clamp(14px, 2.4vw, 22px);
}
.finops-2026-kicker {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid rgba(0,158,115,0.38);
  border-radius: 999px;
  padding: 4px 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #0c6d55;
  background: rgba(0,158,115,0.08);
}
.finops-2026-title {
  margin-top: 8px;
  font-family: 'Source Serif 4', serif;
  font-size: clamp(20px, 2.9vw, 32px);
  line-height: 1.16;
  color: #18233f;
}
.finops-2026-subtitle {
  margin-top: 8px;
  max-width: 880px;
  font-size: clamp(12px, 1.45vw, 14px);
  color: #445067;
  line-height: 1.64;
}
.finops-2026-grid {
  margin-top: 14px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 920px) {
  .finops-2026-grid { grid-template-columns: 1fr; }
}
.finops-2026-report-card {
  border: 1px solid rgba(27, 46, 77, 0.13);
  border-radius: 11px;
  background: rgba(255,255,255,0.94);
  padding: 11px 12px;
}
.finops-2026-report-card h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: #1b3d67;
  margin-bottom: 7px;
}
.finops-2026-report-card ul {
  list-style: none;
  display: grid;
  gap: 6px;
}
.finops-2026-report-card li {
  font-size: 12px;
  color: #42506a;
  line-height: 1.52;
  position: relative;
  padding-left: 12px;
}
.finops-2026-report-card li::before {
  content: '•';
  position: absolute;
  left: 0;
  color: #009e73;
  font-weight: 700;
}
.finops-2026-link {
  margin-top: 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  color: #0c6d55;
  text-decoration: none;
  border: 1px solid rgba(0,158,115,0.34);
  border-radius: 999px;
  padding: 5px 10px;
  background: rgba(0,158,115,0.08);
}
.finops-2026-link:hover { background: rgba(0,158,115,0.13); }

/* ─── CREDIBILITY SECTION ───────────────────────────────────────── */
.credibility-section {
  position: relative;
  isolation: isolate;
  padding: clamp(16px, 2.8vw, 24px) clamp(16px, 4vw, 36px);
  border-bottom: 1px solid var(--border);
  background:
    radial-gradient(circle at 78% 20%, rgba(0,114,178,0.08) 0%, rgba(0,114,178,0) 38%),
    radial-gradient(circle at 12% 84%, rgba(0,158,115,0.07) 0%, rgba(0,158,115,0) 36%),
    linear-gradient(145deg, #f9fbfe 0%, #f1f5fb 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 12px;
}
.credibility-section::before {
  content: "";
  position: absolute;
  inset: 10px clamp(12px, 3vw, 20px);
  border-radius: 18px;
  border: 1px solid rgba(24, 41, 70, 0.08);
  background: rgba(255,255,255,0.45);
  z-index: -1;
}
.cred-avatar {
  width: 102px;
  height: 102px;
  border-radius: 20px;
  overflow: hidden;
  border: 2px solid rgba(255,255,255,0.95);
  box-shadow: 0 8px 18px rgba(24, 41, 70, 0.18);
  background: #fff;
}
.cred-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.cred-content {
  max-width: 880px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid rgba(24, 41, 70, 0.11);
  border-radius: 14px;
  background: rgba(255,255,255,0.84);
  box-shadow: 0 7px 18px rgba(17, 35, 66, 0.06);
  padding: clamp(12px, 2.4vw, 20px);
}
.cred-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #4f6c8a;
  margin-bottom: 4px;
}
.cred-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(28px, 3vw, 44px);
  line-height: 1.12;
  color: #18223d;
  max-width: 24ch;
  text-wrap: balance;
}
.cred-role {
  margin-top: 6px;
  font-size: clamp(14px, 1.45vw, 18px);
  font-weight: 500;
  letter-spacing: 0.01em;
  color: #44536b;
  max-width: 50ch;
  text-wrap: balance;
}
.cred-text {
  margin-top: 8px;
  font-size: clamp(15px, 1.22vw, 18px);
  line-height: 1.64;
  color: #33425a;
  max-width: 66ch;
}
.cred-links {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}
.cred-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 999px;
  border: 1px solid rgba(0,114,178,0.26);
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 600;
  color: #0d547f;
  text-decoration: none;
  background: rgba(0,114,178,0.08);
  box-shadow: none;
  transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease;
}
.cred-link:hover {
  background: rgba(0,114,178,0.13);
  border-color: rgba(0,114,178,0.34);
  color: #09476c;
}
.cred-link:focus-visible {
  outline: 3px solid rgba(0,114,178,0.34);
  outline-offset: 2px;
}

/* ─── CTA BAND ──────────────────────────────────────────────────── */
.cta-band {
  padding: 14px clamp(16px, 4vw, 36px) 20px;
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
  background:
    radial-gradient(circle at 88% 14%, rgba(0,114,178,0.24) 0%, rgba(0,114,178,0) 36%),
    radial-gradient(circle at 14% 80%, rgba(0,158,115,0.2) 0%, rgba(0,158,115,0) 38%),
    linear-gradient(145deg, #fff9ef 0%, #edf9ff 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.cta-shell {
  width: min(980px, 100%);
  border: 1px solid rgba(24, 41, 70, 0.16);
  border-radius: 18px;
  background: rgba(255,255,255,0.82);
  box-shadow: 0 14px 30px rgba(17, 35, 66, 0.1);
  padding: clamp(14px, 3vw, 24px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.cta-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(21px, 2.2vw, 32px);
  line-height: 1.2;
  color: #18213a;
  text-align: center;
}
.cta-sub {
  max-width: 66ch;
  text-align: center;
  color: #364464;
  font-size: clamp(14px, 1.35vw, 18px);
  line-height: 1.52;
}
.cta-actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
}
.cta-btn {
  border: none;
  border-radius: 999px;
  background: linear-gradient(92deg, var(--accent-blue) 0%, var(--accent-cyan) 45%, var(--accent-green) 100%);
  color: #fff;
  min-height: 48px;
  padding: 12px 22px;
  font-size: 17px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  box-shadow: 0 10px 22px rgba(0,114,178,0.3);
  transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
}
.cta-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(0,114,178,0.34);
  filter: brightness(1.03);
}
.cta-btn:focus-visible {
  outline: 3px solid rgba(0,114,178,0.34);
  outline-offset: 3px;
}
.cta-btn.cta-btn-secondary {
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(0,114,178,0.28);
  color: #004f7c;
  box-shadow: 0 7px 18px rgba(24, 41, 70, 0.12);
}
.cta-note {
  font-size: clamp(14px, 1.2vw, 16px);
  color: #2f3d58;
  text-align: center;
  max-width: 70ch;
  border-radius: 12px;
  border: 1px dashed rgba(0,114,178,0.26);
  background: rgba(250,252,255,0.85);
  padding: 9px 12px;
}

@media (max-width: 640px) {
  .cred-title { font-size: clamp(30px, 8vw, 40px); }
  .cred-role { font-size: clamp(13px, 4vw, 15px); }
  .cred-text {
    font-size: clamp(14px, 4vw, 16px);
    line-height: 1.58;
  }
  .cta-btn {
    width: 100%;
    justify-content: center;
    font-size: 16px;
  }
  .cta-actions {
    width: 100%;
  }
}

/* ─── MCP SECTION ──────────────────────────────────────────────── */
.mcp-section {
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
  padding: clamp(16px, 3vw, 28px) clamp(16px, 4vw, 36px);
  background:
    radial-gradient(circle at 10% 15%, rgba(86,180,233,0.2) 0%, rgba(86,180,233,0) 40%),
    radial-gradient(circle at 92% 22%, rgba(0,158,115,0.12) 0%, rgba(0,158,115,0) 35%),
    linear-gradient(145deg, #f5fbff 0%, #f0fff8 52%, #fff8eb 100%);
}
.mcp-shell {
  border: 1px solid rgba(24, 41, 71, 0.14);
  border-radius: 14px;
  background: rgba(255,255,255,0.9);
  box-shadow: 0 16px 34px rgba(17, 35, 66, 0.1);
  padding: clamp(14px, 2.5vw, 24px);
}
.mcp-head {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
}
.mcp-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #0f6789;
}
.mcp-title {
  margin-top: 6px;
  font-family: 'Source Serif 4', serif;
  font-size: clamp(19px, 2.6vw, 30px);
  font-weight: 400;
  line-height: 1.18;
  color: #16213e;
}
.mcp-subtitle {
  margin-top: 8px;
  color: #445067;
  font-size: clamp(12px, 1.5vw, 14px);
  line-height: 1.62;
  max-width: 760px;
}
.mcp-head-actions {
  display: inline-flex;
  gap: 8px;
  flex-wrap: wrap;
}
.mcp-chip-btn {
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: #005a8f;
  font-size: 11px;
  font-weight: 600;
  padding: 7px 12px;
  cursor: pointer;
}
.mcp-chip-btn:hover { background: rgba(0,114,178,0.08); }
.mcp-chip-link {
  border: 1px solid rgba(0,158,115,0.35);
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: #0f7358;
  font-size: 11px;
  font-weight: 600;
  padding: 7px 12px;
  text-decoration: none;
}
.mcp-chip-link:hover { background: rgba(0,158,115,0.08); }
.mcp-grid {
  margin-top: 14px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 920px) {
  .mcp-grid { grid-template-columns: 1fr; }
}
.mcp-card {
  border: 1px solid rgba(25, 40, 68, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.96);
  padding: 12px 13px;
}
.mcp-card h3 {
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: #1e3458;
  margin-bottom: 7px;
}
.mcp-list {
  list-style: none;
  display: grid;
  gap: 7px;
}
.mcp-list li {
  font-size: 12px;
  color: #42506a;
  line-height: 1.5;
}
.mcp-list code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.16);
  border-radius: 5px;
  padding: 1px 5px;
}

/* ─── MCP MODAL ─────────────────────────────────────────────────── */
.mcp-modal {
  position: fixed;
  inset: 0;
  z-index: 170;
  display: none;
}
.mcp-modal.is-open { display: block; }
.mcp-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(13, 25, 45, 0.58);
  backdrop-filter: blur(3px);
}
.mcp-modal-dialog {
  position: relative;
  max-width: min(820px, calc(100vw - 28px));
  margin: clamp(16px, 5vh, 52px) auto;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(160deg, #ffffff 0%, #f8fbff 60%, #f6fff9 100%);
  box-shadow: 0 30px 60px rgba(8, 21, 44, 0.35);
  padding: clamp(16px, 2.6vw, 24px);
  max-height: calc(100vh - 28px);
  overflow: auto;
}
.mcp-modal-dialog:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.mcp-modal-close {
  position: sticky;
  top: 0;
  float: right;
  border: 1px solid rgba(20, 39, 68, 0.16);
  border-radius: 999px;
  width: 30px;
  height: 30px;
  background: #fff;
  color: #2c3954;
  cursor: pointer;
  font-size: 19px;
  line-height: 1;
}
.mcp-modal-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(20px, 3vw, 30px);
  font-weight: 400;
  line-height: 1.2;
  color: #17223f;
  margin-bottom: 6px;
}
.mcp-modal-subtitle {
  font-size: 13px;
  color: #45516a;
  line-height: 1.65;
  margin-bottom: 14px;
}
.mcp-modal-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 740px) {
  .mcp-modal-grid { grid-template-columns: 1fr; }
}
.mcp-modal-card {
  border: 1px solid rgba(22, 38, 67, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.96);
  padding: 11px 12px;
}
.mcp-modal-card h4 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: #1e3458;
  margin-bottom: 6px;
}
.mcp-modal-card ul {
  list-style: none;
  display: grid;
  gap: 6px;
}
.mcp-modal-card li {
  font-size: 12px;
  color: #43506b;
  line-height: 1.55;
}
.mcp-modal-card code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.15);
  border-radius: 5px;
  padding: 1px 4px;
}

/* ─── FIGURE HEADER ─────────────────────────────────────────────── */
.fig-header {
  padding: clamp(16px, 3vw, 28px) clamp(16px, 4vw, 36px) clamp(14px, 2vw, 20px);
  border-top: 1px solid rgba(30, 59, 105, 0.1);
  border-bottom: 1px solid rgba(30, 59, 105, 0.1);
  background:
    linear-gradient(180deg, rgba(0,114,178,0.05) 0%, rgba(255,255,255,0.9) 100%);
}
.fig-header-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 14px;
}
.fig-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(11px, 1.1vw, 12px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}
.fig-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(16px, 3vw, 26px);
  font-weight: 400;
  color: var(--text);
  margin-bottom: 6px;
  line-height: 1.25;
}
.fig-caption {
  font-size: clamp(11px, 1.5vw, 13px);
  color: var(--muted);
  max-width: 680px;
  line-height: 1.6;
}
.chart-focus-btn,
.cfo-focus-btn {
  flex-shrink: 0;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border: 1.5px solid rgba(0,114,178,0.35);
  border-radius: 999px;
  background: rgba(0,114,178,0.08);
  color: #0f4e76;
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  line-height: 1;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s, color 0.2s;
}
.chart-focus-btn:hover,
.cfo-focus-btn:hover {
  background: rgba(0,114,178,0.16);
  border-color: rgba(0,114,178,0.52);
}
.chart-focus-btn[aria-pressed="true"],
.cfo-focus-btn[aria-pressed="true"] {
  background: rgba(0,158,115,0.14);
  border-color: rgba(0,158,115,0.5);
  color: #0c664f;
}
.chart-focus-btn svg,
.cfo-focus-btn svg {
  width: 13px;
  height: 13px;
  flex-shrink: 0;
}
@media (max-width: 760px) {
  .fig-header-top {
    flex-direction: column;
    align-items: stretch;
  }
  .chart-focus-btn,
  .cfo-focus-btn {
    align-self: flex-start;
  }
}

/* ─── CONTROLS BAR ──────────────────────────────────────────────── */
.controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  padding: clamp(10px, 1.5vw, 14px) clamp(16px, 4vw, 36px);
  background: linear-gradient(180deg, #eef5ff 0%, #f8fbff 100%);
  border-bottom: 1px solid var(--border);
}
.controls-label {
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  letter-spacing: 0.12em;
  white-space: nowrap;
  flex-shrink: 0;
}
.btns-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  border-radius: 20px;
  border: 1.5px solid transparent;
  background: transparent;
  font-size: clamp(10px, 1.3vw, 12px);
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: opacity 0.18s, background 0.18s;
  white-space: nowrap;
  user-select: none;
  line-height: 1;
}
.toggle-btn .swatch {
  width: 18px;
  height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}
.toggle-btn.off { opacity: 0.32; }
.toggle-btn:hover { opacity: 1 !important; background: rgba(0,0,0,0.03); }
.toggle-btn:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}
.toggle-btn:disabled:hover {
  opacity: 0.35 !important;
  background: transparent;
}

/* ─── CHART + SIDE PANEL ────────────────────────────────────────── */
.chart-section {
  display: grid;
  grid-template-columns: 1fr 210px;
  position: relative;
  background: linear-gradient(180deg, #fcfdff 0%, #f9fcff 100%);
}
@media (max-width: 660px) {
  .chart-section {
    grid-template-columns: 1fr;
  }
  .side-panel {
    border-left: none !important;
    border-top: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  .side-panel .divider { display: none; }
  .side-panel .insight-box { grid-column: 1 / -1; }
}

.chart-container {
  position: relative;
  overflow: hidden;
  padding: clamp(12px, 2vw, 20px) 0 clamp(8px, 1vw, 12px) 0;
  min-width: 0;
}
.chart-container svg { display: block; width: 100%; }

.chart-focus-close {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 5;
  display: none;
  align-items: center;
  gap: 6px;
  padding: 7px 11px;
  border-radius: 999px;
  border: 1px solid rgba(17, 38, 74, 0.2);
  background: rgba(255,255,255,0.95);
  color: #1d2c49;
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
}
.chart-section:fullscreen,
.chart-section:-webkit-full-screen,
body.chart-focus-open #chart-section {
  grid-template-columns: minmax(0, 1fr) clamp(220px, 24vw, 310px);
  background: linear-gradient(180deg, #f4f8ff 0%, #fafdff 100%);
}
.chart-section:fullscreen,
.chart-section:-webkit-full-screen {
  padding: 8px;
}
body.chart-focus-open #chart-section {
  position: fixed;
  inset: clamp(10px, 2vw, 18px);
  z-index: 165;
  border: 1px solid rgba(17, 38, 74, 0.22);
  border-radius: 12px;
  box-shadow: 0 24px 56px rgba(11, 28, 55, 0.36);
  overflow: auto;
}
.chart-section:fullscreen .chart-container,
.chart-section:-webkit-full-screen .chart-container,
body.chart-focus-open #chart-section .chart-container {
  padding-top: 34px;
}
.chart-section:fullscreen .side-panel,
.chart-section:-webkit-full-screen .side-panel,
body.chart-focus-open #chart-section .side-panel {
  max-height: calc(100vh - 64px);
  overflow: auto;
}
.chart-section:fullscreen .chart-focus-close,
.chart-section:-webkit-full-screen .chart-focus-close,
body.chart-focus-open #chart-section .chart-focus-close {
  display: inline-flex;
}
@media (max-width: 920px) {
  .chart-section:fullscreen,
  .chart-section:-webkit-full-screen,
  body.chart-focus-open #chart-section {
    grid-template-columns: 1fr;
  }
}

/* ─── SIDE PANEL ────────────────────────────────────────────────── */
.side-panel {
  border-left: 1px solid var(--border);
  padding: clamp(14px, 2vw, 20px) clamp(12px, 1.5vw, 18px);
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}
.panel-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 10px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 2px;
}
.readout-n {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(16px, 2.5vw, 22px);
  font-weight: 500;
  color: var(--text);
}
.zone-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: clamp(10px, 1.2vw, 12px);
  font-weight: 500;
  background: var(--light);
  color: var(--text);
  border: 1px solid transparent;
}
.zone-desc-text {
  font-size: clamp(10px, 1.2vw, 11.5px);
  color: var(--muted);
  line-height: 1.55;
  margin-top: 4px;
}
.readout-grid { display: flex; flex-direction: column; gap: 9px; }
.readout-row { display: flex; flex-direction: column; gap: 1px; }
.readout-label {
  font-size: clamp(9px, 1.1vw, 10.5px);
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.readout-swatch {
  width: 11px; height: 11px;
  border-radius: 3px;
  flex-shrink: 0;
}
.readout-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(12px, 1.6vw, 14px);
  font-weight: 500;
  color: var(--text);
}
.readout-val.positive { color: #009e73; }
.readout-val.negative { color: #d55e00; }
.divider { height: 1px; background: var(--border); flex-shrink: 0; }
.insight-box {
  background: var(--light);
  border-radius: var(--radius);
  padding: 10px 12px;
}
.insight-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 9.5px);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 5px;
}

/* ─── ZONES STRIP ───────────────────────────────────────────────── */
.zones-strip {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  border-top: 1px solid var(--border);
  background: linear-gradient(90deg, rgba(0,114,178,0.04), rgba(0,158,115,0.04));
}
@media (max-width: 580px) {
  .zones-strip { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 340px) {
  .zones-strip { grid-template-columns: 1fr; }
}
.zone-cell {
  padding: clamp(10px, 1.5vw, 14px) clamp(12px, 2vw, 16px);
  border-right: 1px solid var(--border);
}
.zone-cell:nth-child(1) { background: rgba(213,94,0,0.045); }
.zone-cell:nth-child(2) { background: rgba(120,120,120,0.03); }
.zone-cell:nth-child(3) { background: rgba(0,158,115,0.05); }
.zone-cell:nth-child(4) { background: rgba(0,114,178,0.05); }
.zone-cell:last-child { border-right: none; }
.zone-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 9px);
  letter-spacing: 0.15em;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 3px;
}
.zone-cell-title {
  font-size: clamp(11px, 1.5vw, 13px);
  font-weight: 600;
  margin-bottom: 4px;
}
.zone-cell-desc {
  font-size: clamp(10px, 1.2vw, 11px);
  color: var(--muted);
  line-height: 1.5;
}

/* ─── FORMULAS ──────────────────────────────────────────────────── */
.formulas-section {
  padding: clamp(16px, 2.5vw, 20px) clamp(16px, 4vw, 36px) clamp(18px, 2.5vw, 24px);
  border-top: 1px solid var(--border);
  background: linear-gradient(180deg, #f0f6ff 0%, #f7fbff 100%);
}
.formulas-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 14px;
}
.formulas-header {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1.1vw, 10px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 0;
}
.formulas-header-actions {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}
.glossary-link-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1.5px solid rgba(0, 114, 178, 0.34);
  background: rgba(0, 114, 178, 0.1);
  color: #005a8f;
  text-decoration: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
  transition: background 0.16s ease, border-color 0.16s ease, transform 0.16s ease;
}
.glossary-link-btn:hover {
  background: rgba(0, 114, 178, 0.16);
  border-color: rgba(0, 114, 178, 0.55);
  transform: translateY(-1px);
}
.glossary-link-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.formulas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 30%, 200px), 1fr));
  gap: 10px;
}
.formula-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: clamp(10px, 1.5vw, 12px) clamp(10px, 1.5vw, 14px);
}
.f-label {
  font-size: clamp(9px, 1.1vw, 10.5px);
  color: var(--muted);
  margin-bottom: 5px;
}
.f-eq {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(10px, 1.3vw, 12px);
  color: var(--text);
  line-height: 1.6;
}
.f-eq .hl  { color: #0072b2; font-weight: 500; }
.f-eq .hl2 { color: #d55e00; font-weight: 500; }

/* ─── FOOTER ────────────────────────────────────────────────────── */
.fig-footer {
  padding: clamp(14px, 2vw, 20px) clamp(16px, 4vw, 36px);
  border-top: 2px solid var(--border);
  background: linear-gradient(180deg, #edf4ff 0%, #e9f2ff 100%);
  border-radius: 0 0 12px 12px;
}
.fig-footer-top {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 14px;
}
.fig-source {
  font-size: clamp(9px, 1.1vw, 11px);
  color: var(--muted);
  line-height: 1.5;
}
.fig-note {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1vw, 10px);
  color: var(--muted);
  white-space: nowrap;
}
.fig-note-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: var(--muted);
  text-decoration: none;
}
.fig-note-link:hover { color: #0072b2; }
.fig-note-link svg {
  width: 13px;
  height: 13px;
  fill: currentColor;
}
.fig-page-meta {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px dashed rgba(0, 114, 178, 0.22);
  display: flex;
  flex-wrap: wrap;
  gap: 8px 14px;
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(10.8px, 0.9vw, 12px);
  color: #55647d;
}
.fig-page-meta strong {
  color: #2f4668;
  font-weight: 600;
}

/* References section */
.fig-refs {
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.fig-refs-title {
  font-size: var(--font-size-2xs);
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
  font-family: 'JetBrains Mono', monospace;
}
.fig-refs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 6px 24px;
}
.fig-ref-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
}
.fig-ref-num {
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: #0072b2;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 2px;
  width: 18px;
}
.fig-ref-text {
  font-size: clamp(10.8px, 0.9vw, 12px);
  color: var(--muted);
  line-height: 1.55;
}
.fig-ref-text a {
  color: #0072b2;
  text-decoration: none;
  word-break: break-all;
}
.fig-ref-text a:hover { text-decoration: underline; }
.ref-tag {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 4px;
  border-radius: 3px;
  vertical-align: middle;
  margin-right: 2px;
  letter-spacing: 0.04em;
}
.ref-tag.econ  { background: rgba(0,114,178,0.1); color: #0072b2; }
.ref-tag.finops { background: rgba(0,158,115,0.1); color: #009e73; }
.ref-tag.cloud  { background: rgba(213,94,0,0.1); color: #d55e00; }

/* ─── CALCULATOR SECTION ────────────────────────────────────────── */
.calc-section {
  border-top: 2px solid rgba(0,114,178,0.2);
}

/* Header */
.calc-header {
  padding: clamp(16px,2.5vw,24px) clamp(16px,4vw,36px) clamp(12px,1.8vw,18px);
  background: linear-gradient(180deg, #ffffff 0%, #f5f9ff 100%);
  border-bottom: 1px solid var(--border);
}
.calc-title-row {
  display: grid;
  grid-template-columns: minmax(0, 1fr);
  align-items: start;
  gap: 12px;
}
.calc-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(16px, 2.2vw, 22px);
  font-weight: 400;
  color: var(--text);
  margin-bottom: 4px;
  line-height: 1.2;
}
.calc-subtitle {
  font-size: clamp(13px, 1.2vw, 15px);
  color: var(--muted);
  line-height: 1.6;
  max-width: 600px;
}
.calc-context-flow {
  margin-top: 10px;
  display: grid;
  gap: 8px;
  max-width: 760px;
}
.calc-release-note {
  margin-top: 0;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 7px;
  max-width: 760px;
  border: 1px solid rgba(0,158,115,0.2);
  border-radius: 9px;
  background: rgba(0,158,115,0.05);
  padding: 7px 10px;
}
.calc-release-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #006d4d;
}
.calc-release-text {
  font-size: var(--font-size-2xs);
  color: #234055;
  line-height: 1.45;
}
.calc-release-link {
  width: fit-content;
  font-size: var(--font-size-2xs);
  font-weight: 600;
  color: #006d4d;
  text-decoration: none;
  border-bottom: 1px dashed rgba(0,109,77,0.4);
}
.calc-release-link:hover {
  border-bottom-color: rgba(0,109,77,0.8);
}
.calc-r4-discovery {
  margin-top: 0;
  max-width: 760px;
  border: 1px solid rgba(213,94,0,0.24);
  border-left: 3px solid rgba(213,94,0,0.46);
  border-radius: 10px;
  background: linear-gradient(180deg, rgba(213,94,0,0.05), rgba(255,255,255,0.95));
  padding: 8px 10px;
  display: grid;
  gap: 5px;
}
.calc-r4-discovery-title {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  font-size: var(--font-size-xs);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.03em;
  color: #7a3300;
}
.calc-r4-discovery-text {
  margin: 0;
  font-size: var(--font-size-2xs);
  line-height: 1.5;
  color: #3a4d65;
}
.calc-r4-discovery-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 7px;
}
.calc-role-note {
  margin-top: 8px;
  min-height: 18px;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
  color: #55637a;
}
.calc-role-note strong {
  color: #143a5e;
}
.calc-inline-link-btn {
  border: 1px solid rgba(0,114,178,0.34);
  border-radius: 999px;
  background: rgba(0,114,178,0.08);
  color: #005a8f;
  padding: 2px 8px;
  margin-left: 4px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  cursor: pointer;
}
.calc-inline-link-btn:hover {
  background: rgba(0,114,178,0.15);
  border-color: rgba(0,114,178,0.5);
}
.calc-r4-discovery.is-coach {
  box-shadow: 0 0 0 2px rgba(213,94,0,0.22), 0 9px 20px rgba(213,94,0,0.12);
}
.share-feedback {
  margin-top: 8px;
  min-height: 16px;
  font-size: var(--font-size-xs);
  color: #0f7358;
}
.share-feedback.error { color: #a64300; }
.calc-deeplink {
  margin-top: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: #0072b2;
  text-decoration: none;
  border: 1px solid rgba(0,114,178,0.25);
  border-radius: 999px;
  padding: 4px 10px;
  background: rgba(0,114,178,0.07);
}
.calc-deeplink:hover {
  background: rgba(0,114,178,0.12);
  border-color: rgba(0,114,178,0.35);
}
.badge-calc {
  display: inline-block;
  background: rgba(0,114,178,0.1);
  color: #0072b2;
  border-radius: 4px;
  padding: 1px 6px;
  font-size: var(--font-size-2xs);
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.calc-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}
.share-btn {
  flex-shrink: 0;
  padding: 8px 14px;
  border: 1.5px solid rgba(0,114,178,0.35);
  border-radius: 8px;
  background: rgba(0,114,178,0.08);
  color: #005a8f;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.share-btn:hover { background: rgba(0,114,178,0.13); border-color: rgba(0,114,178,0.5); }
.share-btn:focus-visible,
.reset-btn:focus-visible,
.feature-request-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.reset-btn {
  flex-shrink: 0;
  padding: 8px 16px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--surface);
  color: var(--muted);
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.reset-btn:hover { border-color: #d55e00; color: #d55e00; background: rgba(213,94,0,0.04); }
.feature-request-btn {
  flex-shrink: 0;
  padding: 8px 14px;
  border: 1.5px solid rgba(213,94,0,0.35);
  border-radius: 8px;
  background: rgba(213,94,0,0.08);
  color: #8a3d00;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.feature-request-btn:hover {
  background: rgba(213,94,0,0.14);
  border-color: rgba(213,94,0,0.55);
}
.feature-request-btn-compact {
  padding: 6px 12px;
  font-size: 11px;
}

/* Unified action controls for calculator header */
.calc-action-btn {
  border: 1.5px solid transparent;
  border-radius: 10px;
  min-height: 36px;
  padding: 7px 12px;
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  letter-spacing: 0.01em;
  line-height: 1;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  cursor: pointer;
  transition: transform 0.16s ease, border-color 0.16s ease, background 0.16s ease, color 0.16s ease, box-shadow 0.16s ease;
}
.calc-action-btn:hover {
  transform: translateY(-1px);
}
.calc-action-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.calc-action-btn svg {
  width: 13px;
  height: 13px;
  flex-shrink: 0;
}
.calc-action-btn--soft {
  border-color: rgba(0,114,178,0.25);
  background: rgba(0,114,178,0.07);
  color: #0072b2;
}
.calc-action-btn--soft:hover {
  border-color: rgba(0,114,178,0.38);
  background: rgba(0,114,178,0.13);
}
.calc-action-btn--primary {
  border-color: rgba(0,114,178,0.35);
  background: rgba(0,114,178,0.1);
  color: #005a8f;
}
.calc-action-btn--primary:hover {
  border-color: rgba(0,114,178,0.52);
  background: rgba(0,114,178,0.16);
}
.calc-action-btn--warning {
  border-color: rgba(213,94,0,0.35);
  background: rgba(213,94,0,0.09);
  color: #8a3d00;
}
.calc-action-btn--warning:hover {
  border-color: rgba(213,94,0,0.52);
  background: rgba(213,94,0,0.16);
}
.calc-action-btn--neutral {
  border-color: rgba(40,62,95,0.22);
  background: rgba(255,255,255,0.9);
  color: #475778;
}
.calc-action-btn--neutral:hover {
  border-color: rgba(40,62,95,0.34);
  background: #ffffff;
}
.calc-action-btn--demo-good {
  border-color: rgba(0,158,115,0.34);
  background: rgba(0,158,115,0.1);
  color: #006d4d;
}
.calc-action-btn--demo-good:hover {
  border-color: rgba(0,158,115,0.5);
  background: rgba(0,158,115,0.16);
}
.calc-action-btn--demo-bad {
  border-color: rgba(181,76,0,0.34);
  background: rgba(181,76,0,0.09);
  color: #8a3d00;
}
.calc-action-btn--demo-bad:hover {
  border-color: rgba(181,76,0,0.5);
  background: rgba(181,76,0,0.15);
}
.calc-action-btn--demo-r4 {
  border-color: rgba(213,94,0,0.42);
  background: rgba(213,94,0,0.12);
  color: #7a3300;
}
.calc-action-btn--demo-r4:hover {
  border-color: rgba(213,94,0,0.58);
  background: rgba(213,94,0,0.2);
}

.calc-new-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(213,94,0,0.55);
  border-radius: 999px;
  padding: 1px 8px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: rgba(213,94,0,0.14);
  color: #7a3300;
}

.calc-new-badge--inline {
  margin-left: 6px;
  vertical-align: middle;
}

.calc-title-main .calc-deeplink.calc-action-btn {
  margin-top: 8px;
  width: fit-content;
}
.calc-actions {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 8px;
  width: 100%;
  min-width: 0;
  padding: 0;
  border: 1px solid rgba(17,71,128,0.14);
  border-radius: 12px;
  background: rgba(255,255,255,0.84);
  box-shadow: 0 5px 14px rgba(15, 44, 82, 0.05);
}
.calc-actions-row {
  display: grid;
  width: 100%;
  gap: 8px;
  align-items: start;
  padding: 8px 10px;
  border: 0;
  border-bottom: 1px solid rgba(17,71,128,0.12);
  border-radius: 0;
  background: transparent;
}
.calc-actions-row--onboarding {
  grid-template-columns: minmax(0, 1fr);
  gap: 7px;
  background: rgba(0,114,178,0.03);
}
.calc-actions-row--persona {
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
}
.calc-actions-row--analysis {
  grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
}
.calc-actions-row--controls {
  grid-template-columns: minmax(0, 1fr);
}
.calc-actions-row--scenarios {
  background: rgba(0,114,178,0.03);
}
.calc-actions-row--advanced {
  border-bottom: 0;
  padding-bottom: 10px;
}
.calc-scenario-suite {
  display: grid;
  gap: 8px;
}
.calc-scenario-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: #1f4f7d;
}
.calc-scenario-copy {
  margin: 0;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
  color: #40506b;
}
.calc-scenario-actions {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 8px;
}
.calc-scenario-item {
  display: grid;
  gap: 4px;
}
.calc-scenario-actions .calc-action-btn {
  width: 100%;
}
.calc-scenario-meta {
  font-size: 10px;
  line-height: 1.35;
  color: #55637a;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
}
.calc-actions-row--advanced .calc-disclosure {
  width: 100%;
}
.calc-actions-hint {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #1f4f7d;
  margin: 0;
}
.calc-onboarding-steps {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 6px;
  margin: 0;
}
.calc-onboarding-step {
  display: grid;
  grid-template-columns: 16px minmax(0, 1fr);
  gap: 5px;
  align-items: center;
  border: 1px solid rgba(31,79,125,0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.9);
  color: #425570;
  padding: 5px 6px;
}
.calc-onboarding-step-num {
  width: 16px;
  height: 16px;
  border-radius: 999px;
  border: 1px solid rgba(31,79,125,0.4);
  background: rgba(31,79,125,0.08);
  color: #1f4f7d;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.calc-onboarding-step-text {
  font-size: var(--font-size-2xs);
  line-height: 1.35;
}
.calc-onboarding-step.is-active {
  border-color: rgba(0,114,178,0.42);
  background: rgba(0,114,178,0.09);
  color: #0f3e65;
}
.calc-onboarding-step.is-done {
  border-color: rgba(0,158,115,0.44);
  background: rgba(0,158,115,0.11);
  color: #005d43;
}
.calc-onboarding-step.is-done .calc-onboarding-step-num {
  border-color: rgba(0,158,115,0.52);
  background: rgba(0,158,115,0.2);
  color: #005d43;
}
.calc-intent-switch {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 6px;
  margin-bottom: 0;
}
.calc-intent-btn {
  border: 1px solid rgba(106, 81, 145, 0.28);
  border-radius: 8px;
  min-height: 30px;
  background: rgba(255,255,255,0.94);
  color: #583c79;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.04em;
  cursor: pointer;
  transition: border-color 0.16s ease, background 0.16s ease, color 0.16s ease;
}
.calc-intent-btn:hover {
  border-color: rgba(106, 81, 145, 0.45);
  background: rgba(106, 81, 145, 0.1);
}
.calc-intent-btn[aria-pressed="true"] {
  border-color: rgba(106, 81, 145, 0.58);
  background: linear-gradient(180deg, rgba(106,81,145,0.2), rgba(0,114,178,0.13));
  color: #3f275f;
}
.calc-intent-btn:focus-visible {
  outline: 2px solid #b39ddb;
  outline-offset: 2px;
}
.calc-intent-summary {
  margin: 0;
  padding: 8px 9px;
  min-height: 100%;
  border-radius: 8px;
  border: 1px solid rgba(106, 81, 145, 0.32);
  background: rgba(106, 81, 145, 0.09);
  color: #353f52;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
}
.calc-intent-outcomes-wrap {
  margin: 0;
}
.calc-intent-outcomes {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.calc-intent-outcome-chip {
  display: inline-flex;
  align-items: center;
  border: 1px solid rgba(0,114,178,0.24);
  border-radius: 999px;
  padding: 4px 8px;
  background: rgba(0,114,178,0.08);
  color: #1f4f7d;
  font-size: var(--font-size-2xs);
  line-height: 1;
  white-space: nowrap;
}
.calc-intent-outcome-chip--placeholder {
  border-style: dashed;
  border-color: rgba(31,79,125,0.32);
  background: rgba(31,79,125,0.06);
  color: #39597f;
}
.calc-next-step {
  margin: 0;
  border: 1px solid rgba(0,114,178,0.22);
  border-radius: 8px;
  background: rgba(0,114,178,0.05);
  padding: 8px 9px;
  display: grid;
  gap: 6px;
}
.calc-next-step-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #1f4f7d;
}
.calc-next-step-copy {
  margin: 0;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
  color: #31465f;
}
.calc-next-step-links {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.calc-next-step-link {
  display: inline-flex;
  align-items: center;
  border: 1px dashed rgba(0,114,178,0.42);
  border-radius: 999px;
  padding: 3px 8px;
  color: #0f4f82;
  text-decoration: none;
  font-size: var(--font-size-2xs);
}
.calc-next-step-link--primary {
  border-style: solid;
  border-color: rgba(0,114,178,0.62);
  background: rgba(0,114,178,0.14);
  color: #0d4773;
  font-weight: 700;
}
.calc-next-step-link:hover {
  border-color: rgba(0,114,178,0.64);
  background: rgba(0,114,178,0.08);
}
.calc-outcome-preview {
  border: 1px dashed rgba(0,114,178,0.24);
  border-radius: 8px;
  background: rgba(255,255,255,0.75);
}
.calc-outcome-preview > summary {
  list-style: none;
  cursor: pointer;
  padding: 7px 9px;
}
.calc-outcome-preview > summary::-webkit-details-marker { display: none; }
.calc-outcome-preview > summary .calc-mode-label {
  font-size: 9px;
  color: #335f8a;
}
.calc-outcome-preview .calc-intent-outcomes-wrap {
  padding: 0 9px 8px;
}
.intent-path-wrap {
  margin: 0;
}
.intent-path-wrap > summary {
  display: flex;
  align-items: center;
  gap: 8px;
}
.intent-path {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 6px;
}
.intent-step {
  display: grid;
  grid-template-columns: 18px minmax(0, 1fr);
  gap: 6px;
  align-items: center;
  border: 1px solid rgba(40, 62, 95, 0.2);
  border-radius: 8px;
  background: rgba(255,255,255,0.85);
  color: #475778;
  padding: 6px 7px;
  min-height: 36px;
}
.intent-step-status {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  border: 1px solid rgba(40, 62, 95, 0.25);
  background: rgba(255,255,255,0.95);
}
.intent-step-label {
  font-size: var(--font-size-2xs);
  line-height: 1.35;
}
.intent-step.active {
  border-color: rgba(230,159,0,0.45);
  background: rgba(230,159,0,0.1);
  color: #845800;
}
.intent-step.active .intent-step-status {
  border-color: rgba(230,159,0,0.6);
  background: rgba(230,159,0,0.18);
  color: #845800;
}
.intent-step.done {
  border-color: rgba(0,158,115,0.44);
  background: rgba(0,158,115,0.12);
  color: #00684a;
}
.intent-step.done .intent-step-status {
  border-color: rgba(0,158,115,0.58);
  background: rgba(0,158,115,0.2);
  color: #00684a;
}
.intent-export-row {
  margin-top: 7px;
  display: grid;
  grid-template-columns: minmax(0, 1fr);
  gap: 6px;
}
.intent-path-progress {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.04em;
  text-transform: none;
  color: #4f5f80;
  margin-left: auto;
  padding-right: 14px;
}
.intent-export-btn {
  min-height: 32px;
  text-align: center;
}
.calc-mode-switch {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 6px;
  margin-bottom: 2px;
}
.calc-mode-label {
  grid-column: 1 / -1;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #2e5c8a;
}
.calc-mode-btn {
  border: 1px solid rgba(0,114,178,0.26);
  border-radius: 8px;
  min-height: 30px;
  background: rgba(255,255,255,0.94);
  color: #2a5078;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  cursor: pointer;
  transition: border-color 0.16s ease, background 0.16s ease, color 0.16s ease;
}
.calc-mode-btn:hover {
  border-color: rgba(0,114,178,0.44);
  background: rgba(0,114,178,0.1);
}
.calc-mode-btn[aria-pressed="true"] {
  border-color: rgba(0,114,178,0.58);
  background: linear-gradient(180deg, rgba(0,114,178,0.2), rgba(0,165,200,0.14));
  color: #0f3e65;
}
.calc-mode-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.calc-actions .calc-action-btn {
  width: auto;
}
.calc-actions-row--controls .calc-action-btn,
.calc-disclosure-body .calc-action-btn {
  width: 100%;
}
.calc-advanced-wrap {
  margin: 0;
  display: grid;
  gap: 6px;
}
.calc-feature-switch {
  display: grid;
  gap: 6px;
}
.calc-feature-toggle-summary {
  font-size: 10px;
  line-height: 1.4;
  color: #4a5d7a;
}
.calc-feature-toggle-list {
  display: grid;
  gap: 6px;
}
.calc-feature-toggle-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  border: 1px solid rgba(40, 62, 95, 0.18);
  border-radius: 8px;
  background: rgba(255,255,255,0.92);
  padding: 6px 8px;
}
.calc-feature-toggle-item.is-required {
  opacity: 0.8;
}
.calc-feature-toggle-main {
  min-width: 0;
  display: grid;
  gap: 2px;
}
.calc-feature-toggle-name {
  font-size: 11px;
  font-weight: 700;
  color: #1f3f63;
}
.calc-feature-toggle-meta {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.04em;
  color: #5f6f86;
}
.calc-feature-toggle-control {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.calc-feature-toggle-control input[type="checkbox"] {
  width: 14px;
  height: 14px;
  margin: 0;
  accent-color: #0072b2;
}
.calc-feature-toggle-pill {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 999px;
  padding: 2px 6px;
  color: #2b4e78;
  background: rgba(0,114,178,0.08);
}
.calc-feature-reset-btn[hidden] {
  display: none !important;
}
.calc-disclosure {
  border: 1px solid rgba(40, 62, 95, 0.2);
  border-radius: 10px;
  background: rgba(255,255,255,0.78);
  margin: 0;
}
.calc-disclosure > summary {
  list-style: none;
  cursor: pointer;
  padding: 8px 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #38587d;
}
.calc-disclosure > summary::-webkit-details-marker { display: none; }
.calc-disclosure > summary::after {
  content: '+';
  float: right;
  color: #4f6e91;
}
.calc-disclosure[open] > summary::after {
  content: '−';
}
.calc-disclosure[open] > summary {
  border-bottom: 1px solid rgba(40, 62, 95, 0.16);
  background: rgba(0,114,178,0.07);
}
.calc-disclosure-body {
  display: grid;
  gap: 8px;
  padding: 8px;
}

@media (max-width: 1120px) {
  .calc-actions-row--persona {
    grid-template-columns: minmax(0, 1fr);
  }
  .calc-actions-row--analysis {
    grid-template-columns: minmax(0, 1fr);
  }
  .calc-scenario-actions {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 680px) {
  .calc-actions {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: flex-start;
    align-items: stretch;
    padding: 10px;
  }
  .calc-context-flow {
    gap: 7px;
  }
  .calc-release-note,
  .calc-r4-discovery {
    max-width: 100%;
  }
  .calc-actions-row--persona,
  .calc-actions-row--analysis,
  .calc-actions-row--controls {
    grid-template-columns: minmax(0, 1fr);
    gap: 8px;
    padding: 8px;
  }
  .calc-actions-row--scenarios,
  .calc-actions-row--advanced {
    grid-template-columns: minmax(0, 1fr);
    gap: 8px;
    padding: 8px;
  }
  .calc-actions-hint { margin-bottom: 0; }
  .calc-onboarding-steps {
    grid-template-columns: minmax(0, 1fr);
  }
  .calc-scenario-actions {
    grid-template-columns: minmax(0, 1fr);
  }
  .calc-next-step-links {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
  }
  .intent-path {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  .intent-step {
    min-height: 34px;
  }
  .calc-actions .calc-action-btn {
    min-height: 34px;
    padding: 7px 10px;
    font-size: 11px;
  }
  .calc-title-main .calc-deeplink.calc-action-btn {
    width: fit-content;
  }
}

/* Body wrapper */
.calc-body {
  padding: clamp(16px,2.5vw,24px) clamp(16px,4vw,36px);
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: linear-gradient(180deg, #eef5ff 0%, #f6fbff 52%, #fff8ef 100%);
}

/* ── Step groups ── */
.calc-group {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 22px rgba(14, 35, 72, 0.06);
}
.calc-group-title {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 18px;
  background: linear-gradient(180deg, #f2f7ff 0%, #edf4ff 100%);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.calc-group-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px; height: 24px;
  border-radius: 50%;
  background: var(--text);
  color: white;
  font-size: 12px;
  font-weight: 700;
  flex-shrink: 0;
  line-height: 1;
}
.calc-group-label {
  font-size: clamp(12px, 1.5vw, 14px);
  font-weight: 600;
  color: var(--text);
}
.calc-group-hint {
  font-size: var(--font-size-xs);
  font-weight: 400;
  color: var(--muted);
}
.fine-tune-area-indicators {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 2px;
}
.fine-tune-area-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  appearance: none;
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 999px;
  background: rgba(255,255,255,0.85);
  color: #23496f;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.02em;
  padding: 3px 8px;
  line-height: 1;
  cursor: pointer;
}
.fine-tune-area-chip:hover {
  background: rgba(0,114,178,0.12);
  border-color: rgba(0,114,178,0.45);
}
.fine-tune-area-chip:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.fine-tune-area-chip.is-disabled {
  border-color: rgba(95, 111, 134, 0.45);
  background: rgba(242, 245, 249, 0.92);
  color: #5f6f86;
}
.fine-tune-area-chip.is-disabled:hover {
  background: rgba(232, 237, 244, 0.98);
  border-color: rgba(95, 111, 134, 0.6);
}
.fine-tune-area-chip.is-disabled .fine-tune-area-chip-num {
  background: rgba(95, 111, 134, 0.16);
  color: #52637a;
}
.fine-tune-area-chip-num {
  width: 16px;
  height: 16px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,114,178,0.16);
  color: #12416c;
  font-size: 10px;
  font-weight: 700;
  line-height: 1;
}

/* ── Input fields grid ── */
.calc-fields {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 0;
}
.calc-field {
  padding: clamp(14px,2vw,18px) clamp(14px,1.8vw,18px);
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  position: relative;
  transition: background 0.2s;
}
.calc-field:nth-last-child(-n+4):nth-child(4n+1),
.calc-field:last-child { border-right: none; }
@media (max-width: 600px) { .calc-field { border-right: none; } }

.calc-field.has-value,
.startup-field.has-value { background: rgba(0,114,178,0.025); }
.calc-field.has-value::before,
.startup-field.has-value::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px; height: 100%;
  background: #0072b2;
  border-radius: 0 0 0 12px;
}

/* Field label row */
.calc-label {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: clamp(12px, 1.2vw, 14px);
  font-weight: 600;
  color: var(--text);
  margin-bottom: 9px;
  cursor: default;
  line-height: 1.3;
}
.ftag {
  font-size: var(--font-size-2xs);
  font-weight: 500;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--light);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 5px;
  letter-spacing: 0.04em;
  white-space: nowrap;
}

/* Input box */
.calc-input-wrap {
  display: flex;
  align-items: stretch;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  background: var(--surface);
  transition: border-color 0.18s, box-shadow 0.18s;
  height: 38px;
}
.calc-input-wrap:focus-within {
  border-color: #0072b2;
  box-shadow: 0 0 0 3px rgba(0,114,178,0.12);
}
.calc-field.invalid .calc-input-wrap,
.startup-field.invalid .calc-input-wrap {
  border-color: #d55e00;
  box-shadow: 0 0 0 3px rgba(213,94,0,0.14);
}
.calc-input-wrap input {
  flex: 1;
  min-width: 0;
  border: none;
  outline: none;
  padding: 0 10px;
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text);
  background: transparent;
  appearance: textfield;
  -moz-appearance: textfield;
}
.calc-input-wrap input::-webkit-inner-spin-button,
.calc-input-wrap input::-webkit-outer-spin-button { -webkit-appearance: none; }
.calc-input-wrap select {
  flex: 1;
  min-width: 0;
  border: none;
  outline: none;
  padding: 0 10px;
  font-size: 13px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text);
  background: transparent;
  appearance: none;
}
.calc-select-wrap { position: relative; }
.calc-select-wrap::after {
  content: '▾';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  font-size: 11px;
  pointer-events: none;
}
.calc-select-wrap select { padding-right: 26px; }
.calc-input-wrap input::placeholder { color: #ccc; font-weight: 400; font-size: 13px; }
.calc-unit {
  padding: 0 10px;
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--light);
  border-left: 1px solid var(--border);
  display: flex;
  align-items: center;
  white-space: nowrap;
  flex-shrink: 0;
}
.calc-hint {
  margin-top: 7px;
  font-size: var(--font-size-2xs);
  color: var(--muted);
  line-height: 1.45;
}
.calc-input-error {
  margin-top: 6px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.02em;
  color: #a33f00;
}

/* Startup planner (ARPU unknown) */
.startup-planner {
  border-top: 1px dashed var(--border);
  background: linear-gradient(180deg, rgba(0,114,178,0.03), rgba(0,158,115,0.03));
}
.startup-title {
  padding: 10px 18px 8px;
  font-size: var(--font-size-xs);
  color: #2f415f;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.fine-tune-area-seq {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  margin-right: 6px;
  border-radius: 6px;
  border: 1px solid rgba(0,114,178,0.34);
  background: rgba(0,114,178,0.12);
  color: #13436c;
  font-size: 10px;
  font-weight: 700;
  line-height: 1;
}
.startup-help {
  margin: 0 18px 10px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px dashed rgba(0, 114, 178, 0.32);
  background: rgba(255,255,255,0.78);
}
.startup-help-title {
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #005a8f;
  margin-bottom: 6px;
}
.startup-help-list {
  margin: 0;
  padding-left: 16px;
  font-size: var(--font-size-xs);
  color: #4b5263;
  line-height: 1.5;
}
.startup-help-list li { margin: 2px 0; }
.startup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.startup-field {
  padding: clamp(14px,2vw,18px) clamp(14px,1.8vw,18px);
  border-right: 1px solid var(--border);
  border-top: 1px solid var(--border);
  position: relative;
  transition: background 0.2s;
}
.startup-field:last-child { border-right: none; }
@media (max-width: 600px) {
  .startup-field { border-right: none; }
}

/* Multi-technology normalization panel (R2 Wave 1) */
.portfolio-overlay {
  border-top: 1px dashed var(--border);
  background: linear-gradient(180deg, rgba(0,114,178,0.02), rgba(0,158,115,0.02));
}
.value-overlay {
  border-top: 1px dashed rgba(0,114,178,0.3);
  border-left: 3px solid rgba(0,114,178,0.4);
  background: linear-gradient(180deg, rgba(86,180,233,0.07), rgba(0,114,178,0.03));
}
.value-overlay .calc-field {
  background: linear-gradient(180deg, rgba(240,248,255,0.86) 0%, rgba(248,252,255,0.94) 100%);
  border-top-color: rgba(0,114,178,0.2);
}
.value-overlay .calc-label {
  color: #1d4c7b;
}
.value-overlay .ftag {
  border-color: rgba(0,114,178,0.34);
  background: rgba(86,180,233,0.1);
  color: #0f4e76;
}
.value-guardrail {
  border-top: 1px dashed rgba(0,114,178,0.28);
}
.finops-2026-highlight {
  position: relative;
  border-top: 1px dashed rgba(0,158,115,0.42);
  border-left: 3px solid rgba(0,158,115,0.5);
  background:
    linear-gradient(180deg, rgba(0,158,115,0.06) 0%, rgba(0,114,178,0.03) 100%);
}
.finops-2026-highlight .calc-field {
  background: linear-gradient(180deg, rgba(234,254,246,0.85) 0%, rgba(246,251,255,0.92) 100%);
  border-top-color: rgba(0,158,115,0.26);
}
.finops-2026-highlight .calc-label {
  color: #0f5f4a;
}
.finops-2026-highlight .ftag {
  border-color: rgba(0,158,115,0.35);
  background: rgba(0,158,115,0.1);
  color: #0c6d55;
}
.ai-token-overlay {
  border-top: 1px dashed rgba(111, 78, 145, 0.42);
  border-left: 3px solid rgba(111, 78, 145, 0.5);
  background:
    linear-gradient(180deg, rgba(111, 78, 145, 0.07) 0%, rgba(0, 114, 178, 0.03) 100%);
}
.ai-token-overlay .calc-field {
  background: linear-gradient(180deg, rgba(246, 240, 255, 0.86) 0%, rgba(249, 244, 255, 0.94) 100%);
  border-top-color: rgba(111, 78, 145, 0.24);
}
.ai-token-overlay .calc-label {
  color: #4f3370;
}
.ai-token-overlay .ftag {
  border-color: rgba(111, 78, 145, 0.34);
  background: rgba(111, 78, 145, 0.1);
  color: #4f3370;
}
.ai-preset-actions {
  padding: 0 18px 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.ai-preset-btn {
  border: 1px solid rgba(111, 78, 145, 0.34);
  border-radius: 999px;
  background: rgba(111, 78, 145, 0.1);
  color: #4f3370;
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  padding: 5px 10px;
  cursor: pointer;
}
.ai-preset-btn:hover {
  background: rgba(111, 78, 145, 0.16);
  border-color: rgba(111, 78, 145, 0.5);
}
.ai-token-card {
  border-color: rgba(111, 78, 145, 0.35);
  background: linear-gradient(180deg, rgba(246, 240, 255, 0.95) 0%, rgba(241, 249, 255, 0.9) 100%);
}
.ai-token-card .calc-out-label { color: #4f3370; }
.finops-2026-pill {
  margin-left: 8px;
  display: inline-flex;
  align-items: center;
  border: 1px solid rgba(0,158,115,0.4);
  border-radius: 999px;
  padding: 2px 8px;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.09em;
  text-transform: uppercase;
  color: #0d6d55;
  background: rgba(255,255,255,0.78);
}
.reliability-overlay {
  border-top: 1px dashed rgba(213,94,0,0.4);
  border-left: 3px solid rgba(213,94,0,0.45);
  background: linear-gradient(180deg, rgba(255,245,238,0.88), rgba(246,251,255,0.9));
}
.reliability-overlay .calc-field {
  background: linear-gradient(180deg, rgba(255,250,246,0.92) 0%, rgba(251,254,255,0.94) 100%);
  border-top-color: rgba(213,94,0,0.2);
}
.reliability-overlay .calc-label {
  color: #7a3300;
}
.reliability-overlay .ftag {
  border-color: rgba(213,94,0,0.35);
  background: rgba(213,94,0,0.1);
  color: #8a3d00;
}
.reliability-explainer {
  margin: 0 18px 10px;
  border: 1px dashed rgba(213,94,0,0.34);
  border-radius: 8px;
  background: rgba(255,255,255,0.75);
  padding: 6px 10px;
}
.reliability-explainer summary {
  cursor: pointer;
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: #7a3300;
}
.reliability-explainer-body {
  margin-top: 6px;
  font-size: var(--font-size-2xs);
  color: #4b5263;
  line-height: 1.45;
}
.reliability-card {
  border-color: rgba(213,94,0,0.38);
  background: linear-gradient(180deg, rgba(255,248,243,0.94), rgba(241,249,255,0.92));
}

.reliability-emphasis {
  box-shadow: 0 0 0 2px rgba(213,94,0,0.25), 0 10px 22px rgba(213,94,0,0.1);
}

.reliability-spotlight {
  animation: reliabilityPulse 1.4s ease-in-out 1;
}

@keyframes reliabilityPulse {
  0% { box-shadow: 0 0 0 0 rgba(213,94,0,0.05); }
  35% { box-shadow: 0 0 0 8px rgba(213,94,0,0.18); }
  100% { box-shadow: 0 0 0 0 rgba(213,94,0,0); }
}

@media (prefers-reduced-motion: reduce) {
  .reliability-spotlight {
    animation: none;
  }
}
.portfolio-guardrail {
  border-top: 1px dashed var(--border);
  padding: 9px 18px 11px;
  font-size: var(--font-size-2xs);
  color: #4b5263;
  line-height: 1.5;
}
.portfolio-guardrail.warn {
  color: #b07800;
  background: rgba(230,159,0,0.08);
}
.portfolio-guardrail.good {
  color: #006d4d;
  background: rgba(0,158,115,0.08);
}
.portfolio-report-note {
  padding: 0 18px 11px;
  font-size: var(--font-size-2xs);
}
.portfolio-report-note a {
  color: #005a8f;
  text-decoration: none;
  border-bottom: 1px dashed rgba(0,90,143,0.35);
}
.portfolio-report-note a:hover {
  border-bottom-color: rgba(0,90,143,0.7);
}
.calc-inline-help {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  color: #005a8f;
  border: 1px solid rgba(0,114,178,0.35);
  background: rgba(0,114,178,0.08);
  text-decoration: none;
  line-height: 1;
}
.calc-inline-help:hover { background: rgba(0,114,178,0.16); }
.calc-inline-help--hint {
  margin-left: 6px;
  cursor: help;
}
.calc-inline-help--hint:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.calc-inline-help-popover {
  position: fixed;
  left: -9999px;
  top: -9999px;
  z-index: 240;
  max-width: min(320px, 76vw);
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0,114,178,0.28);
  background: rgba(11, 35, 61, 0.96);
  color: #f4f9ff;
  font-size: 11px;
  font-weight: 500;
  line-height: 1.35;
  letter-spacing: 0.01em;
  box-shadow: 0 10px 24px rgba(7, 24, 42, 0.32);
  opacity: 0;
  visibility: hidden;
  transform: translate(-50%, calc(-100% - 8px));
  transition: opacity 0.12s ease;
  pointer-events: none;
}
.calc-inline-help-popover.is-open {
  opacity: 1;
  visibility: visible;
}
.calc-inline-help-popover::after {
  content: '';
  position: absolute;
  left: 50%;
  bottom: -5px;
  width: 8px;
  height: 8px;
  transform: translateX(-50%) rotate(45deg);
  border-right: 1px solid rgba(0,114,178,0.28);
  border-bottom: 1px solid rgba(0,114,178,0.28);
  background: rgba(11, 35, 61, 0.96);
}
.calc-inline-help-popover[data-placement="bottom"] {
  transform: translate(-50%, 8px);
}
.calc-inline-help-popover[data-placement="bottom"]::after {
  top: -5px;
  bottom: auto;
  border-right: none;
  border-bottom: none;
  border-left: 1px solid rgba(0,114,178,0.28);
  border-top: 1px solid rgba(0,114,178,0.28);
}
.tech-domain-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 2px;
}
.tech-domain-chip {
  border: 1px solid rgba(0, 114, 178, 0.25);
  background: rgba(255,255,255,0.86);
  color: #35506f;
  border-radius: 999px;
  font-size: 10.5px;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1;
  padding: 6px 9px;
  cursor: pointer;
  transition: all 0.16s;
}
.tech-domain-chip.selected {
  border-color: rgba(0,158,115,0.5);
  background: rgba(0,158,115,0.12);
  color: #006d4d;
  box-shadow: 0 0 0 1px rgba(0,158,115,0.15);
}
.tech-domain-chip:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 1px;
}
.tech-domain-actions {
  margin-top: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.tech-domain-link-btn {
  border: none;
  background: transparent;
  padding: 0;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: #005a8f;
  cursor: pointer;
  border-bottom: 1px dashed rgba(0,90,143,0.35);
}
.tech-domain-link-btn:hover { border-bottom-color: rgba(0,90,143,0.7); }

.portfolio-summary {
  margin: 0 18px 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #fbfdff;
  overflow: hidden;
}
.portfolio-summary-head {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #385072;
  background: rgba(0,114,178,0.05);
}
.portfolio-summary-body {
  display: grid;
  font-size: var(--font-size-xs);
}
.portfolio-row {
  display: grid;
  grid-template-columns: 1.3fr 0.8fr 0.9fr 1.2fr;
  gap: 8px;
  padding: 8px 12px;
  border-top: 1px solid rgba(30, 56, 94, 0.08);
  align-items: center;
}
.portfolio-row:first-child { border-top: none; }
.portfolio-row.portfolio-head {
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: #637896;
  background: rgba(0,114,178,0.03);
}
.portfolio-row.is-primary {
  background: rgba(0,114,178,0.04);
}
.portfolio-row.in-scope {
  background: rgba(0,114,178,0.05);
}
.portfolio-row.out-of-scope {
  opacity: 0.58;
}
.portfolio-row.total {
  background: rgba(0,158,115,0.08);
  font-weight: 600;
}
.portfolio-tag {
  margin-left: 6px;
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: #005a8f;
  border: 1px solid rgba(0,114,178,0.24);
  border-radius: 999px;
  padding: 1px 6px;
}
.portfolio-tag.scope {
  color: #006d4d;
  border-color: rgba(0,158,115,0.32);
  background: rgba(0,158,115,0.12);
}
.portfolio-empty {
  padding: 12px;
  color: var(--muted);
  font-size: var(--font-size-xs);
}
.qbv-dashboard {
  margin: 0 18px 18px;
  border: 1px solid rgba(0,114,178,0.2);
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(245,251,255,0.96) 0%, rgba(239,248,255,0.94) 100%);
  overflow: hidden;
}
.qbv-dashboard-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 11px 12px;
  border-bottom: 1px solid rgba(0,114,178,0.2);
  background: rgba(0,114,178,0.08);
}
.qbv-dashboard-head-actions {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}
.qbv-dashboard-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #1f4f7f;
}
.qbv-dashboard-sub {
  margin-top: 2px;
  font-size: var(--font-size-sm);
  color: #3a5a7d;
}
.qbv-export-btn {
  border: 1px solid rgba(0,114,178,0.35);
  background: rgba(255,255,255,0.92);
  color: #0f4f78;
  border-radius: 999px;
  font-size: var(--font-size-xs);
  font-family: 'JetBrains Mono', monospace;
  padding: 6px 10px;
  cursor: pointer;
}
.qbv-export-btn:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}
.qbv-dashboard-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  padding: 10px 12px;
}
.qbv-panel {
  border: 1px solid rgba(30, 75, 118, 0.16);
  border-radius: 10px;
  background: rgba(255,255,255,0.9);
  padding: 10px;
  position: relative;
}
.cfo-panel-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.qbv-panel h4 {
  margin: 0 0 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #215280;
}
.cfo-panel-tip {
  position: relative;
}
.cfo-panel-tip > summary {
  list-style: none;
  width: 17px;
  height: 17px;
  border-radius: 999px;
  border: 1px solid rgba(0,114,178,0.35);
  background: rgba(0,114,178,0.08);
  color: #0f4e76;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  user-select: none;
}
.cfo-panel-tip > summary::-webkit-details-marker { display: none; }
.cfo-panel-tip[open] > summary {
  background: rgba(0,158,115,0.14);
  border-color: rgba(0,158,115,0.45);
  color: #0c664f;
}
.cfo-panel-tip-popover {
  position: absolute;
  top: 24px;
  right: 0;
  width: min(340px, calc(100vw - 72px));
  z-index: 8;
  border: 1px solid rgba(0,114,178,0.28);
  border-radius: 10px;
  background: #ffffff;
  box-shadow: 0 14px 26px rgba(15,40,74,0.18);
  padding: 9px 10px;
  font-size: var(--font-size-xs);
  color: #2f4f72;
  line-height: 1.45;
}
.cfo-panel-tip-popover strong {
  color: #1b4e7d;
  font-weight: 700;
}
.cfo-panel-tip-popover p {
  margin: 0;
}
.cfo-panel-tip-popover p + p {
  margin-top: 6px;
}
.qbv-panel-sub {
  margin: 0 0 8px;
  font-size: var(--font-size-xs);
  color: #587290;
}
.qbv-placeholder {
  font-size: var(--font-size-xs);
  color: #6a7c95;
}
.qbv-bar-row {
  display: grid;
  grid-template-columns: 42px minmax(0, 1fr) 88px;
  align-items: center;
  gap: 6px;
}
.qbv-bar-row + .qbv-bar-row { margin-top: 6px; }
.qbv-bar-label {
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: #55708f;
}
.qbv-bar-stack {
  display: grid;
  gap: 4px;
}
.qbv-bar-track {
  height: 7px;
  border-radius: 999px;
  background: rgba(36, 65, 102, 0.12);
  overflow: hidden;
}
.qbv-bar-fill { display: block; height: 100%; border-radius: 999px; }
.qbv-bar-fill.budget { background: rgba(0,114,178,0.65); }
.qbv-bar-fill.cost { background: rgba(213,94,0,0.65); }
.qbv-bar-fill.rel-penalty { background: rgba(0,114,178,0.65); }
.qbv-bar-fill.rel-incident { background: rgba(213,94,0,0.68); }
.qbv-bar-fill.rel-downtime { background: rgba(230,159,0,0.72); }
.qbv-bar-fill.rel-churn { background: rgba(123,45,139,0.68); }
.qbv-bar-meta {
  text-align: right;
  font-size: var(--font-size-xs);
  font-family: 'JetBrains Mono', monospace;
  color: #335774;
}
.qbv-risk-pill {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid rgba(28, 62, 101, 0.22);
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: #2b4f73;
  background: rgba(255,255,255,0.85);
}
.qbv-risk-pill.good {
  border-color: rgba(0,158,115,0.36);
  color: #0c664f;
  background: rgba(0,158,115,0.12);
}
.qbv-risk-pill.warn {
  border-color: rgba(230,159,0,0.4);
  color: #8a5a00;
  background: rgba(230,159,0,0.14);
}
.qbv-risk-pill.bad {
  border-color: rgba(213,94,0,0.4);
  color: #8a3100;
  background: rgba(213,94,0,0.13);
}
.qbv-forecast-svg {
  width: 100%;
  height: 170px;
  border: 1px solid rgba(0,114,178,0.18);
  border-radius: 8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.94) 0%, rgba(247,251,255,0.94) 100%);
}
.qbv-forecast-legend {
  margin-top: 7px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: var(--font-size-2xs);
  font-family: 'JetBrains Mono', monospace;
  color: #4a688a;
}
.qbv-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  display: inline-block;
  margin-right: 4px;
}
.qbv-dot.best { background: #009e73; }
.qbv-dot.base { background: #0072b2; }
.qbv-dot.worst { background: #d55e00; }
.qbv-realization-meter {
  height: 10px;
  border-radius: 999px;
  overflow: hidden;
  background: rgba(0,114,178,0.12);
}
.qbv-realization-meter-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #009e73 0%, #00a58d 100%);
  transition: width 0.25s ease;
}
.qbv-realization-summary {
  margin-top: 7px;
  font-size: var(--font-size-xs);
  color: #3f607f;
}
.qbv-realization-bars { margin-top: 8px; }
.qbv-table-wrap {
  padding: 0 12px 10px;
  overflow-x: auto;
}
.qbv-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 760px;
  font-size: var(--font-size-xs);
}
.qbv-table th,
.qbv-table td {
  border: 1px solid rgba(30,56,94,0.14);
  padding: 6px 7px;
  text-align: left;
  white-space: nowrap;
}
.qbv-table th {
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #244f7a;
  background: rgba(0,114,178,0.08);
}
.qbv-quarter-sep td {
  border: 0;
  padding: 8px 0 4px;
  background: transparent;
}
.qbv-quarter-sep-line {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
}
.qbv-quarter-sep-line::after {
  content: '';
  flex: 1;
  height: 2px;
  border-radius: 999px;
  background: rgba(28, 98, 177, 0.5);
}
.qbv-quarter-sep-label {
  display: inline-flex;
  align-items: center;
  padding-left: 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #214e80;
}
.qbv-dashboard-note {
  border-top: 1px dashed rgba(0,114,178,0.22);
  padding: 8px 12px 10px;
  font-size: var(--font-size-xs);
  color: #3d5d80;
}
.cfo-focus-close {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 6;
  display: none;
  align-items: center;
  gap: 6px;
  padding: 7px 11px;
  border-radius: 999px;
  border: 1px solid rgba(17, 38, 74, 0.2);
  background: rgba(255,255,255,0.95);
  color: #1d2c49;
  font-family: 'JetBrains Mono', monospace;
  font-size: var(--font-size-2xs);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
}
#qbv-dashboard:fullscreen,
#qbv-dashboard:-webkit-full-screen,
body.cfo-focus-open #qbv-dashboard {
  background: linear-gradient(180deg, #f4f8ff 0%, #fafdff 100%);
}
#qbv-dashboard:fullscreen,
#qbv-dashboard:-webkit-full-screen {
  margin: 0;
  border-radius: 0;
  border: none;
}
body.cfo-focus-open #qbv-dashboard {
  position: fixed;
  inset: clamp(10px, 2vw, 18px);
  z-index: 170;
  margin: 0;
  border: 1px solid rgba(17, 38, 74, 0.22);
  border-radius: 12px;
  box-shadow: 0 24px 56px rgba(11, 28, 55, 0.36);
  overflow: auto;
}
#qbv-dashboard:fullscreen .cfo-focus-close,
#qbv-dashboard:-webkit-full-screen .cfo-focus-close,
body.cfo-focus-open #qbv-dashboard .cfo-focus-close {
  display: inline-flex;
}
@media (max-width: 900px) {
  .portfolio-row { grid-template-columns: 1.2fr 0.8fr 0.9fr; }
  .portfolio-row .focus-col { display: none; }
  .qbv-dashboard-grid { grid-template-columns: 1fr; }
}

/* ── Output cards ── */
.calc-outputs {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  padding: 16px 18px;
}
@media (max-width: 700px) { .calc-outputs { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 420px) { .calc-outputs { grid-template-columns: 1fr; } }

.calc-out-card {
  background: linear-gradient(180deg, #f8fbff 0%, #eef5ff 100%);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 13px 14px 11px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 0;
  overflow: visible;
  transition: border-color 0.22s, background 0.22s, box-shadow 0.22s;
  position: relative;
}
[data-feature][hidden],
[data-ui-mode][hidden] {
  display: none !important;
}
.finops-2026-group {
  border-color: rgba(0,158,115,0.44);
  box-shadow:
    0 12px 28px rgba(14, 35, 72, 0.08),
    0 0 0 1px rgba(0,158,115,0.18);
}
.finops-2026-group .calc-group-title {
  background: linear-gradient(180deg, rgba(0,158,115,0.12) 0%, rgba(86,180,233,0.09) 100%);
  border-bottom-color: rgba(0,158,115,0.3);
}
.finops-2026-group .calc-group-label {
  color: #0d5f4a;
}
.finops-2026-group .calc-group-hint {
  color: #2f6c61;
}
.finops-2026-card {
  border-color: rgba(0,158,115,0.38);
  background: linear-gradient(180deg, rgba(238,255,248,0.92) 0%, rgba(241,249,255,0.9) 100%);
}
.finops-2026-card .calc-out-label { color: #0f6f57; }
.qbv-card {
  border-color: rgba(0,114,178,0.28);
  background: linear-gradient(180deg, rgba(241,249,255,0.95) 0%, rgba(236,247,255,0.92) 100%);
}
.qbv-card .calc-out-label {
  color: #1c507f;
}
.calc-out-card.tip-enabled { cursor: pointer; }
.calc-out-card.tip-open { z-index: 8; }
.calc-out-card.live {
  border-color: #009e73;
  background: rgba(0,158,115,0.05);
  box-shadow: 0 0 0 1px rgba(0,158,115,0.15);
}
.calc-out-card.live-warn {
  border-color: #e69f00;
  background: rgba(230,159,0,0.05);
  box-shadow: 0 0 0 1px rgba(230,159,0,0.15);
}
.calc-out-card.live-bad {
  border-color: #d55e00;
  background: rgba(213,94,0,0.05);
  box-shadow: 0 0 0 1px rgba(213,94,0,0.15);
}

.calc-severity-helper {
  margin: 0 18px 0;
  padding: 8px 10px;
  border-top: 1px dashed rgba(40, 62, 95, 0.18);
  border-bottom: 1px dashed rgba(40, 62, 95, 0.18);
  background: rgba(247, 251, 255, 0.72);
  font-size: 10px;
  line-height: 1.45;
  color: #4a5d79;
}
.calc-severity-helper strong {
  color: #173d62;
  font-weight: 700;
}

.calc-out-severity-badge {
  align-self: flex-start;
  margin: 0 0 3px;
  border: 1px solid rgba(40, 62, 95, 0.26);
  border-radius: 999px;
  padding: 2px 7px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  background: rgba(255,255,255,0.88);
  color: #395472;
}
.calc-out-severity-badge.severity-critical {
  border-color: rgba(213,94,0,0.46);
  background: rgba(213,94,0,0.14);
  color: #8a3100;
}
.calc-out-severity-badge.severity-high {
  border-color: rgba(230,159,0,0.5);
  background: rgba(230,159,0,0.16);
  color: #7a5400;
}
.calc-out-severity-badge.severity-needs {
  border-color: rgba(106,81,163,0.4);
  background: rgba(106,81,163,0.12);
  color: #4f347f;
}
.calc-out-severity-badge.severity-low {
  border-color: rgba(0,158,115,0.45);
  background: rgba(0,158,115,0.12);
  color: #0a664e;
}
.calc-out-severity-badge.severity-info {
  border-color: rgba(0,114,178,0.35);
  background: rgba(0,114,178,0.1);
  color: #12517e;
}

.calc-severity-divider {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 2px 0;
}
.calc-severity-divider-line {
  flex: 1;
  height: 0;
  border-top: 2px dashed rgba(40,62,95,0.22);
}
.calc-severity-divider-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  border: 1px solid rgba(40,62,95,0.25);
  background: rgba(255,255,255,0.9);
  padding: 2px 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: #3a5675;
  white-space: nowrap;
}
.calc-severity-divider.severity-critical .calc-severity-divider-line {
  border-top-color: rgba(213,94,0,0.46);
}
.calc-severity-divider.severity-critical .calc-severity-divider-label {
  border-color: rgba(213,94,0,0.46);
  color: #8a3100;
  background: rgba(213,94,0,0.12);
}
.calc-severity-divider.severity-high .calc-severity-divider-line {
  border-top-color: rgba(230,159,0,0.5);
}
.calc-severity-divider.severity-high .calc-severity-divider-label {
  border-color: rgba(230,159,0,0.5);
  color: #7a5400;
  background: rgba(230,159,0,0.16);
}
.calc-severity-divider.severity-needs .calc-severity-divider-line {
  border-top-color: rgba(106,81,163,0.42);
}
.calc-severity-divider.severity-needs .calc-severity-divider-label {
  border-color: rgba(106,81,163,0.42);
  color: #4f347f;
  background: rgba(106,81,163,0.12);
}
.calc-severity-divider.severity-low .calc-severity-divider-line {
  border-top-color: rgba(0,158,115,0.46);
}
.calc-severity-divider.severity-low .calc-severity-divider-label {
  border-color: rgba(0,158,115,0.46);
  color: #0a664e;
  background: rgba(0,158,115,0.12);
}

.calc-out-label {
  font-size: 9.5px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  padding-right: 26px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.calc-out-label.with-icon {
  display: flex;
  align-items: center;
  gap: 6px;
}
.calc-out-label.with-icon .info-icon-badge {
  width: 16px;
  height: 16px;
  border-radius: 5px;
}
.calc-out-label.with-icon .info-icon {
  width: 10px;
  height: 10px;
}

.calc-out-tip-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1px solid rgba(0,114,178,0.34);
  background: rgba(255,255,255,0.95);
  color: #005a8f;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  line-height: 1;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(13, 31, 60, 0.12);
}
.calc-out-tip-btn:hover { background: rgba(0,114,178,0.1); }
.calc-out-tip-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 1px;
}

.calc-out-tip {
  position: absolute;
  top: 30px;
  right: 8px;
  width: min(340px, calc(100vw - 54px));
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 10px;
  background: linear-gradient(180deg, #ffffff 0%, #f3f9ff 100%);
  box-shadow: 0 16px 34px rgba(11, 28, 58, 0.24);
  padding: 10px 11px;
  display: none;
  z-index: 20;
}
.calc-out-tip.tip-floating {
  position: fixed;
  right: auto;
  top: 0;
  z-index: 280;
}
.calc-out-card.tip-open .calc-out-tip { display: block; }
.calc-out-tip-title {
  font-family: 'Source Serif 4', serif;
  font-size: 14px;
  color: #16213e;
  line-height: 1.25;
}
.calc-out-tip-what {
  margin-top: 5px;
  font-size: 11px;
  line-height: 1.5;
  color: #405070;
}
.calc-out-tip-sub {
  margin-top: 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #005a8f;
}
.calc-out-tip-list {
  margin-top: 6px;
  padding-left: 14px;
  display: grid;
  gap: 4px;
}
.calc-out-tip-list li {
  font-size: 10.5px;
  line-height: 1.45;
  color: #2f3c57;
}
.calc-out-tip code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.14);
  border-radius: 4px;
  padding: 1px 4px;
}
.calc-out-tip-link {
  margin-top: 9px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 600;
  color: #005a8f;
  text-decoration: none;
  border-bottom: 1px dashed rgba(0,90,143,0.4);
}
.calc-out-tip-link:hover {
  border-bottom-color: rgba(0,90,143,0.8);
}
.calc-out-tip-action-btn {
  margin-top: 10px;
  width: 100%;
  border: 1px solid rgba(0,114,178,0.32);
  border-radius: 8px;
  background: rgba(0,114,178,0.08);
  color: #045e93;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 8px 9px;
  cursor: pointer;
}
.calc-out-tip-action-btn:hover {
  background: rgba(0,114,178,0.14);
}
.calc-out-tip-action-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}

.calc-out-solve-modal {
  position: fixed;
  inset: 0;
  z-index: 1600;
  display: none;
}
.calc-out-solve-modal.open {
  display: block;
}
.calc-out-solve-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(9, 22, 45, 0.48);
}
.calc-out-solve-dialog {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: min(760px, calc(100vw - 28px));
  max-height: min(82vh, 860px);
  overflow: auto;
  border-radius: 14px;
  border: 1px solid rgba(0,114,178,0.26);
  background: linear-gradient(180deg, #ffffff 0%, #f4f9ff 100%);
  box-shadow: 0 28px 52px rgba(9, 22, 45, 0.35);
  padding: 18px 18px 16px;
}
.calc-out-solve-close {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 30px;
  height: 30px;
  border-radius: 999px;
  border: 1px solid rgba(11, 51, 98, 0.2);
  background: #ffffff;
  color: #184b7c;
  font-size: 21px;
  line-height: 1;
  cursor: pointer;
}
.calc-out-solve-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #0f5d93;
}
.calc-out-solve-title {
  margin-top: 4px;
  font-family: 'Source Serif 4', serif;
  font-size: clamp(24px, 3.1vw, 31px);
  line-height: 1.1;
  color: #1a2a4a;
}
.calc-out-solve-audience {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.calc-out-solve-audience-btn {
  border: 1px solid rgba(0, 90, 143, 0.2);
  border-radius: 999px;
  background: #ffffff;
  color: #2f4a70;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 4px 9px;
  cursor: pointer;
}
.calc-out-solve-audience-btn.active {
  background: rgba(0,114,178,0.12);
  border-color: rgba(0,114,178,0.34);
  color: #045e93;
}
.calc-out-solve-audience-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.calc-out-solve-current {
  margin-top: 9px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
.calc-out-solve-signal {
  border-radius: 999px;
  border: 1px solid transparent;
  padding: 3px 9px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.calc-out-solve-signal.good { color: #0f825f; background: rgba(0,158,115,0.12); border-color: rgba(0,158,115,0.25); }
.calc-out-solve-signal.warn { color: #8f6200; background: rgba(230,159,0,0.16); border-color: rgba(230,159,0,0.3); }
.calc-out-solve-signal.bad { color: #a34800; background: rgba(213,94,0,0.14); border-color: rgba(213,94,0,0.28); }
.calc-out-solve-signal.needs { color: #5b6173; background: rgba(122,122,140,0.18); border-color: rgba(122,122,140,0.28); }
.calc-out-solve-value {
  font-size: 12px;
  color: #324365;
}
.calc-out-solve-objective {
  margin-top: 8px;
  font-size: 13px;
  line-height: 1.55;
  color: #2f3f60;
}
.calc-out-solve-grid {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}
.calc-out-solve-card {
  border: 1px solid rgba(17, 71, 128, 0.16);
  border-radius: 10px;
  background: #ffffff;
  padding: 10px 10px 9px;
}
.calc-out-solve-sub {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #005a8f;
}
.calc-out-solve-list {
  margin-top: 6px;
  padding-left: 15px;
  display: grid;
  gap: 4px;
}
.calc-out-solve-list li {
  font-size: 12px;
  line-height: 1.45;
  color: #2f3d57;
}
.calc-out-solve-refs {
  margin-top: 12px;
  border-top: 1px dashed rgba(0, 90, 143, 0.25);
  padding-top: 10px;
}
.calc-out-solve-refs-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #005a8f;
}
.calc-out-solve-ref-links {
  margin-top: 6px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.calc-out-solve-ref-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: #045e93;
  text-decoration: none;
  border-bottom: 1px dashed rgba(4, 94, 147, 0.35);
}
.calc-out-solve-ref-link:hover {
  border-bottom-color: rgba(4, 94, 147, 0.8);
}
@media (max-width: 760px) {
  .calc-out-solve-dialog {
    top: auto;
    left: 0;
    right: 0;
    bottom: 0;
    transform: none;
    width: 100%;
    max-height: 88vh;
    border-radius: 16px 16px 0 0;
    padding: 16px 14px 14px;
  }
  .calc-out-solve-grid {
    grid-template-columns: 1fr;
  }
}

.calc-out-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(15px, 2vw, 18px);
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
  word-break: break-word;
  overflow-wrap: anywhere;
  min-width: 0;
}
.calc-out-val.good { color: #009e73; }
.calc-out-val.warn { color: #b07800; }
.calc-out-val.bad  { color: #d55e00; }
.calc-out-val.muted { color: var(--muted); font-weight: 400; font-size: 13px; }

.calc-out-sub {
  font-size: 10px;
  color: var(--muted);
  line-height: 1.4;
  margin-top: 1px;
}

/* Status bar */
.calc-status-bar {
  padding: 0 18px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 28px;
}
.calc-status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #ccc;
  flex-shrink: 0;
  transition: background 0.3s;
}
.calc-status-dot.active { background: #009e73; }
.calc-status-text {
  font-size: 11px;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  transition: color 0.3s;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.calc-status-text.active { color: #009e73; }

.calc-out-card.needs-data {
  border-color: var(--border);
  background: var(--light);
  opacity: 0.75;
}
.calc-out-card.needs-data .calc-out-label { color: var(--muted); }
.calc-out-card.needs-data .calc-out-sub {
  color: #b07800;
  font-style: italic;
}
.calc-out-missing-msg {
  display: inline;
}
.calc-out-missing-cta {
  appearance: none;
  border: none;
  background: transparent;
  color: #8a5a00;
  cursor: pointer;
  pointer-events: auto;
  font: inherit;
  font-size: 10px;
  font-style: normal;
  font-weight: 700;
  line-height: 1.35;
  margin: 0;
  padding: 0;
  text-decoration: underline;
  text-decoration-thickness: 1px;
  text-underline-offset: 2px;
}
.calc-out-missing-cta:hover {
  color: #6f4600;
}
.calc-out-missing-cta:focus-visible {
  outline: 2px solid rgba(86, 180, 233, 0.9);
  outline-offset: 2px;
  border-radius: 3px;
}

/* Progress pills — show how many fields are filled */
.calc-progress {
  display: flex;
  gap: 4px;
  align-items: center;
  padding: 0 18px 14px;
}
.cp-label { font-size: 10px; color: var(--muted); margin-right: 4px; }
.cp-pill {
  width: 28px; height: 5px;
  border-radius: 3px;
  background: var(--border);
  transition: background 0.3s;
  cursor: default;
  position: relative;
}
.cp-pill.filled { background: #0072b2; }
.cp-pill[data-filled="0"] {
  cursor: pointer;
}
.cp-pill[data-filled="0"]:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.cp-pill::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  bottom: calc(100% + 8px);
  transform: translateX(-50%) translateY(4px);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  line-height: 1.25;
  color: #fff;
  background: rgba(22, 36, 58, 0.98);
  border: 1px solid rgba(86, 118, 156, 0.55);
  border-radius: 6px;
  padding: 5px 7px;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 25;
  transition: opacity 0.16s ease, transform 0.16s ease, visibility 0.16s ease;
}
.cp-pill::before {
  content: '';
  position: absolute;
  left: 50%;
  bottom: calc(100% + 3px);
  width: 8px;
  height: 8px;
  background: rgba(22, 36, 58, 0.98);
  border-right: 1px solid rgba(86, 118, 156, 0.55);
  border-bottom: 1px solid rgba(86, 118, 156, 0.55);
  transform: translateX(-50%) rotate(45deg) scale(0.9);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 24;
  transition: opacity 0.16s ease, transform 0.16s ease, visibility 0.16s ease;
}
.cp-pill:hover::after,
.cp-pill:hover::before {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(0);
}


/* ── GROUP D: PROVIDERS ── */
.provider-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  padding: 16px 18px;
}
.provider-btn {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  min-height: 42px;
  padding: 0 11px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: linear-gradient(180deg, #ffffff 0%, #f5f8ff 100%);
  color: #575b66;
  font-size: clamp(11px, 1.25vw, 13px);
  font-weight: 500;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.18s ease;
}
.provider-btn:hover {
  border-color: #5a5a8a;
  color: #5a5a8a;
  background: rgba(90,90,138,0.07);
}
.provider-btn.selected {
  border-color: #5a5a8a;
  color: #42426d;
  background: rgba(90,90,138,0.12);
  box-shadow: 0 0 0 2px rgba(90,90,138,0.15);
}
.provider-btn .check {
  display: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #5a5a8a;
  color: #fff;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  line-height: 16px;
  text-align: center;
  margin-left: auto;
}
.provider-btn.selected .check { display: inline-block; }
.provider-label {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.provider-logo {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 8.5px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  flex-shrink: 0;
}
.provider-logo.aws { background: #232f3e; color: #ff9900; }
.provider-logo.azure { background: #0078d4; color: #fff; }
.provider-logo.gcp {
  color: #fff;
  background: conic-gradient(#ea4335 0 25%, #fbbc05 25% 50%, #34a853 50% 75%, #4285f4 75% 100%);
}
.provider-logo.oci { background: #c74634; color: #fff; }
.provider-logo.ibm { background: #052fad; color: #fff; }
.provider-logo.alibaba { background: #ff6a00; color: #fff; }
.provider-logo.huawei { background: #cf0a2c; color: #fff; }
.provider-logo.onprem { background: #4b5563; color: #fff; }
.provider-logo.multi { background: #5a5a8a; color: #fff; }

/* ── GROUP E: HEALTH + RECOMMENDATIONS ── */
.health-wrap {
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.health-banner {
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: linear-gradient(180deg, #f7fbff 0%, #eef5ff 100%);
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 14px;
  flex-wrap: wrap;
}
.health-banner.awaiting { border-color: var(--border); }
.health-banner.green {
  border-color: #009e73;
  background: rgba(0,158,115,0.08);
}
.health-banner.yellow {
  border-color: #e69f00;
  background: rgba(230,159,0,0.08);
}
.health-banner.red {
  border-color: #d55e00;
  background: rgba(213,94,0,0.08);
}
.health-zone-title {
  font-size: clamp(14px, 1.7vw, 18px);
  font-weight: 700;
  line-height: 1.25;
}
.health-zone-desc {
  margin-top: 6px;
  color: var(--muted);
  font-size: clamp(11px, 1.3vw, 13px);
  line-height: 1.55;
  max-width: 760px;
}
.health-zone-list {
  margin: 0;
  padding-left: 18px;
  display: grid;
  gap: 4px;
}
.health-zone-list li {
  margin: 0;
}
.health-score {
  min-width: 130px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}
.health-score-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.11em;
  color: var(--muted);
}
.health-score-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(24px, 3vw, 34px);
  font-weight: 700;
  line-height: 1.1;
}

.rec-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 10px;
}
.rec-filters {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}
.intent-rec-helper {
  margin-top: 6px;
  padding: 7px 10px;
  border-radius: 8px;
  border: 1px dashed rgba(0,114,178,0.3);
  background: rgba(0,114,178,0.07);
  color: #4b5263;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
}
.rec-filters-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
}
.rec-filter-btn {
  appearance: none;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: #fff;
  color: #33405f;
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  line-height: 1;
  padding: 6px 10px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s, color 0.15s;
}
.rec-filter-btn:hover {
  border-color: rgba(0,114,178,0.45);
  background: rgba(0,114,178,0.07);
}
.rec-filter-btn.is-active,
.rec-filter-btn[aria-pressed="true"] {
  background: rgba(0,114,178,0.12);
  border-color: rgba(0,114,178,0.52);
  color: #0f4e76;
}
.intent-kpi-helper {
  margin: 10px 12px 0;
  padding: 8px 10px;
  border-radius: 9px;
  border: 1px dashed rgba(0,114,178,0.32);
  background: rgba(0,114,178,0.07);
  color: #4b5263;
  font-size: var(--font-size-2xs);
  line-height: 1.45;
}
.rec-card {
  border: 1.5px solid var(--border);
  border-radius: 11px;
  background: linear-gradient(180deg, #ffffff 0%, #f5f9ff 100%);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.rec-card.high { border-left: 4px solid #d55e00; }
.rec-card.medium { border-left: 4px solid #e69f00; }
.rec-card.low { border-left: 4px solid #009e73; }

.rec-head {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
}
.rec-icon { font-size: 15px; }
.rec-title {
  font-size: clamp(12px, 1.35vw, 13px);
  font-weight: 600;
  color: var(--text);
}
.rec-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 1px 5px;
  border-radius: 4px;
  border: 1px solid var(--border);
  color: var(--muted);
  background: #fff;
}
.rec-tag.priority-high { color: #d55e00; border-color: rgba(213,94,0,0.4); background: rgba(213,94,0,0.1); }
.rec-tag.priority-medium { color: #b07800; border-color: rgba(176,120,0,0.4); background: rgba(230,159,0,0.1); }
.rec-tag.priority-low { color: #009e73; border-color: rgba(0,158,115,0.4); background: rgba(0,158,115,0.1); }
.rec-tag.category-infrastructure { color: #0f4e76; border-color: rgba(0,114,178,0.4); background: rgba(0,114,178,0.1); }
.rec-tag.category-pricing { color: #995d00; border-color: rgba(230,159,0,0.45); background: rgba(230,159,0,0.12); }
.rec-tag.category-marketing { color: #005a6f; border-color: rgba(0,158,115,0.4); background: rgba(0,158,115,0.12); }
.rec-tag.category-crm { color: #6f3a9a; border-color: rgba(123,45,139,0.4); background: rgba(123,45,139,0.12); }
.rec-tag.category-governance { color: #595f73; border-color: rgba(96,103,122,0.45); background: rgba(96,103,122,0.12); }

.rec-desc {
  color: var(--muted);
  font-size: 11px;
  line-height: 1.55;
}
.rec-action {
  font-size: 11px;
  color: #2a2f44;
  line-height: 1.45;
}
.rec-links {
  margin-top: 2px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.rec-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: #045e93;
  text-decoration: none;
  border-bottom: 1px dashed rgba(4, 94, 147, 0.35);
}
.rec-link:hover {
  border-bottom-color: rgba(4, 94, 147, 0.8);
}
.rec-empty {
  grid-column: 1 / -1;
  padding: 11px 12px;
  border-radius: 9px;
  border: 1px dashed var(--border);
  color: var(--muted);
  font-size: 11px;
  background: #faf9f7;
}


/* ─── FORMULA CARD TOOLTIPS ─────────────────────────────────────── */
.formula-card {
  position: relative;
  cursor: pointer;
  transition: box-shadow 0.18s, border-color 0.18s;
}
.formula-card:hover,
.formula-card.active {
  border-color: #0072b2;
  box-shadow: 0 0 0 3px rgba(0,114,178,0.1);
}
.formula-card:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.formula-card .info-btn {
  position: absolute;
  top: 8px; right: 8px;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--light);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 11px;
  font-weight: 700;
  line-height: 16px;
  text-align: center;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  user-select: none;
  flex-shrink: 0;
}
.formula-card:hover .info-btn,
.formula-card.active .info-btn {
  background: #0072b2;
  color: white;
  border-color: #0072b2;
}

/* Tooltip panel */
.ftip {
  display: none;
  position: absolute;
  z-index: 100;
  bottom: calc(100% + 10px);
  left: 0;
  width: clamp(220px, 32vw, 320px);
  background: #fff;
  border: 1.5px solid #0072b2;
  border-radius: 10px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.13);
  padding: 14px 16px 12px;
  pointer-events: none;
}
.ftip.tip-floating {
  position: fixed;
  left: 0;
  top: 0;
  bottom: auto;
  z-index: 280;
}
.ftip.open { display: block; }

/* Flip tooltip to below if card is in top half */
.formula-card.flip-down .ftip {
  bottom: auto;
  top: calc(100% + 10px);
}

/* Arrow */
.ftip::before {
  content: '';
  position: absolute;
  bottom: -7px; left: 20px;
  width: 12px; height: 12px;
  background: #fff;
  border-right: 1.5px solid #0072b2;
  border-bottom: 1.5px solid #0072b2;
  transform: rotate(45deg);
}
.formula-card.flip-down .ftip::before {
  bottom: auto;
  top: -7px;
  border-right: none; border-bottom: none;
  border-left: 1.5px solid #0072b2;
  border-top: 1.5px solid #0072b2;
}

.ftip-title {
  font-family: 'Source Serif 4', serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}
.ftip-desc {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.6;
  margin-bottom: 10px;
}
.ftip-vars {
  display: flex;
  flex-direction: column;
  gap: 5px;
  border-top: 1px solid var(--border);
  padding-top: 9px;
}
.ftip-var {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  align-items: baseline;
}
.ftip-sym {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  color: #0072b2;
  white-space: nowrap;
}
.ftip-sym.hl2 { color: #d55e00; }
.ftip-def {
  font-size: 11px;
  color: var(--muted);
  line-height: 1.45;
}

@media (prefers-reduced-motion: reduce) {
  html { scroll-behavior: auto; }
  *, *::before, *::after {
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
  }
}
</style>
</head>
<body>
<a class="skip-link" href="#calculator-section">Skip to calculator</a>

<nav class="sticky-top-nav" aria-label="Quick section navigation">
  <div class="sticky-top-nav-inner">
    <a class="sticky-top-brand" href="#introduction-section" aria-label="Go to page overview">
      <span class="sticky-top-logo" aria-hidden="true">
        <img src="FiceCal-Logo-L-trsprt.png" alt="" decoding="async">
      </span>
      <span class="sticky-top-brand-text">FiceCal by Duksh</span>
    </a>
    <ul class="sticky-top-nav-list">
      <li><a class="sticky-top-nav-link" data-nav-link href="#introduction-section">Overview</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#finops2026-section">FinOps 2026</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#model-assurance-section">Model Assurance</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#about-section">About</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#mcp-section">MCP</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#roadmap-section">Roadmap</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#calculator-section">Calculator</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#group-health">Health</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#chart-section">Chart</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#formulas-section">Formulas</a></li>
      <li><a class="sticky-top-nav-link" href="document.html#glossary">Glossary</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#references-section">References</a></li>
    </ul>
  </div>
</nav>
<div class="paper">

  <!-- LANDING INTRO -->
  <section class="landing-intro section-anchor" id="introduction-section">
    <div class="landing-kicker">FiceCal - FinOps &amp; Cloud Economics Calculator by Duksh</div>
    <h1 class="landing-title">A practical FiceCal model to quantify break-even, pricing floor, cloud efficiency, and AI economics before you scale.</h1>
    <p class="landing-subtitle">
      This page combines a live calculator and an interactive economics visualization to help teams convert cloud spend into clear operating decisions.
      Enter a few inputs and immediately see viability thresholds, contribution margin, CCER posture, and recommendation-driven next actions.
    </p>

    <div class="landing-grid">
      <article class="landing-card">
        <h2 class="landing-card-title">What this tool provides</h2>
        <ul class="landing-card-list">
          <li>Instant break-even and minimum viable client projections.</li>
          <li>Per-client cost and minimum pricing guardrails.</li>
          <li>Provider-aware recommendations based on health zone signals.</li>
        </ul>
        <a class="landing-card-link" href="#calculator-section">Go to Calculator &darr;</a>
      </article>

      <article class="landing-card">
        <h2 class="landing-card-title">Features &amp; advantages</h2>
        <ul class="landing-card-list">
          <li>Role-based guided workflow with quick steps, outcomes preview, and intent path progression.</li>
          <li>AI token economics output cards (token cost, allocated AI spend, and AI cost per client).</li>
          <li>Real-time recalculation with transparent formulas and governance-ready recommendations.</li>
        </ul>
        <a class="landing-card-link features" href="#chart-section">Go to Chart &darr;</a>
      </article>

      <article class="landing-card">
        <h2 class="landing-card-title">Target users</h2>
        <ul class="landing-card-list">
          <li>FinOps practitioners and cloud cost optimization teams.</li>
          <li>SaaS founders, product leaders, and cloud/AI solution architects.</li>
          <li>CTOs, CFOs, and operations teams validating unit economics at scale.</li>
        </ul>
        <a class="landing-card-link users" href="#formulas-section">Go to Formulas &darr;</a>
      </article>
    </div>
  </section>

  <!-- FINOPS 2026 FINDINGS -->
  <section class="finops-2026-section section-anchor" id="finops2026-section" aria-labelledby="finops2026-title">
    <div class="finops-2026-shell">
      <span class="finops-2026-kicker">State of FinOps 2026</span>
      <h2 class="finops-2026-title" id="finops2026-title">2026 report findings translated into FiceCal capabilities</h2>
      <p class="finops-2026-subtitle">
        This section summarizes how FiceCal operationalizes FinOps Foundation guidance from the 2026 report,
        turning visibility into action across normalized unit economics, AI token economics, Release 4 reliability economics,
        and policy-ready prioritization.
      </p>

      <div class="finops-2026-grid">
        <article class="finops-2026-report-card">
          <h3>Key findings reflected</h3>
          <ul>
            <li>Cloud cost decisions must connect to broader technology value and business outcomes.</li>
            <li>Coverage quality matters: fragmented scope weakens confidence in optimization decisions.</li>
            <li>FinOps maturity grows when technical metrics are paired with operational governance signals.</li>
          </ul>
        </article>

        <article class="finops-2026-report-card">
          <h3>Implemented in this calculator</h3>
          <ul>
            <li>Multi-technology cost inputs (SaaS, Licensing, Private Cloud, Data Center, Labor).</li>
            <li>Scoped normalization: <code>NTC/client = Σ(αᵈ × Cᵈ) / n</code> for cross-domain comparability.</li>
            <li>AI token economics with token pricing mode, retry/premium mix, and allocated AI cost outputs.</li>
            <li>Release 4 reliability economics with 10 reliability inputs, 8 reliability output cards, and 2 reliability-adjusted chart overlays for resilience planning.</li>
            <li>Coverage and confidence outputs for evidence-quality signaling before actioning recommendations.</li>
          </ul>
        </article>

        <article class="finops-2026-report-card">
          <h3>Recommended operating motion</h3>
          <ul>
            <li>Start with Financial Truth mode (<code>αᵈ ∈ {0,1}</code>) to anchor baseline reporting.</li>
            <li>Use Priority Index weights (<code>Σwᵈ=1</code>) only when governance policy requires scenario emphasis.</li>
            <li>Use 4 scenario demos (Healthy, Unhealthy, Reliability Healthy, Reliability Unhealthy) to stress-test policy and downside readiness before live rollout.</li>
            <li>Review normalization confidence before making pricing or commitment decisions.</li>
          </ul>
          <a class="finops-2026-link" href="https://data.finops.org" target="_blank" rel="noopener noreferrer">Open State of FinOps 2026 ↗</a>
        </article>
      </div>
    </div>
  </section>

  <!-- CREDIBILITY -->
  <section class="credibility-section section-anchor" id="about-section" aria-labelledby="about-title" aria-describedby="about-summary">
    <div class="cred-avatar">
      <img src="https://avatars.githubusercontent.com/u/586947?v=4" alt="Duksh Koonjoobeeharry profile photo">
    </div>
    <div class="cred-content">
      <p class="cred-kicker">Built by</p>
      <h2 class="cred-title" id="about-title">Duksh Koonjoobeeharry</h2>
      <p class="cred-role">FinOps &amp; AWS/GCP Cloud Solution Developer · DBA Researcher</p>
      <p class="cred-text" id="about-summary">
        I design cloud-financial models and architecture strategies that connect technical decisions to business outcomes.
        This calculator reflects practical FinOps implementation, multi-cloud design thinking, and research-backed cost modelling for grounded decision support.
      </p>
      <div class="cred-links">
        <a class="cred-link" href="https://www.linkedin.com/in/duksh/" target="_blank" rel="noopener noreferrer" aria-label="Open Duksh's LinkedIn profile in a new tab">LinkedIn · duksh</a>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta-band" aria-labelledby="cta-band-title" aria-describedby="cta-band-description cta-band-note">
    <div class="cta-shell">
      <h2 class="cta-title" id="cta-band-title">Choose your next step</h2>
      <p class="cta-sub" id="cta-band-description">Jump straight into the live FiceCal experience, or explore the MCP version if you want assistants and workflows to consume the same model programmatically.</p>
      <div class="cta-actions" role="group" aria-label="Primary call-to-action buttons">
        <button class="cta-btn" aria-describedby="cta-band-note" onclick="document.getElementById('calculator-section').scrollIntoView({behavior:'smooth', block:'start'})">Get Started — Open FiceCal</button>
        <button class="cta-btn cta-btn-secondary" type="button" data-mcp-open aria-haspopup="dialog" aria-controls="mcp-modal" aria-describedby="cta-band-note">Learn more about FiceCal MCP</button>
      </div>
      <p class="cta-note" id="cta-band-note">Need agent-ready workflows? The same calculator model is available as MCP tools that assistants can call directly.</p>
    </div>
  </section>

  <!-- MCP OVERVIEW -->
  <section class="mcp-section section-anchor" id="mcp-section" aria-labelledby="mcp-section-title">
    <div class="mcp-shell">
      <div class="mcp-head">
        <div>
          <div class="mcp-kicker">FiceCal MCP</div>
          <h2 class="mcp-title" id="mcp-section-title">Use this model from AI assistants, not just from the browser UI.</h2>
          <p class="mcp-subtitle">
            FiceCal is also available as a Model Context Protocol (MCP) server so teams can request break-even, health, AI token economics, and recommendation outputs programmatically from Cursor, Windsurf, Claude Desktop, and other MCP-capable tools.
          </p>
        </div>
        <div class="mcp-head-actions">
          <button class="mcp-chip-btn" type="button" data-mcp-open aria-haspopup="dialog" aria-controls="mcp-modal">Learn more</button>
          <a class="mcp-chip-link" href="https://github.com/duksh/finops-calculator-mcp" target="_blank" rel="noopener noreferrer">Open MCP Repo ↗</a>
        </div>
      </div>

      <div class="mcp-grid">
        <article class="mcp-card">
          <h3>Available tools</h3>
          <ul class="mcp-list">
            <li><code>finops.calculate</code> returns normalized inputs, outputs, health, and recommendations.</li>
            <li><code>finops.health</code> returns zone, score, and failed checks only.</li>
            <li><code>finops.recommend</code> returns prioritized actions by zone/provider.</li>
            <li><code>finops.state.encode</code> / <code>finops.state.decode</code> handles shareable state tokens.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>How to connect</h3>
          <ul class="mcp-list">
            <li>Clone the MCP repo and run <code>npm run check</code>, <code>npm run test</code>, and <code>npm run test:parity</code> in <code>server/</code>.</li>
            <li><code>test:parity</code> validates contract drift against the latest <code>finops-calculator</code> <code>main/index.html</code>.</li>
            <li>Register server command: <code>node .../server/index.js</code> in your MCP client config.</li>
            <li>Reload your assistant and verify all five FinOps tools appear.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>Best-fit use cases</h3>
          <ul class="mcp-list">
            <li>Turn pricing and cloud assumptions into quick scenario comparisons.</li>
            <li>Embed FinOps checks in architecture reviews and governance workflows.</li>
            <li>Generate recommendation summaries without re-entering calculator inputs.</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <!-- ROADMAP PROMO -->
  <section class="mcp-section section-anchor" id="roadmap-section" aria-labelledby="roadmap-section-title">
    <div class="mcp-shell">
      <div class="mcp-head">
        <div>
          <div class="mcp-kicker">Product Roadmap</div>
          <h2 class="mcp-title" id="roadmap-section-title">See what features are coming next for FiceCal.</h2>
          <p class="mcp-subtitle">
            Explore the public quarterly roadmap to understand upcoming capabilities across FinOps, ITAM, GreenOps,
            and AI economics, including how each release improves decision quality, governance, and execution speed.
          </p>
        </div>
        <div class="mcp-head-actions">
          <a class="mcp-chip-link" href="https://duksh.github.io/finops-roadmap.html" target="_blank" rel="noopener noreferrer">Open Public Roadmap ↗</a>
          <a class="mcp-chip-link" href="https://github.com/duksh/finops-calculator/blob/main/docs/roadmap/2026-roadmap.md" target="_blank" rel="noopener noreferrer">Open Detailed Plan ↗</a>
        </div>
      </div>

      <div class="mcp-grid">
        <article class="mcp-card">
          <h3>What you will find</h3>
          <ul class="mcp-list">
            <li>Quarter-by-quarter feature themes from model trust to enterprise readiness.</li>
            <li>Target outcomes tied to calculator accuracy, explainability, and operational impact.</li>
            <li>Milestone KPIs to track adoption, savings realization, and governance maturity.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>Why it matters</h3>
          <ul class="mcp-list">
            <li>Helps stakeholders align on what is shipping and why.</li>
            <li>Provides a transparent view of planned model and platform improvements.</li>
            <li>Connects roadmap priorities to measurable FinOps value delivery.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>How to use it</h3>
          <ul class="mcp-list">
            <li>Share the public page for quick executive and partner visibility.</li>
            <li>Use the detailed plan in GitHub for backlog and release management.</li>
            <li>Revisit each quarter to compare roadmap promises against delivered capabilities.</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <!-- MODEL ASSURANCE -->
  <section class="mcp-section section-anchor" id="model-assurance-section" aria-labelledby="model-assurance-title">
    <div class="mcp-shell">
      <div class="mcp-head">
        <div>
          <div class="mcp-kicker">Model Assurance</div>
          <h2 class="mcp-title" id="model-assurance-title">What changed in the model and how to validate it quickly</h2>
          <p class="mcp-subtitle">
            This section documents recent formula hardening decisions, expected behavior, and a fast verification flow.
            Use it as a CFO/FinOps quality gate before relying on outputs for pricing, budgeting, or board narrative.
          </p>
        </div>
        <div class="mcp-head-actions">
          <a class="mcp-chip-link" href="#calculator-section">Run live checks ↓</a>
          <a class="mcp-chip-link" href="docs/model-risk-and-validation.md" target="_blank" rel="noopener noreferrer">Open detailed notes ↗</a>
        </div>
      </div>

      <div class="mcp-grid">
        <article class="mcp-card">
          <h3>What was hardened</h3>
          <ul class="mcp-list">
            <li>Strategic ARPU guidance now compares <strong>€/client</strong> against <strong>€/client</strong> (unit-consistent floor).</li>
            <li>Recalculation now rebuilds the model from defaults each run, preventing stale state carry-over.</li>
            <li>Break-even and minimum unit cost now use a deterministic integer-range scan for consistency.</li>
            <li>CCER handles zero-infra scenarios as <code>∞</code> when revenue exists, without false penalty.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>2-minute validation run</h3>
          <ul class="mcp-list">
            <li><strong>CCER sanity:</strong> set ARPU &gt; 0 and Infra = 0, confirm CCER displays <code>∞</code>.</li>
            <li><strong>State reset:</strong> set Margin/CUD, then clear them and confirm outputs revert to defaults.</li>
            <li><strong>Recommendation units:</strong> in unhealthy demo, verify ARPU-gap advice is shown in <code>/client</code>.</li>
            <li><strong>Break-even stability:</strong> change <code>nMax</code> and confirm break-even remains stable.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>Interpretation guardrails</h3>
          <ul class="mcp-list">
            <li>Health score thresholds are policy heuristics, not statistically calibrated confidence estimates.</li>
            <li>Forecast spread represents deterministic scenario range, not a probabilistic confidence interval.</li>
            <li>CUD function assumes exponent adjustment; treat as a practical model assumption pending calibration.</li>
            <li>Use this calculator for decision support; validate major decisions with billing exports and cohort data.</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <!-- ═══ LIVE CALCULATOR ════════════════════════════════════════ -->
  <div class="calc-section section-anchor" id="calculator-section">
    <div class="calc-header" id="live-calculator">
      <div class="calc-title-row">
        <div class="calc-title-main">
          <div class="fig-label" style="margin-bottom:5px">⚙︎ Interactive Model — Live Parameter Calculator</div>
          <h2 class="calc-title">Enter what you know. I'll calculate the rest for you.</h2>
          <p class="calc-subtitle">Type in any business figure and the model instantly derives all other parameters and <strong>redraws the chart</strong>. Fields show <span class="badge-calc">calculated</span> when auto-derived from your inputs.</p>
          <div class="calc-context-flow">
            <div class="calc-release-note" role="note" aria-label="Current FiceCal capabilities and release update">
              <span class="calc-release-title">Current feature update</span>
              <span class="calc-release-text">FiceCal now covers 6 capability lanes: core unit economics, business-value forecasting, multi-tech normalization, AI token economics, Release 4 reliability economics, and health + recommendation guidance.</span>
              <a class="calc-release-link" href="https://data.finops.org" target="_blank" rel="noopener noreferrer" title="Open the State of FinOps 2026 report">FinOps 2026 ↗</a>
            </div>
            <div class="calc-r4-discovery" id="calc-r4-discovery" role="note" aria-label="Release 4 reliability economics overview" data-feature="sla-slo-sli-economics">
              <div class="calc-r4-discovery-title">
                <span class="calc-new-badge">New in R4</span>
                <span>SLA/SLO/SLI reliability economics now supports full downside-to-action decisioning.</span>
              </div>
              <p class="calc-r4-discovery-text">R4 adds 10 reliability inputs, 8 reliability output cards, 2 reliability-adjusted chart curves, and 2 reliability scenario demos (healthy + unhealthy) so teams can quantify resilience trade-offs before approving pricing, investment, or growth decisions.</p>
              <div class="calc-r4-discovery-actions">
                <button class="calc-action-btn calc-action-btn--demo-r4" type="button" onclick="focusReliabilityFeature()" aria-label="Open Release 4 reliability input lane">Open R4 reliability inputs</button>
                <button class="calc-action-btn calc-action-btn--neutral" type="button" onclick="focusScenarioDemos()" aria-label="Open scenario demo presets">Compare scenario demos</button>
              </div>
            </div>
          </div>
          <div class="calc-role-note" id="reliability-visibility-note" aria-live="polite"></div>
          <div class="share-feedback" id="share-feedback" aria-live="polite"></div>
        </div>
        <div class="calc-actions">
          <div class="calc-actions-row calc-actions-row--onboarding">
            <div class="calc-actions-hint" title="Three-step onboarding: pick role, provide core inputs, then review outcomes.">3 quick steps <span class="calc-inline-help calc-inline-help--hint" data-help="Three-step onboarding: pick role, provide core inputs, then review outcomes." aria-label="Help: quick-start checklist" tabindex="0" role="button">?</span></div>
            <div class="calc-onboarding-steps" id="calc-onboarding-steps" aria-label="Quick start steps">
              <div class="calc-onboarding-step is-active" data-onboarding-step="1" title="Step 1: choose the persona that best matches your decision context.">
                <span class="calc-onboarding-step-num">1</span>
                <span class="calc-onboarding-step-text" id="calc-step-role">Pick your role</span>
              </div>
              <div class="calc-onboarding-step" data-onboarding-step="2" title="Step 2: enter Infra Cost and ARPU to unlock core viability outputs.">
                <span class="calc-onboarding-step-num">2</span>
                <span class="calc-onboarding-step-text" id="calc-step-inputs">Fill Infra Cost + ARPU</span>
              </div>
              <div class="calc-onboarding-step" data-onboarding-step="3" title="Step 3: review health recommendations and take the first suggested action.">
                <span class="calc-onboarding-step-num">3</span>
                <span class="calc-onboarding-step-text" id="calc-step-outcomes">Review top 3 outcomes + action</span>
              </div>
            </div>
          </div>
          <div class="calc-actions-row calc-actions-row--persona">
            <div class="calc-intent-switch" id="calc-intent-switch" role="group" aria-label="Decision lens selector">
              <span class="calc-mode-label" title="Choose your decision lens to prioritize the most relevant KPIs and recommendations.">I am... <span class="calc-inline-help calc-inline-help--hint" data-help="Choose your decision lens to prioritize the most relevant KPIs and recommendations." aria-label="Help: decision lens selector" tabindex="0" role="button">?</span></span>
              <button type="button" class="calc-intent-btn" data-ui-intent-btn="viability" onclick="setUiIntent('viability')" aria-pressed="false">Finance</button>
              <button type="button" class="calc-intent-btn" data-ui-intent-btn="operations" onclick="setUiIntent('operations')" aria-pressed="false">Operations</button>
              <button type="button" class="calc-intent-btn" data-ui-intent-btn="architecture" onclick="setUiIntent('architecture')" aria-pressed="false">Architecture</button>
              <button type="button" class="calc-intent-btn" data-ui-intent-btn="executive" onclick="setUiIntent('executive')" aria-pressed="false">Executive</button>
            </div>
            <div class="calc-intent-summary" id="calc-intent-summary" title="Role-specific summary of what this profile optimizes first.">As Finance, prioritize break-even, minimum price, and contribution margin for a fast viability decision.</div>
          </div>
          <div class="calc-actions-row calc-actions-row--analysis">
            <div class="calc-next-step" id="calc-next-step">
              <div class="calc-next-step-title" title="Recommended next action to keep your guided workflow moving.">Do this next <span class="calc-inline-help calc-inline-help--hint" data-help="Recommended next action to keep your guided workflow moving." aria-label="Help: next recommended action" tabindex="0" role="button">?</span></div>
              <p class="calc-next-step-copy" id="calc-next-step-copy">Enter Total Infra Cost and ARPU to unlock your first finance-grade readout.</p>
              <div class="calc-next-step-links">
                <a class="calc-next-step-link calc-next-step-link--primary" id="calc-step2-cta" href="#field-infraTotal">Start Step 2</a>
              </div>
              <details class="calc-outcome-preview" id="calc-outcome-preview">
                <summary title="Preview of the first outcomes that become available for your selected role."><span class="calc-mode-label" id="calc-outcomes-label">Top outcomes preview</span></summary>
                <div class="calc-intent-outcomes-wrap" id="calc-intent-outcomes-wrap">
                  <div class="calc-intent-outcomes" id="calc-intent-outcomes" role="list" aria-label="Top outcomes preview"></div>
                </div>
              </details>
            </div>
            <details class="calc-disclosure intent-path-wrap" id="intent-path-wrap">
              <summary title="Expanded checklist for your selected role: steps move from to-do to active to done as inputs are completed.">
                Guided path <span class="calc-inline-help calc-inline-help--hint" data-help="Expanded checklist for your selected role: steps move from to-do to active to done as inputs are completed." aria-label="Help: guided path checklist" tabindex="0" role="button">?</span>
                <span class="intent-path-progress" id="intent-path-progress">0/3 steps complete</span>
              </summary>
              <div class="calc-disclosure-body">
                <div class="intent-path" id="intent-path" role="list" aria-label="Intent guided decision path"></div>
                <button class="calc-action-btn calc-action-btn--neutral intent-export-btn" id="intent-export-btn" type="button" onclick="exportIntentPreset()">Export intent preset</button>
              </div>
            </details>
          </div>
          <div class="calc-actions-row calc-actions-row--scenarios" id="calc-scenario-demos">
            <div class="calc-scenario-suite">
              <div class="calc-scenario-title" id="calc-scenario-title">Scenario demos (4 presets)</div>
              <p class="calc-scenario-copy" id="calc-scenario-copy">Load 1 of 4 curated states to compare baseline viability, downside stress, and Release 4 reliability healthy/unhealthy posture with the same model logic and outputs.</p>
              <div class="calc-scenario-actions" role="group" aria-label="Scenario demo presets">
                <div class="calc-scenario-item">
                  <button class="calc-action-btn calc-action-btn--demo-good" type="button" onclick="loadDemoScenario('healthy')" aria-label="Load Healthy preset">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1.5 6.5 4.5 9.5 10.5 2.5"/></svg>
                    Healthy
                  </button>
                  <span class="calc-scenario-meta">Core viability baseline</span>
                </div>
                <div class="calc-scenario-item">
                  <button class="calc-action-btn calc-action-btn--demo-bad" type="button" onclick="loadDemoScenario('unhealthy')" aria-label="Load Unhealthy preset">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M6 1.5 11 10.5H1z"/><path d="M6 4.2v2.8"/><circle cx="6" cy="8.9" r="0.2" fill="currentColor"/></svg>
                    Unhealthy
                  </button>
                  <span class="calc-scenario-meta">Core downside stress</span>
                </div>
                <div class="calc-scenario-item" data-feature="sla-slo-sli-economics" data-scenario-group="reliability">
                  <button class="calc-action-btn calc-action-btn--demo-good" type="button" onclick="loadDemoScenario('reliabilityHealthy')" aria-label="Load Reliability Healthy R4 preset">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1.5 6.5 4.5 9.5 10.5 2.5"/></svg>
                    Reliability Healthy (R4)
                  </button>
                  <span class="calc-scenario-meta">Reliability low-risk baseline</span>
                </div>
                <div class="calc-scenario-item" data-feature="sla-slo-sli-economics" data-scenario-group="reliability">
                  <button class="calc-action-btn calc-action-btn--demo-r4" type="button" onclick="loadDemoScenario('reliabilityUnhealthy')" aria-label="Load Reliability Unhealthy R4 preset">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1.5 6h9"/><path d="M6 1.5v9"/></svg>
                    Reliability Unhealthy (R4)
                  </button>
                  <span class="calc-scenario-meta">Reliability downside stress</span>
                </div>
              </div>
            </div>
          </div>
          <div class="calc-actions-row calc-actions-row--controls">
            <button class="share-btn calc-action-btn calc-action-btn--primary" id="share-state-btn" type="button" onclick="copyShareStateLink()" aria-label="Copy a shareable link with current calculator state" title="Copy a URL containing current inputs, role, mode, and selected controls.">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="4" width="7" height="7" rx="1"/><rect x="1" y="1" width="7" height="7" rx="1"/></svg>
              Copy state link
            </button>
          </div>
          <div class="calc-actions-row calc-actions-row--advanced">
            <details class="calc-disclosure" id="calc-more-actions">
              <summary title="Advanced controls for mode override, maintenance, and power-user actions.">Advanced tools <span class="calc-inline-help calc-inline-help--hint" data-help="Advanced controls for mode override, maintenance, and power-user actions." aria-label="Help: advanced tools" tabindex="0" role="button">?</span></summary>
              <div class="calc-disclosure-body">
                <div class="calc-advanced-wrap">
                  <div class="calc-mode-switch" id="calc-mode-switch" role="group" aria-label="Calculator interface mode selector">
                    <span class="calc-mode-label" title="Manually force UI depth: Quick for essentials, Operator for operational KPIs, or Architect for policy-heavy controls.">Mode override <span class="calc-inline-help calc-inline-help--hint" data-help="Manually force UI depth: Quick for essentials, Operator for operational KPIs, or Architect for policy-heavy controls." aria-label="Help: mode override options" tabindex="0" role="button">?</span></span>
                    <button type="button" class="calc-mode-btn" data-ui-mode-btn="quick" onclick="setUiMode('quick')" aria-pressed="false">Quick</button>
                    <button type="button" class="calc-mode-btn" data-ui-mode-btn="operator" onclick="setUiMode('operator')" aria-pressed="false">Operator</button>
                    <button type="button" class="calc-mode-btn" data-ui-mode-btn="architect" onclick="setUiMode('architect')" aria-pressed="false">Architect</button>
                  </div>
                  <div class="calc-feature-switch" id="calc-feature-switch" role="group" aria-label="Optional feature module controls">
                    <span class="calc-mode-label" title="Enable or disable optional FiceCal modules without editing files.">Feature controls <span class="calc-inline-help calc-inline-help--hint" data-help="Enable or disable optional FiceCal modules without editing files. Required modules stay locked on." aria-label="Help: feature controls" tabindex="0" role="button">?</span></span>
                    <div class="calc-feature-toggle-summary" id="calc-feature-toggle-summary">Loading feature controls…</div>
                    <div class="calc-feature-toggle-list" id="calc-feature-toggle-list"></div>
                    <button class="calc-action-btn calc-action-btn--neutral calc-feature-reset-btn" id="calc-feature-reset-btn" type="button" onclick="resetFeatureToggles()" hidden>Reset feature defaults</button>
                  </div>
                </div>
                <button class="feature-request-btn calc-action-btn calc-action-btn--warning" type="button" onclick="requestFeature('Calculator Section')" aria-label="Request a feature on Github">
                  Request a feature on Github
                </button>
                <button class="reset-btn calc-action-btn calc-action-btn--neutral" type="button" onclick="resetModel()">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 6A5 5 0 1 0 3 2.5"/><polyline points="1,1 1,4 4,4"/></svg>
                  Reset defaults
                </button>
              </div>
            </details>
          </div>
        </div>
      </div>
    </div>

    <div class="calc-body">
        <!-- ── GROUP A ──────────────────────────────────────────── -->

      <!-- ── GROUP A ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num">A</span>
          <span class="calc-group-label">Your Current Business Snapshot</span>
          <span class="calc-group-hint">Start here — enter what you already know</span>
        </div>
        <div class="calc-fields">

          <div class="calc-field" id="field-nRef">
            <label class="calc-label" for="inp-nRef">
              Current Client Count
              <span class="ftag">reference&nbsp;n</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-nRef" inputmode="numeric" min="1" max="100000" step="1" placeholder="e.g. 100" oninput="onInput('nRef')">
              <span class="calc-unit">clients</span>
            </div>
            <div class="calc-hint">How many clients right now? All curves calibrate from this point.</div>
          </div>

          <div class="calc-field" id="field-currency">
            <label class="calc-label" for="inp-currency">
              Currency
              <span class="ftag">display</span>
            </label>
            <div class="calc-input-wrap">
              <select id="inp-currency" data-default-value="EUR" onchange="onInput('currency')">
                <option value="EUR" selected>EUR (€)</option>
                <option value="GBP">GBP (£)</option>
                <option value="USD">USD ($)</option>
              </select>
            </div>
            <div class="calc-hint">Display currency for financial inputs/outputs (values are not FX-converted).</div>
          </div>

          <div class="calc-field" id="field-devPerClient">
            <label class="calc-label" for="inp-devPerClient">
              Dev Cost (Monthly @ n)
              <span class="ftag" style="color:var(--dev);border-color:var(--dev);background:rgba(213,94,0,0.06)">● orange curve</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-devPerClient" inputmode="decimal" min="0" step="1" placeholder="e.g. 500" oninput="onInput('devPerClient')">
              <span class="calc-unit">€ / month</span>
            </div>
            <div class="calc-hint">Your amortized monthly development burden at reference n. Derives <strong>K</strong> for the dev cost decay curve.</div>
          </div>

          <div class="calc-field" id="field-infraTotal">
            <label class="calc-label" for="inp-infraTotal">
              Total Infra Cost
              <span class="ftag" style="color:var(--infra-raw);border-color:var(--infra-raw);background:rgba(0,158,115,0.06)">● green curve</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-infraTotal" inputmode="decimal" min="0" step="1" placeholder="e.g. 2400" oninput="onInput('infraTotal')">
              <span class="calc-unit">€ / month</span>
            </div>
            <div class="calc-hint">Your current total cloud bill at n. Derives <strong>c</strong> (infra base coefficient).</div>
          </div>

          <div class="calc-field" id="field-ARPU">
            <label class="calc-label" for="inp-ARPU">
              Revenue / Client (ARPU)
              <span class="ftag" style="color:var(--revenue);border-color:var(--revenue);background:rgba(0,114,178,0.06)">● blue line</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-ARPU" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 30" oninput="onInput('ARPU')">
              <span class="calc-unit">€ / client</span>
            </div>
            <div class="calc-hint">Average monthly revenue per client. If unknown, leave blank and use Startup Planning below.</div>
          </div>

          <div class="calc-field" id="field-techDomain" data-feature="multi-tech-normalization" data-ui-mode="operator architect">
            <label class="calc-label" for="inp-techDomains">
              Technology Domains in Scope
              <span class="ftag">R2 wave 1</span>
              <a class="calc-inline-help" href="#formulas-section" title="Select one or more domains. Formula, references, and weighting policy are in Core FinOps Equations.">?</a>
            </label>
            <input type="hidden" id="inp-techDomains" value="cloud" data-default-value="cloud">
            <div class="tech-domain-controls" id="tech-domain-controls" role="group" aria-label="Select one or more technology domains">
              <button type="button" class="tech-domain-chip selected" data-domain="cloud" aria-pressed="true" onclick="toggleTechDomain('cloud')">Cloud</button>
              <button type="button" class="tech-domain-chip" data-domain="saas" aria-pressed="false" onclick="toggleTechDomain('saas')">SaaS</button>
              <button type="button" class="tech-domain-chip" data-domain="licensing" aria-pressed="false" onclick="toggleTechDomain('licensing')">Licensing</button>
              <button type="button" class="tech-domain-chip" data-domain="private-cloud" aria-pressed="false" onclick="toggleTechDomain('private-cloud')">Private Cloud</button>
              <button type="button" class="tech-domain-chip" data-domain="data-center" aria-pressed="false" onclick="toggleTechDomain('data-center')">Data Center</button>
              <button type="button" class="tech-domain-chip" data-domain="labor" aria-pressed="false" onclick="toggleTechDomain('labor')">Labor</button>
            </div>
            <div class="tech-domain-actions">
              <button type="button" class="tech-domain-link-btn" onclick="setTechDomainPreset('all')">Select all domains</button>
              <button type="button" class="tech-domain-link-btn" onclick="setTechDomainPreset('cloud-only')">Cloud only</button>
            </div>
            <div class="calc-hint">Choose one domain (single-focus mode) or multiple domains (portfolio mode). See Core FinOps Equations for the normalization formula.</div>
          </div>

        </div>

        <div class="startup-planner">
          <div class="startup-title">Startup planning mode (if ARPU is unknown) — fill either option</div>
          <div class="startup-help">
            <div class="startup-help-title">How to use (new entrepreneur)</div>
            <ul class="startup-help-list">
              <li><strong>Option A:</strong> enter a realistic market price to estimate how many clients you need.</li>
              <li><strong>Option B:</strong> enter your acquisition target to estimate the minimum price per client.</li>
              <li>You can fill both options to compare scenarios and set a safer revenue target.</li>
            </ul>
          </div>
          <div class="startup-grid">
            <div class="startup-field" id="field-startupTargetPrice">
              <label class="calc-label" for="inp-startupTargetPrice">
                Option A — Target Price / Client
                <span class="ftag" style="color:#0072b2;border-color:#0072b2;background:rgba(0,114,178,0.06)">price-first</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-startupTargetPrice" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 35" oninput="onInput('startupTargetPrice')">
                <span class="calc-unit">€ / client</span>
              </div>
              <div class="calc-hint">If you know what the market can pay, we estimate how many clients you need to hit profitability.</div>
            </div>

            <div class="startup-field" id="field-startupTargetClients">
              <label class="calc-label" for="inp-startupTargetClients">
                Option B — Target Clients
                <span class="ftag" style="color:#009e73;border-color:#009e73;background:rgba(0,158,115,0.06)">clients-first</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-startupTargetClients" inputmode="numeric" min="1" step="1" placeholder="e.g. 80" oninput="onInput('startupTargetClients')">
                <span class="calc-unit">clients</span>
              </div>
              <div class="calc-hint">If you know your acquisition target, we estimate the minimum viable price and monthly revenue target.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── GROUP B ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#888">B</span>
          <span class="calc-group-label">Optional — Fine-Tune the Model</span>
          <span class="calc-group-hint">Leave blank to use smart defaults</span>
          <div class="fine-tune-area-indicators" aria-label="Section B fine-tuning areas">
            <button type="button" class="fine-tune-area-chip" data-area-key="value" onclick="jumpToFineTuneArea('value')" aria-label="Jump to Area 1: Quantify business value controls"><span class="fine-tune-area-chip-num">1</span>Value controls</button>
            <button type="button" class="fine-tune-area-chip" data-area-key="multi" data-feature-id="multi-tech-normalization" onclick="jumpToFineTuneArea('multi')" aria-label="Jump to Area 2: Multi-technology overlay"><span class="fine-tune-area-chip-num">2</span>Multi-tech overlay</button>
            <button type="button" class="fine-tune-area-chip" data-area-key="ai" data-feature-id="ai-token-economics" onclick="jumpToFineTuneArea('ai')" aria-label="Jump to Area 3: AI token economics"><span class="fine-tune-area-chip-num">3</span>AI token economics</button>
            <button type="button" class="fine-tune-area-chip" data-area-key="reliability" data-feature-id="sla-slo-sli-economics" onclick="jumpToFineTuneArea('reliability')" aria-label="Jump to Area 4: Reliability economics"><span class="fine-tune-area-chip-num">4</span>Reliability economics</button>
          </div>
        </div>
        <div class="calc-fields">

          <div class="calc-field" id="field-cudPct">
            <label class="calc-label" for="inp-cudPct">
              CUD Discount
              <span class="ftag" style="color:var(--infra-cud);border-color:var(--infra-cud);background:rgba(0,158,115,0.08)">-- dashed green</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-cudPct" inputmode="numeric" min="0" max="100" step="1" placeholder="32" oninput="onInput('cudPct')">
              <span class="calc-unit">%</span>
            </div>
            <div class="calc-hint">Your CUD / Savings Plan rate. Default: 32%. GCP typically 20–55%.</div>
          </div>

          <div class="calc-field" id="field-margin">
            <label class="calc-label" for="inp-margin">
              Target Margin
              <span class="ftag">min price line</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-margin" inputmode="numeric" min="0" max="100" step="1" placeholder="15" oninput="onInput('margin')">
              <span class="calc-unit">%</span>
            </div>
            <div class="calc-hint">Profit margin above cost recovery per client. Default: 15%.</div>
          </div>

          <div class="calc-field" id="field-nMax">
            <label class="calc-label" for="inp-nMax">
              Chart Scale (max n)
              <span class="ftag">x-axis</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-nMax" inputmode="numeric" min="10" max="100000" step="10" placeholder="1000" oninput="onInput('nMax')">
              <span class="calc-unit">clients</span>
            </div>
            <div class="calc-hint">Max clients on the x-axis. Zoom out for large-scale projections.</div>
          </div>

        </div>

        <div class="value-overlay" id="fine-tune-value-controls" data-ui-mode="operator architect">
          <div class="startup-title"><span class="fine-tune-area-seq" aria-hidden="true">1</span>Quantify business value controls<span class="finops-2026-pill">Forecasting · Budgeting · Realization</span></div>
          <div class="calc-fields">
            <div class="calc-field" id="field-budgetMonthly">
              <label class="calc-label" for="inp-budgetMonthly">
                Monthly Technology Budget
                <span class="ftag">budgeting</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-budgetMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 4500" oninput="onInput('budgetMonthly')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Compare modeled monthly cost against approved budget to track overrun risk early.</div>
            </div>

            <div class="calc-field" id="field-forecastGrowthPct">
              <label class="calc-label" for="inp-forecastGrowthPct">
                Forecast Client Growth
                <span class="ftag">planning</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-forecastGrowthPct" inputmode="decimal" min="-95" max="500" step="0.1" placeholder="e.g. 12" oninput="onInput('forecastGrowthPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Expected client growth for the next planning cycle (baseline scenario).</div>
            </div>

            <div class="calc-field" id="field-forecastBestEfficiencyPct">
              <label class="calc-label" for="inp-forecastBestEfficiencyPct">
                Best-case Cost Efficiency
                <span class="ftag">scenario</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-forecastBestEfficiencyPct" inputmode="decimal" min="0" max="95" step="0.1" placeholder="e.g. 8" oninput="onInput('forecastBestEfficiencyPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Potential cost-down from optimization execution in a positive scenario.</div>
            </div>

            <div class="calc-field" id="field-forecastWorstDriftPct">
              <label class="calc-label" for="inp-forecastWorstDriftPct">
                Worst-case Cost Drift
                <span class="ftag">scenario</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-forecastWorstDriftPct" inputmode="decimal" min="0" max="200" step="0.1" placeholder="e.g. 12" oninput="onInput('forecastWorstDriftPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Potential cost-up pressure from demand spikes, creep, or execution delay.</div>
            </div>

            <div class="calc-field" id="field-savingsIdentified">
              <label class="calc-label" for="inp-savingsIdentified">
                Identified Savings Target
                <span class="ftag">ledger</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-savingsIdentified" inputmode="decimal" min="0" step="1" placeholder="e.g. 1200" oninput="onInput('savingsIdentified')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Savings opportunity identified in planning and optimization backlog.</div>
            </div>

            <div class="calc-field" id="field-savingsRealized">
              <label class="calc-label" for="inp-savingsRealized">
                Realized Savings
                <span class="ftag">ledger</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-savingsRealized" inputmode="decimal" min="0" step="1" placeholder="e.g. 700" oninput="onInput('savingsRealized')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Savings already captured and verified from delivered actions.</div>
            </div>

            <div class="calc-field" id="field-costAvoidance">
              <label class="calc-label" for="inp-costAvoidance">
                Cost Avoidance
                <span class="ftag">shift-left</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costAvoidance" inputmode="decimal" min="0" step="1" placeholder="e.g. 300" oninput="onInput('costAvoidance')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Cost prevented before spend landed (architecture/design/governance actions).</div>
            </div>
          </div>
          <div class="portfolio-guardrail value-guardrail" id="value-guardrail">Set budget and at least one forecasting or realization input to activate Quantify Business Value controls.</div>
        </div>

        <div class="portfolio-overlay finops-2026-highlight" id="fine-tune-multi-tech" data-feature="multi-tech-normalization" data-ui-mode="operator architect">
          <div class="startup-title"><span class="fine-tune-area-seq" aria-hidden="true">2</span>Multi-technology spend overlay (FOCUS-aligned normalization)<span class="finops-2026-pill">State of FinOps 2026 aligned</span></div>
          <div class="calc-fields">
            <div class="calc-field" id="field-costSaaS">
              <label class="calc-label" for="inp-costSaaS">
                SaaS Monthly Cost
                <span class="ftag">focus: saas</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costSaaS" inputmode="decimal" min="0" step="1" placeholder="e.g. 600" oninput="onInput('costSaaS')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Optional spend outside core cloud bill. Supports wider FinOps scope beyond IaaS/PaaS.</div>
            </div>

            <div class="calc-field" id="field-costLicensing">
              <label class="calc-label" for="inp-costLicensing">
                Licensing Monthly Cost
                <span class="ftag">focus: licensing</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costLicensing" inputmode="decimal" min="0" step="1" placeholder="e.g. 300" oninput="onInput('costLicensing')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Include software license/subscription commitments tied to this service line.</div>
            </div>

            <div class="calc-field" id="field-costPrivateCloud">
              <label class="calc-label" for="inp-costPrivateCloud">
                Private Cloud Monthly Cost
                <span class="ftag">focus: private</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costPrivateCloud" inputmode="decimal" min="0" step="1" placeholder="e.g. 900" oninput="onInput('costPrivateCloud')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Use when part of the workload is delivered through internal or hosted private cloud platforms.</div>
            </div>

            <div class="calc-field" id="field-costDataCenter">
              <label class="calc-label" for="inp-costDataCenter">
                Data Center Monthly Cost
                <span class="ftag">focus: dc</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costDataCenter" inputmode="decimal" min="0" step="1" placeholder="e.g. 500" oninput="onInput('costDataCenter')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Add colocation, rack, or facility-backed infrastructure costs related to this service.</div>
            </div>

            <div class="calc-field" id="field-costLabor">
              <label class="calc-label" for="inp-costLabor">
                Labor Monthly Cost
                <span class="ftag">focus: labor</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-costLabor" inputmode="decimal" min="0" step="1" placeholder="e.g. 1200" oninput="onInput('costLabor')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Optional FinOps extension to estimate total technology value pressure, not only platform spend.</div>
            </div>
          </div>
          <div class="portfolio-guardrail" id="portfolio-guardrail">Add at least one non-cloud domain cost to activate multi-technology normalization insights.</div>
          <div class="portfolio-report-note"><a href="https://data.finops.org" target="_blank" rel="noopener noreferrer" title="Open the online State of FinOps 2026 report">Why this matters in State of FinOps 2026 ↗</a></div>
        </div>

        <div class="portfolio-overlay ai-token-overlay" id="fine-tune-ai-token" data-feature="ai-token-economics" data-ui-mode="operator architect">
          <div class="startup-title"><span class="fine-tune-area-seq" aria-hidden="true">3</span>AI token economics (Wave 3 MVP)<span class="finops-2026-pill">Operator + Architect modes</span></div>
          <div class="ai-preset-actions">
            <button type="button" class="ai-preset-btn" onclick="applyAiTokenPreset('balanced')">Balanced AI mix</button>
            <button type="button" class="ai-preset-btn" onclick="applyAiTokenPreset('premiumSpike')">Premium routing spike</button>
            <button type="button" class="ai-preset-btn" onclick="applyAiTokenPreset('retryStorm')">Retry storm</button>
          </div>
          <div class="calc-fields">
            <div class="calc-field" id="field-aiEnabled">
              <label class="calc-label" for="inp-aiEnabled">
                AI Cost Tracking
                <span class="ftag">toggle</span>
              </label>
              <div class="calc-input-wrap">
                <select id="inp-aiEnabled" data-default-value="off" onchange="onInput('aiEnabled')">
                  <option value="off" selected>Off</option>
                  <option value="on">On</option>
                </select>
              </div>
              <div class="calc-hint">Enable AI token economics to include inference spend and allocation pressure in KPIs.</div>
            </div>

            <div class="calc-field" id="field-aiPricingMode">
              <label class="calc-label" for="inp-aiPricingMode">
                Pricing Mode
                <span class="ftag">model</span>
              </label>
              <div class="calc-input-wrap">
                <select id="inp-aiPricingMode" data-default-value="blended" onchange="onInput('aiPricingMode')">
                  <option value="blended" selected>Blended (single rate)</option>
                  <option value="tiered">Tiered (input/output split)</option>
                </select>
              </div>
              <div class="calc-hint">Blended uses a single per-1M rate. Tiered separates input and output token rates.</div>
            </div>

            <div class="calc-field" id="field-aiRatePer1MInput">
              <label class="calc-label" for="inp-aiRatePer1MInput">
                Input Token Rate
                <span class="ftag">tiered</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiRatePer1MInput" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 3" oninput="onInput('aiRatePer1MInput')">
                <span class="calc-unit">€ / 1M</span>
              </div>
              <div class="calc-hint">Used when pricing mode is Tiered.</div>
            </div>

            <div class="calc-field" id="field-aiRatePer1MOutput">
              <label class="calc-label" for="inp-aiRatePer1MOutput">
                Output Token Rate
                <span class="ftag">tiered</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiRatePer1MOutput" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 9" oninput="onInput('aiRatePer1MOutput')">
                <span class="calc-unit">€ / 1M</span>
              </div>
              <div class="calc-hint">Used when pricing mode is Tiered.</div>
            </div>

            <div class="calc-field" id="field-aiRatePer1MTotal">
              <label class="calc-label" for="inp-aiRatePer1MTotal">
                Blended Token Rate
                <span class="ftag">blended</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiRatePer1MTotal" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 6" oninput="onInput('aiRatePer1MTotal')">
                <span class="calc-unit">€ / 1M</span>
              </div>
              <div class="calc-hint">Used when pricing mode is Blended. If empty, weighted fallback from input/output rates is used.</div>
            </div>

            <div class="calc-field" id="field-aiInputTokensM">
              <label class="calc-label" for="inp-aiInputTokensM">
                Input Tokens / Month
                <span class="ftag">volume</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiInputTokensM" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 12" oninput="onInput('aiInputTokensM')">
                <span class="calc-unit">M tokens</span>
              </div>
              <div class="calc-hint">Monthly prompt-side token volume.</div>
            </div>

            <div class="calc-field" id="field-aiOutputTokensM">
              <label class="calc-label" for="inp-aiOutputTokensM">
                Output Tokens / Month
                <span class="ftag">volume</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiOutputTokensM" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 8" oninput="onInput('aiOutputTokensM')">
                <span class="calc-unit">M tokens</span>
              </div>
              <div class="calc-hint">Monthly completion-side token volume.</div>
            </div>

            <div class="calc-field" id="field-aiRetryRatePct">
              <label class="calc-label" for="inp-aiRetryRatePct">
                Retry Rate
                <span class="ftag">quality</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiRetryRatePct" inputmode="decimal" min="0" max="100" step="0.1" placeholder="e.g. 8" oninput="onInput('aiRetryRatePct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Additional token demand caused by retries / re-prompts.</div>
            </div>

            <div class="calc-field" id="field-aiPremiumMixPct">
              <label class="calc-label" for="inp-aiPremiumMixPct">
                Premium Model Mix
                <span class="ftag">routing</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiPremiumMixPct" inputmode="decimal" min="0" max="100" step="0.1" placeholder="e.g. 20" oninput="onInput('aiPremiumMixPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Share of traffic routed to premium model tier.</div>
            </div>

            <div class="calc-field" id="field-aiSharedOverheadMonthly">
              <label class="calc-label" for="inp-aiSharedOverheadMonthly">
                Shared AI Overhead
                <span class="ftag">allocation</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-aiSharedOverheadMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 1200" oninput="onInput('aiSharedOverheadMonthly')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Common AI platform costs allocated on top of token spend.</div>
            </div>

            <div class="calc-field" id="field-aiAllocationPolicy">
              <label class="calc-label" for="inp-aiAllocationPolicy">
                Allocation Policy
                <span class="ftag">governance</span>
              </label>
              <div class="calc-input-wrap">
                <select id="inp-aiAllocationPolicy" data-default-value="token-weighted" onchange="onInput('aiAllocationPolicy')">
                  <option value="token-weighted" selected>Token-weighted</option>
                  <option value="equal">Equal split</option>
                  <option value="premium-weighted">Premium-weighted</option>
                </select>
              </div>
              <div class="calc-hint">MVP allocation model selector for showback/chargeback strategy.</div>
            </div>
          </div>
          <div class="portfolio-guardrail" id="ai-token-guardrail">AI token economics remains inactive until AI Cost Tracking is set to On and token/rate inputs are provided.</div>
        </div>

        <div class="portfolio-overlay reliability-overlay" id="fine-tune-reliability" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
          <div class="startup-title"><span class="fine-tune-area-seq" aria-hidden="true">4</span>SLA/SLO/SLI reliability economics (Release 4 scaffold)<span class="calc-new-badge calc-new-badge--inline">NEW</span><span class="finops-2026-pill">Operator &amp; Architect</span></div>
          <details class="reliability-explainer" open>
            <summary>What Release 4 adds and how it is modeled</summary>
            <div class="reliability-explainer-body">Release 4 reliability includes <strong>10 reliability inputs</strong>, <strong>8 reliability output cards</strong>, and <strong>2 chart overlays</strong> (Total Cost + Reliability, Profit + Reliability). The model combines four downside lanes (SLA penalties, incident labor, downtime revenue loss, churn-risk expectation), then computes reliability-adjusted cost, reliability-adjusted profit/loss, ARPU uplift needed, and extra clients needed at current ARPU. This helps teams choose between resilience investment, pricing changes, or additional client growth with a quantified trade-off view.</div>
          </details>
          <div class="calc-fields">
            <div class="calc-field" id="field-reliabilityEnabled">
              <label class="calc-label" for="inp-reliabilityEnabled">
                Reliability Economics
                <span class="ftag">toggle</span>
              </label>
              <div class="calc-input-wrap">
                <select id="inp-reliabilityEnabled" data-default-value="off" onchange="onInput('reliabilityEnabled')">
                  <option value="off" selected>Off</option>
                  <option value="on">On</option>
                </select>
              </div>
              <div class="calc-hint">Enable reliability economics to estimate SLA penalties, incident losses, and risk-adjusted cost pressure.</div>
            </div>

            <div class="calc-field" id="field-sloTargetAvailabilityPct">
              <label class="calc-label" for="inp-sloTargetAvailabilityPct">
                SLO Target Availability
                <span class="ftag">policy</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-sloTargetAvailabilityPct" inputmode="decimal" min="90" max="100" step="0.001" placeholder="e.g. 99.90" oninput="onInput('sloTargetAvailabilityPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Your target reliability policy threshold used for breach-gap and penalty modeling.</div>
            </div>

            <div class="calc-field" id="field-sliObservedAvailabilityPct">
              <label class="calc-label" for="inp-sliObservedAvailabilityPct">
                Observed SLI Availability
                <span class="ftag">observed</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-sliObservedAvailabilityPct" inputmode="decimal" min="90" max="100" step="0.001" placeholder="e.g. 99.70" oninput="onInput('sliObservedAvailabilityPct')">
                <span class="calc-unit">%</span>
              </div>
              <div class="calc-hint">Measured availability from production telemetry for the modeled service period.</div>
            </div>

            <div class="calc-field" id="field-incidentCountMonthly">
              <label class="calc-label" for="inp-incidentCountMonthly">
                Incidents / Month
                <span class="ftag">ops</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-incidentCountMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 4" oninput="onInput('incidentCountMonthly')">
                <span class="calc-unit">count</span>
              </div>
              <div class="calc-hint">Average monthly production incidents relevant to this service's SLA obligations.</div>
            </div>

            <div class="calc-field" id="field-mttrHours">
              <label class="calc-label" for="inp-mttrHours">
                MTTR
                <span class="ftag">ops</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-mttrHours" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 1.5" oninput="onInput('mttrHours')">
                <span class="calc-unit">hours</span>
              </div>
              <div class="calc-hint">Mean time to recover per incident used to estimate labor and downtime-driven exposure.</div>
            </div>

            <div class="calc-field" id="field-incidentBlendedHourlyRate">
              <label class="calc-label" for="inp-incidentBlendedHourlyRate">
                Incident Team Blended Rate
                <span class="ftag">labor</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-incidentBlendedHourlyRate" inputmode="decimal" min="0" step="1" placeholder="e.g. 95" oninput="onInput('incidentBlendedHourlyRate')">
                <span class="calc-unit">€ / hour</span>
              </div>
              <div class="calc-hint">Blended hourly cost of incident responders participating in major/minor incident recovery.</div>
            </div>

            <div class="calc-field" id="field-criticalRevenuePerMinute">
              <label class="calc-label" for="inp-criticalRevenuePerMinute">
                Critical Revenue at Risk
                <span class="ftag">revenue</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-criticalRevenuePerMinute" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 35" oninput="onInput('criticalRevenuePerMinute')">
                <span class="calc-unit">€ / minute</span>
              </div>
              <div class="calc-hint">Revenue exposure per critical minute used for outage loss estimation.</div>
            </div>

            <div class="calc-field" id="field-arrExposedMonthly">
              <label class="calc-label" for="inp-arrExposedMonthly">
                ARR Exposed (Monthly)
                <span class="ftag">retention</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-arrExposedMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 120000" oninput="onInput('arrExposedMonthly')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Revenue base at retention risk if reliability misses persist.</div>
            </div>

            <div class="calc-field" id="field-slaPenaltyRatePerBreachPointMonthly">
              <label class="calc-label" for="inp-slaPenaltyRatePerBreachPointMonthly">
                SLA Penalty Rate
                <span class="ftag">contract</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-slaPenaltyRatePerBreachPointMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 6000" oninput="onInput('slaPenaltyRatePerBreachPointMonthly')">
                <span class="calc-unit">€ / breach-pt</span>
              </div>
              <div class="calc-hint">Penalty cost per availability percentage point below target for monthly estimation.</div>
            </div>

            <div class="calc-field" id="field-reliabilityInvestmentMonthly">
              <label class="calc-label" for="inp-reliabilityInvestmentMonthly">
                Reliability Investment
                <span class="ftag">preventive</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-reliabilityInvestmentMonthly" inputmode="decimal" min="0" step="1" placeholder="e.g. 2500" oninput="onInput('reliabilityInvestmentMonthly')">
                <span class="calc-unit">€ / month</span>
              </div>
              <div class="calc-hint">Planned monthly spend for resilience controls (redundancy, observability, on-call readiness, validation).</div>
            </div>
          </div>
          <div class="portfolio-guardrail" id="reliability-guardrail">Reliability economics remains inactive until enabled with SLO/SLI and incident context inputs.</div>
        </div>
      </div>

      <!-- ── GROUP C ──────────────────────────────────────────── -->
      <div class="calc-group finops-2026-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#009e73">C</span>
          <span class="calc-group-label">Auto-Calculated Results</span>
          <span class="calc-group-hint">Updates instantly as you type</span>
          <span class="finops-2026-pill">State of FinOps 2026 aligned outputs</span>
        </div>

        <div class="intent-kpi-helper" id="intent-kpi-helper">Intent profile prioritization is active for KPI output ordering.</div>
        <div class="calc-severity-helper" id="calc-severity-helper"><strong>Severity order:</strong> Critical → High → Needs data → Low. Severity is computed from each card's current status thresholds.</div>

        <div class="calc-outputs" id="calc-kpi-output-grid">

          <div class="calc-out-card" id="out-beN">
            <div class="calc-out-label">Break-Even Clients</div>
            <div class="calc-out-val muted" id="oval-beN">—</div>
            <div class="calc-out-sub">Minimum clients to cover all costs</div>
          </div>

          <div class="calc-out-card" id="out-minPrice">
            <div class="calc-out-label">Min. Price / Client</div>
            <div class="calc-out-val muted" id="oval-minPrice">—</div>
            <div class="calc-out-sub">Floor price at your current n</div>
          </div>

          <div class="calc-out-card" id="out-vcpu">
            <div class="calc-out-label">VCPU at n</div>
            <div class="calc-out-val muted" id="oval-vcpu">—</div>
            <div class="calc-out-sub">Variable Cost Per User (infra ÷ n)</div>
          </div>

          <div class="calc-out-card" id="out-margin">
            <div class="calc-out-label">Contribution Margin</div>
            <div class="calc-out-val muted" id="oval-margin">—</div>
            <div class="calc-out-sub">ARPU − VCPU per client</div>
          </div>

          <div class="calc-out-card" id="out-ccer">
            <div class="calc-out-label">CCER at n</div>
            <div class="calc-out-val muted" id="oval-ccer">—</div>
            <div class="calc-out-sub">Revenue ÷ Cloud Spend (target &gt; 3×)</div>
          </div>

          <div class="calc-out-card" id="out-cudSave">
            <div class="calc-out-label">CUD Monthly Saving</div>
            <div class="calc-out-val muted" id="oval-cudSave">—</div>
            <div class="calc-out-sub">On-demand vs committed at n</div>
          </div>

          <div class="calc-out-card" id="out-reqClients">
            <div class="calc-out-label">Required Clients @ Target Price</div>
            <div class="calc-out-val muted" id="oval-reqClients">—</div>
            <div class="calc-out-sub">Use Option A to estimate client volume needed for profitability</div>
          </div>

          <div class="calc-out-card" id="out-reqPrice">
            <div class="calc-out-label">Required Price @ Target Clients</div>
            <div class="calc-out-val muted" id="oval-reqPrice">—</div>
            <div class="calc-out-sub">Use Option B to estimate minimum price per client</div>
          </div>

          <div class="calc-out-card" id="out-targetRevenue">
            <div class="calc-out-label">Target Monthly Revenue</div>
            <div class="calc-out-val muted" id="oval-targetRevenue">—</div>
            <div class="calc-out-sub">Revenue level implied by your startup planning assumptions</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-budgetVariance" data-ui-mode="operator architect">
            <div class="calc-out-label">Budget Variance</div>
            <div class="calc-out-val muted" id="oval-budgetVariance">—</div>
            <div class="calc-out-sub">Headroom or overrun versus monthly technology budget</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-forecastBand" data-ui-mode="operator architect">
            <div class="calc-out-label">Forecast Margin Band</div>
            <div class="calc-out-val muted" id="oval-forecastBand">—</div>
            <div class="calc-out-sub">Baseline, best, and worst monthly margin for next cycle</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-forecastSpread" data-ui-mode="operator architect">
            <div class="calc-out-label">Forecast Confidence Band</div>
            <div class="calc-out-val muted" id="oval-forecastSpread">—</div>
            <div class="calc-out-sub">Spread width between best and worst scenarios (narrower is stronger)</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-realizedValue" data-ui-mode="operator architect">
            <div class="calc-out-label">Total Realized Value</div>
            <div class="calc-out-val muted" id="oval-realizedValue">—</div>
            <div class="calc-out-sub">Realized savings plus cost avoidance captured this cycle</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-realizationRatio" data-ui-mode="operator architect">
            <div class="calc-out-label">Savings Realization Ratio</div>
            <div class="calc-out-val muted" id="oval-realizationRatio">—</div>
            <div class="calc-out-sub">Total realized value divided by identified savings target</div>
          </div>

          <div class="calc-out-card qbv-card" id="out-realizationGap" data-ui-mode="operator architect">
            <div class="calc-out-label">Residual Value Gap</div>
            <div class="calc-out-val muted" id="oval-realizationGap">—</div>
            <div class="calc-out-sub">Remaining value to realize (or exceeded target)</div>
          </div>

          <div class="calc-out-card finops-2026-card" id="out-techCoverage" data-feature="multi-tech-normalization" data-ui-mode="operator architect">
            <div class="calc-out-label">Coverage Across Domains</div>
            <div class="calc-out-val muted" id="oval-techCoverage">—</div>
            <div class="calc-out-sub">Coverage inside your selected scope (single or multi-domain)</div>
          </div>

          <div class="calc-out-card finops-2026-card" id="out-techNorm" data-feature="multi-tech-normalization" data-ui-mode="operator architect">
            <div class="calc-out-label">Normalized Tech Cost / Client</div>
            <div class="calc-out-val muted" id="oval-techNorm">—</div>
            <div class="calc-out-sub">Scoped cost aggregation normalized per client using selected domains</div>
          </div>

          <div class="calc-out-card finops-2026-card" id="out-focusMaturity" data-feature="multi-tech-normalization" data-ui-mode="operator architect">
            <div class="calc-out-label">Normalization Confidence</div>
            <div class="calc-out-val muted" id="oval-focusMaturity">—</div>
            <div class="calc-out-sub">Confidence based on selected-domain completeness and input quality</div>
          </div>

          <div class="calc-out-card ai-token-card" id="out-aiTokenCost" data-feature="ai-token-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">AI Token Cost</div>
            <div class="calc-out-val muted" id="oval-aiTokenCost">—</div>
            <div class="calc-out-sub">Inference token spend after retry/premium behavior adjustments</div>
          </div>

          <div class="calc-out-card ai-token-card" id="out-aiAllocatedCost" data-feature="ai-token-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">AI Total Allocated Cost</div>
            <div class="calc-out-val muted" id="oval-aiAllocatedCost">—</div>
            <div class="calc-out-sub">Token spend plus shared AI overhead allocation</div>
          </div>

          <div class="calc-out-card ai-token-card" id="out-aiCostPerClient" data-feature="ai-token-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">AI Cost / Client</div>
            <div class="calc-out-val muted" id="oval-aiCostPerClient">—</div>
            <div class="calc-out-sub">Allocated AI monthly cost divided by active clients</div>
          </div>

          <div class="calc-out-card ai-token-card" id="out-aiRetryInflation" data-feature="ai-token-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">AI Retry Inflation</div>
            <div class="calc-out-val muted" id="oval-aiRetryInflation">—</div>
            <div class="calc-out-sub">Extra AI cost pressure driven by retry behavior</div>
          </div>

          <div class="calc-out-card ai-token-card" id="out-aiPremiumMix" data-feature="ai-token-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">AI Premium Mix</div>
            <div class="calc-out-val muted" id="oval-aiPremiumMix">—</div>
            <div class="calc-out-sub">Share of AI traffic routed to premium models</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relDowntime" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Expected Downtime</div>
            <div class="calc-out-val muted" id="oval-relDowntime">—</div>
            <div class="calc-out-sub">Estimated monthly downtime from observed SLI availability</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relFailureCost" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Expected Reliability Failure Cost <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relFailureCost">—</div>
            <div class="calc-out-sub">Penalties + incident labor + outage loss + churn-risk expectation</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relAdjustedCost" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Reliability-Adjusted Cost <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relAdjustedCost">—</div>
            <div class="calc-out-sub">Baseline modeled cost plus reliability investment and expected failure burden</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relProfitImpact" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Reliability-Adjusted Profit / Loss <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relProfitImpact">—</div>
            <div class="calc-out-sub">Revenue minus reliability-adjusted monthly cost envelope (includes reliability downside + investment)</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relArpuUplift" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">ARPU Uplift Needed <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relArpuUplift">—</div>
            <div class="calc-out-sub">Incremental price per client needed to preserve margin target under reliability-adjusted cost</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relExtraClients" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Extra Clients Needed @ Current ARPU <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relExtraClients">—</div>
            <div class="calc-out-sub">Additional clients required to absorb reliability-adjusted cost if current ARPU is unchanged</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relRiskBand" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Reliability Risk Band <span class="calc-new-badge calc-new-badge--inline">R4</span></div>
            <div class="calc-out-val muted" id="oval-relRiskBand">—</div>
            <div class="calc-out-sub">Risk signal from breach gap and expected reliability loss share</div>
          </div>

          <div class="calc-out-card reliability-card" id="out-relDataConfidence" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
            <div class="calc-out-label">Reliability Data Confidence</div>
            <div class="calc-out-val muted" id="oval-relDataConfidence">—</div>
            <div class="calc-out-sub">Confidence score based on completeness of reliability and risk inputs</div>
          </div>

        </div>

        <!-- Progress + status bar -->
        <div class="calc-progress" id="calc-progress" style="display:none">
          <span class="cp-label">INPUTS FILLED</span>
          <div class="cp-pill" id="cp-0"></div>
          <div class="cp-pill" id="cp-1"></div>
          <div class="cp-pill" id="cp-2"></div>
          <div class="cp-pill" id="cp-3"></div>
          <div class="cp-pill" id="cp-4"></div>
          <div class="cp-pill" id="cp-5"></div>
          <div class="cp-pill" id="cp-6"></div>
          <div class="cp-pill" id="cp-7"></div>
          <div class="cp-pill" id="cp-8"></div>
          <div class="cp-pill" id="cp-9"></div>
          <div class="cp-pill" id="cp-10"></div>
          <div class="cp-pill" id="cp-11"></div>
          <div class="cp-pill" id="cp-12"></div>
          <div class="cp-pill" id="cp-13"></div>
          <div class="cp-pill" id="cp-14"></div>
          <div class="cp-pill" id="cp-15"></div>
          <div class="cp-pill" id="cp-16"></div>
          <div class="cp-pill" id="cp-17"></div>
          <div class="cp-pill" id="cp-18"></div>
          <div class="cp-pill" id="cp-19"></div>
          <div class="cp-pill" id="cp-20"></div>
          <div class="cp-pill" id="cp-21"></div>
          <div class="cp-pill" id="cp-22"></div>
          <div class="cp-pill" id="cp-23"></div>
          <div class="cp-pill" id="cp-24"></div>
          <div class="cp-pill" id="cp-25"></div>
          <div class="cp-pill" id="cp-26"></div>
          <div class="cp-pill" id="cp-27"></div>
          <div class="cp-pill" id="cp-28"></div>
          <div class="cp-pill" id="cp-29"></div>
          <div class="cp-pill" id="cp-30"></div>
          <div class="cp-pill" id="cp-31"></div>
          <div class="cp-pill" id="cp-32"></div>
          <div class="cp-pill" id="cp-33"></div>
          <div class="cp-pill" id="cp-34"></div>
          <div class="cp-pill" id="cp-35"></div>
          <div class="cp-pill" id="cp-36"></div>
          <div class="cp-pill" id="cp-37"></div>
          <div class="cp-pill" id="cp-38"></div>
          <div class="cp-pill" id="cp-39"></div>
          <div class="cp-pill" id="cp-40"></div>
          <div class="cp-pill" id="cp-41"></div>
          <div class="cp-pill" id="cp-42"></div>
          <div class="cp-pill" id="cp-43"></div>
          <div class="cp-pill" id="cp-44"></div>
          <div class="cp-pill" id="cp-45"></div>
          <div class="cp-pill" id="cp-46"></div>
          <div class="cp-pill" id="cp-47"></div>
        </div>
        <div class="calc-status-bar" id="calc-status-bar">
          <div class="calc-status-dot" id="calc-dot"></div>
          <span class="calc-status-text" id="calc-status-text">Enter values above to begin</span>
        </div>

        <div class="portfolio-summary" id="portfolio-summary">
          <div class="portfolio-summary-head">Single-pane portfolio summary (R2 foundation)</div>
          <div class="portfolio-summary-body" id="portfolio-summary-body">
            <div class="portfolio-empty">Enter Infra Cost and at least one additional domain cost to compare normalized technology dimensions.</div>
          </div>
        </div>

        <div class="qbv-dashboard" id="qbv-dashboard" data-ui-mode="operator architect">
          <button class="cfo-focus-close" id="qbv-focus-close" type="button" aria-label="Exit expanded CFO dashboard view">Exit focus view</button>
          <div class="qbv-dashboard-head">
            <div>
              <div class="qbv-dashboard-title">CFO Forecast Dashboard</div>
              <div class="qbv-dashboard-sub">12-month visual plan for budgeting, scenario forecasting, and value realization tracking</div>
            </div>
            <div class="qbv-dashboard-head-actions">
              <button class="cfo-focus-btn" id="qbv-focus-btn" type="button" aria-controls="qbv-dashboard" aria-pressed="false" aria-label="Expand CFO dashboard view">
                <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M6 2.5H2.5V6M10 2.5h3.5V6M6 13.5H2.5V10M10 13.5h3.5V10"></path>
                </svg>
                <span id="qbv-focus-btn-text">Expand dashboard</span>
              </button>
              <button class="qbv-export-btn" id="qbv-export-csv" type="button" disabled>Export CFO CSV</button>
            </div>
          </div>

          <div class="qbv-dashboard-grid">
            <article class="qbv-panel">
              <div class="cfo-panel-head">
                <h4>Budgeting view</h4>
                <details class="cfo-panel-tip">
                  <summary aria-label="Learn more about Budgeting view">?</summary>
                  <div class="cfo-panel-tip-popover">
                    <p><strong>What:</strong> Compares your declared monthly budget against modeled technology cost at key planning checkpoints (M1, M6, M12).</p>
                    <p><strong>How calculated:</strong> <code>Budget variance = Budget - ModeledCost</code>. Modeled cost uses the active model curves and selected scope basis.</p>
                    <p><strong>Why it matters:</strong> Gives CFO-ready early warning on headroom vs overrun before month-end closes.</p>
                  </div>
                </details>
              </div>
              <p class="qbv-panel-sub">Budget vs modeled monthly cost checkpoints (M1, M6, M12)</p>
              <div id="qbv-budget-bars" class="qbv-placeholder">Provide monthly budget to render budgeting comparison bars.</div>
            </article>

            <article class="qbv-panel">
              <div class="cfo-panel-head">
                <h4>Forecast fan view</h4>
                <details class="cfo-panel-tip">
                  <summary aria-label="Learn more about Forecast fan view">?</summary>
                  <div class="cfo-panel-tip-popover">
                    <p><strong>What:</strong> Shows best, baseline, and worst monthly margin trajectories over a 12-month horizon.</p>
                    <p><strong>How calculated:</strong> Baseline uses projected clients and modeled cost; best/worst apply your efficiency and drift percentages to forecast cost.</p>
                    <p><strong>Why it matters:</strong> Helps finance teams quantify uncertainty bands and build board-grade forecast narratives.</p>
                  </div>
                </details>
              </div>
              <p class="qbv-panel-sub">Best/base/worst margin trajectory for the next 12 months</p>
              <svg id="qbv-forecast-svg" class="qbv-forecast-svg" viewBox="0 0 520 170" aria-label="Forecast margin scenario fan chart"></svg>
              <div id="qbv-forecast-legend" class="qbv-forecast-legend"></div>
            </article>

            <article class="qbv-panel">
              <div class="cfo-panel-head">
                <h4>Value realization ledger</h4>
                <details class="cfo-panel-tip">
                  <summary aria-label="Learn more about Value realization ledger">?</summary>
                  <div class="cfo-panel-tip-popover">
                    <p><strong>What:</strong> Tracks progress from identified value target to delivered value (realized savings + cost avoidance).</p>
                    <p><strong>How calculated:</strong> <code>Total realized value = RealizedSavings + CostAvoidance</code>; cumulative gap compares target run-rate against delivered run-rate over months.</p>
                    <p><strong>Why it matters:</strong> Makes benefits tracking auditable and supports finance governance on value delivery.</p>
                  </div>
                </details>
              </div>
              <p class="qbv-panel-sub">Burn-up of identified target vs realized + avoided value</p>
              <div class="qbv-realization-meter">
                <div id="qbv-realization-meter-fill" class="qbv-realization-meter-fill"></div>
              </div>
              <div id="qbv-realization-summary" class="qbv-realization-summary">Add realization inputs to compute burn-up status.</div>
              <div id="qbv-realization-bars" class="qbv-realization-bars qbv-placeholder"></div>
            </article>

            <article class="qbv-panel" data-feature="sla-slo-sli-economics" data-ui-mode="operator architect">
              <div class="cfo-panel-head">
                <h4>Reliability risk-cost panel</h4>
                <details class="cfo-panel-tip">
                  <summary aria-label="Learn more about Reliability risk-cost panel">?</summary>
                  <div class="cfo-panel-tip-popover">
                    <p><strong>What:</strong> Breaks expected reliability downside into penalty, incident labor, downtime loss, and churn-risk components.</p>
                    <p><strong>How calculated:</strong> Uses the SLA/SLO/SLI economics module outputs to aggregate <code>ExpectedFailureCost</code> and compare against reliability-adjusted cost.</p>
                    <p><strong>Why it matters:</strong> Makes reliability trade-offs explicit so teams can balance preventive investment against expected downside.</p>
                  </div>
                </details>
              </div>
              <p class="qbv-panel-sub">Monthly reliability downside composition and risk posture</p>
              <div id="qbv-reliability-summary" class="qbv-realization-summary">Enable reliability economics to activate risk-cost composition output.</div>
              <div id="qbv-reliability-bars" class="qbv-realization-bars qbv-placeholder"></div>
            </article>
          </div>

          <div class="qbv-table-wrap">
            <table class="qbv-table" aria-label="CFO month-by-month planning table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Clients</th>
                  <th>Modeled Cost</th>
                  <th>Budget Variance</th>
                  <th>Base Margin</th>
                  <th>Best Margin</th>
                  <th>Worst Margin</th>
                  <th>Cumulative Value Gap</th>
                </tr>
              </thead>
              <tbody id="qbv-table-body">
                <tr><td colspan="8" class="qbv-placeholder">Add cost inputs to generate your 12-month CFO planning view.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="qbv-dashboard-note" id="qbv-dashboard-note">Add cost inputs to activate CFO visual planning outputs.</div>
        </div>

      </div>

      <!-- ── GROUP D ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#5a5a8a">D</span>
          <span class="calc-group-label">Your Cloud Provider(s)</span>
          <span class="calc-group-hint">Select one or more providers to personalise recommendations</span>
        </div>
        <div class="provider-grid">
          <button class="provider-btn" data-provider="aws" onclick="toggleProvider('aws')"><span class="provider-logo aws" aria-hidden="true">aws</span><span class="provider-label">AWS</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="azure" onclick="toggleProvider('azure')"><span class="provider-logo azure" aria-hidden="true">az</span><span class="provider-label">Microsoft Azure</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="gcp" onclick="toggleProvider('gcp')"><span class="provider-logo gcp" aria-hidden="true">gcp</span><span class="provider-label">Google Cloud (GCP)</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="oci" onclick="toggleProvider('oci')"><span class="provider-logo oci" aria-hidden="true">oci</span><span class="provider-label">Oracle Cloud (OCI)</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="ibm" onclick="toggleProvider('ibm')"><span class="provider-logo ibm" aria-hidden="true">ibm</span><span class="provider-label">IBM Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="alibaba" onclick="toggleProvider('alibaba')"><span class="provider-logo alibaba" aria-hidden="true">ali</span><span class="provider-label">Alibaba Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="huawei" onclick="toggleProvider('huawei')"><span class="provider-logo huawei" aria-hidden="true">hw</span><span class="provider-label">Huawei Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="onprem" onclick="toggleProvider('onprem')"><span class="provider-logo onprem" aria-hidden="true">dc</span><span class="provider-label">On-Prem Data Center</span><span class="check">✓</span></button>
        </div>
      </div>

      <!-- ── GROUP E ──────────────────────────────────────────── -->
      <div class="calc-group section-anchor" id="group-health">
        <div class="calc-group-title" id="health-title-row">
          <span class="calc-group-num" id="health-group-num" style="background:#7a7a8c">E</span>
          <span class="calc-group-label">Health Zone &amp; Recommendations</span>
          <span class="calc-group-hint">Live FinOps posture based on break-even, CCER, contribution margin, and commitment coverage</span>
        </div>
        <div class="health-wrap">
          <div class="health-banner awaiting" id="health-banner">
            <div>
              <div class="health-zone-title" id="health-zone-title">Awaiting Inputs</div>
              <div class="health-zone-desc" id="health-zone-desc">Add at least Infra Cost and ARPU to compute your FinOps health zone and recommendations.</div>
            </div>
            <div class="health-score">
              <span class="health-score-label">HEALTH SCORE</span>
              <span class="health-score-value" id="health-score-value">—</span>
            </div>
          </div>
          <div class="rec-filters" id="rec-filters" role="group" aria-label="Filter recommendations by category">
            <span class="rec-filters-label">Category</span>
            <button class="rec-filter-btn is-active" type="button" data-rec-category="all" aria-pressed="true">All</button>
            <button class="rec-filter-btn" type="button" data-rec-category="infrastructure" aria-pressed="false">Infrastructure</button>
            <button class="rec-filter-btn" type="button" data-rec-category="pricing" aria-pressed="false">Pricing</button>
            <button class="rec-filter-btn" type="button" data-rec-category="marketing" aria-pressed="false">Marketing</button>
            <button class="rec-filter-btn" type="button" data-rec-category="crm" aria-pressed="false">CRM</button>
            <button class="rec-filter-btn" type="button" data-rec-category="governance" aria-pressed="false">Governance</button>
          </div>
          <div class="intent-rec-helper" id="intent-rec-helper">Recommendation emphasis adapts to selected intent while keeping health-score logic unchanged.</div>
          <div class="rec-list" id="rec-list">
            <div class="rec-empty">Recommendations will appear here once enough data is available.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- HEADER -->
  <div class="fig-header">
    <div class="fig-header-top">
      <div>
        <div class="fig-label">Figure 1 · Interactive Cost &amp; Profitability Curves</div>
        <h2 class="fig-title">Cloud Economics Visualization — Explore Scale, Cost Curves, and Profitability Thresholds</h2>
        <p class="fig-caption" id="chart-focus-caption">Use this section after filling the calculator to inspect how development decay, infrastructure growth, CUD effects, and pricing floors evolve across client volume. Hover over the chart to inspect values at any point.</p>
      </div>
      <button class="chart-focus-btn" id="chart-focus-btn" type="button" aria-controls="chart-section" aria-pressed="false" aria-describedby="chart-focus-caption">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M6 2.5H2.5V6M10 2.5h3.5V6M6 13.5H2.5V10M10 13.5h3.5V10"></path>
        </svg>
        <span class="chart-focus-btn-text">Expand chart view</span>
      </button>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <span class="controls-label">SHOW/HIDE:</span>
    <div class="btns-wrap">
      <button class="toggle-btn" id="btn-dev"       onclick="toggle('dev')"       style="color:var(--dev);      border-color:var(--dev)"><span class="swatch" style="background:var(--dev)"></span>Dev Cost (Amortized / mo)</button>
      <button class="toggle-btn" id="btn-infra-raw" onclick="toggle('infra-raw')" style="color:var(--infra-raw);border-color:var(--infra-raw)"><span class="swatch" style="background:var(--infra-raw)"></span>Infra (On-Demand)</button>
      <button class="toggle-btn" id="btn-infra-cud" onclick="toggle('infra-cud')" style="color:var(--infra-cud);border-color:var(--infra-cud)"><span class="swatch" style="background:linear-gradient(90deg,var(--infra-cud) 55%,transparent 55%) repeat-x left/9px 3px"></span>Infra (With CUDs)</button>
      <button class="toggle-btn" id="btn-total"     onclick="toggle('total')"     style="color:var(--total);    border-color:var(--total)"><span class="swatch" style="background:var(--total)"></span>Total Cost / mo</button>
      <button class="toggle-btn" id="btn-total-rel" onclick="toggle('total-rel')" style="color:var(--total-rel);border-color:var(--total-rel)"><span class="swatch" style="background:linear-gradient(90deg,var(--total-rel) 60%,transparent 60%) repeat-x left/10px 3px"></span>Total Cost + Reliability / mo</button>
      <button class="toggle-btn" id="btn-revenue"   onclick="toggle('revenue')"   style="color:var(--revenue);  border-color:var(--revenue)"><span class="swatch" style="background:var(--revenue)"></span>Revenue / mo</button>
      <button class="toggle-btn" id="btn-profit"    onclick="toggle('profit')"    style="color:var(--profit);   border-color:var(--profit)"><span class="swatch" style="background:linear-gradient(90deg,var(--profit) 60%,transparent 60%) repeat-x left/10px 3px"></span>Profit / ROI</button>
      <button class="toggle-btn" id="btn-profit-rel" onclick="toggle('profit-rel')" style="color:var(--profit-rel);border-color:var(--profit-rel)"><span class="swatch" style="background:linear-gradient(90deg,var(--profit-rel) 60%,transparent 60%) repeat-x left/10px 3px"></span>Profit / ROI + Reliability</button>
      <button class="toggle-btn" id="btn-price-min" onclick="toggle('price-min')" style="color:var(--price-min);border-color:var(--price-min)"><span class="swatch" style="background:linear-gradient(90deg,var(--price-min) 40%,transparent 40%) repeat-x left/7px 3px"></span>Revenue Target / mo</button>
    </div>
  </div>

  <!-- CHART + SIDE PANEL -->
  <div class="chart-section section-anchor" id="chart-section">
    <button class="chart-focus-close" id="chart-focus-close" type="button" aria-label="Exit expanded chart view">Exit focus view</button>
    <div class="chart-container" id="chart-container">
      <svg id="chart"></svg>
    </div>
    <div class="side-panel">
      <div>
        <div class="panel-title">Client Count</div>
        <div class="readout-n" id="sp-n">— clients</div>
      </div>
      <div class="divider"></div>
      <div>
        <div class="panel-title">Current Zone</div>
        <div id="sp-zone-badge" class="zone-badge">Hover chart →</div>
        <div id="sp-zone-desc" class="zone-desc-text"></div>
      </div>
      <div class="divider"></div>
      <div class="readout-grid">
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--dev)"></span>Dev Cost (Amortized / mo)</div>
          <div class="readout-val" id="sp-dev">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--infra-raw)"></span>Infra (On-Demand)</div>
          <div class="readout-val" id="sp-infra-raw">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--infra-cud)"></span>Infra (CUDs)</div>
          <div class="readout-val" id="sp-infra-cud">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--total)"></span>Total Cost / mo</div>
          <div class="readout-val" id="sp-total">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--total-rel)"></span>Total Cost + Reliability</div>
          <div class="readout-val" id="sp-total-rel">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--revenue)"></span>Revenue / mo</div>
          <div class="readout-val" id="sp-revenue">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--profit)"></span>Profit / Loss</div>
          <div class="readout-val" id="sp-profit">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--profit-rel)"></span>Profit / Loss + Reliability</div>
          <div class="readout-val" id="sp-profit-rel">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--price-min);border:1px solid #bbb"></span>Revenue Target / mo</div>
          <div class="readout-val" id="sp-price-min">—</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="insight-box">
        <div class="insight-label">Key Insight</div>
        <div id="sp-insight" class="zone-desc-text">Move cursor over chart to see contextual insights.</div>
      </div>
    </div>
  </div>

  <!-- ZONES STRIP -->
  <div class="zones-strip">
    <div class="zone-cell">
      <div class="zone-num">Zone I</div>
      <div class="zone-cell-title" style="color:var(--dev)">Loss Zone</div>
      <div class="zone-cell-desc">Fixed costs dominate. Revenue cannot cover total cost of service. Below minimum viable scale.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Threshold</div>
      <div class="zone-cell-title" style="color:var(--total)">Break-Even</div>
      <div class="zone-cell-desc">First n where Revenue(n) ≥ TotalCost(n). Minimum clients for sustainable operations.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Zone III</div>
      <div class="zone-cell-title" style="color:var(--profit)">ROI Sweet Spot</div>
      <div class="zone-cell-desc">Economies of scale reduce per-client dev cost while infra scales efficiently with CUDs.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Zone IV</div>
      <div class="zone-cell-title" style="color:var(--revenue)">Margin Compression</div>
      <div class="zone-cell-desc">Infra cost growth outpaces revenue. Trigger: CUD renegotiation, right-sizing, or architecture review.</div>
    </div>
  </div>

  <!-- FORMULAS -->
  <div class="formulas-section section-anchor" id="formulas-section">
    <div class="formulas-header-row">
      <div class="formulas-header">Core FinOps Equations Referenced in Figure 1 — <span style="font-weight:400;letter-spacing:0">click any card (or press Enter/Space) for a full explanation</span></div>
      <div class="formulas-header-actions">
        <a class="glossary-link-btn" href="document.html#glossary" aria-label="Open glossary section with detailed term explanations">Open glossary ↗</a>
        <button class="feature-request-btn feature-request-btn-compact" type="button" onclick="requestFeature('Formulas Section')" aria-label="Request a feature on Github">Request a feature on Github</button>
      </div>
    </div>
    <div class="formulas-grid">

      <!-- 1 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Break-Even Clients (scan)</div>
        <div class="f-eq">BreakEven = first n where <span class="hl2">Revenue</span>(n) ≥ TC(n)</div>
        <div class="ftip">
          <div class="ftip-title">Break-Even Clients (deterministic scan)</div>
          <div class="ftip-desc">The calculator finds the first client count where modeled monthly revenue meets or exceeds modeled monthly total cost. This threshold is computed by scanning the nonlinear cost/revenue curves (not by a single closed-form FC/(ARPU−VCPU) shortcut).</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">BreakEven</span><span class="ftip-def">First n in scan range where Revenue(n) ≥ TotalCost(n)</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">Revenue(n)</span><span class="ftip-def">ARPU × n using manual ARPU or startup-derived ARPU</span></div>
            <div class="ftip-var"><span class="ftip-sym">TC(n)</span><span class="ftip-def">TotalCost(n) = DevCost(n) + InfraCost(n)</span></div>
            <div class="ftip-var"><span class="ftip-sym">n range</span><span class="ftip-def">Deterministic search from n=1 up to the configured scan horizon</span></div>
            <div class="ftip-var"><span class="ftip-sym">Note</span><span class="ftip-def">The FC/(ARPU−VCPU) form remains useful intuition, but the app output is scan-based for nonlinear realism.</span></div>
          </div>
        </div>
      </div>

      <!-- 2 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Dev Cost Decay (Amortized Burden)</div>
        <div class="f-eq">DC(n) = <span class="hl2">K</span> · n<sup>−α</sup>,  α ∈ (0,1)</div>
        <div class="ftip">
          <div class="ftip-title">Development Cost Decay</div>
          <div class="ftip-desc">As you onboard more clients, shared development burden can be amortized more efficiently. In this model, the monthly development cost component decays with a power-law curve as scale increases.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">DC(n)</span><span class="ftip-def">Amortized monthly development cost component at scale n</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">K</span><span class="ftip-def">Calibration constant derived from your development-cost input at reference n</span></div>
            <div class="ftip-var"><span class="ftip-sym">n</span><span class="ftip-def">Number of clients currently onboarded</span></div>
            <div class="ftip-var"><span class="ftip-sym">−α</span><span class="ftip-def">Decay exponent (0 &lt; α &lt; 1). Higher α means faster amortization as scale grows</span></div>
          </div>
        </div>
      </div>

      <!-- 3 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Infra Cost — On-Demand</div>
        <div class="f-eq">IC(n) = <span class="hl2">c</span> · n<sup>β</sup>,  β &gt; 1</div>
        <div class="ftip">
          <div class="ftip-title">Infrastructure Cost (On-Demand Pricing)</div>
          <div class="ftip-desc">When paying full on-demand cloud rates (no commitments), infrastructure costs grow super-linearly with clients — each new client adds slightly more cost than the previous one due to usage patterns and resource contention. This is the green curve in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">IC(n)</span><span class="ftip-def">Total infrastructure cost at n clients on on-demand pricing</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">c</span><span class="ftip-def">Base cost coefficient — the infrastructure cost for the first client</span></div>
            <div class="ftip-var"><span class="ftip-sym">β</span><span class="ftip-def">Scaling exponent (β &gt; 1). Represents super-linear growth — each client incrementally increases cost faster than the last</span></div>
          </div>
        </div>
      </div>

      <!-- 4 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Infra Cost — With CUDs</div>
        <div class="f-eq">IC<span class="hl">cud</span>(n) = γ · c · n<sup>β·0.96</sup></div>
        <div class="ftip">
          <div class="ftip-title">Infrastructure Cost with Committed Use Discounts (CUDs)</div>
          <div class="ftip-desc">By committing to a certain level of cloud resource usage over 1 or 3 years, providers receive significant discounts (typically 20–55% depending on the platform and resource type). This shifts the entire infrastructure cost curve downward — extending the ROI sweet spot to the right. This is the dashed green curve in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym hl2">IC<sub>cud</sub>(n)</span><span class="ftip-def">Infrastructure cost at n clients after applying CUD/Reserved Instance discounts</span></div>
            <div class="ftip-var"><span class="ftip-sym">IC(n)</span><span class="ftip-def">Baseline on-demand infrastructure cost (from the formula above)</span></div>
            <div class="ftip-var"><span class="ftip-sym">γ</span><span class="ftip-def">CUD discount factor (0 &lt; γ &lt; 1). A γ of 0.72 means a 28% cost reduction through commitments. Lower γ = deeper discount</span></div>
            <div class="ftip-var"><span class="ftip-sym">CUDs</span><span class="ftip-def">Committed Use Discounts — GCP's discount model for pre-committing compute resources. AWS equivalent: Savings Plans / Reserved Instances. Azure: Reserved Instances</span></div>
          </div>
        </div>
      </div>

      <!-- 5 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Revenue Target with Margin</div>
        <div class="f-eq">RT(n) = TC(n) · (1 + <span class="hl2">m</span>)</div>
        <div class="ftip">
          <div class="ftip-title">Revenue Target with Margin (RT)</div>
          <div class="ftip-desc">This computes the monthly revenue target required to cover modeled total cost and include your target margin buffer at scale n. It is the dotted black line in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">RT(n)</span><span class="ftip-def">Required monthly revenue target at scale n</span></div>
            <div class="ftip-var"><span class="ftip-sym">TC(n)</span><span class="ftip-def">Total monthly cost at n clients — development plus infrastructure components</span></div>
            <div class="ftip-var"><span class="ftip-sym">n</span><span class="ftip-def">Current number of clients used for scale-sensitive cost modeling</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">m</span><span class="ftip-def">Target margin factor added on top of cost recovery (e.g. 15%)</span></div>
            <div class="ftip-var"><span class="ftip-sym">Note</span><span class="ftip-def">Minimum price per client output in Group C is computed separately as <code>(TC(n) ÷ n) × (1 + m)</code>.</span></div>
          </div>
        </div>
      </div>

      <!-- 6 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Cloud Cost Efficiency Ratio</div>
        <div class="f-eq">CCER = <span class="hl">Revenue</span> ÷ Modeled Infra Spend</div>
        <div class="ftip">
          <div class="ftip-title">Cloud Cost Efficiency Ratio (CCER)</div>
          <div class="ftip-desc">A FinOps north-star KPI that measures how much revenue is generated for every euro of modeled cloud infrastructure spend. A CCER of 4.5 means €4.50 in revenue for every €1 of modeled infra cost.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">CCER</span><span class="ftip-def">Cloud Cost Efficiency Ratio — the primary FinOps ROI metric for service providers</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">Revenue</span><span class="ftip-def">Total recurring revenue from all active clients in the measurement period</span></div>
            <div class="ftip-var"><span class="ftip-sym">Modeled Infra Spend</span><span class="ftip-def">The modeled on-demand infrastructure cost component IC(n) used by this calculator</span></div>
            <div class="ftip-var"><span class="ftip-sym">Target</span><span class="ftip-def">A CCER &gt; 3.0 is generally considered healthy for cloud-native SaaS. Below 1.0 means the business is unprofitable from a cloud economics standpoint</span></div>
          </div>
        </div>
      </div>

      <!-- 7 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Multi-Domain Normalized Tech Cost</div>
        <div class="f-eq">NTC/client = Σ(α<sub>d</sub> · C<sub>d</sub>) ÷ n</div>
        <div class="ftip">
          <div class="ftip-title">Scoped Multi-Domain Normalization</div>
          <div class="ftip-desc">This extends cloud-only costing to a selected technology scope. It aggregates monthly cost from selected domains and normalizes to a per-client comparable unit.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">NTC/client</span><span class="ftip-def">Normalized technology cost per client for the selected scope</span></div>
            <div class="ftip-var"><span class="ftip-sym">C<sub>d</sub></span><span class="ftip-def">Monthly cost of domain d (Cloud, SaaS, Licensing, Private Cloud, Data Center, Labor)</span></div>
            <div class="ftip-var"><span class="ftip-sym">α<sub>d</sub></span><span class="ftip-def">Allocation factor for domain d. Financial Truth mode: α<sub>d</sub>=1 if selected, else 0 (default).</span></div>
            <div class="ftip-var"><span class="ftip-sym">w<sub>d</sub></span><span class="ftip-def">Optional Priority Index weights where Σw<sub>d</sub>=1. Suggested bands: Cloud 0.25–0.45, SaaS 0.15–0.30, Licensing 0.08–0.20, Private Cloud 0.05–0.20, Data Center 0.03–0.15, Labor 0.08–0.20.</span></div>
            <div class="ftip-var"><span class="ftip-sym">n</span><span class="ftip-def">Client count used to normalize the pooled monthly cost</span></div>
            <div class="ftip-var"><span class="ftip-sym">Default</span><span class="ftip-def">Balanced policy profile (optional): Cloud 0.35, SaaS 0.20, Licensing 0.12, Private Cloud 0.13, Data Center 0.08, Labor 0.12.</span></div>
            <div class="ftip-var"><span class="ftip-sym">Refs</span><span class="ftip-def">See Academic &amp; Primary References [6], [9], [10]</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER WITH ACADEMIC REFERENCES -->
  <div class="fig-footer section-anchor" id="references-section">
    <div class="fig-footer-top">
      <span class="fig-source">
        <strong>Source:</strong> Conceptual model derived from cloud economics literature and empirical FinOps practice.
        Mathematical formulations (power-law cost scaling, break-even analysis) adapted from foundational cloud economics research [1][2].
        Cloud service model definitions align with NIST guidance [11]. FinOps framework principles follow the FinOps Foundation standard [3][4].
        CUD discount modelling is grounded in provider documentation and cross-cloud comparative studies [7][8][16][17].
        Reliability economics assumptions and SLO/SLA operational patterns are anchored in SRE literature [12][13], and forecast/confidence logic is informed by forecasting and uncertainty methodology [14][15][18].
        All parameter values are illustrative and for research purposes only.
      </span>
      <span class="fig-note">
        <a class="fig-note-link" href="https://www.linkedin.com/in/duksh/" target="_blank" rel="noopener noreferrer" aria-label="DK Koonjoobeeharry on LinkedIn">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 20.45h-3.56v-5.58c0-1.33-.03-3.03-1.85-3.03-1.85 0-2.13 1.45-2.13 2.94v5.67H9.35V9h3.42v1.56h.05c.48-.9 1.64-1.85 3.37-1.85 3.6 0 4.26 2.37 4.26 5.46v6.28zM5.34 7.43a2.07 2.07 0 1 1 0-4.14 2.07 2.07 0 0 1 0 4.14zM7.12 20.45H3.56V9h3.56v11.45zM22.22 0H1.77C.79 0 0 .78 0 1.74v20.52C0 23.22.79 24 1.77 24h20.45c.98 0 1.78-.78 1.78-1.74V1.74C24 .78 23.2 0 22.22 0z"/></svg>
          <span>DK Koonjoobeeharry · DBA Research · Open University of Mauritius</span>
        </a>
      </span>
    </div>

    <div class="fig-refs">
      <div class="fig-refs-title">Academic &amp; Primary References</div>
      <div class="fig-refs-grid">

        <div class="fig-ref-item">
          <span class="fig-ref-num">[1]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Harms, R. &amp; Yamartino, M. (2010). <em>The Economics of the Cloud</em>. Microsoft Corp. White Paper.
            Establishes the three economies of scale in cloud: data centre size, demand pooling, and multi-tenancy — foundational basis for the infrastructure cost curves.
            <br><a href="https://news.microsoft.com/download/archived/presskits/cloud/docs/The-Economics-of-the-Cloud.pdf" target="_blank">↗ microsoft.com/Economics-of-the-Cloud.pdf</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[2]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Bayrak, E., Conley, J.P. &amp; Wilkie, S. (2011). The Economics of Cloud Computing.
            <em>Korean Economic Review</em>, 27(2), 203–230.
            Peer-reviewed survey of cloud cost structure and fixed vs. variable cost modelling — supports the power-law DC(n) and IC(n) formulations.
            <br><a href="https://irbe.library.vanderbilt.edu/server/api/core/bitstreams/26dba360-5fee-457a-aef2-7706b4f0505a/content" target="_blank">↗ Vanderbilt University · Working Paper 11-W18</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[3]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Bryant, J. (2022). Driving into the Cloud: What is FinOps?
            <em>ITNOW</em>, 64(3), 54–55. Oxford University Press.
            Peer-reviewed definition and lifecycle model of FinOps as a cloud financial management discipline — basis for the CCER and Min Price metrics.
            <br><a href="https://doi.org/10.1093/combul/bwac097" target="_blank">↗ doi.org/10.1093/combul/bwac097</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[4]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Nawrocki, P. &amp; Smendowski, M. (2024). FinOps-driven optimization of cloud resource usage for HPC using machine learning.
            <em>Journal of Computational Science</em>, 78, 102269. ScienceDirect.
            Academic study applying FinOps cost forecasting and resource reservation planning — validates the CUD optimisation model.
            <br><a href="https://www.sciencedirect.com/science/article/abs/pii/S1877750324000851" target="_blank">↗ sciencedirect.com · doi.org/10.1016/j.jocs.2024.102269</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[5]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Bourreau, M., de Streel, A. &amp; Graef, I. (2024). <em>The Economics of the Cloud</em>. TSE Working Paper No. 1520.
            Toulouse School of Economics / Microsoft Commission. Comprehensive economic analysis of cloud pricing, committed-spend discounts, and egress fees.
            <br><a href="https://www.tse-fr.eu/sites/default/files/TSE/documents/doc/wp/2024/wp_tse_1520.pdf" target="_blank">↗ tse-fr.eu · WP-TSE-1520</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[6]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            FinOps Foundation. (2026). <em>State of FinOps Report</em>. Annual practitioner survey (700+ respondents).
            Industry benchmark for cloud cost efficiency metrics, CCER thresholds, and FinOps maturity adoption rates cited in this model.
            <br><a href="https://data.finops.org/" target="_blank">↗ data.finops.org</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[7]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            Google Cloud. (2024). <em>Resource-based Committed Use Discounts</em>. Google Cloud Compute Engine Documentation.
            Primary source for CUD discount rates (up to 57% for 3-year, 37% for 1-year commitments) used to parameterise the γ discount factor.
            <br><a href="https://cloud.google.com/compute/docs/instances/signing-up-committed-use-discounts" target="_blank">↗ cloud.google.com/compute/docs/committed-use-discounts</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[8]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            GSA / ITVMO. (2023). <em>Cloud Optimization Through Discounts and Consolidated Billing</em>. U.S. General Services Administration.
            Government-published comparative analysis of AWS Savings Plans, Azure Reservations, and GCP CUDs — supports the cross-cloud CUD benchmarking in this model.
            <br><a href="https://itvmo.gsa.gov/assets/files/FinOps-Optimization-Through-Discounts.pdf" target="_blank">↗ itvmo.gsa.gov · FinOps-Optimization-Through-Discounts.pdf</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[9]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Kaplan, R.S. &amp; Anderson, S.R. (2004). <em>Time-Driven Activity-Based Costing</em>. Harvard Business Review.
            Foundational cost-allocation method supporting pooled cost normalization with explicit allocation coefficients.
            <br><a href="https://hbr.org/2004/11/time-driven-activity-based-costing" target="_blank">↗ hbr.org/time-driven-activity-based-costing</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[10]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Nardo, M. et al. (2008). <em>Handbook on Constructing Composite Indicators</em>. OECD / European Commission JRC.
            Methodological basis for completeness and confidence scoring used with aggregated multi-domain indicators.
            <br><a href="https://knowledge4policy.ec.europa.eu/sites/default/files/jrc47008_handbook_final.pdf" target="_blank">↗ JRC Handbook on Composite Indicators</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[11]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            Mell, P. &amp; Grance, T. (2011). <em>The NIST Definition of Cloud Computing</em> (NIST SP 800-145).
            Canonical definition of cloud service models and deployment models used as baseline framing for cloud-economic comparability.
            <br><a href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-145.pdf" target="_blank">↗ nist.gov · SP 800-145</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[12]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Beyer, B., Jones, C., Petoff, J. &amp; Murphy, N.R. (Eds.). (2016). <em>Site Reliability Engineering: How Google Runs Production Systems</em>. O'Reilly.
            Foundational reliability engineering text for SLI/SLO design, error budgets, and reliability-cost trade-off framing used in Release 4 reliability economics.
            <br><a href="https://sre.google/sre-book/table-of-contents/" target="_blank">↗ sre.google/sre-book</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[13]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Jones, C., Armel, J., Woog, N. et al. (2018). <em>The Site Reliability Workbook</em>. O'Reilly.
            Practitioner reference for operationalizing SLO targets, incident response patterns, and reliability controls that map to downtime and risk-cost assumptions.
            <br><a href="https://sre.google/workbook/table-of-contents/" target="_blank">↗ sre.google/workbook</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[14]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Hyndman, R.J. &amp; Athanasopoulos, G. (2021). <em>Forecasting: Principles and Practice</em> (3rd ed.). OTexts.
            Statistical basis for scenario forecasting logic and interpretation of baseline/best/worst bands in planning outputs.
            <br><a href="https://otexts.com/fpp3/" target="_blank">↗ otexts.com/fpp3</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[15]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Makridakis, S., Spiliotis, E. &amp; Assimakopoulos, V. (2020). The M4 Competition: 100,000 time series and 61 forecasting methods.
            <em>International Journal of Forecasting</em>, 36(1), 54-74.
            Peer-reviewed evidence on forecast benchmarking and model-selection rigor supporting confidence-band interpretation.
            <br><a href="https://doi.org/10.1016/j.ijforecast.2019.04.014" target="_blank">↗ doi.org/10.1016/j.ijforecast.2019.04.014</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[16]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            Amazon Web Services. (2024). <em>AWS Well-Architected Framework: Cost Optimization Pillar</em>.
            Reputed cloud architecture standard for cost governance, commitment planning, and unit-economics optimization controls.
            <br><a href="https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/welcome.html" target="_blank">↗ docs.aws.amazon.com/wellarchitected/cost-optimization</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[17]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            Microsoft Azure. (2025). <em>Azure Well-Architected Framework: Cost Optimization</em>.
            Cross-provider benchmark used to triangulate cost-efficiency and financial-governance practices beyond a single cloud vendor.
            <br><a href="https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/" target="_blank">↗ learn.microsoft.com/azure/well-architected/cost-optimization</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[18]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            JCGM. (2008). <em>Evaluation of Measurement Data - Guide to the Expression of Uncertainty in Measurement</em> (JCGM 100:2008).
            Methodological basis for confidence communication and uncertainty-aware interpretation in decision-support indicators.
            <br><a href="https://www.bipm.org/documents/20126/2071204/JCGM_100_2008_E.pdf" target="_blank">↗ bipm.org · JCGM 100:2008</a>
          </span>
        </div>

      </div>
    </div>

    <div class="fig-page-meta" aria-label="Page metadata">
      <span><strong>Last updated:</strong> <time id="page-last-updated" datetime="2026-02-16T14:15:00+04:00">16 Feb 2026, 14:15 (UTC+04:00)</time></span>
      <span><strong>Version ID:</strong> <span id="page-version-id">v2026.02.16-01</span></span>
    </div>
  </div>

</div><!-- /.paper -->

<div class="mcp-modal" id="mcp-modal" aria-hidden="true">
  <div class="mcp-modal-backdrop" data-mcp-close></div>
  <div class="mcp-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="mcp-modal-title" tabindex="-1">
    <button class="mcp-modal-close" type="button" data-mcp-close aria-label="Close MCP details">×</button>
    <h2 class="mcp-modal-title" id="mcp-modal-title">FiceCal MCP — Quick Guide</h2>
    <p class="mcp-modal-subtitle">
      This MCP exposes the same FinOps logic used on this page, so agents can compute outputs and recommendations in automation flows.
    </p>

    <div class="mcp-modal-grid">
      <article class="mcp-modal-card">
        <h4>Install</h4>
        <ul>
          <li>Clone <code>github.com/duksh/finops-calculator-mcp</code>.</li>
          <li>Run <code>npm run check</code>, <code>npm run test</code>, and <code>npm run test:parity</code> in <code>server/</code>.</li>
          <li>Parity check confirms MCP stays synced with the latest calculator logic on <code>main</code>.</li>
          <li>Start server via <code>npm run start</code>.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Connect</h4>
        <ul>
          <li>Add MCP config with command <code>node</code>.</li>
          <li>Set args to absolute path ending in <code>/server/index.js</code>.</li>
          <li>Reload client and confirm tools are discovered.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Key tools</h4>
        <ul>
          <li><code>finops.calculate</code> for full scenario outputs.</li>
          <li><code>finops.health</code> for score-only checks in workflows.</li>
          <li><code>finops.recommend</code> for zone/provider action plans.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Example prompts</h4>
        <ul>
          <li>"Run <code>finops.calculate</code> for ARPU 35, infra 2400, dev 500."</li>
          <li>"Run <code>finops.health</code> and explain why zone is yellow."</li>
          <li>"Encode this state and return a share token."</li>
        </ul>
      </article>
    </div>
  </div>
</div>

<script src="src/features/runtime-gates.js"></script>
<script src="src/features/ai-token-economics/engine.js"></script>
<script src="src/features/sla-slo-sli-economics/engine.js"></script>
<script src="src/core/economics.js"></script>
<script>
// ─── STATE ──────────────────────────────────────────────────────
const hidden = new Set();
let paths = {}, hoverDots = {}, currentPts = [], currentScales = {};
const FINOPS_2026_REPORT_URL = 'https://data.finops.org';
const TDABC_REFERENCE_URL = 'https://hbr.org/2004/11/time-driven-activity-based-costing';
const COMPOSITE_INDEX_REFERENCE_URL = 'https://knowledge4policy.ec.europa.eu/sites/default/files/jrc47008_handbook_final.pdf';
const OFFICIAL_REFERENCE_URLS = {
  finopsFramework: 'https://www.finops.org/framework/',
  finopsUnitEconomics: 'https://www.finops.org/framework/capabilities/unit-economics/',
  finopsRateOptimization: 'https://www.finops.org/framework/capabilities/rate-optimization/',
  finopsWorkloadOptimization: 'https://www.finops.org/framework/capabilities/workload-optimization/',
  finopsAllocation: 'https://www.finops.org/framework/capabilities/allocation/',
  finopsForecasting: 'https://www.finops.org/framework/capabilities/forecasting/',
  finopsAnomalyManagement: 'https://www.finops.org/framework/capabilities/anomaly-management/',
  finopsBudgetManagement: 'https://www.finops.org/framework/capabilities/budget-management/',
  finopsReport: FINOPS_2026_REPORT_URL,
  nistCloud: 'https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-145.pdf',
  forecastingPractice: 'https://otexts.com/fpp3/',
  forecastingBenchmark: 'https://doi.org/10.1016/j.ijforecast.2019.04.014',
  uncertaintyGuide: 'https://www.bipm.org/documents/20126/2071204/JCGM_100_2008_E.pdf',
  sreBook: 'https://sre.google/sre-book/table-of-contents/',
  sreWorkbook: 'https://sre.google/workbook/table-of-contents/',
  googleCud: 'https://cloud.google.com/compute/docs/instances/signing-up-committed-use-discounts',
  awsSavingsPlans: 'https://docs.aws.amazon.com/savingsplans/latest/userguide/what-is-savings-plans.html',
  awsCostOptimization: 'https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/welcome.html',
  awsRightsizing: 'https://docs.aws.amazon.com/cost-management/latest/userguide/ce-rightsizing.html',
  awsSpot: 'https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html',
  awsAnomalyDetection: 'https://docs.aws.amazon.com/cost-management/latest/userguide/manage-ad.html',
  awsS3IntelligentTiering: 'https://docs.aws.amazon.com/AmazonS3/latest/userguide/intelligent-tiering.html',
  azureReservations: 'https://learn.microsoft.com/en-us/azure/cost-management-billing/reservations/save-compute-costs-reservations',
  azureCostOptimization: 'https://learn.microsoft.com/en-us/azure/well-architected/cost-optimization/',
  azureAdvisor: 'https://learn.microsoft.com/en-us/azure/advisor/advisor-cost-recommendations',
  azureBudgets: 'https://learn.microsoft.com/en-us/azure/cost-management-billing/costs/tutorial-acm-create-budgets',
  azureSpot: 'https://learn.microsoft.com/en-us/azure/virtual-machines/spot-vms',
  gcpBudgets: 'https://cloud.google.com/billing/docs/how-to/budgets',
  gcpBudgetPubSub: 'https://cloud.google.com/billing/docs/how-to/budgets-programmatic-notifications',
  gcpRecommender: 'https://cloud.google.com/recommender/docs/recommenders',
  gcpBillingExport: 'https://cloud.google.com/billing/docs/how-to/export-data-bigquery',
  gcpBigQueryCosts: 'https://cloud.google.com/bigquery/docs/best-practices-costs',
  gcpBigQueryReservations: 'https://cloud.google.com/bigquery/docs/reservations-intro',
  gcpSud: 'https://cloud.google.com/compute/docs/sustained-use-discounts',
  ociBilling: 'https://docs.oracle.com/en-us/iaas/Content/Billing/Concepts/billingoverview.htm',
  ociAlwaysFree: 'https://www.oracle.com/cloud/free/',
  ibmBilling: 'https://cloud.ibm.com/docs/account?topic=account-accounts',
  ibmSustainability: 'https://www.ibm.com/products/environmental-intelligence-suite',
  alibabaBilling: 'https://www.alibabacloud.com/help/en/user-center/latest/billing-overview',
  huaweiBilling: 'https://support.huaweicloud.com/intl/en-us/billing/index.html',
  onPremVmwareResourceManagement: 'https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-resource-management/GUID-24B177F0-BB8D-4CE1-B7E2-A5A54B4D54E8.html',
  openaiPricing: 'https://openai.com/api/pricing/',
  openaiRateLimits: 'https://platform.openai.com/docs/guides/rate-limits',
  openCost: 'https://opencost.io/docs/'
};
const SHARE_STATE_VERSION = 1;
const UI_MODE_OPTIONS = ['quick', 'operator', 'architect'];
const UI_INTENT_OPTIONS = ['viability', 'operations', 'architecture', 'executive'];
const UI_INTENT_DEFAULT = 'viability';
const UI_INTENT_STORAGE_KEY = 'ficecal.ui.intent';
const RELEASE4_RELIABILITY_SEEN_KEY = 'ficecal.r4.reliability.seen';
const FEATURE_TOGGLE_ORDER = ['multi-tech-normalization', 'ai-token-economics', 'sla-slo-sli-economics'];
const FEATURE_TOGGLE_LABELS = {
  'core-economics': 'Core Economics',
  'multi-tech-normalization': 'Multi-Technology Normalization',
  'ai-token-economics': 'AI Token Economics',
  'sla-slo-sli-economics': 'SLA/SLO/SLI Reliability Economics'
};
const UI_INTENT_PROFILES = {
  viability: {
    mode: 'quick',
    recommendationCategory: 'pricing',
    featureProfile: 'core-kpis',
    personaLabel: 'Finance',
    summary: 'As Finance, prioritize break-even, minimum price, and contribution margin for fast go/no-go checks.',
    outcomePreview: ['Break-even threshold', 'Minimum viable price', 'Contribution margin'],
    nextStep: 'Enter Total Infra Cost and ARPU to unlock your first finance-grade readout.',
    kpiHelper: 'Viability first: focus on Break-Even, Min Price, Contribution Margin, and CCER before broader overlays.',
    recommendationHelper: 'Recommendation emphasis: pricing and revenue-fit actions are ranked first for viability decisions.',
    recommendationWeights: { pricing: 0, infrastructure: 1, marketing: 2, crm: 3, governance: 4, all: 5 },
    kpiOrder: ['out-beN', 'out-minPrice', 'out-margin', 'out-ccer', 'out-vcpu', 'out-targetRevenue'],
    guidedSteps: [
      { label: 'Viability', requires: ['hasInfraInput', 'hasARPU'] },
      { label: 'Risk', requires: ['hasHealthScore'] },
      { label: 'Action', requires: ['hasRecommendations'] }
    ],
    exportLabel: 'Export viability preset',
    exportMetrics: ['out-beN', 'out-minPrice', 'out-margin', 'out-ccer', 'out-vcpu', 'out-targetRevenue']
  },
  operations: {
    mode: 'operator',
    recommendationCategory: 'infrastructure',
    featureProfile: 'finops-operations',
    personaLabel: 'Operations',
    summary: 'As Operations, prioritize budgeting, reliability downside exposure, and monthly optimization levers.',
    outcomePreview: ['Budget variance', 'Reliability failure cost', 'Top optimization action'],
    nextStep: 'Enter Total Infra Cost and budget assumptions, then activate reliability inputs to expose downside pressure.',
    kpiHelper: 'Operations first: budget variance, reliability failure cost, risk band, and forecast signals are surfaced early.',
    recommendationHelper: 'Recommendation emphasis: infrastructure and operating levers are ranked first for monthly control loops.',
    recommendationWeights: { infrastructure: 0, governance: 1, pricing: 2, crm: 3, marketing: 4, all: 5 },
    kpiOrder: ['out-budgetVariance', 'out-relFailureCost', 'out-relRiskBand', 'out-relAdjustedCost', 'out-forecastBand', 'out-forecastSpread', 'out-realizedValue', 'out-realizationGap', 'out-techCoverage', 'out-techNorm', 'out-focusMaturity'],
    guidedSteps: [
      { label: 'Budget', requires: ['hasInfraInput', 'hasBudget'] },
      { label: 'Risk', requires: ['hasOpsRiskSignal'] },
      { label: 'Action', requires: ['hasRecommendations'] }
    ],
    exportLabel: 'Export operations preset',
    exportMetrics: ['out-budgetVariance', 'out-relFailureCost', 'out-relRiskBand', 'out-relAdjustedCost', 'out-forecastBand', 'out-forecastSpread', 'out-techNorm']
  },
  architecture: {
    mode: 'architect',
    recommendationCategory: 'governance',
    featureProfile: 'policy-ai',
    personaLabel: 'Architecture',
    summary: 'As Architecture, surface policy-heavy controls across AI token economics and SLA/SLO/SLI reliability economics.',
    outcomePreview: ['Reliability-adjusted cost signal', 'AI allocation pressure', 'Governance risk action'],
    nextStep: 'Enable AI and/or reliability inputs (or load a demo) to unlock policy, risk, and action guidance.',
    kpiHelper: 'Architecture first: reliability-adjusted cost, reliability risk, AI allocation, and governance-sensitive outputs are prioritized.',
    recommendationHelper: 'Recommendation emphasis: governance and policy controls are ranked first, then infrastructure and pricing.',
    recommendationWeights: { governance: 0, infrastructure: 1, pricing: 2, crm: 3, marketing: 4, all: 5 },
    kpiOrder: ['out-relAdjustedCost', 'out-relFailureCost', 'out-relRiskBand', 'out-aiAllocatedCost', 'out-aiCostPerClient', 'out-aiTokenCost', 'out-aiRetryInflation', 'out-aiPremiumMix', 'out-techNorm', 'out-focusMaturity'],
    guidedSteps: [
      { label: 'Policy', requires: ['hasArchitecturePolicySignal'] },
      { label: 'Risk', requires: ['hasArchitectureRiskSignal'] },
      { label: 'Action', requires: ['hasRecommendations'] }
    ],
    exportLabel: 'Export architecture preset',
    exportMetrics: ['out-relAdjustedCost', 'out-relFailureCost', 'out-relRiskBand', 'out-aiAllocatedCost', 'out-aiCostPerClient', 'out-aiTokenCost', 'out-focusMaturity']
  },
  executive: {
    mode: 'operator',
    recommendationCategory: 'all',
    featureProfile: 'executive-summary',
    personaLabel: 'Executive',
    summary: 'As Executive, keep a concise KPI story with risk-adjusted cost and cross-domain recommendations for decision review.',
    outcomePreview: ['Portfolio health narrative', 'Reliability downside view', 'Decision-ready readout'],
    nextStep: 'Enter the two core inputs first, then scan guided path and export a board-ready snapshot.',
    kpiHelper: 'Executive first: concise KPI narrative prioritizing reliability-adjusted cost, risk band, variance, and margin-sensitive metrics.',
    recommendationHelper: 'Recommendation emphasis: high-priority cross-domain actions are surfaced first for decision review.',
    recommendationWeights: { all: 0, infrastructure: 1, pricing: 2, governance: 3, crm: 4, marketing: 5 },
    kpiOrder: ['out-forecastBand', 'out-relAdjustedCost', 'out-relRiskBand', 'out-budgetVariance', 'out-margin', 'out-ccer', 'out-realizationRatio', 'out-techNorm', 'out-aiCostPerClient'],
    guidedSteps: [
      { label: 'Narrative', requires: ['hasInfraInput', 'hasARPU'] },
      { label: 'Risk', requires: ['hasExecutiveRiskSignal'] },
      { label: 'Readout', requires: ['hasQbvRows'] }
    ],
    exportLabel: 'Export executive preset',
    exportMetrics: ['out-forecastBand', 'out-relAdjustedCost', 'out-relRiskBand', 'out-budgetVariance', 'out-margin', 'out-realizationRatio', 'out-techNorm']
  }
};
const SHAREABLE_INPUT_KEYS = [
  'nRef', 'currency', 'devPerClient', 'infraTotal', 'ARPU',
  'startupTargetPrice', 'startupTargetClients',
  'cudPct', 'margin', 'nMax',
  'budgetMonthly', 'forecastGrowthPct', 'forecastBestEfficiencyPct', 'forecastWorstDriftPct',
  'savingsIdentified', 'savingsRealized', 'costAvoidance',
  'costSaaS', 'costLicensing', 'costPrivateCloud', 'costDataCenter', 'costLabor',
  'aiEnabled', 'aiPricingMode', 'aiRatePer1MInput', 'aiRatePer1MOutput', 'aiRatePer1MTotal',
  'aiInputTokensM', 'aiOutputTokensM', 'aiRetryRatePct', 'aiPremiumMixPct',
  'aiSharedOverheadMonthly', 'aiAllocationPolicy',
  'reliabilityEnabled', 'sloTargetAvailabilityPct', 'sliObservedAvailabilityPct',
  'incidentCountMonthly', 'mttrHours', 'incidentBlendedHourlyRate',
  'criticalRevenuePerMinute', 'arrExposedMonthly',
  'slaPenaltyRatePerBreachPointMonthly', 'reliabilityInvestmentMonthly'
];
const SHAREABLE_CURVE_KEYS = ['dev', 'infra-raw', 'infra-cud', 'total', 'total-rel', 'revenue', 'profit', 'profit-rel', 'price-min'];
const TECH_DOMAIN_SCHEMA = [
  { key: 'cloud', inputKey: 'infraTotal', label: 'Cloud', focusDimension: 'Cloud IaaS/PaaS' },
  { key: 'saas', inputKey: 'costSaaS', label: 'SaaS', focusDimension: 'Software subscriptions' },
  { key: 'licensing', inputKey: 'costLicensing', label: 'Licensing', focusDimension: 'License commitments' },
  { key: 'private-cloud', inputKey: 'costPrivateCloud', label: 'Private Cloud', focusDimension: 'Private platform spend' },
  { key: 'data-center', inputKey: 'costDataCenter', label: 'Data Center', focusDimension: 'Facility-backed infra' },
  { key: 'labor', inputKey: 'costLabor', label: 'Labor', focusDimension: 'People cost overlay' }
];
const DEFAULT_TECH_DOMAINS = ['cloud'];
const VALID_TECH_DOMAIN_KEYS = TECH_DOMAIN_SCHEMA.map(item => item.key);
let shareFeedbackTimer = null;
const mcpModalEl = document.getElementById('mcp-modal');
const mcpModalDialogEl = mcpModalEl ? mcpModalEl.querySelector('.mcp-modal-dialog') : null;
let outputSolveModalEl = null;
let outputSolveDialogEl = null;
let outputSolveTitleEl = null;
let outputSolveBodyEl = null;
let outputSolveAudienceEl = null;
let outputSolveActiveCardId = null;
let outputSolveAudienceMode = 'founder';
const mcpModalOpeners = Array.from(document.querySelectorAll('[data-mcp-open]'));
const chartSectionFocusEl = document.getElementById('chart-section');
const chartFocusToggleBtnEl = document.getElementById('chart-focus-btn');
const chartFocusToggleTextEl = chartFocusToggleBtnEl ? chartFocusToggleBtnEl.querySelector('.chart-focus-btn-text') : null;
const chartFocusCloseBtnEl = document.getElementById('chart-focus-close');
const qbvDashboardEl = document.getElementById('qbv-dashboard');
const qbvFocusToggleBtnEl = document.getElementById('qbv-focus-btn');
const qbvFocusToggleTextEl = document.getElementById('qbv-focus-btn-text');
const qbvFocusCloseBtnEl = document.getElementById('qbv-focus-close');
const qbvExportBtnEl = document.getElementById('qbv-export-csv');
let lastMcpModalTrigger = null;
let lastChartFocusTrigger = null;
let lastQbvFocusTrigger = null;
let restoreChartFocusOnExit = false;
let restoreQbvFocusOnExit = false;
let qbvDashboardRows = [];
const OUTPUT_TOOLTIP_CONTENT = {
  'out-beN': {
    title: 'Break-Even Clients',
    what: 'This shows the first client volume where the model turns sustainable (revenue meets/exceeds total monthly cost).',
    how: [
      'Model scans client counts and finds the first <code>n</code> where <code>Revenue(n) >= TotalCost(n)</code>.',
      '<code>Revenue(n) = ARPU × n</code> (manual ARPU or startup-derived ARPU).',
      '<code>TotalCost(n) = DevCost(n) + InfraCost(n)</code>.'
    ]
  },
  'out-minPrice': {
    title: 'Minimum Price per Client',
    what: 'This is the minimum monthly unit price needed at current scale to recover cost and hit target margin.',
    how: [
      'Calculated at current client count <code>n</code> (or default estimate when n is missing).',
      '<code>MinPrice(n) = (TotalCost(n) / n) × (1 + margin)</code>.',
      'If ARPU is below this number, margin pressure appears.'
    ]
  },
  'out-vcpu': {
    title: 'VCPU at n',
    what: 'This is variable cloud cost per client at the current scale.',
    how: [
      'Uses current infra cost curve at selected <code>n</code>.',
      '<code>VCPU = InfraCost(n) / n</code>.',
      'It is used directly in contribution margin and break-even logic.'
    ]
  },
  'out-margin': {
    title: 'Contribution Margin',
    what: 'This shows unit economics headroom per client after variable cloud cost.',
    how: [
      '<code>ContributionMargin = ARPU − VCPU</code>.',
      'Positive margin means each additional client contributes toward fixed+growth costs.',
      'Negative margin means each new client currently destroys margin.'
    ]
  },
  'out-ccer': {
    title: 'CCER at n',
    what: 'Cloud Cost Efficiency Ratio compares generated revenue against modeled infrastructure spend at the same scale.',
    how: [
      '<code>CCER = Revenue / InfraCost</code>.',
      '<code>Revenue = ARPU × n</code>.',
      'A common benchmark is <code>> 3×</code> for healthy cloud efficiency.'
    ]
  },
  'out-cudSave': {
    title: 'CUD Monthly Saving',
    what: 'Estimated monthly savings from commitment discounts versus on-demand infra pricing.',
    how: [
      '<code>Saving = InfraOnDemand(n) − InfraWithCUD(n)</code>.',
      'Infra with CUD uses your discount % input through commitment factor <code>γ</code>.',
      'Higher discounts and larger scale usually increase this saving.'
    ]
  },
  'out-reqClients': {
    title: 'Required Clients @ Target Price',
    what: 'Given Option A target price, this estimates how many clients are needed to become viable.',
    how: [
      'Model scans upward and finds smallest <code>n</code> where <code>MinPrice(n) <= TargetPrice</code>.',
      'Uses your current cost calibration + margin target.',
      'If not reachable in range, it returns a warning threshold.'
    ]
  },
  'out-reqPrice': {
    title: 'Required Price @ Target Clients',
    what: 'Given Option B target clients, this is the minimum viable unit price.',
    how: [
      'Computed directly at your target client count.',
      '<code>RequiredPrice = MinPrice(targetClients)</code>.',
      'This helps validate go-to-market price assumptions.'
    ]
  },
  'out-targetRevenue': {
    title: 'Target Monthly Revenue',
    what: 'This is the monthly revenue level implied by your startup planning assumptions.',
    how: [
      'If both target price and target clients are provided: <code>RevenueTarget = price × clients</code>.',
      'If only one startup option is provided, missing value is derived from model first.',
      'Reflects the current calibration of cost, scale, and margin settings.'
    ]
  },
  'out-budgetVariance': {
    title: 'Budget Variance',
    what: 'Compares your modeled monthly technology cost against the declared monthly budget to show headroom or overrun.',
    how: [
      'Budget basis uses selected-domain monthly scope when available, otherwise modeled core cost.',
      '<code>Variance = Budget - ModeledCost</code>. Positive = headroom, negative = overrun.',
      'Variance % is normalized by budget to make periods comparable.'
    ]
  },
  'out-forecastBand': {
    title: 'Forecast Margin Band',
    what: 'Shows baseline, best-case, and worst-case monthly margin for the next cycle using your forecast assumptions.',
    how: [
      'Forecast client count: <code>n_f = n × (1 + growth%)</code>.',
      'Baseline margin: <code>Revenue(n_f) - Cost(n_f)</code>.',
      'Best/Worst margins apply your efficiency and drift assumptions to forecast cost.'
    ]
  },
  'out-forecastSpread': {
    title: 'Forecast Confidence Band',
    what: 'Quantifies uncertainty by measuring the spread between best and worst scenarios.',
    how: [
      '<code>Spread = BestMargin - WorstMargin</code>.',
      'Spread is also expressed as % of forecast revenue for comparability.',
      'Narrower spread indicates stronger confidence in expected value realization.'
    ]
  },
  'out-realizedValue': {
    title: 'Total Realized Value',
    what: 'Represents value captured this cycle by combining realized savings and cost avoidance.',
    how: [
      '<code>TotalRealized = RealizedSavings + CostAvoidance</code>.',
      'Realized savings = value already captured in spend run-rate.',
      'Cost avoidance = value prevented before spend occurred (shift-left decisions).'
    ]
  },
  'out-realizationRatio': {
    title: 'Savings Realization Ratio',
    what: 'Tracks execution effectiveness by comparing total realized value against identified savings target.',
    how: [
      '<code>RealizationRatio = TotalRealized / IdentifiedSavings</code>.',
      'Above 100% means value captured exceeds identified target for the cycle.',
      'Low ratio indicates delivery gap between planning and realized outcomes.'
    ]
  },
  'out-realizationGap': {
    title: 'Residual Value Gap',
    what: 'Shows how much value remains to be realized (or whether target has been exceeded).',
    how: [
      '<code>ResidualGap = IdentifiedSavings - TotalRealized</code>.',
      'Positive gap = pending realization; negative gap = exceeded target.',
      'Use with realization ratio to prioritize follow-up actions.'
    ]
  },
  'out-techCoverage': {
    title: 'Coverage Across Domains',
    what: 'Shows completeness of your selected scope (single or multi-domain).',
    how: [
      'Coverage = <code>domains with cost in selected scope / selected domains</code>.',
      'You can keep one domain selected (single-focus mode) or many (portfolio mode).',
      'Higher scoped coverage improves reliability of downstream normalization signals.'
    ],
    refs: [
      { label: 'Composite indicators (JRC)', url: COMPOSITE_INDEX_REFERENCE_URL }
    ]
  },
  'out-techNorm': {
    title: 'Normalized Tech Cost / Client',
    what: 'Aggregates selected-domain monthly technology costs into one comparable per-client metric.',
    how: [
      '<code>NTC/client = Σ(αᵈ × Cᵈ) / n</code>.',
      '<code>Cᵈ</code> is monthly cost for domain d, and <code>n</code> is client count.',
      '<strong>Financial Truth mode (recommended):</strong> <code>αᵈ ∈ {0,1}</code> based on scope selection (in/out).',
      '<strong>Priority Index mode (optional):</strong> use <code>Σwᵈ=1</code> with policy bands — Cloud 0.25–0.45, SaaS 0.15–0.30, Licensing 0.08–0.20, Private Cloud 0.05–0.20, Data Center 0.03–0.15, Labor 0.08–0.20.',
      'Balanced default profile: Cloud 0.35, SaaS 0.20, Licensing 0.12, Private Cloud 0.13, Data Center 0.08, Labor 0.12.'
    ],
    refs: [
      { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
    ]
  },
  'out-focusMaturity': {
    title: 'Normalization Confidence',
    what: 'Indicates how reliable cross-domain comparisons are based on completeness and quality of the current inputs.',
    how: [
      'Confidence tier depends on domain coverage and whether non-cloud categories are represented.',
      '<code>High</code>: broad domain coverage + non-cloud spend present.',
      '<code>Medium/Low</code>: partial or cloud-only coverage; more domain data needed.'
    ],
    refs: [
      { label: 'State of FinOps report', url: FINOPS_2026_REPORT_URL }
    ]
  },
  'out-aiTokenCost': {
    title: 'AI Token Cost',
    what: 'Monthly AI inference spend from token consumption and selected pricing model.',
    how: [
      '<code>TokenCost = (InputTokens × InputRate) + (OutputTokens × OutputRate)</code> (or blended equivalent).',
      'Retry rate and premium model mix increase effective token burn.',
      'Use this metric to control direct model spend before overhead allocation.'
    ],
    refs: [
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
      { label: 'OpenAI rate-limit guidance', url: OFFICIAL_REFERENCE_URLS.openaiRateLimits }
    ]
  },
  'out-aiAllocatedCost': {
    title: 'AI Total Allocated Cost',
    what: 'AI token cost plus shared overhead allocated to product/client context.',
    how: [
      '<code>AIAllocatedCost = TokenCost + SharedOverheadAllocation</code>.',
      'Allocation policy controls how overhead distribution is applied.',
      'Use this metric for chargeback/showback and margin planning.'
    ],
    refs: [
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
      { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation }
    ]
  },
  'out-aiCostPerClient': {
    title: 'AI Cost / Client',
    what: 'Allocated AI cost normalized per active client for unit-economics decisions.',
    how: [
      '<code>AICostPerClient = AIAllocatedCost / n</code>.',
      'Compare this directly against ARPU to protect contribution margin.',
      'Use this metric to set AI pricing tiers and fair-use envelopes.'
    ],
    refs: [
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
      { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics }
    ]
  },
  'out-aiRetryInflation': {
    title: 'AI Retry Inflation',
    what: 'Extra AI cost percentage caused by retries compared to first-pass execution.',
    how: [
      '<code>RetryInflation% = (RetryDrivenTokenCost / BaseTokenCost) × 100</code>.',
      'High retry inflation indicates quality, timeout, or workflow reliability defects.',
      'Lower retry inflation directly improves AI margin profile.'
    ],
    refs: [
      { label: 'OpenAI rate-limit guidance', url: OFFICIAL_REFERENCE_URLS.openaiRateLimits },
      { label: 'FinOps workload optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsWorkloadOptimization }
    ]
  },
  'out-aiPremiumMix': {
    title: 'AI Premium Mix',
    what: 'Share of AI requests routed to premium models with higher unit costs.',
    how: [
      '<code>PremiumMix% = PremiumRequests / TotalRequests × 100</code>.',
      'High premium mix raises weighted cost per request and per-client cost.',
      'Use routing policy to reserve premium models for high-value workloads.'
    ],
    refs: [
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
      { label: 'FinOps rate optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsRateOptimization }
    ]
  },
  'out-relDowntime': {
    title: 'Expected Downtime',
    what: 'Estimates monthly downtime minutes from observed availability for reliability cost modeling.',
    how: [
      '<code>ExpectedDowntimeMinutes = (1 - SLI_observed) × minutes_in_month</code>.',
      'SLI observed availability is interpreted as operational outcome for the selected period.',
      'Used downstream by revenue-at-risk and reliability risk-band estimation.'
    ]
  },
  'out-relFailureCost': {
    title: 'Expected Reliability Failure Cost',
    what: 'Aggregates contract and operational loss exposure from reliability shortfalls.',
    how: [
      '<code>FailureCost = SLA penalty + incident labor + revenue at risk + churn-risk expectation</code>.',
      'Penalty cost uses SLO-SLI breach gap and your configured penalty rate override model.',
      'Each component is expressed as monthly total for planning and governance reviews.'
    ]
  },
  'out-relAdjustedCost': {
    title: 'Reliability-Adjusted Cost',
    what: 'Adds reliability investment and expected failure exposure to baseline modeled monthly cost.',
    how: [
      '<code>AdjustedCost = BaselineModeledCost + ReliabilityInvestment + ExpectedFailureCost</code>.',
      'Lets teams compare preventive spend with expected downside risk in one cost frame.',
      'Designed as additive overlay so baseline core economics remain intact when disabled.'
    ]
  },
  'out-relProfitImpact': {
    title: 'Reliability-Adjusted Profit / Loss',
    what: 'Shows monthly profit after reliability downside and reliability investment are included in the cost envelope.',
    how: [
      '<code>RelProfit = Revenue - ReliabilityAdjustedCost</code>.',
      'Revenue uses current ARPU and client count; adjusted cost includes baseline cost, reliability investment, and expected failure cost.',
      'Use this together with risk band to evaluate whether resilience spending improves risk-adjusted margin.'
    ]
  },
  'out-relArpuUplift': {
    title: 'ARPU Uplift Needed',
    what: 'Indicates how much additional ARPU per client is required to maintain margin target after reliability-adjusted cost is included.',
    how: [
      '<code>RequiredARPU_with_rel = (ReliabilityAdjustedCost / n) × (1 + marginTarget)</code>.',
      '<code>ARPUUplift = max(0, RequiredARPU_with_rel - CurrentARPU)</code>.',
      'If uplift is near zero, current pricing already absorbs reliability downside at the target margin.'
    ]
  },
  'out-relExtraClients': {
    title: 'Extra Clients Needed @ Current ARPU',
    what: 'Estimates additional client volume needed when current ARPU is fixed and reliability-adjusted costs are included.',
    how: [
      'Scans client counts and finds first <code>n</code> where <code>CurrentARPU × n >= (BaseCost(n) + ReliabilityLoad) × (1 + marginTarget)</code>.',
      '<code>ExtraClients = max(0, RequiredClients_with_rel - CurrentClients)</code>.',
      'Useful when pricing changes are constrained and scale increase is the primary lever.'
    ]
  },
  'out-relRiskBand': {
    title: 'Reliability Risk Band',
    what: 'Classifies reliability pressure level from breach gap and downside share signals.',
    how: [
      'Risk is derived from breach gap and failure-cost share of adjusted cost envelope.',
      '<code>LOW</code>, <code>MEDIUM</code>, or <code>HIGH</code> supports policy and remediation triage.',
      'Used as decision signal, not as legal SLA interpretation.'
    ]
  },
  'out-relDataConfidence': {
    title: 'Reliability Data Confidence',
    what: 'Indicates confidence based on completeness of reliability and exposure inputs.',
    how: [
      'Confidence counts how many required reliability model inputs are populated.',
      '<code>HIGH</code> = richer data coverage; <code>LOW</code> = directional estimate only.',
      'Use confidence with risk band before committing major investment decisions.'
    ]
  }
};

const OUTPUT_ACTION_GUIDES = {
  'out-beN': {
    objective: 'Reach break-even at a client level your team can acquire sustainably.',
    recommended: [
      'Raise realized ARPU (packaging, upsell, annual plans) before scaling spend.',
      'Reduce monthly run-rate on infra and development burden to lower the break-even threshold.',
      'Use Startup Planning options to test target price vs target clients before commitments.'
    ],
    potential: [
      'Improve activation and retention so more leads convert into paying clients.',
      'Create tiered offers so high-value clients subsidize lower-entry plans.'
    ],
    monitor: ['Break-Even Clients', 'Contribution Margin', 'CCER at n'],
    inputs: ['Total Infra Cost', 'ARPU or Startup Planning input']
  },
  'out-minPrice': {
    objective: 'Keep your minimum viable price below market-acceptable pricing while preserving margin.',
    recommended: [
      'Lower cost drivers first (idle resources, over-provisioning, unused licences).',
      'Refine margin target if your current target is too aggressive for this growth phase.',
      'Re-check assumptions at realistic n so pricing decisions are not based on tiny sample sizes.'
    ],
    potential: [
      'Bundle premium features to justify higher ARPU where cost cannot drop quickly.',
      'Split plans by usage profile to avoid subsidizing high-usage clients.'
    ],
    monitor: ['Min. Price / Client', 'Contribution Margin', 'Required Price @ Target Clients'],
    inputs: ['Client Count (n)', 'Dev Cost', 'Infra Cost']
  },
  'out-vcpu': {
    objective: 'Bring variable cloud cost per client into a stable and predictable band.',
    recommended: [
      'Right-size compute and storage by workload profile.',
      'Apply autoscaling guardrails and schedule non-critical workloads.',
      'Reduce waste from cross-zone data transfer and duplicate services.'
    ],
    potential: [
      'Refactor heavy paths to cheaper managed services.',
      'Improve caching to cut repeated expensive calls.'
    ],
    monitor: ['VCPU at n', 'Contribution Margin', 'CCER at n'],
    inputs: ['Infra Cost', 'Client Count (n)']
  },
  'out-margin': {
    objective: 'Maintain positive unit contribution margin before chasing aggressive growth.',
    recommended: [
      'Increase ARPU through packaging, retention and expansion motions.',
      'Lower VCPU via optimization, commitment coverage, and platform efficiencies.',
      'Pause acquisition channels that bring low-value clients with poor unit economics.'
    ],
    potential: [
      'Introduce add-ons with high gross margin.',
      'Use customer segmentation to focus on profitable cohorts.'
    ],
    monitor: ['Contribution Margin', 'VCPU at n', 'Break-Even Clients'],
    inputs: ['ARPU or Startup Planning', 'Infra Cost']
  },
  'out-ccer': {
    objective: 'Move cloud efficiency toward or above benchmark range (commonly > 3x).',
    recommended: [
      'Prioritize cost optimization on top cloud services by spend concentration.',
      'Improve monetization per workload (pricing, product usage, expansion).',
      'Use CUD/Savings Plans where demand is predictable.'
    ],
    potential: [
      'Shift low-value workloads to lower-cost classes or regions where acceptable.',
      'Implement spend alerts tied to revenue movement.'
    ],
    monitor: ['CCER at n', 'CUD Monthly Saving', 'Budget Variance'],
    inputs: ['ARPU', 'Infra Cost']
  },
  'out-cudSave': {
    objective: 'Capture more commitment-discount value without over-committing risk.',
    recommended: [
      'Increase commitment coverage only on stable baseline workloads.',
      'Review discount assumptions against actual provider offers and term lengths.',
      'Track realized vs expected commitment savings monthly.'
    ],
    potential: [
      'Use blended commitment portfolios across compute families.',
      'Negotiate enterprise discount programs if usage volume qualifies.'
    ],
    monitor: ['CUD Monthly Saving', 'CCER at n', 'Budget Variance'],
    inputs: ['CUD %', 'Infra Cost']
  },
  'out-reqClients': {
    objective: 'Validate whether target price is realistic for your acquisition capacity.',
    recommended: [
      'If required clients are too high, reduce cost or increase target price.',
      'Compare required clients to your funnel conversion baseline.',
      'Run scenarios with conservative and optimistic growth assumptions.'
    ],
    potential: [
      'Boost conversion through onboarding and trial optimization.',
      'Prioritize channels with stronger CAC payback at current margin.'
    ],
    monitor: ['Required Clients @ Target Price', 'Break-Even Clients', 'Target Monthly Revenue'],
    inputs: ['Startup Target Price', 'Cost inputs']
  },
  'out-reqPrice': {
    objective: 'Set a target price that keeps the model viable at your planned client volume.',
    recommended: [
      'If required price is above market tolerance, lower cost envelope first.',
      'Revisit margin target for your current maturity stage.',
      'Test multiple pricing structures (flat, tiered, usage-based).'
    ],
    potential: [
      'Use value-based packaging to justify higher plans for advanced segments.',
      'Offer annual commitments with incentives to improve realized ARPU.'
    ],
    monitor: ['Required Price @ Target Clients', 'Min. Price / Client', 'Contribution Margin'],
    inputs: ['Startup Target Clients', 'Cost inputs']
  },
  'out-targetRevenue': {
    objective: 'Use target revenue as an execution goal tied to feasible pricing and acquisition assumptions.',
    recommended: [
      'Break the monthly target into weekly funnel and retention goals.',
      'Validate if target revenue supports required cost and margin trajectory.',
      'Track leading indicators (pipeline, conversion, churn) against this target.'
    ],
    potential: [
      'Create scenario-specific GTM plans for best/base/worst paths.',
      'Attach owner and cadence for revenue target review.'
    ],
    monitor: ['Target Monthly Revenue', 'Required Clients @ Target Price', 'Contribution Margin'],
    inputs: ['Startup Planning options', 'Cost inputs']
  },
  'out-budgetVariance': {
    objective: 'Move from overrun to controllable variance with explicit budget guardrails.',
    recommended: [
      'Freeze or defer non-critical spend while root-cause analysis is running.',
      'Segment variance by domain (cloud, SaaS, licensing, etc.) to isolate drivers.',
      'Set threshold alerts and owner accountability for each cost domain.'
    ],
    potential: [
      'Adopt rolling forecasts to avoid end-of-cycle surprises.',
      'Negotiate contract renewals before annual true-up windows.'
    ],
    monitor: ['Budget Variance', 'Forecast Margin Band', 'Coverage Across Domains'],
    inputs: ['Monthly Budget', 'In-scope domain costs']
  },
  'out-forecastBand': {
    objective: 'Reduce downside risk and improve forecasted margin resilience.',
    recommended: [
      'Validate growth and efficiency assumptions against recent trend data.',
      'Prepare mitigation actions for worst-case margin path in advance.',
      'Use best/base/worst planning in monthly operating reviews.'
    ],
    potential: [
      'Run sensitivity tests on top two cost drivers.',
      'Create trigger rules that switch to cost-containment mode early.'
    ],
    monitor: ['Forecast Margin Band', 'Forecast Confidence Band', 'Budget Variance'],
    inputs: ['Forecast Growth %', 'Best Efficiency %', 'Worst Drift %']
  },
  'out-forecastSpread': {
    objective: 'Narrow uncertainty spread to improve confidence in expected outcomes.',
    recommended: [
      'Improve data quality and refresh assumptions more frequently.',
      'Prioritize initiatives that reduce volatility in top spend categories.',
      'Treat wide spread as a risk signal and attach contingency actions.'
    ],
    potential: [
      'Use shorter forecasting cycles in periods of high change.',
      'Benchmark forecast error against prior cycles.'
    ],
    monitor: ['Forecast Confidence Band', 'Forecast Margin Band', 'Normalization Confidence'],
    inputs: ['Forecast assumptions', 'Reliable ARPU and cost baselines']
  },
  'out-realizedValue': {
    objective: 'Increase value captured in-cycle from delivered FinOps actions.',
    recommended: [
      'Track savings and cost avoidance separately to avoid double counting.',
      'Link each optimization initiative to verified realized value evidence.',
      'Close execution gaps by assigning owners and due dates per initiative.'
    ],
    potential: [
      'Prioritize high-confidence, high-impact actions first.',
      'Publish monthly value capture scorecards for leadership review.'
    ],
    monitor: ['Total Realized Value', 'Savings Realization Ratio', 'Residual Value Gap'],
    inputs: ['Savings Identified', 'Savings Realized', 'Cost Avoidance']
  },
  'out-realizationRatio': {
    objective: 'Push realization ratio toward or above target by improving delivery throughput.',
    recommended: [
      'Review delayed actions and remove blockers in execution workflow.',
      'Re-prioritize to initiatives with faster value realization windows.',
      'Validate identified savings baseline if ratio is distorted by poor scoping.'
    ],
    potential: [
      'Add interim checkpoints and value verification gates.',
      'Use category-level realization targets to avoid aggregate blind spots.'
    ],
    monitor: ['Savings Realization Ratio', 'Total Realized Value', 'Residual Value Gap'],
    inputs: ['Savings Identified', 'Realized and avoided value']
  },
  'out-realizationGap': {
    objective: 'Close remaining value gap through targeted follow-up actions.',
    recommended: [
      'Focus on unexecuted or underperforming initiatives first.',
      'Convert large unresolved gaps into a dated action backlog.',
      'Escalate blockers where gap persists across cycles.'
    ],
    potential: [
      'Re-baseline target if original identified savings was materially inaccurate.',
      'Replicate successful actions from areas with strong realization.'
    ],
    monitor: ['Residual Value Gap', 'Savings Realization Ratio', 'Total Realized Value'],
    inputs: ['Savings Identified', 'Savings Realized', 'Cost Avoidance']
  },
  'out-techCoverage': {
    objective: 'Increase selected-domain coverage so normalized indicators remain decision-grade.',
    recommended: [
      'Fill missing cost inputs for all selected domains in scope.',
      'Expand from cloud-only to multi-domain view when portfolio decisions require it.',
      'Treat low-coverage snapshots as directional, not final.'
    ],
    potential: [
      'Adopt a recurring data collection cadence per domain owner.',
      'Set minimum coverage thresholds before executive reporting.'
    ],
    monitor: ['Coverage Across Domains', 'Normalization Confidence', 'Normalized Tech Cost / Client'],
    inputs: ['techDomains selection', 'Domain monthly costs']
  },
  'out-techNorm': {
    objective: 'Use normalized cost as a cross-domain comparability anchor, not just a raw total.',
    recommended: [
      'Confirm scope selection reflects what you want to compare.',
      'Increase domain completeness to improve confidence in normalized value.',
      'Use per-client normalized trend over time, not one isolated snapshot.'
    ],
    potential: [
      'Compare normalized cost across business units or products.',
      'Introduce policy thresholds for acceptable normalized ranges.'
    ],
    monitor: ['Normalized Tech Cost / Client', 'Coverage Across Domains', 'Normalization Confidence'],
    inputs: ['Client count n', 'In-scope domain costs']
  },
  'out-focusMaturity': {
    objective: 'Raise confidence tier by improving completeness and balance of in-scope inputs.',
    recommended: [
      'Add non-cloud domain costs where currently missing.',
      'Increase selected-scope coverage before relying on cross-domain comparisons.',
      'Document assumptions used for missing values and retire them as data matures.'
    ],
    potential: [
      'Move to recurring governance reviews for input quality.',
      'Track confidence trend as a KPI for FinOps data maturity.'
    ],
    monitor: ['Normalization Confidence', 'Coverage Across Domains', 'Budget Variance'],
    inputs: ['Domain completeness', 'Scope balance across cloud and non-cloud costs']
  },
  'out-aiTokenCost': {
    objective: 'Keep AI token spend predictable and aligned to workload value.',
    recommended: [
      'Review model pricing tables and enforce token budgets by workflow.',
      'Monitor token-volume growth against realized revenue contribution.',
      'Set alert thresholds for sudden token-cost spikes.'
    ],
    potential: ['Adopt routing policies for high-cost prompts.', 'Shift repetitive prompts to lower-cost templates.'],
    monitor: ['AI Token Cost', 'AI Total Allocated Cost', 'AI Cost / Client'],
    inputs: ['AI token rates', 'AI token volumes', 'Retry and premium mix assumptions']
  },
  'out-aiAllocatedCost': {
    objective: 'Improve AI cost attribution so chargeback/showback stays auditable.',
    recommended: [
      'Standardize allocation policy and apply it consistently across teams.',
      'Validate shared overhead assumptions against actual platform invoices.',
      'Track allocation confidence as a control KPI.'
    ],
    potential: ['Move toward policy-backed allocation governance.', 'Review allocation drift each month-close cycle.'],
    monitor: ['AI Total Allocated Cost', 'AI Cost / Client', 'Normalization Confidence'],
    inputs: ['Shared AI overhead', 'Allocation policy', 'Client baseline n']
  },
  'out-aiCostPerClient': {
    objective: 'Keep AI unit cost sustainable relative to ARPU.',
    recommended: [
      'Compare AI cost/client to ARPU and enforce margin-safe thresholds.',
      'Adjust pricing or usage entitlements for AI-heavy customer segments.',
      'Reduce expensive prompt patterns before scaling AI adoption.'
    ],
    potential: ['Introduce AI tiering by usage intensity.', 'Use fair-use envelopes tied to package level.'],
    monitor: ['AI Cost / Client', 'Contribution Margin', 'ARPU Uplift Needed'],
    inputs: ['ARPU or startup-derived ARPU', 'AI allocated cost', 'Client count n']
  },
  'out-aiRetryInflation': {
    objective: 'Reduce avoidable retry-driven AI spend.',
    recommended: [
      'Set retry budgets and maximum retries per workflow.',
      'Instrument failure reasons and eliminate prompt/timeout defects.',
      'Track retry inflation trend as an engineering quality signal.'
    ],
    potential: ['Introduce request validation before model call.', 'Use fallback flows for known failure classes.'],
    monitor: ['AI Retry Inflation', 'AI Token Cost', 'AI Cost / Client'],
    inputs: ['Retry rate %', 'Token usage telemetry', 'Workflow error tracking']
  },
  'out-aiPremiumMix': {
    objective: 'Keep premium-model usage aligned to high-value use cases.',
    recommended: [
      'Route low-complexity requests to lower-cost models by policy.',
      'Reserve premium models for high-risk or high-value decisions.',
      'Review premium-mix drift in monthly FinOps governance reviews.'
    ],
    potential: ['Implement confidence-based routing logic.', 'A/B test quality vs cost for model tiers.'],
    monitor: ['AI Premium Mix', 'AI Token Cost', 'AI Cost / Client'],
    inputs: ['Premium mix %', 'Routing policy', 'Model cost cards']
  },
  'out-relDowntime': {
    objective: 'Reduce expected downtime to protect revenue and trust.',
    recommended: [
      'Improve incident response speed and reliability engineering backlog discipline.',
      'Review SLI measurement quality and SLO target realism.',
      'Prioritize reliability controls for highest business-impact services.'
    ],
    potential: ['Use error-budget policy for release pacing.', 'Harden observability and alert quality.'],
    monitor: ['Expected Downtime', 'Reliability Risk Band', 'Expected Reliability Failure Cost'],
    inputs: ['Observed SLI', 'Incident count', 'MTTR']
  },
  'out-relFailureCost': {
    objective: 'Shrink expected monthly downside from reliability failures.',
    recommended: [
      'Quantify and reduce top contributors (penalties, labor, revenue-at-risk, churn-risk).',
      'Increase preventive controls where expected downside exceeds investment cost.',
      'Re-baseline breach assumptions with current service behavior.'
    ],
    potential: ['Separate customer-impact severity tiers.', 'Track failure-cost trend by service line.'],
    monitor: ['Expected Reliability Failure Cost', 'Reliability-Adjusted Cost', 'Reliability Risk Band'],
    inputs: ['SLO/SLI gap', 'Penalty assumptions', 'Revenue-at-risk and ARR exposure']
  },
  'out-relAdjustedCost': {
    objective: 'Ensure resilience spend and downside exposure are visible in one cost frame.',
    recommended: [
      'Review adjusted cost against budget and margin guardrails before approval cycles.',
      'Balance preventive investment against expected failure burden.',
      'Track adjusted cost trend to validate resilience ROI.'
    ],
    potential: ['Run scenario comparisons with different investment levels.', 'Set governance threshold for acceptable adjusted-cost ratio.'],
    monitor: ['Reliability-Adjusted Cost', 'Budget Variance', 'Reliability-Adjusted Profit / Loss'],
    inputs: ['Reliability investment', 'Expected failure cost components', 'Baseline modeled cost']
  },
  'out-relProfitImpact': {
    objective: 'Maintain positive profitability after resilience and downside costs are included.',
    recommended: [
      'If adjusted profit is negative, evaluate pricing uplift and efficiency actions immediately.',
      'Prioritize reliability fixes with highest downside reduction per euro invested.',
      'Align growth plans with risk-adjusted margin constraints.'
    ],
    potential: ['Set risk-adjusted profit targets per quarter.', 'Add reliability ROI checkpoints to operating reviews.'],
    monitor: ['Reliability-Adjusted Profit / Loss', 'ARPU Uplift Needed', 'Extra Clients Needed @ Current ARPU'],
    inputs: ['ARPU', 'Reliability-adjusted cost', 'Client baseline n']
  },
  'out-relArpuUplift': {
    objective: 'Close pricing gap required to sustain target margin under reliability-adjusted costs.',
    recommended: [
      'Use packaging changes or value-based pricing to recover reliability-adjusted margin.',
      'Pair pricing changes with reliability improvements to support customer acceptance.',
      'Re-check target margin if uplift requirement exceeds market tolerance.'
    ],
    potential: ['Introduce resilience-linked service tiers.', 'Model phased pricing rollout for retention safety.'],
    monitor: ['ARPU Uplift Needed', 'Required Price @ Target Clients', 'Contribution Margin'],
    inputs: ['Current ARPU', 'Reliability-adjusted cost', 'Margin target']
  },
  'out-relExtraClients': {
    objective: 'Understand growth burden if pricing stays fixed while reliability-adjusted costs rise.',
    recommended: [
      'If extra-client gap is large, combine growth plan with pricing and cost actions.',
      'Use funnel conversion and retention assumptions to test achievability.',
      'Avoid growth-only strategy when unit economics remain structurally weak.'
    ],
    potential: ['Run acquisition-capacity stress tests.', 'Sequence growth initiatives by payback speed.'],
    monitor: ['Extra Clients Needed @ Current ARPU', 'Break-Even Clients', 'Target Monthly Revenue'],
    inputs: ['Current ARPU', 'Client count n', 'Reliability-adjusted cost envelope']
  },
  'out-relRiskBand': {
    objective: 'Move risk classification toward lower-risk operating posture.',
    recommended: [
      'Treat HIGH risk as immediate remediation queue with executive visibility.',
      'Reduce breach-gap and expected failure-cost share through targeted controls.',
      'Track risk-band movement after each remediation cycle.'
    ],
    potential: ['Set policy thresholds by service criticality.', 'Link risk-band transitions to release-governance gates.'],
    monitor: ['Reliability Risk Band', 'Expected Downtime', 'Expected Reliability Failure Cost'],
    inputs: ['SLO/SLI values', 'Incident profile', 'Risk exposure fields']
  },
  'out-relDataConfidence': {
    objective: 'Increase reliability-data quality before making major resilience commitments.',
    recommended: [
      'Populate missing reliability inputs to improve confidence tier.',
      'Validate incident and exposure data quality from source systems.',
      'Document assumption quality and retire placeholders quickly.'
    ],
    potential: ['Create reliability data dictionary with owners.', 'Automate monthly data-quality checks.'],
    monitor: ['Reliability Data Confidence', 'Reliability Risk Band', 'Reliability-Adjusted Cost'],
    inputs: ['Reliability input completeness', 'Exposure and penalty assumptions', 'Incident telemetry quality']
  }
};

const OUTPUT_PROVIDER_ACTION_OVERRIDES = {
  'out-vcpu': {
    aws: 'Use AWS Cost Explorer rightsizing recommendations and apply actions on top monthly-impact resources.',
    azure: 'Use Azure Advisor cost recommendations and remediate right-size or idle findings.',
    gcp: 'Use GCP Recommender cost recommendations and remove idle or oversized resources.',
    oci: 'Use OCI cost analysis views to right-size underutilized compute profiles.',
    ibm: 'Use IBM Cloud usage and billing reports to right-size persistent workloads.',
    onprem: 'Use virtualization and host telemetry to right-size VM clusters and reclaim unused capacity.'
  },
  'out-ccer': {
    aws: 'Use AWS Cost Optimization and rightsizing reports to lift revenue per cloud spend.',
    azure: 'Use Azure Cost Management plus Advisor findings to lift revenue per cloud spend.',
    gcp: 'Use Billing export and Recommender actions to lift revenue per cloud spend.',
    oci: 'Use OCI Billing and Cost Management reports to improve spend efficiency per workload.',
    ibm: 'Use IBM Cloud billing analytics to reduce non-value spend and improve efficiency ratio.',
    onprem: 'Use chargeback/showback and capacity telemetry to improve service revenue-to-cost efficiency.'
  },
  'out-cudSave': {
    aws: 'Review AWS Savings Plans recommendations and commit only to stable baseline usage.',
    azure: 'Review Azure Reservations recommendations and prioritize always-on workloads.',
    gcp: 'Review GCP committed-use discount recommendations for stable baseline workloads.',
    oci: 'Review OCI usage commitments and baseline workloads before increasing credit commitments.',
    ibm: 'Review IBM reserved capacity options for predictable long-running workloads.',
    onprem: 'Review long-run infrastructure leases and maintenance contracts against actual baseline demand.'
  }
};

function getPrimaryScopedProvider(providerScope = []) {
  const scoped = normalizeProviderKeys(providerScope).filter(provider => provider !== 'multi');
  if (scoped.length === 1) return scoped[0];
  return null;
}

function getProviderSpecificOutputAction(cardId, signalKey, providerScope = []) {
  if (signalKey === 'good' || signalKey === 'needs') return '';
  const primary = getPrimaryScopedProvider(providerScope);
  if (!primary) return '';
  const cardMap = OUTPUT_PROVIDER_ACTION_OVERRIDES[cardId] || null;
  if (!cardMap) return '';
  return cardMap[primary] || '';
}

const OUTPUT_AUDIENCE_MODES = {
  founder: {
    label: 'Founder',
    framing: 'Focus on viability, growth capacity, and fast corrective moves that protect runway.',
    sectionLabels: {
      recommended: 'Recommended moves',
      potential: 'Growth levers',
      monitor: 'Watch next',
      inputs: 'Decision inputs'
    }
  },
  cfo: {
    label: 'CFO',
    framing: 'Focus on margin protection, variance control, and finance-grade decision confidence.',
    sectionLabels: {
      recommended: 'Recommended controls',
      potential: 'Financial levers',
      monitor: 'Watch KPIs',
      inputs: 'Data required'
    }
  },
  engineer: {
    label: 'Engineer',
    framing: 'Focus on technical execution, efficiency drivers, and measurable remediation tasks.',
    sectionLabels: {
      recommended: 'Implementation steps',
      potential: 'Technical levers',
      monitor: 'Watch signals',
      inputs: 'Input integrity checks'
    }
  }
};

let activeOutputTipCard = null;
let outputTooltipPositionListenersBound = false;
let formulaTooltipPositionListenersBound = false;

function clearOutputCardTooltipPlacement(panel) {
  if (!panel) return;
  panel.classList.remove('tip-floating');
  panel.style.removeProperty('left');
  panel.style.removeProperty('top');
  panel.style.removeProperty('width');
  panel.style.removeProperty('max-height');
  panel.style.removeProperty('overflow-y');
}

function positionOutputCardTooltip(card) {
  if (!card || !card.classList.contains('tip-open')) return;
  const panel = card.querySelector('.calc-out-tip');
  const btn = card.querySelector('.calc-out-tip-btn');
  if (!panel || !btn) return;

  const viewportPadding = 10;
  const gap = 8;

  panel.classList.add('tip-floating');
  panel.style.maxHeight = '';
  panel.style.overflowY = '';

  const maxWidth = Math.max(220, Math.min(340, window.innerWidth - (viewportPadding * 2)));
  panel.style.width = `${maxWidth}px`;

  const btnRect = btn.getBoundingClientRect();
  const panelHeight = panel.offsetHeight;

  let top = btnRect.bottom + gap;
  if ((top + panelHeight) > (window.innerHeight - viewportPadding)) {
    top = btnRect.top - panelHeight - gap;
  }

  const maxHeight = Math.max(180, window.innerHeight - (viewportPadding * 2));
  if (panelHeight > maxHeight) {
    panel.style.maxHeight = `${maxHeight}px`;
    panel.style.overflowY = 'auto';
    if (top < viewportPadding) top = viewportPadding;
  }

  let left = btnRect.right - maxWidth;
  if (left < viewportPadding) left = viewportPadding;
  const maxLeft = window.innerWidth - maxWidth - viewportPadding;
  if (left > maxLeft) left = maxLeft;
  if (top < viewportPadding) top = viewportPadding;

  panel.style.left = `${Math.round(left)}px`;
  panel.style.top = `${Math.round(top)}px`;
}

function syncActiveOutputTooltipPlacement() {
  if (!activeOutputTipCard || !activeOutputTipCard.classList.contains('tip-open')) return;
  positionOutputCardTooltip(activeOutputTipCard);
}

function clearFormulaTooltipPlacement(card) {
  if (!card) return;
  const tip = card.querySelector('.ftip');
  if (!tip) return;
  tip.classList.remove('tip-floating');
  tip.style.removeProperty('left');
  tip.style.removeProperty('top');
  tip.style.removeProperty('width');
}

function positionFormulaTooltip(card) {
  if (!card || !card.classList.contains('active')) return;
  const tip = card.querySelector('.ftip');
  if (!tip) return;

  const viewportPadding = 10;
  const gap = 10;
  const cardRect = card.getBoundingClientRect();

  tip.classList.add('tip-floating');
  const maxWidth = Math.max(220, Math.min(320, window.innerWidth - (viewportPadding * 2)));
  tip.style.width = `${maxWidth}px`;

  const tipHeight = tip.offsetHeight;
  let placeBelow = cardRect.top < (window.innerHeight / 2);
  let top = placeBelow
    ? cardRect.bottom + gap
    : cardRect.top - tipHeight - gap;

  if (!placeBelow && top < viewportPadding) {
    placeBelow = true;
    top = cardRect.bottom + gap;
  }
  if (placeBelow && (top + tipHeight) > (window.innerHeight - viewportPadding)) {
    placeBelow = false;
    top = cardRect.top - tipHeight - gap;
  }
  if (top < viewportPadding) top = viewportPadding;

  let left = cardRect.left;
  const maxLeft = window.innerWidth - maxWidth - viewportPadding;
  if (left > maxLeft) left = maxLeft;
  if (left < viewportPadding) left = viewportPadding;

  card.classList.toggle('flip-down', placeBelow);
  tip.style.left = `${Math.round(left)}px`;
  tip.style.top = `${Math.round(top)}px`;
}

function syncActiveFormulaTooltipPlacement() {
  document.querySelectorAll('.formula-card.active').forEach(positionFormulaTooltip);
}

function ensureOutputSolutionPanel() {
  if (outputSolveModalEl) return;

  const wrapper = document.createElement('div');
  wrapper.className = 'calc-out-solve-modal';
  wrapper.id = 'calc-out-solve-modal';
  wrapper.setAttribute('aria-hidden', 'true');
  wrapper.innerHTML = `
    <div class="calc-out-solve-backdrop" data-output-solve-close></div>
    <div class="calc-out-solve-dialog" role="dialog" aria-modal="true" aria-labelledby="calc-out-solve-title" tabindex="-1">
      <button type="button" class="calc-out-solve-close" data-output-solve-close aria-label="Close guidance panel">×</button>
      <div class="calc-out-solve-kicker">Indicator action panel</div>
      <h3 class="calc-out-solve-title" id="calc-out-solve-title">How to address this indicator</h3>
      <div class="calc-out-solve-audience" id="calc-out-solve-audience"></div>
      <div id="calc-out-solve-body"></div>
    </div>
  `;

  document.body.appendChild(wrapper);
  outputSolveModalEl = wrapper;
  outputSolveDialogEl = wrapper.querySelector('.calc-out-solve-dialog');
  outputSolveTitleEl = wrapper.querySelector('#calc-out-solve-title');
  outputSolveBodyEl = wrapper.querySelector('#calc-out-solve-body');
  outputSolveAudienceEl = wrapper.querySelector('#calc-out-solve-audience');

  wrapper.addEventListener('click', event => {
    const audienceBtn = event.target.closest('[data-output-audience]');
    if (audienceBtn) {
      event.preventDefault();
      setOutputAudienceMode(audienceBtn.dataset.outputAudience);
      return;
    }
    if (!event.target.closest('[data-output-solve-close]')) return;
    closeOutputSolutionPanel();
  });
  if (outputSolveDialogEl) {
    outputSolveDialogEl.addEventListener('click', event => {
      if (event.target.closest('[data-output-solve-close]')) return;
      event.stopPropagation();
    });
  }

  renderOutputAudienceButtons();
}

function closeOutputSolutionPanel() {
  if (!outputSolveModalEl) return;
  outputSolveModalEl.classList.remove('open');
  outputSolveModalEl.setAttribute('aria-hidden', 'true');
  outputSolveActiveCardId = null;
}

function getOutputAudienceMode(mode) {
  return OUTPUT_AUDIENCE_MODES[mode] ? mode : 'founder';
}

function renderOutputAudienceButtons() {
  if (!outputSolveAudienceEl) return;
  outputSolveAudienceEl.innerHTML = Object.entries(OUTPUT_AUDIENCE_MODES).map(([key, cfg]) => `
    <button
      type="button"
      class="calc-out-solve-audience-btn ${key === outputSolveAudienceMode ? 'active' : ''}"
      data-output-audience="${key}"
      aria-pressed="${key === outputSolveAudienceMode ? 'true' : 'false'}"
    >${cfg.label}</button>
  `).join('');
}

function setOutputAudienceMode(mode) {
  const next = getOutputAudienceMode(mode);
  if (next === outputSolveAudienceMode) return;
  outputSolveAudienceMode = next;
  renderOutputAudienceButtons();
  if (outputSolveActiveCardId) {
    renderOutputSolutionPanel(outputSolveActiveCardId);
  }
}

function getOutputCardSignal(card) {
  if (!card) {
    return { key: 'needs', label: 'Data required', cls: 'needs' };
  }
  if (card.classList.contains('needs-data')) {
    return { key: 'needs', label: 'Data required', cls: 'needs' };
  }
  if (card.classList.contains('live-bad')) {
    return { key: 'bad', label: 'Action needed', cls: 'bad' };
  }
  if (card.classList.contains('live-warn')) {
    return { key: 'warn', label: 'Needs attention', cls: 'warn' };
  }
  if (card.classList.contains('live')) {
    return { key: 'good', label: 'Healthy signal', cls: 'good' };
  }
  return { key: 'needs', label: 'Review signal', cls: 'needs' };
}

function getOutputCardSeverityMeta(card) {
  const signal = getOutputCardSignal(card);
  if (signal.key === 'bad') return { rank: 0, key: 'critical', label: 'Critical' };
  if (signal.key === 'warn') return { rank: 1, key: 'high', label: 'High' };
  if (signal.key === 'needs') return { rank: 2, key: 'needs', label: 'Needs data' };
  if (signal.key === 'good') return { rank: 3, key: 'low', label: 'Low' };
  return { rank: 4, key: 'info', label: 'Info' };
}

function applyOutputCardSeverityBadge(card, severity) {
  if (!card || !severity) return;
  const labelEl = card.querySelector('.calc-out-label');
  if (!labelEl) return;

  let badgeEl = card.querySelector('.calc-out-severity-badge');
  if (!badgeEl) {
    badgeEl = document.createElement('span');
    badgeEl.className = 'calc-out-severity-badge';
    labelEl.insertAdjacentElement('afterend', badgeEl);
  }

  badgeEl.className = `calc-out-severity-badge severity-${severity.key}`;
  badgeEl.textContent = severity.label;
  badgeEl.setAttribute('aria-label', `Severity ${severity.label}`);
}

function clearOutputSeverityDividers(outputGrid) {
  if (!outputGrid) return;
  outputGrid.querySelectorAll(':scope > .calc-severity-divider').forEach(divider => divider.remove());
}

function getSeverityDividerLabel(severityKey, count) {
  const labelMap = {
    critical: 'Critical severity',
    high: 'High severity',
    needs: 'Needs data',
    low: 'Low severity',
    info: 'Info'
  };
  const base = labelMap[severityKey] || 'Severity';
  const safeCount = Number.isFinite(Number(count)) ? Number(count) : 0;
  return safeCount > 0 ? `${base} (${safeCount})` : base;
}

function createSeverityDivider(severityKey, count) {
  const divider = document.createElement('div');
  divider.className = `calc-severity-divider severity-${severityKey}`;

  const leftLine = document.createElement('span');
  leftLine.className = 'calc-severity-divider-line';

  const label = document.createElement('span');
  label.className = 'calc-severity-divider-label';
  label.textContent = getSeverityDividerLabel(severityKey, count);

  const rightLine = document.createElement('span');
  rightLine.className = 'calc-severity-divider-line';

  divider.appendChild(leftLine);
  divider.appendChild(label);
  divider.appendChild(rightLine);
  return divider;
}

function syncOutputCardSeverityAndOrder() {
  const outputGrid = document.getElementById('calc-kpi-output-grid');
  if (!outputGrid) return;
  clearOutputSeverityDividers(outputGrid);

  const cards = Array.from(outputGrid.querySelectorAll(':scope > .calc-out-card'));
  if (!cards.length) return;

  const withMeta = cards.map((card, index) => {
    const severity = getOutputCardSeverityMeta(card);
    applyOutputCardSeverityBadge(card, severity);
    const parsedRank = Number(card.dataset.intentRank);
    const intentRank = Number.isFinite(parsedRank) ? parsedRank : index;
    card.dataset.severityKey = severity.key;
    card.dataset.severityRank = String(severity.rank);
    return { card, severity, intentRank };
  });

  withMeta.sort((a, b) => {
    if (a.severity.rank !== b.severity.rank) return a.severity.rank - b.severity.rank;
    return a.intentRank - b.intentRank;
  });

  withMeta.forEach(({ card }) => {
    outputGrid.appendChild(card);
  });

  const visibleWithMeta = withMeta.filter(({ card }) => card.offsetParent !== null && !card.hidden);
  const groupOrder = [];
  const groupMap = new Map();
  visibleWithMeta.forEach((item) => {
    const key = item.severity.key;
    if (!groupMap.has(key)) {
      groupMap.set(key, []);
      groupOrder.push(key);
    }
    groupMap.get(key).push(item.card);
  });

  groupOrder.forEach((key) => {
    const groupCards = groupMap.get(key) || [];
    const firstCard = groupCards[0];
    if (!firstCard) return;
    const divider = createSeverityDivider(key, groupCards.length);
    outputGrid.insertBefore(divider, firstCard);
  });

  const helperEl = document.getElementById('calc-severity-helper');
  if (!helperEl) return;

  const visible = visibleWithMeta;
  const counters = { critical: 0, high: 0, needs: 0, low: 0 };
  visible.forEach(({ severity }) => {
    if (Object.prototype.hasOwnProperty.call(counters, severity.key)) counters[severity.key] += 1;
  });

  helperEl.innerHTML = `<strong>Severity order:</strong> Critical → High → Needs data → Low. Calculated from each card's computed status threshold (<code>live-bad</code>, <code>live-warn</code>, <code>needs-data</code>, <code>live</code>). Visible now: ${counters.critical} critical, ${counters.high} high, ${counters.needs} needs data, ${counters.low} low.`;
}

function buildActionList(items = []) {
  if (!items.length) {
    return '<ul class="calc-out-solve-list"><li>No specific actions yet. Use this as a review checkpoint.</li></ul>';
  }
  return `<ul class="calc-out-solve-list">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
}

function renderOutputSolutionPanel(cardId) {
  const card = document.getElementById(cardId);
  const config = OUTPUT_TOOLTIP_CONTENT[cardId];
  if (!card || !config) return;

  const guide = OUTPUT_ACTION_GUIDES[cardId] || {
    objective: 'Keep this indicator in a stable, decision-ready range.',
    recommended: ['Review the input assumptions used by this indicator.', 'Compare this signal against adjacent indicators for consistency.'],
    potential: ['Use scenario testing to evaluate alternative operating paths.'],
    monitor: ['Re-check this indicator after each assumption update.'],
    inputs: ['Relevant calculator assumptions for this metric']
  };

  const signal = getOutputCardSignal(card);
  const valueText = (card.querySelector('.calc-out-val') || {}).textContent || '—';
  const needsDataActions = (guide.inputs || []).map(item => `Provide ${item} to unlock reliable recommendations.`);
  const recommended = signal.key === 'needs' && needsDataActions.length ? needsDataActions : (guide.recommended || []);
  const refLinks = getOutputCardOfficialReferences(cardId, config.refs || [], getActiveProviderScope());
  const refsHtml = refLinks.length
    ? `<div class="calc-out-solve-refs"><div class="calc-out-solve-refs-title">Official references</div><div class="calc-out-solve-ref-links">${refLinks.map(ref => `<a class="calc-out-solve-ref-link" href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.label} ↗</a>`).join('')}</div></div>`
    : '';
  const audience = OUTPUT_AUDIENCE_MODES[getOutputAudienceMode(outputSolveAudienceMode)];
  const labels = audience.sectionLabels;

  outputSolveTitleEl.textContent = `${config.title} · How to address this?`;
  outputSolveBodyEl.innerHTML = `
    <div class="calc-out-solve-current">
      <span class="calc-out-solve-signal ${signal.cls}">${signal.label}</span>
      <span class="calc-out-solve-value">Current value: <strong>${valueText}</strong></span>
    </div>
    <p class="calc-out-solve-objective"><strong>Perspective:</strong> ${audience.label} — ${audience.framing}</p>
    <p class="calc-out-solve-objective"><strong>Goal:</strong> ${guide.objective}</p>
    <div class="calc-out-solve-grid">
      <section class="calc-out-solve-card">
        <div class="calc-out-solve-sub">${labels.recommended}</div>
        ${buildActionList(recommended)}
      </section>
      <section class="calc-out-solve-card">
        <div class="calc-out-solve-sub">${labels.potential}</div>
        ${buildActionList(guide.potential || [])}
      </section>
      <section class="calc-out-solve-card">
        <div class="calc-out-solve-sub">${labels.monitor}</div>
        ${buildActionList(guide.monitor || [])}
      </section>
      <section class="calc-out-solve-card">
        <div class="calc-out-solve-sub">${labels.inputs}</div>
        ${buildActionList(guide.inputs || [])}
      </section>
    </div>
    ${refsHtml}
  `;
  applyGlossaryAutoLinks(outputSolveBodyEl);
}

function openOutputSolutionPanel(cardId) {
  ensureOutputSolutionPanel();
  outputSolveActiveCardId = cardId;
  renderOutputAudienceButtons();
  renderOutputSolutionPanel(cardId);

  outputSolveModalEl.classList.add('open');
  outputSolveModalEl.setAttribute('aria-hidden', 'false');
  if (outputSolveDialogEl) outputSolveDialogEl.focus();
}

function normalizeTechDomainSelection(list) {
  const input = Array.isArray(list) ? list : [];
  const deduped = Array.from(new Set(input.filter(key => VALID_TECH_DOMAIN_KEYS.includes(key))));
  return deduped.length ? deduped : [...DEFAULT_TECH_DOMAINS];
}

// ─── TOGGLE ─────────────────────────────────────────────────────
function toggle(id) {
  const btn = document.getElementById(`btn-${id}`);
  if (!btn || btn.disabled) return;
  if (hidden.has(id)) {
    hidden.delete(id);
    if (paths[id]) paths[id].attr('opacity', 0.92);
    btn.classList.remove('off');
  } else {
    hidden.add(id);
    if (paths[id]) paths[id].attr('opacity', 0);
    btn.classList.add('off');
  }
}

function encodeShareState(payload) {
  try {
    const json = JSON.stringify(payload);
    const bytes = new TextEncoder().encode(json);
    let bin = '';
    bytes.forEach(b => { bin += String.fromCharCode(b); });
    return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  } catch (err) {
    return null;
  }
}

function decodeShareState(encoded) {
  try {
    const base = String(encoded || '').replace(/-/g, '+').replace(/_/g, '/');
    const padded = base + '='.repeat((4 - (base.length % 4)) % 4);
    const bin = atob(padded);
    const bytes = Uint8Array.from(bin, ch => ch.charCodeAt(0));
    const parsed = JSON.parse(new TextDecoder().decode(bytes));
    return (parsed && typeof parsed === 'object') ? parsed : null;
  } catch (err) {
    return null;
  }
}

function writeShareFeedback(message, isError = false) {
  const el = document.getElementById('share-feedback');
  if (!el) return;
  if (shareFeedbackTimer) {
    clearTimeout(shareFeedbackTimer);
    shareFeedbackTimer = null;
  }
  el.textContent = message || '';
  el.classList.toggle('error', !!isError);
  if (message) {
    shareFeedbackTimer = setTimeout(() => {
      el.textContent = '';
      el.classList.remove('error');
      shareFeedbackTimer = null;
    }, isError ? 5500 : 3200);
  }
}

function requestFeature(sourceSection) {
  const source = sourceSection || 'General';
  const issueBody = [
    '## Feedback source',
    '- Source type: internal',
    `- Source detail: ${source}`,
    '- Date captured: ',
    '',
    '## What was requested',
    '',
    '',
    '## Current workaround',
    '',
    '',
    '## Expected value if solved',
    '- [ ] Better usability',
    '- [ ] Better trust',
    '- [ ] Better economics accuracy',
    '- [x] Faster decisions',
    '- [ ] Other: ',
    '',
    '## Suggested next action',
    '- [ ] Close (not actionable)',
    '- [x] Convert to story',
    '- [ ] Needs research spike',
    '',
    '## Links',
    `- Page: ${window.location.origin}${window.location.pathname}`,
    `- Section: ${source}`
  ].join('\n');

  const params = new URLSearchParams({
    template: 'feedback.md',
    title: '[FEEDBACK] Feature Request: ',
    labels: 'type:feedback',
    body: issueBody
  });

  window.open(`https://github.com/duksh/finops-calculator/issues/new?${params.toString()}`, '_blank', 'noopener,noreferrer');
}

function getSelectedTechDomains() {
  const selected = VALID_TECH_DOMAIN_KEYS.filter(key => selectedTechDomains.has(key));
  return selected.length ? selected : [...DEFAULT_TECH_DOMAINS];
}

function syncTechDomainSelectionUi() {
  const selected = new Set(getSelectedTechDomains());
  const hiddenInput = document.getElementById('inp-techDomains');
  if (hiddenInput) hiddenInput.value = Array.from(selected).join(',');

  document.querySelectorAll('.tech-domain-chip').forEach(btn => {
    const domain = btn.dataset.domain;
    const isSelected = selected.has(domain);
    btn.classList.toggle('selected', isSelected);
    btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
  });

  const field = document.getElementById('field-techDomain');
  if (field) field.classList.toggle('has-value', selected.size > 0);
  USER_PROVIDED.techDomains = selected.size > 0;
}

function setTechDomainSelection(domains, recalcAfter = true) {
  const normalized = normalizeTechDomainSelection(domains);
  selectedTechDomains.clear();
  normalized.forEach(domain => selectedTechDomains.add(domain));
  syncTechDomainSelectionUi();
  if (recalcAfter) {
    recalculate();
    updateProgressPills();
  }
}

function toggleTechDomain(domain) {
  if (!VALID_TECH_DOMAIN_KEYS.includes(domain)) return;
  const next = new Set(getSelectedTechDomains());
  if (next.has(domain)) {
    if (next.size === 1) return;
    next.delete(domain);
  } else {
    next.add(domain);
  }
  setTechDomainSelection(Array.from(next));
}

function setTechDomainPreset(mode) {
  if (mode === 'all') {
    setTechDomainSelection(VALID_TECH_DOMAIN_KEYS);
    return;
  }
  setTechDomainSelection(DEFAULT_TECH_DOMAINS);
}

const AI_TOKEN_PRESETS = {
  balanced: {
    aiEnabled: 'on',
    aiPricingMode: 'blended',
    aiRatePer1MInput: 3,
    aiRatePer1MOutput: 9,
    aiRatePer1MTotal: 6,
    aiInputTokensM: 12,
    aiOutputTokensM: 8,
    aiRetryRatePct: 8,
    aiPremiumMixPct: 18,
    aiSharedOverheadMonthly: 1200,
    aiAllocationPolicy: 'token-weighted'
  },
  premiumSpike: {
    aiEnabled: 'on',
    aiPricingMode: 'tiered',
    aiRatePer1MInput: 4,
    aiRatePer1MOutput: 14,
    aiRatePer1MTotal: '',
    aiInputTokensM: 14,
    aiOutputTokensM: 11,
    aiRetryRatePct: 10,
    aiPremiumMixPct: 62,
    aiSharedOverheadMonthly: 1850,
    aiAllocationPolicy: 'premium-weighted'
  },
  retryStorm: {
    aiEnabled: 'on',
    aiPricingMode: 'tiered',
    aiRatePer1MInput: 3,
    aiRatePer1MOutput: 9,
    aiRatePer1MTotal: '',
    aiInputTokensM: 16,
    aiOutputTokensM: 10,
    aiRetryRatePct: 34,
    aiPremiumMixPct: 28,
    aiSharedOverheadMonthly: 1400,
    aiAllocationPolicy: 'token-weighted'
  }
};

function applyAiTokenPreset(presetKey) {
  const preset = AI_TOKEN_PRESETS[presetKey];
  if (!preset) return;

  Object.entries(preset).forEach(([fieldId, rawValue]) => {
    const input = document.getElementById(`inp-${fieldId}`);
    if (!input) return;
    input.value = String(rawValue);
    const filled = isMeaningfulInputValue(input, rawValue);
    USER_PROVIDED[fieldId] = filled;
    const fieldWrap = input.closest('.calc-field, .startup-field');
    if (fieldWrap) fieldWrap.classList.toggle('has-value', filled);
  });

  recalculate();
  updateProgressPills();
}

function applyFeatureGates() {
  const runtime = window.FiceCalFeatureRuntime;
  if (runtime && typeof runtime.applyDomGates === 'function') {
    runtime.applyDomGates(document);
  }
  syncScenarioDemoVisibility();
  syncFineTuneAreaIndicatorState();
  renderFeatureToggleControls();
}

function isFeatureRuntimeEnabled(featureId) {
  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime || typeof runtime.isFeatureEnabled !== 'function') return true;
  return runtime.isFeatureEnabled(featureId);
}

function syncFineTuneAreaIndicatorState() {
  document.querySelectorAll('.fine-tune-area-chip').forEach((chipEl) => {
    const featureId = chipEl.dataset.featureId;
    if (!featureId) {
      chipEl.classList.remove('is-disabled');
      chipEl.removeAttribute('data-feature-state');
      chipEl.removeAttribute('title');
      return;
    }

    const enabled = isFeatureRuntimeEnabled(featureId);
    const displayName = getFeatureDisplayName(featureId);
    chipEl.classList.toggle('is-disabled', !enabled);
    chipEl.setAttribute('data-feature-state', enabled ? 'enabled' : 'disabled');
    chipEl.title = enabled
      ? `${displayName} enabled`
      : `${displayName} disabled - enable in Feature controls`;
  });
}

function getFeatureDisplayName(featureId) {
  if (FEATURE_TOGGLE_LABELS[featureId]) return FEATURE_TOGGLE_LABELS[featureId];
  const runtime = window.FiceCalFeatureRuntime;
  const manifests = runtime && typeof runtime.getManifests === 'function' ? runtime.getManifests() : null;
  const manifestName = manifests && manifests[featureId] && manifests[featureId].name;
  return manifestName || featureId;
}

function syncScenarioDemoVisibility() {
  const reliabilityEnabled = isFeatureRuntimeEnabled('sla-slo-sli-economics');
  document.querySelectorAll('[data-scenario-group="reliability"]').forEach((el) => {
    el.hidden = !reliabilityEnabled;
  });

  const titleEl = document.getElementById('calc-scenario-title');
  if (titleEl) {
    titleEl.textContent = reliabilityEnabled ? 'Scenario demos (4 presets)' : 'Scenario demos (2 presets)';
  }

  const copyEl = document.getElementById('calc-scenario-copy');
  if (copyEl) {
    copyEl.textContent = reliabilityEnabled
      ? 'Load 1 of 4 curated states to compare baseline viability, downside stress, and Release 4 reliability healthy/unhealthy posture with the same model logic and outputs.'
      : 'Load 1 of 2 curated states to compare baseline viability and downside stress. Enable the Reliability module in Advanced tools to unlock the Release 4 reliability demos.';
  }
}

function renderFeatureToggleControls() {
  const listEl = document.getElementById('calc-feature-toggle-list');
  const summaryEl = document.getElementById('calc-feature-toggle-summary');
  const resetBtn = document.getElementById('calc-feature-reset-btn');
  if (!listEl) return;

  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime || typeof runtime.getCatalog !== 'function') {
    listEl.textContent = '';
    if (summaryEl) summaryEl.textContent = 'Feature runtime is unavailable in this environment.';
    if (resetBtn) resetBtn.hidden = true;
    return;
  }

  const catalog = runtime.getCatalog();
  const features = Array.isArray(catalog && catalog.features) ? catalog.features.slice() : [];
  const manifests = typeof runtime.getManifests === 'function' ? runtime.getManifests() : {};
  const enabledIds = typeof runtime.getEnabledFeatureIds === 'function' ? runtime.getEnabledFeatureIds() : [];
  const enabledSet = new Set(enabledIds);

  features.sort((a, b) => {
    const aIndex = FEATURE_TOGGLE_ORDER.indexOf(a && a.id);
    const bIndex = FEATURE_TOGGLE_ORDER.indexOf(b && b.id);
    const normalizedA = aIndex === -1 ? 999 : aIndex;
    const normalizedB = bIndex === -1 ? 999 : bIndex;
    if (normalizedA !== normalizedB) return normalizedA - normalizedB;
    return String(a && a.id || '').localeCompare(String(b && b.id || ''));
  });

  listEl.textContent = '';
  features.forEach((entry) => {
    if (!entry || !entry.id) return;
    const featureId = entry.id;
    const required = Boolean(entry.required);
    const manifest = manifests && manifests[featureId] ? manifests[featureId] : {};
    const modeScope = Array.isArray(manifest.uiModes) && manifest.uiModes.length
      ? manifest.uiModes.join(', ')
      : 'all modes';
    const checkboxId = `feature-toggle-${featureId.replace(/[^a-z0-9_-]/gi, '-')}`;

    const row = document.createElement('label');
    row.className = `calc-feature-toggle-item${required ? ' is-required' : ''}`;
    row.setAttribute('for', checkboxId);

    const main = document.createElement('span');
    main.className = 'calc-feature-toggle-main';

    const name = document.createElement('span');
    name.className = 'calc-feature-toggle-name';
    name.textContent = getFeatureDisplayName(featureId);

    const meta = document.createElement('span');
    meta.className = 'calc-feature-toggle-meta';
    meta.textContent = `${featureId} • modes: ${modeScope}`;

    main.appendChild(name);
    main.appendChild(meta);

    const control = document.createElement('span');
    control.className = 'calc-feature-toggle-control';

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = checkboxId;
    input.setAttribute('data-feature-toggle', featureId);
    input.checked = enabledSet.has(featureId);
    input.disabled = required;
    input.addEventListener('change', () => setFeatureToggle(featureId, input.checked));

    const pill = document.createElement('span');
    pill.className = 'calc-feature-toggle-pill';
    pill.textContent = required ? 'Required' : 'Optional';

    control.appendChild(input);
    control.appendChild(pill);

    row.appendChild(main);
    row.appendChild(control);
    listEl.appendChild(row);
  });

  if (summaryEl) {
    const optionalCount = features.filter((entry) => entry && !entry.required).length;
    summaryEl.textContent = `${enabledSet.size} modules active • ${optionalCount} optional modules can be toggled here.`;
  }

  if (resetBtn && typeof runtime.getFeatureOverrides === 'function') {
    const overrides = runtime.getFeatureOverrides() || {};
    resetBtn.hidden = Object.keys(overrides).length === 0;
  }
}

function openFeatureToggles(featureId) {
  const advancedEl = document.getElementById('calc-more-actions');
  if (advancedEl && !advancedEl.open) advancedEl.open = true;
  renderFeatureToggleControls();
  const listEl = document.getElementById('calc-feature-toggle-list');
  const selector = featureId ? `input[data-feature-toggle="${featureId}"]` : null;
  const target = selector && listEl ? listEl.querySelector(selector) : listEl;
  if (!target) return;
  target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  if (typeof target.focus === 'function') target.focus();
}

function setFeatureToggle(featureId, enabled) {
  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime || typeof runtime.setFeatureEnabled !== 'function') {
    writeShareFeedback('Feature toggle controls are unavailable in this runtime.', true);
    return;
  }

  const changed = runtime.setFeatureEnabled(featureId, enabled);
  if (!changed) {
    renderFeatureToggleControls();
    return;
  }

  applyFeatureGates();
  syncUiModeButtons();
  syncUiIntentButtons();
  syncReliabilityVisibilityHint();
  recalculate();
  updateProgressPills();
  draw();

  const label = getFeatureDisplayName(featureId);
  writeShareFeedback(`${label} ${enabled ? 'enabled' : 'disabled'}.`, false);
}

function resetFeatureToggles() {
  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime || typeof runtime.resetFeatureOverrides !== 'function') {
    writeShareFeedback('Feature reset controls are unavailable in this runtime.', true);
    return;
  }
  runtime.resetFeatureOverrides();
  applyFeatureGates();
  syncUiModeButtons();
  syncUiIntentButtons();
  syncReliabilityVisibilityHint();
  recalculate();
  updateProgressPills();
  draw();
  writeShareFeedback('Feature controls reset to catalog defaults.', false);
}

function getCurrentUiMode() {
  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime || typeof runtime.getMode !== 'function') return 'quick';
  return runtime.getMode();
}

function normalizeUiIntent(intent) {
  return UI_INTENT_OPTIONS.includes(intent) ? intent : UI_INTENT_DEFAULT;
}

function getStoredUiIntent() {
  try {
    const stored = window.localStorage.getItem(UI_INTENT_STORAGE_KEY);
    return normalizeUiIntent(stored || UI_INTENT_DEFAULT);
  } catch (err) {
    return UI_INTENT_DEFAULT;
  }
}

function storeUiIntent(intent) {
  try {
    window.localStorage.setItem(UI_INTENT_STORAGE_KEY, normalizeUiIntent(intent));
  } catch (err) {
    // Ignore storage failures silently.
  }
}

function getCurrentUiIntent() {
  return normalizeUiIntent(activeUiIntent);
}

function getUiIntentProfile(intent) {
  return UI_INTENT_PROFILES[normalizeUiIntent(intent)] || UI_INTENT_PROFILES[UI_INTENT_DEFAULT];
}

function recommendationIntentWeight(categoryKey, intent) {
  const profile = getUiIntentProfile(intent);
  const weights = profile.recommendationWeights || {};
  const normalizedCategory = normalizeRecommendationCategory(categoryKey);
  if (Object.prototype.hasOwnProperty.call(weights, normalizedCategory)) {
    return Number(weights[normalizedCategory]) || 0;
  }
  return 99;
}

function applyIntentOutputOrdering(intent) {
  const profile = getUiIntentProfile(intent);
  const outputGrid = document.getElementById('calc-kpi-output-grid');
  if (!outputGrid) return;

  const currentCards = Array.from(outputGrid.querySelectorAll(':scope > .calc-out-card'));
  if (!currentCards.length) return;

  const byId = new Map(currentCards.map(card => [card.id, card]));
  const appended = new Set();
  let intentRank = 0;

  (profile.kpiOrder || []).forEach(cardId => {
    const card = byId.get(cardId);
    if (!card) return;
    outputGrid.appendChild(card);
    card.dataset.intentRank = String(intentRank++);
    appended.add(card);
  });

  currentCards.forEach(card => {
    if (appended.has(card)) return;
    outputGrid.appendChild(card);
    card.dataset.intentRank = String(intentRank++);
  });

  syncOutputCardSeverityAndOrder();
}

function buildIntentSignalState(inputs = {}) {
  const {
    devPerClient,
    infraTotal,
    ARPU: arpuInput,
    effectiveARPU,
    budgetMonthly,
    forecastGrowthPct,
    forecastBestEfficiencyPct,
    forecastWorstDriftPct,
    savingsIdentified,
    savingsRealized,
    costAvoidance,
    aiEnabled,
    aiMetrics,
    reliabilityEnabled,
    reliabilityMetrics
  } = inputs || {};

  const hasAnyCostInput =
    (devPerClient !== null && devPerClient !== undefined && devPerClient >= 0) ||
    (infraTotal !== null && infraTotal !== undefined && infraTotal >= 0);
  const hasInfraInput = infraTotal !== null && infraTotal !== undefined && infraTotal >= 0;
  const hasARPU =
    (effectiveARPU !== null && effectiveARPU !== undefined && effectiveARPU > 0) ||
    (arpuInput !== null && arpuInput !== undefined && arpuInput > 0);
  const hasBudget = budgetMonthly !== null && budgetMonthly !== undefined && budgetMonthly >= 0;
  const hasForecastSignal =
    (forecastGrowthPct !== null && forecastGrowthPct !== undefined) ||
    (forecastBestEfficiencyPct !== null && forecastBestEfficiencyPct !== undefined) ||
    (forecastWorstDriftPct !== null && forecastWorstDriftPct !== undefined);
  const hasRealizationSignal =
    (savingsIdentified !== null && savingsIdentified !== undefined) ||
    (savingsRealized !== null && savingsRealized !== undefined) ||
    (costAvoidance !== null && costAvoidance !== undefined);

  const scoreEl = document.getElementById('health-score-value');
  const scoreNumber = scoreEl ? Number(String(scoreEl.textContent || '').trim()) : NaN;
  const hasHealthScore = Number.isFinite(scoreNumber);
  const hasRecommendations = document.querySelectorAll('#rec-list .rec-card').length > 0;
  const hasProviderSelection = selectedProviders.size > 0;
  const hasQbvRows = Array.isArray(qbvDashboardRows) && qbvDashboardRows.length > 0;
  const hasAiEnabled = Boolean(aiEnabled);
  const hasAiSignal = Boolean(aiMetrics && aiMetrics.enabled && aiMetrics.aiTotalTokenCost !== null);
  const hasReliabilityEnabled = Boolean(reliabilityEnabled);
  const hasReliabilitySignal = Boolean(
    reliabilityMetrics &&
    reliabilityMetrics.enabled &&
    reliabilityMetrics.expectedReliabilityFailureCostMonthly !== null
  );
  const hasOpsRiskSignal = Boolean((hasARPU && hasForecastSignal) || hasReliabilitySignal);
  const hasArchitecturePolicySignal = Boolean(hasAiEnabled || hasReliabilityEnabled);
  const hasArchitectureRiskSignal = Boolean(hasAiSignal || hasReliabilitySignal);
  const hasExecutiveRiskSignal = Boolean((hasHealthScore && hasForecastSignal) || hasReliabilitySignal);

  return {
    hasAnyCostInput,
    hasInfraInput,
    hasARPU,
    hasBudget,
    hasForecastSignal,
    hasRealizationSignal,
    hasHealthScore,
    hasRecommendations,
    hasProviderSelection,
    hasQbvRows,
    hasAiEnabled,
    hasAiSignal,
    hasReliabilityEnabled,
    hasReliabilitySignal,
    hasOpsRiskSignal,
    hasArchitecturePolicySignal,
    hasArchitectureRiskSignal,
    hasExecutiveRiskSignal
  };
}

function evaluateIntentSteps(intent, inputs = {}) {
  const profile = getUiIntentProfile(intent);
  const steps = Array.isArray(profile.guidedSteps) ? profile.guidedSteps : [];
  const signals = buildIntentSignalState(inputs);

  return steps.map((step, index) => {
    const requires = Array.isArray(step.requires) ? step.requires : [];
    const metCount = requires.filter(flag => Boolean(signals[flag])).length;
    let status = 'todo';
    if (!requires.length || metCount === requires.length) {
      status = 'done';
    } else if (metCount > 0) {
      status = 'active';
    }

    return {
      key: `${intent}-${index + 1}`,
      label: step.label || `Step ${index + 1}`,
      status,
      metCount,
      requiredCount: requires.length
    };
  });
}

function renderRoleOnboardingState(inputs = {}) {
  const onboardingRoot = document.getElementById('calc-onboarding-steps');
  if (!onboardingRoot) return;

  const stepEls = Array.from(onboardingRoot.querySelectorAll('[data-onboarding-step]'));
  if (stepEls.length < 3) return;

  const profile = getUiIntentProfile(getCurrentUiIntent());
  const signals = buildIntentSignalState(inputs);
  const expectedOutcomes = Array.isArray(profile.outcomePreview) && profile.outcomePreview.length
    ? profile.outcomePreview.slice(0, 3).join(', ')
    : 'top outcomes and action guidance';
  const filledCoreCount = Number(Boolean(signals.hasInfraInput)) + Number(Boolean(signals.hasARPU));
  const hasRequiredInputs = Boolean(signals.hasInfraInput && signals.hasARPU);
  const hasOutcomeReady = Boolean(signals.hasHealthScore && signals.hasRecommendations);
  renderIntentOutcomePreview(profile, { locked: !hasRequiredInputs });

  const outcomesLabelEl = document.getElementById('calc-outcomes-label');
  if (outcomesLabelEl) {
    outcomesLabelEl.textContent = hasRequiredInputs
      ? 'Top outcomes preview'
      : 'Top outcomes unlock after Step 2';
  }

  const applyState = (stepEl, state) => {
    stepEl.classList.remove('is-active', 'is-done');
    if (state === 'active') stepEl.classList.add('is-active');
    if (state === 'done') stepEl.classList.add('is-done');
  };

  applyState(stepEls[0], 'done');
  applyState(stepEls[1], hasRequiredInputs ? 'done' : (filledCoreCount > 0 ? 'active' : 'todo'));
  applyState(stepEls[2], hasOutcomeReady ? 'done' : ((hasRequiredInputs || signals.hasHealthScore || signals.hasRecommendations) ? 'active' : 'todo'));

  const stepInputsEl = document.getElementById('calc-step-inputs');
  if (stepInputsEl) {
    if (hasRequiredInputs) {
      stepInputsEl.textContent = 'Fill Infra Cost + ARPU (done)';
    } else if (filledCoreCount > 0) {
      stepInputsEl.textContent = 'Fill Infra Cost + ARPU (1/2 complete)';
    } else {
      stepInputsEl.textContent = 'Fill Infra Cost + ARPU';
    }
  }

  const stepOutcomesEl = document.getElementById('calc-step-outcomes');
  if (stepOutcomesEl) {
    if (hasOutcomeReady) {
      stepOutcomesEl.textContent = 'Review top 3 outcomes + action (done)';
    } else if (hasRequiredInputs || signals.hasHealthScore || signals.hasRecommendations) {
      stepOutcomesEl.textContent = 'Review top 3 outcomes + action (in progress)';
    } else {
      stepOutcomesEl.textContent = 'Review top 3 outcomes + action';
    }
  }

  const nextStepCopyEl = document.getElementById('calc-next-step-copy');
  const step2CtaEl = document.getElementById('calc-step2-cta');
  if (nextStepCopyEl) {
    if (!hasRequiredInputs) {
      const missing = [];
      if (!signals.hasInfraInput) missing.push('Total Infra Cost');
      if (!signals.hasARPU) missing.push('Revenue / Client (ARPU)');
      nextStepCopyEl.textContent = `Step 2: fill ${missing.join(' + ')}. Step 3 unlocks: ${expectedOutcomes}.`;
      if (step2CtaEl) {
        if (!signals.hasInfraInput) {
          step2CtaEl.textContent = 'Start Step 2';
          step2CtaEl.setAttribute('href', '#field-infraTotal');
        } else {
          step2CtaEl.textContent = 'Continue Step 2';
          step2CtaEl.setAttribute('href', '#field-ARPU');
        }
      }
    } else if (!hasOutcomeReady) {
      nextStepCopyEl.textContent = 'Step 3: review Health Zone recommendations to see your top outcomes and first action.';
      if (step2CtaEl) {
        step2CtaEl.textContent = 'Open Step 3 outcomes';
        step2CtaEl.setAttribute('href', '#group-health');
      }
    } else {
      nextStepCopyEl.textContent = `Done. ${profile.personaLabel || 'Role'} outcomes are ready (${expectedOutcomes}). Copy state link to share this analysis.`;
      if (step2CtaEl) {
        step2CtaEl.textContent = 'Review recommendations';
        step2CtaEl.setAttribute('href', '#group-health');
      }
    }
  }
}

function renderIntentGuidedPath(inputs = {}) {
  const intent = getCurrentUiIntent();
  const steps = evaluateIntentSteps(intent, inputs);
  const pathEl = document.getElementById('intent-path');
  const progressEl = document.getElementById('intent-path-progress');
  if (!pathEl || !progressEl) return;

  if (!steps.length) {
    pathEl.innerHTML = '';
    progressEl.textContent = '0/0 steps complete';
    return;
  }

  const doneCount = steps.filter(step => step.status === 'done').length;
  progressEl.textContent = `${doneCount}/${steps.length} steps complete`;

  pathEl.innerHTML = steps.map(step => {
    const marker = step.status === 'done' ? '✓' : (step.status === 'active' ? '•' : '○');
    return `
      <div class="intent-step ${step.status}" role="listitem" aria-label="${step.label}: ${step.status}">
        <span class="intent-step-status">${marker}</span>
        <span class="intent-step-label">${step.label}</span>
      </div>
    `;
  }).join('');

  renderRoleOnboardingState(inputs);
}

function syncIntentExportButton() {
  const btn = document.getElementById('intent-export-btn');
  if (!btn) return;
  const profile = getUiIntentProfile(getCurrentUiIntent());
  const label = profile.exportLabel || 'Export intent preset';
  btn.textContent = label;
  btn.setAttribute('aria-label', label);
}

function csvEscape(value) {
  const text = String(value ?? '');
  if (!/[",\n]/.test(text)) return text;
  return `"${text.replace(/"/g, '""')}"`;
}

function collectIntentExportRows(intent, inputs = {}) {
  const profile = getUiIntentProfile(intent);
  const mode = getCurrentUiMode();
  const timestamp = new Date().toISOString();
  const rows = [
    ['section', 'key', 'value'],
    ['meta', 'intent', intent],
    ['meta', 'mode', mode],
    ['meta', 'timestamp', timestamp],
    ['meta', 'providers', Array.from(selectedProviders).join('|') || 'none'],
    ['meta', 'tech_domains', getSelectedTechDomains().join('|')],
    ['meta', 'recommendation_category', selectedRecommendationCategory]
  ];

  evaluateIntentSteps(intent, inputs).forEach((step, idx) => {
    rows.push(['path', `step_${idx + 1}_${step.label.toLowerCase()}`, step.status]);
  });

  const metricIds = Array.isArray(profile.exportMetrics) && profile.exportMetrics.length
    ? profile.exportMetrics
    : (profile.kpiOrder || []);

  metricIds.forEach(cardId => {
    const card = document.getElementById(cardId);
    if (!card) return;
    const label = card.querySelector('.calc-out-label')?.textContent?.trim() || cardId;
    const value = card.querySelector('.calc-out-val')?.textContent?.trim() || '—';
    rows.push(['kpi', label, value]);
  });

  if (intent === 'operations' && Array.isArray(qbvDashboardRows) && qbvDashboardRows.length) {
    rows.push(['cfo', 'columns', 'month|clients|modeled_cost|budget_variance|base_margin|cumulative_gap']);
    qbvDashboardRows.forEach(row => {
      rows.push([
        'cfo',
        `M${row.month}`,
        [
          Math.round(row.clients),
          row.modeledCost.toFixed(2),
          row.budgetVariance !== null ? row.budgetVariance.toFixed(2) : '',
          row.baseMargin !== null ? row.baseMargin.toFixed(2) : '',
          row.cumulativeGap !== null ? row.cumulativeGap.toFixed(2) : ''
        ].join('|')
      ]);
    });
  }

  if (intent === 'architecture' && inputs.aiMetrics && inputs.aiMetrics.enabled) {
    const ai = inputs.aiMetrics;
    rows.push(['ai', 'allocation_policy', ai.allocationPolicy || '']);
    rows.push(['ai', 'allocation_confidence', ai.allocationConfidence || '']);
    rows.push(['ai', 'governance_risk', ai.tokenGovernanceRisk || '']);
    rows.push(['ai', 'token_volume_m', ai.tokenVolumeM !== null && ai.tokenVolumeM !== undefined ? Number(ai.tokenVolumeM).toFixed(2) : '']);
  }

  return rows;
}

function exportIntentPreset() {
  const intent = getCurrentUiIntent();
  const rows = collectIntentExportRows(intent, lastInputs || {});
  if (rows.length <= 1) {
    writeShareFeedback('Add at least one value before exporting an intent preset.', true);
    return;
  }

  const csv = rows.map(parts => parts.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `ficecal-${intent}-preset-${new Date().toISOString().slice(0, 10)}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  writeShareFeedback(`${getUiIntentProfile(intent).exportLabel || 'Intent preset'} exported.`, false);
}

function renderIntentOutcomePreview(profile, options = {}) {
  const outcomesEl = document.getElementById('calc-intent-outcomes');
  if (!outcomesEl) return;

  const { locked = false } = options;
  const outcomes = Array.isArray(profile.outcomePreview) && profile.outcomePreview.length
    ? profile.outcomePreview
    : ['Break-even signal', 'Risk signal', 'Recommended action'];

  outcomesEl.textContent = '';
  if (locked) {
    const placeholder = document.createElement('span');
    placeholder.className = 'calc-intent-outcome-chip calc-intent-outcome-chip--placeholder';
    placeholder.setAttribute('role', 'listitem');
    placeholder.textContent = 'Complete Step 2 (Infra Cost + ARPU) to unlock outcomes';
    outcomesEl.appendChild(placeholder);
    return;
  }

  outcomes.slice(0, 3).forEach(label => {
    const chip = document.createElement('span');
    chip.className = 'calc-intent-outcome-chip';
    chip.setAttribute('role', 'listitem');
    chip.textContent = label;
    outcomesEl.appendChild(chip);
  });
}

function syncUiIntentButtons() {
  const activeIntent = getCurrentUiIntent();
  const profile = getUiIntentProfile(activeIntent);
  const signals = buildIntentSignalState(lastInputs || {});
  const hasRequiredInputs = Boolean(signals.hasInfraInput && signals.hasARPU);

  document.querySelectorAll('[data-ui-intent-btn]').forEach(btn => {
    const intent = btn.getAttribute('data-ui-intent-btn');
    const pressed = intent === activeIntent;
    btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    btn.classList.toggle('is-active', pressed);
  });

  const summaryEl = document.getElementById('calc-intent-summary');
  if (summaryEl) summaryEl.textContent = profile.summary;

  renderIntentOutcomePreview(profile, { locked: !hasRequiredInputs });

  const nextStepCopyEl = document.getElementById('calc-next-step-copy');
  if (nextStepCopyEl) nextStepCopyEl.textContent = profile.nextStep || 'Enter Total Infra Cost and ARPU to unlock your first readout.';

  const stepRoleEl = document.getElementById('calc-step-role');
  if (stepRoleEl) {
    stepRoleEl.textContent = profile.personaLabel
      ? `Role selected: ${profile.personaLabel}`
      : 'Choose your role';
  }

  const kpiHelperEl = document.getElementById('intent-kpi-helper');
  if (kpiHelperEl) kpiHelperEl.textContent = profile.kpiHelper || 'Intent profile prioritization is active for KPI output ordering.';

  const recHelperEl = document.getElementById('intent-rec-helper');
  if (recHelperEl) recHelperEl.textContent = profile.recommendationHelper || 'Recommendation emphasis adapts to selected intent while keeping health-score logic unchanged.';

  applyIntentOutputOrdering(activeIntent);
  syncIntentExportButton();
  renderIntentGuidedPath(lastInputs || {});

  const calcSection = document.getElementById('calculator-section');
  if (calcSection) {
    calcSection.dataset.uiIntent = activeIntent;
    calcSection.dataset.intentProfile = profile.featureProfile;
  }
}

function setUiIntent(intent, options = {}) {
  const {
    recalcAfter = true,
    syncMode = true,
    persist = true,
    syncRecommendations = true
  } = options;
  const normalized = normalizeUiIntent(intent);
  const profile = getUiIntentProfile(normalized);
  activeUiIntent = normalized;

  if (persist) storeUiIntent(normalized);

  if (syncMode) {
    setUiMode(profile.mode, false);
  }

  if (syncRecommendations) {
    setRecommendationCategory(profile.recommendationCategory || 'all');
  }

  syncUiIntentButtons();

  if (recalcAfter) {
    recalculate();
    updateProgressPills();
    draw();
  }
}

function syncUiModeButtons() {
  const activeMode = getCurrentUiMode();
  document.querySelectorAll('[data-ui-mode-btn]').forEach(btn => {
    const mode = btn.getAttribute('data-ui-mode-btn');
    const pressed = mode === activeMode;
    btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    btn.classList.toggle('is-active', pressed);
  });
  syncReliabilityVisibilityHint();
}

function setUiMode(mode, recalcAfter = true) {
  const normalized = UI_MODE_OPTIONS.includes(mode) ? mode : 'quick';
  const runtime = window.FiceCalFeatureRuntime;
  if (runtime && typeof runtime.setMode === 'function') {
    runtime.setMode(normalized);
  }
  applyFeatureGates();
  syncUiModeButtons();
  if (recalcAfter) {
    recalculate();
    updateProgressPills();
    draw();
  }
}

function getRelease4ReliabilitySeen() {
  try {
    return window.localStorage.getItem(RELEASE4_RELIABILITY_SEEN_KEY) === '1';
  } catch (err) {
    return false;
  }
}

function setRelease4ReliabilitySeen() {
  try {
    window.localStorage.setItem(RELEASE4_RELIABILITY_SEEN_KEY, '1');
  } catch (err) {
    // Ignore storage failures silently.
  }
}

function applyReliabilityDiscoveryState() {
  const discoveryEl = document.getElementById('calc-r4-discovery');
  if (!discoveryEl) return;
  const isSeen = getRelease4ReliabilitySeen();
  discoveryEl.classList.toggle('is-coach', !isSeen);

  const dismissBtn = discoveryEl.querySelector('button[onclick="dismissReliabilityCoachmark()"]');
  if (dismissBtn) dismissBtn.hidden = isSeen;

  const emphasisTargets = [
    document.querySelector('.reliability-overlay'),
    document.getElementById('out-relFailureCost'),
    document.getElementById('out-relAdjustedCost'),
    document.getElementById('out-relRiskBand')
  ].filter(Boolean);

  emphasisTargets.forEach(el => el.classList.toggle('reliability-emphasis', !isSeen));
}

function ensureReliabilityPreviewVisible() {
  if (!isFeatureRuntimeEnabled('sla-slo-sli-economics')) return;
  applyFeatureGates();
}

function dismissReliabilityCoachmark() {
  setRelease4ReliabilitySeen();
  applyReliabilityDiscoveryState();
  syncReliabilityVisibilityHint();
}

function syncReliabilityVisibilityHint() {
  const noteEl = document.getElementById('reliability-visibility-note');
  if (!noteEl) return;
  const reliabilityEnabled = isFeatureRuntimeEnabled('sla-slo-sli-economics');
  if (!reliabilityEnabled) {
    noteEl.innerHTML = '<strong>Release 4 visibility:</strong> Reliability module is disabled in Feature controls. <button type="button" class="calc-inline-link-btn" onclick="openFeatureToggles(\'sla-slo-sli-economics\')">Enable it</button>';
    return;
  }
  const mode = getCurrentUiMode();
  const overlay = document.querySelector('.reliability-overlay');
  const overlayHidden = !overlay || overlay.hasAttribute('hidden') || window.getComputedStyle(overlay).display === 'none';

  if (mode === 'quick') {
    noteEl.innerHTML = '<strong>Release 4 visibility:</strong> Reliability Economics is shown in Operator and Architect modes. <button type="button" class="calc-inline-link-btn" onclick="setUiIntent(\'operations\')">Switch to Operations</button>';
    return;
  }

  if (overlayHidden) {
    noteEl.innerHTML = '<strong>Release 4 visibility:</strong> Reliability controls are currently gated by mode. <button type="button" class="calc-inline-link-btn" onclick="setUiIntent(\'operations\')">Switch to Operations</button>';
    return;
  }

  noteEl.innerHTML = '<strong>Release 4 visibility:</strong> Reliability controls are active in Group B and reliability cards are marked in Group C. <button type="button" class="calc-inline-link-btn" onclick="focusReliabilityFeature()">Jump to reliability</button>';
}

function focusReliabilityFeature() {
  if (!isFeatureRuntimeEnabled('sla-slo-sli-economics')) {
    openFeatureToggles('sla-slo-sli-economics');
    writeShareFeedback('Enable SLA/SLO/SLI Reliability Economics from Advanced tools → Feature controls first.', true);
    return;
  }
  setRelease4ReliabilitySeen();
  if (getCurrentUiMode() === 'quick') {
    setUiIntent('operations');
  }

  ensureReliabilityPreviewVisible();
  window.setTimeout(ensureReliabilityPreviewVisible, 140);

  applyReliabilityDiscoveryState();
  syncReliabilityVisibilityHint();

  const target = document.getElementById('field-reliabilityEnabled') || document.getElementById('out-relFailureCost');
  if (target) {
    requestAnimationFrame(() => {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('reliability-spotlight');
      window.setTimeout(() => target.classList.remove('reliability-spotlight'), 1500);
    });
  }

  writeShareFeedback('Release 4 reliability inputs ready. Toggle Reliability Economics to On to activate R4 outputs.', false);
}

function focusScenarioDemos() {
  const demos = document.getElementById('calc-scenario-demos');
  if (!demos) return;
  demos.scrollIntoView({ behavior: 'smooth', block: 'center' });
  demos.classList.add('reliability-spotlight');
  window.setTimeout(() => demos.classList.remove('reliability-spotlight'), 1400);
}

function jumpToFineTuneArea(areaKey) {
  const areaMap = {
    value: { id: 'fine-tune-value-controls' },
    multi: { id: 'fine-tune-multi-tech', featureId: 'multi-tech-normalization' },
    ai: { id: 'fine-tune-ai-token', featureId: 'ai-token-economics' },
    reliability: { id: 'fine-tune-reliability', featureId: 'sla-slo-sli-economics' }
  };

  const targetConfig = areaMap[areaKey];
  if (!targetConfig) return;

  if (targetConfig.featureId && !isFeatureRuntimeEnabled(targetConfig.featureId)) {
    openFeatureToggles(targetConfig.featureId);
    writeShareFeedback(`${getFeatureDisplayName(targetConfig.featureId)} is disabled. Enable it in Feature controls to access this area.`, true);
    return;
  }

  if (getCurrentUiMode() === 'quick') {
    setUiIntent('operations', { recalcAfter: false, syncMode: true, persist: true, syncRecommendations: true });
    applyFeatureGates();
    syncUiModeButtons();
    syncUiIntentButtons();
  }

  const targetEl = document.getElementById(targetConfig.id);
  if (!targetEl) return;

  requestAnimationFrame(() => {
    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
}

function initRelease4ReliabilityDiscovery() {
  applyReliabilityDiscoveryState();
  syncReliabilityVisibilityHint();
}

async function initFeatureRuntime() {
  const runtime = window.FiceCalFeatureRuntime;
  if (!runtime) {
    syncUiIntentButtons();
    syncUiModeButtons();
    syncScenarioDemoVisibility();
    renderFeatureToggleControls();
    return;
  }
  applyFeatureGates();
  if (typeof runtime.loadCatalog === 'function') {
    await runtime.loadCatalog();
  }
  applyFeatureGates();
  syncUiIntentButtons();
  syncUiModeButtons();
  syncScenarioDemoVisibility();
  renderFeatureToggleControls();
}

function collectShareState() {
  const inputState = {};
  SHAREABLE_INPUT_KEYS.forEach(key => {
    const el = document.getElementById(`inp-${key}`);
    if (!el) return;
    const value = el.value.trim();
    if (isMeaningfulInputValue(el, value)) inputState[key] = value;
  });

  const runtime = window.FiceCalFeatureRuntime;
  const featureOverrides = (runtime && typeof runtime.getFeatureOverrides === 'function')
    ? runtime.getFeatureOverrides()
    : {};

  return {
    v: SHARE_STATE_VERSION,
    ui: getCurrentUiIntent(),
    um: getCurrentUiMode(),
    i: inputState,
    td: getSelectedTechDomains(),
    p: Array.from(selectedProviders),
    h: Array.from(hidden).filter(id => SHAREABLE_CURVE_KEYS.includes(id)),
    f: featureOverrides
  };
}

function buildShareStateUrl() {
  const state = collectShareState();
  const defaultScope = DEFAULT_TECH_DOMAINS.join(',');
  const hasCustomScope = state.td.join(',') !== defaultScope;
  const runtime = window.FiceCalFeatureRuntime;
  const defaultMode = (runtime && typeof runtime.getDefaultMode === 'function')
    ? runtime.getDefaultMode()
    : 'quick';
  const defaultIntent = UI_INTENT_DEFAULT;
  const hasCustomMode = state.um !== defaultMode;
  const hasCustomIntent = state.ui !== defaultIntent;
  const hasCustomFeatureOverrides = state.f && Object.keys(state.f).length > 0;
  const hasData = Object.keys(state.i).length > 0 || state.p.length > 0 || state.h.length > 0 || hasCustomScope || hasCustomMode || hasCustomIntent || hasCustomFeatureOverrides;
  if (!hasData) return null;

  const encoded = encodeShareState(state);
  if (!encoded) return null;

  const url = new URL(window.location.href);
  url.searchParams.set('state', encoded);
  url.hash = 'group-health';
  return url;
}

function copyShareStateLink() {
  const urlObj = buildShareStateUrl();
  if (!urlObj) {
    writeShareFeedback('Add at least one value before creating a share link.', true);
    return;
  }

  const shareUrl = urlObj.toString();
  const replacePath = `${urlObj.pathname}${urlObj.search}${urlObj.hash}`;
  window.history.replaceState({}, '', replacePath);

  const fallback = () => {
    window.prompt('Copy this calculator state link:', shareUrl);
    writeShareFeedback('Share link ready. Copy it from the dialog.', false);
  };

  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl)
      .then(() => writeShareFeedback('Share link copied. Your colleague will open the same state.', false))
      .catch(fallback);
  } else {
    fallback();
  }
}

function loadDemoScenario(scenarioKey) {
  const preset = DEMO_SCENARIOS[scenarioKey];
  if (!preset) {
    writeShareFeedback('Demo preset not found.', true);
    return;
  }

  const isReliabilityScenario = scenarioKey === 'reliability' || scenarioKey === 'reliabilityHealthy' || scenarioKey === 'reliabilityUnhealthy';
  if (isReliabilityScenario && !isFeatureRuntimeEnabled('sla-slo-sli-economics')) {
    openFeatureToggles('sla-slo-sli-economics');
    writeShareFeedback('Reliability demo is disabled. Enable SLA/SLO/SLI Reliability Economics in Feature controls first.', true);
    return;
  }

  closeOutputSolutionPanel();
  closeAllOutputCardTooltips();

  const applied = applySharedState(preset.state);
  if (!applied) {
    writeShareFeedback('Could not load demo scenario.', true);
    return;
  }

  clearShareStateParam();
  if (isReliabilityScenario) {
    setRelease4ReliabilitySeen();
    ensureReliabilityPreviewVisible();
    window.setTimeout(ensureReliabilityPreviewVisible, 140);
    applyReliabilityDiscoveryState();
    syncReliabilityVisibilityHint();
  }
  writeShareFeedback(`${preset.label} demo loaded. ${preset.summary}`, false);

  const focusSelector = typeof preset.focusSelector === 'string' && preset.focusSelector
    ? preset.focusSelector
    : '#group-health';
  const focusEl = document.querySelector(focusSelector);
  if (focusEl) {
    requestAnimationFrame(() => {
      focusEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      if (focusSelector === '#field-reliabilityEnabled' || focusSelector === '#out-relFailureCost') {
        focusEl.classList.add('reliability-spotlight');
        window.setTimeout(() => focusEl.classList.remove('reliability-spotlight'), 1500);
      }
    });
  }
}

function normaliseSharedInput(el, rawValue) {
  if (!el) return '';
  const value = String(rawValue ?? '').trim();
  if (!value) return '';

  if (el.tagName === 'SELECT') {
    const allowed = Array.from(el.options).map(option => option.value);
    return allowed.includes(value) ? value : '';
  }

  const num = Number(value);
  if (!isFinite(num)) return '';

  const min = el.getAttribute('min');
  const max = el.getAttribute('max');
  if (min !== null && min !== '' && num < Number(min)) return '';
  if (max !== null && max !== '' && num > Number(max)) return '';
  return value;
}

function applySharedState(state) {
  if (!state || typeof state !== 'object') return false;

  const runtime = window.FiceCalFeatureRuntime;
  const hasFeatureState = Object.prototype.hasOwnProperty.call(state, 'f');
  if (hasFeatureState && runtime && typeof runtime.resetFeatureOverrides === 'function' && typeof runtime.setFeatureEnabled === 'function') {
    const featureOverrides = (state.f && typeof state.f === 'object') ? state.f : {};
    runtime.resetFeatureOverrides({ persist: true });
    Object.entries(featureOverrides).forEach(([featureId, enabled]) => {
      if (typeof enabled !== 'boolean') return;
      runtime.setFeatureEnabled(featureId, enabled, { persist: true });
    });
    applyFeatureGates();
  }

  if (typeof state.ui === 'string') {
    setUiIntent(state.ui, {
      recalcAfter: false,
      syncMode: typeof state.um !== 'string',
      persist: true,
      syncRecommendations: true
    });
  }

  if (typeof state.um === 'string') {
    setUiMode(state.um, false);
  }

  const inputState = (state.i && typeof state.i === 'object') ? state.i : {};
  SHAREABLE_INPUT_KEYS.forEach(key => {
    const el = document.getElementById(`inp-${key}`);
    if (!el) return;
    const hasKey = Object.prototype.hasOwnProperty.call(inputState, key);
    const defaultValue = el.tagName === 'SELECT'
      ? (el.dataset.defaultValue || (el.options[0] ? el.options[0].value : ''))
      : '';
    const safeValue = hasKey ? normaliseSharedInput(el, inputState[key]) : defaultValue;
    el.value = safeValue;
    USER_PROVIDED[key] = isMeaningfulInputValue(el, safeValue);
    const wrap = el.closest('.calc-field, .startup-field');
    if (wrap) wrap.classList.toggle('has-value', isMeaningfulInputValue(el, safeValue));
  });

  const legacyPrimary = (typeof inputState.techDomain === 'string') ? [inputState.techDomain] : [];
  const scopedDomains = Array.isArray(state.td) ? state.td : [];
  setTechDomainSelection(scopedDomains.length ? scopedDomains : legacyPrimary, false);

  const validProviders = new Set(Array.from(document.querySelectorAll('.provider-btn')).map(btn => btn.dataset.provider));
  selectedProviders.clear();
  document.querySelectorAll('.provider-btn.selected').forEach(btn => btn.classList.remove('selected'));
  if (Array.isArray(state.p)) {
    state.p.forEach(provider => {
      if (!validProviders.has(provider)) return;
      selectedProviders.add(provider);
      const btn = document.querySelector(`[data-provider="${provider}"]`);
      if (btn) btn.classList.add('selected');
    });
  }

  const hiddenFromState = Array.isArray(state.h) ? state.h : [];
  hidden.clear();
  SHAREABLE_CURVE_KEYS.forEach(curveId => {
    const shouldHide = hiddenFromState.includes(curveId);
    if (shouldHide) hidden.add(curveId);
    const btn = document.getElementById(`btn-${curveId}`);
    if (btn) btn.classList.toggle('off', shouldHide);
  });

  recalculate();
  updateProgressPills();
  draw();
  return true;
}

function scrollToHealthSectionFromSharedState() {
  const healthSection = document.getElementById('group-health');
  if (!healthSection) return;

  const url = new URL(window.location.href);
  if (url.hash !== '#group-health') {
    const replacePath = `${url.pathname}${url.search}#group-health`;
    window.history.replaceState({}, '', replacePath);
  }

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      healthSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
}

const GLOSSARY_PAGE_PATH = 'document.html';
const GLOSSARY_TERM_ENTRIES = [
  { id: 'term-modeled-cost', aliases: ['ModeledCost', 'modeled cost', 'modeled_cost'] },
  { id: 'term-arpu', aliases: ['ARPU', 'Average Revenue Per User'] },
  { id: 'term-break-even', aliases: ['break-even', 'break even'] },
  { id: 'term-break-even-clients', aliases: ['Break-Even Clients', 'Minimum Viable Clients'] },
  { id: 'term-min-price', aliases: ['Min Price', 'Minimum Price'] },
  { id: 'term-vcpu', aliases: ['VCPU', 'Variable Cost Per User'] },
  { id: 'term-contribution-margin', aliases: ['Contribution Margin'] },
  { id: 'term-ccer', aliases: ['CCER', 'Cloud Cost Efficiency Ratio'] },
  { id: 'term-cud', aliases: ['CUD', 'CUDs', 'Committed Use Discount', 'Committed Use Discounts'] },
  { id: 'term-savings-plan', aliases: ['Savings Plan', 'Savings Plans'] },
  { id: 'term-reserved-instances', aliases: ['Reserved Instance', 'Reserved Instances'] },
  { id: 'term-target-margin', aliases: ['Target Margin', 'margin target'] },
  { id: 'term-target-revenue', aliases: ['Target Revenue', 'Revenue Target'] },
  { id: 'term-budget-variance', aliases: ['Budget Variance'] },
  { id: 'term-forecast-band', aliases: ['Forecast Band'] },
  { id: 'term-forecast-spread', aliases: ['Forecast Spread'] },
  { id: 'term-savings-identified', aliases: ['Savings Identified', 'Identified Savings'] },
  { id: 'term-savings-realized', aliases: ['Savings Realized', 'Savings Realised', 'Realized Savings', 'Realised Savings'] },
  { id: 'term-cost-avoidance', aliases: ['Cost Avoidance'] },
  { id: 'term-realization-ratio', aliases: ['Realization Ratio', 'Realisation Ratio'] },
  { id: 'term-realization-gap', aliases: ['Realization Gap', 'Realisation Gap'] },
  { id: 'term-normalization', aliases: ['Normalization', 'normalisation'] },
  { id: 'term-ntc-client', aliases: ['NTC/client', 'Normalized Technology Cost'] },
  { id: 'term-financial-truth-mode', aliases: ['Financial Truth mode'] },
  { id: 'term-priority-index', aliases: ['Priority Index'] },
  { id: 'term-tech-coverage', aliases: ['Tech Coverage'] },
  { id: 'term-focus-maturity', aliases: ['Focus Maturity'] },
  { id: 'term-nref', aliases: ['reference n', 'nRef'] },
  { id: 'term-nmax', aliases: ['nMax'] },
  { id: 'term-cfo-forecast-dashboard', aliases: ['CFO Forecast Dashboard'] }
];

const GLOSSARY_ALIAS_TO_ID = new Map();
const GLOSSARY_MATCH_PARTS = [];
const GLOSSARY_TERM_IDS = new Set(GLOSSARY_TERM_ENTRIES.map(entry => entry.id));
const GLOSSARY_DEFINITION_BY_ID = new Map();
const GLOSSARY_TITLE_BY_ID = new Map();
const GLOSSARY_INLINE_FALLBACK_DEFINITIONS = {
  'term-modeled-cost': { title: 'ModeledCost', definition: 'The projected monthly technology cost generated by the model for a given client volume. It combines the development decay component and infrastructure growth component for scenario analysis.' },
  'term-arpu': { title: 'ARPU (Average Revenue Per User)', definition: 'Average revenue generated per client per month. In this calculator, ARPU is the core unit revenue assumption used to derive break-even, contribution margin, and CCER.' },
  'term-break-even': { title: 'Break-even', definition: 'The operating point where total monthly revenue equals total monthly cost. Above this threshold, the business becomes contribution-positive; below it, operations are loss-making.' },
  'term-break-even-clients': { title: 'Break-Even Clients / Minimum Viable Clients', definition: 'The first client count in the modeled scan range where monthly revenue meets or exceeds monthly total cost. This is shown as the key threshold in KPI cards and chart insights.' },
  'term-min-price': { title: 'Min Price / Minimum Price', definition: 'The minimum viable per-client price required to recover modeled cost and target margin at a given scale. Used for pricing floor and startup planning outputs.' },
  'term-vcpu': { title: 'VCPU (Variable Cost Per User)', definition: 'Per-client share of variable infrastructure cost. It indicates how much incremental cloud cost each additional client introduces under current assumptions.' },
  'term-contribution-margin': { title: 'Contribution Margin', definition: 'ARPU minus VCPU. It measures the amount each client contributes to fixed-cost recovery and profit after covering their own variable infrastructure load.' },
  'term-ccer': { title: 'CCER (Cloud Cost Efficiency Ratio)', definition: 'Revenue divided by modeled on-demand cloud infrastructure cost in this calculator. A higher ratio means stronger revenue productivity per euro of modeled infra spend; low values indicate weak efficiency posture.' },
  'term-cud': { title: 'CUD / CUDs (Committed Use Discounts)', definition: 'Commitment-based cloud discounts (e.g., 1-3 year commitments) that reduce unit infrastructure cost versus on-demand rates when workloads are predictable.' },
  'term-savings-plan': { title: 'Savings Plans', definition: 'A commitment discount mechanism (primarily AWS) that lowers compute pricing for committed usage levels. Equivalent in intent to commitment models on other clouds.' },
  'term-reserved-instances': { title: 'Reserved Instances', definition: 'Pre-purchased cloud capacity commitments that trade flexibility for lower unit cost. Used in optimization strategies alongside Savings Plans/CUDs.' },
  'term-target-margin': { title: 'Target Margin', definition: 'The profit margin objective applied above modeled cost in pricing equations. It defines how much profit buffer you require beyond pure cost recovery.' },
  'term-target-revenue': { title: 'Target Revenue', definition: 'Monthly revenue level required for the selected startup planning assumptions (target clients or target price) while meeting cost and margin objectives.' },
  'term-budget-variance': { title: 'Budget Variance', definition: 'Difference between technology budget and modeled/scoped monthly cost. Positive values indicate headroom; negative values indicate overrun risk.' },
  'term-forecast-band': { title: 'Forecast Band', definition: 'Base, best, and worst margin outcomes generated from growth plus efficiency/drift assumptions. This is a deterministic scenario band, not statistical probability.' },
  'term-forecast-spread': { title: 'Forecast Spread', definition: 'Distance between best and worst forecast margins, often expressed versus revenue. Wider spread implies greater planning uncertainty and lower confidence.' },
  'term-savings-identified': { title: 'Savings Identified', definition: 'Total monthly savings opportunity discovered by analysis (rightsizing, commitments, waste reduction), before realization has occurred.' },
  'term-savings-realized': { title: 'Savings Realized', definition: 'Monthly savings already captured in spend outcomes, not just identified. This is the achieved value component used in realization tracking.' },
  'term-cost-avoidance': { title: 'Cost Avoidance', definition: 'Future spend prevented through proactive design, governance, or procurement decisions. Unlike realized savings, this often represents avoided increases.' },
  'term-realization-ratio': { title: 'Realization Ratio', definition: 'Percentage of identified value that has been achieved through realized savings plus cost avoidance. Tracks execution quality of FinOps initiatives.' },
  'term-realization-gap': { title: 'Realization Gap', definition: 'Remaining difference between identified value target and achieved value. A positive gap indicates value still pending capture.' },
  'term-normalization': { title: 'Normalization', definition: 'Process of converting monthly costs into a comparable per-client basis across selected domains. Enables fair comparison of mixed technology cost structures.' },
  'term-ntc-client': { title: 'NTC/client (Normalized Technology Cost per Client)', definition: 'Aggregate selected-domain monthly cost divided by client count. This provides a unified per-client technology cost signal across cloud and non-cloud domains.' },
  'term-financial-truth-mode': { title: 'Financial Truth mode', definition: 'Baseline mode where selected domains are included with neutral weighting for transparent reporting. Used to anchor governance discussions on actual scoped spend.' },
  'term-priority-index': { title: 'Priority Index', definition: 'Policy-weighted prioritization lens used to emphasize selected dimensions when governance requires scenario emphasis over neutral baseline representation.' },
  'term-tech-coverage': { title: 'Tech Coverage', definition: 'Share of selected technology domains that currently have cost data provided. Higher coverage improves confidence in normalization outputs.' },
  'term-focus-maturity': { title: 'Focus Maturity', definition: 'Confidence level for scoped normalization quality (e.g., Low/Medium/High), based on data completeness and domain coverage.' },
  'term-nref': { title: 'reference n / nRef', definition: 'The current client baseline used for calibrating model coefficients from your present-day cost and usage conditions.' },
  'term-nmax': { title: 'nMax', definition: 'Maximum client count shown in chart/scanning ranges. It controls projection horizon for break-even search and curve visualization range.' },
  'term-cfo-forecast-dashboard': { title: 'CFO Forecast Dashboard', definition: 'The planning panel that summarizes budget checkpoints, margin scenarios, and realization trajectories for month-by-month finance review.' }
};
let glossaryDefinitionLoadPromise = null;
let glossaryHoverPanelEl = null;
let glossaryHoverActiveLinkEl = null;
let glossaryHoverHideTimer = null;
let glossaryHoverListenersBound = false;

function escapeGlossaryRegex(text) {
  return String(text).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function escapeGlossaryAttr(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function normalizeGlossaryAlias(text) {
  return String(text || '').toLowerCase().replace(/\s+/g, ' ').trim();
}

function aliasPattern(alias) {
  const escaped = escapeGlossaryRegex(alias).replace(/\s+/g, '\\s+');
  return /^[A-Za-z0-9\-\/ ]+$/.test(alias)
    ? `\\b${escaped}\\b`
    : escaped;
}

GLOSSARY_TERM_ENTRIES.forEach(entry => {
  entry.aliases.forEach(alias => {
    const normalized = normalizeGlossaryAlias(alias);
    GLOSSARY_ALIAS_TO_ID.set(normalized, entry.id);
    GLOSSARY_MATCH_PARTS.push(aliasPattern(alias));
  });
});

GLOSSARY_MATCH_PARTS.sort((a, b) => b.length - a.length);
const GLOSSARY_TERMS_REGEX = new RegExp(`(${GLOSSARY_MATCH_PARTS.join('|')})`, 'gi');

function ensureGlossaryHoverPanel() {
  if (glossaryHoverPanelEl) return glossaryHoverPanelEl;
  const panel = document.createElement('div');
  panel.className = 'glossary-hover-panel';
  panel.id = 'glossary-hover-panel';
  panel.setAttribute('role', 'tooltip');
  panel.setAttribute('aria-hidden', 'true');
  panel.setAttribute('data-no-glossary', 'true');
  panel.innerHTML = '<p class="glossary-hover-title"></p><p class="glossary-hover-body"></p>';
  document.body.appendChild(panel);
  glossaryHoverPanelEl = panel;
  return glossaryHoverPanelEl;
}

function normalizeGlossaryDefinitionText(text) {
  return String(text || '').replace(/\s+/g, ' ').trim();
}

function setGlossaryDefinitionEntry(id, title, definition) {
  if (!id) return;
  const cleanDefinition = normalizeGlossaryDefinitionText(definition);
  if (!cleanDefinition) return;
  GLOSSARY_DEFINITION_BY_ID.set(id, cleanDefinition);
  if (title) GLOSSARY_TITLE_BY_ID.set(id, String(title).trim());
}

function primeGlossaryFallbackDefinitions() {
  Object.entries(GLOSSARY_INLINE_FALLBACK_DEFINITIONS).forEach(([id, payload]) => {
    if (!GLOSSARY_TERM_IDS.has(id)) return;
    if (GLOSSARY_DEFINITION_BY_ID.has(id)) return;
    setGlossaryDefinitionEntry(id, payload.title, payload.definition);
  });
}

function getGlossaryTooltipData(linkEl) {
  const fallbackTerm = (linkEl?.dataset?.glossaryTerm || linkEl?.textContent || '').trim();
  const id = String(linkEl?.dataset?.glossaryId || '').trim();
  if (!id) {
    return {
      id: '',
      term: fallbackTerm,
      title: fallbackTerm,
      definition: ''
    };
  }

  const title = GLOSSARY_TITLE_BY_ID.get(id) || fallbackTerm;
  const definition = GLOSSARY_DEFINITION_BY_ID.get(id) || '';
  return { id, term: fallbackTerm, title, definition };
}

function positionGlossaryHoverPanel(linkEl) {
  if (!glossaryHoverPanelEl || !linkEl) return;

  const rect = linkEl.getBoundingClientRect();
  const panelRect = glossaryHoverPanelEl.getBoundingClientRect();
  const gap = 10;
  const vw = window.innerWidth || document.documentElement.clientWidth || 0;
  const vh = window.innerHeight || document.documentElement.clientHeight || 0;

  let left = rect.left + (rect.width / 2) - (panelRect.width / 2);
  const maxLeft = Math.max(10, vw - panelRect.width - 10);
  left = Math.min(Math.max(10, left), maxLeft);

  const topAbove = rect.top - panelRect.height - gap;
  let placeAbove = topAbove >= 10;
  let top = placeAbove ? topAbove : rect.bottom + gap;
  if (!placeAbove && top + panelRect.height > vh - 10) {
    top = Math.max(10, vh - panelRect.height - 10);
    placeAbove = false;
  }
  top = Math.max(10, top);

  const linkCenter = rect.left + (rect.width / 2);
  const arrowLeft = Math.min(Math.max(14, linkCenter - left), Math.max(14, panelRect.width - 14));

  glossaryHoverPanelEl.style.left = `${Math.round(left)}px`;
  glossaryHoverPanelEl.style.top = `${Math.round(top)}px`;
  glossaryHoverPanelEl.style.setProperty('--glossary-arrow-left', `${Math.round(arrowLeft)}px`);
  glossaryHoverPanelEl.classList.toggle('is-above', placeAbove);
  glossaryHoverPanelEl.classList.toggle('is-below', !placeAbove);
}

function hideGlossaryDefinitionTooltip() {
  if (!glossaryHoverPanelEl) return;
  glossaryHoverPanelEl.classList.remove('is-open');
  glossaryHoverPanelEl.setAttribute('aria-hidden', 'true');
  glossaryHoverActiveLinkEl = null;
}

function scheduleGlossaryDefinitionTooltipHide() {
  if (glossaryHoverHideTimer) clearTimeout(glossaryHoverHideTimer);
  glossaryHoverHideTimer = window.setTimeout(() => {
    hideGlossaryDefinitionTooltip();
  }, 90);
}

async function preloadGlossaryDefinitions() {
  if (glossaryDefinitionLoadPromise) return glossaryDefinitionLoadPromise;
  primeGlossaryFallbackDefinitions();

  glossaryDefinitionLoadPromise = (async () => {
    try {
      const response = await fetch(GLOSSARY_PAGE_PATH, { cache: 'force-cache' });
      if (!response.ok) return;
      const html = await response.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const terms = Array.from(doc.querySelectorAll('#glossary .glossary-term[id]'));
      terms.forEach(termEl => {
        const id = termEl.id;
        if (!GLOSSARY_TERM_IDS.has(id)) return;
        const title = normalizeGlossaryDefinitionText((termEl.querySelector('h3') || {}).textContent || id);
        const definition = normalizeGlossaryDefinitionText((termEl.querySelector('p') || {}).textContent || '');
        setGlossaryDefinitionEntry(id, title, definition);
      });
    } catch (err) {
      // Silent fallback: links remain functional even when definitions cannot be prefetched.
    }
  })();

  return glossaryDefinitionLoadPromise;
}

function renderGlossaryDefinitionTooltip(linkEl, loading = false) {
  if (!linkEl) return;
  const panel = ensureGlossaryHoverPanel();
  const titleEl = panel.querySelector('.glossary-hover-title');
  const bodyEl = panel.querySelector('.glossary-hover-body');
  const tooltipData = getGlossaryTooltipData(linkEl);

  titleEl.textContent = tooltipData.title || tooltipData.term || 'Glossary term';
  if (loading) {
    bodyEl.textContent = 'Loading glossary definition…';
  } else if (tooltipData.definition) {
    bodyEl.textContent = tooltipData.definition;
  } else {
    bodyEl.textContent = 'Definition not available in glossary preview. Click the term to open the full glossary entry.';
  }

  panel.setAttribute('aria-hidden', 'false');
  panel.classList.add('is-open');
  positionGlossaryHoverPanel(linkEl);
}

function showGlossaryDefinitionTooltip(linkEl) {
  if (!linkEl || !linkEl.classList.contains('glossary-term-link')) return;
  if (glossaryHoverHideTimer) {
    clearTimeout(glossaryHoverHideTimer);
    glossaryHoverHideTimer = null;
  }

  glossaryHoverActiveLinkEl = linkEl;
  const tooltipData = getGlossaryTooltipData(linkEl);
  renderGlossaryDefinitionTooltip(linkEl, !tooltipData.definition);

  if (!tooltipData.definition) {
    preloadGlossaryDefinitions().then(() => {
      if (glossaryHoverActiveLinkEl !== linkEl) return;
      renderGlossaryDefinitionTooltip(linkEl, false);
    });
  }
}

function bindGlossaryHoverTooltips() {
  if (glossaryHoverListenersBound) return;
  glossaryHoverListenersBound = true;

  document.addEventListener('mouseover', event => {
    const linkEl = event.target.closest && event.target.closest('.glossary-term-link');
    if (!linkEl) return;
    showGlossaryDefinitionTooltip(linkEl);
  });

  document.addEventListener('mouseout', event => {
    const linkEl = event.target.closest && event.target.closest('.glossary-term-link');
    if (!linkEl) return;
    const related = event.relatedTarget;
    if (related && linkEl.contains(related)) return;
    scheduleGlossaryDefinitionTooltipHide();
  });

  document.addEventListener('focusin', event => {
    const linkEl = event.target.closest && event.target.closest('.glossary-term-link');
    if (!linkEl) return;
    showGlossaryDefinitionTooltip(linkEl);
  });

  document.addEventListener('focusout', event => {
    const linkEl = event.target.closest && event.target.closest('.glossary-term-link');
    if (!linkEl) return;
    scheduleGlossaryDefinitionTooltipHide();
  });

  window.addEventListener('scroll', () => {
    if (glossaryHoverActiveLinkEl) positionGlossaryHoverPanel(glossaryHoverActiveLinkEl);
  }, { passive: true, capture: true });

  window.addEventListener('resize', () => {
    if (glossaryHoverActiveLinkEl) positionGlossaryHoverPanel(glossaryHoverActiveLinkEl);
  }, { passive: true });

  document.addEventListener('keydown', event => {
    if (event.key !== 'Escape') return;
    hideGlossaryDefinitionTooltip();
  });
}

function shouldSkipGlossaryNode(textNode) {
  const parent = textNode && textNode.parentElement;
  if (!parent) return true;
  return Boolean(parent.closest('a, code, pre, kbd, samp, script, style, textarea, input, button, select, option, [data-no-glossary]'));
}

function linkGlossaryTermsInRoot(rootEl) {
  if (!rootEl) return;
  const walker = document.createTreeWalker(rootEl, NodeFilter.SHOW_TEXT, {
    acceptNode(node) {
      if (!node || !node.nodeValue || shouldSkipGlossaryNode(node)) return NodeFilter.FILTER_REJECT;
      GLOSSARY_TERMS_REGEX.lastIndex = 0;
      return GLOSSARY_TERMS_REGEX.test(node.nodeValue)
        ? NodeFilter.FILTER_ACCEPT
        : NodeFilter.FILTER_REJECT;
    }
  });

  const targets = [];
  while (walker.nextNode()) targets.push(walker.currentNode);

  targets.forEach(node => {
    const source = node.nodeValue;
    GLOSSARY_TERMS_REGEX.lastIndex = 0;
    const updated = source.replace(GLOSSARY_TERMS_REGEX, match => {
      const key = normalizeGlossaryAlias(match);
      const id = GLOSSARY_ALIAS_TO_ID.get(key);
      if (!id) return match;
      const safeTerm = escapeGlossaryAttr(match);
      return `<a class="glossary-term-link" data-glossary-id="${id}" data-glossary-term="${safeTerm}" href="${GLOSSARY_PAGE_PATH}#${id}" aria-label="Open glossary definition: ${safeTerm}">${match}</a>`;
    });

    if (updated === source) return;
    const temp = document.createElement('span');
    temp.innerHTML = updated;
    const fragment = document.createDocumentFragment();
    while (temp.firstChild) fragment.appendChild(temp.firstChild);
    node.parentNode.replaceChild(fragment, node);
  });
}

function applyGlossaryAutoLinks(scopeEl = null) {
  if (!GLOSSARY_MATCH_PARTS.length) return;

  if (scopeEl) {
    linkGlossaryTermsInRoot(scopeEl);
    return;
  }

  const roots = [document.body].filter(Boolean);

  roots.forEach(linkGlossaryTermsInRoot);
}

function loadSharedStateFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const encoded = params.get('state');
  if (!encoded) return false;

  const decoded = decodeShareState(encoded);
  if (!decoded) {
    writeShareFeedback('Shared state link is invalid or corrupted.', true);
    return false;
  }

  const applied = applySharedState(decoded);
  if (applied) {
    writeShareFeedback('Shared calculator state loaded. Jumped to Health & Recommendations.', false);
    scrollToHealthSectionFromSharedState();
  }
  return applied;
}

function clearShareStateParam() {
  const url = new URL(window.location.href);
  if (!url.searchParams.has('state')) return;
  url.searchParams.delete('state');
  const replacePath = `${url.pathname}${url.search}${url.hash}`;
  window.history.replaceState({}, '', replacePath);
}

// ─── MODEL PARAMS (live, updated by calculator) ──────────────────
let MODEL = { K:50000, a:0.45, c:0.8, b:1.28, g:0.68, ARPU:30, m:0.15, nMax:1000 };
let chartReliabilityInputs = null;

// ─── DATA MODEL ─────────────────────────────────────────────────
function buildData() {
  const coreEconomics = window.FiceCalCoreEconomics;
  let points;
  if (coreEconomics && typeof coreEconomics.buildDataFromModel === 'function') {
    points = coreEconomics.buildDataFromModel(MODEL, 300);
  } else {
    const { K, a, c, b, g, ARPU, m, nMax } = MODEL;
    const N = 300;
    points = d3.range(N + 1).map(i => {
      const n       = Math.max(1, (i / N) * nMax);
      const dev      = K * Math.pow(n, -a);
      const infraRaw = c * Math.pow(n, b);
      const infraCud = g * c * Math.pow(n, b * 0.96);
      const total    = dev + infraRaw;
      const revenue  = ARPU * n;
      const profit   = revenue - total;
      const priceMin = total * (1 + m);
      return { n, dev, infraRaw, infraCud, total, revenue, profit, priceMin };
    });
  }

  const reliabilityMetrics = chartReliabilityInputs && chartReliabilityInputs.reliabilityMetrics;
  const hasReliabilitySignal = Boolean(
    chartReliabilityInputs &&
    chartReliabilityInputs.reliabilityEnabled &&
    reliabilityMetrics &&
    reliabilityMetrics.enabled &&
    reliabilityMetrics.expectedReliabilityFailureCostMonthly !== null
  );
  const reliabilityLoadMonthly = hasReliabilitySignal
    ? Math.max(
      0,
      (Number(reliabilityMetrics.reliabilityInvestmentMonthly) || 0) +
      (Number(reliabilityMetrics.expectedReliabilityFailureCostMonthly) || 0)
    )
    : 0;

  return points.map(point => {
    if (!hasReliabilitySignal) {
      return { ...point, totalRel: null, profitRel: null };
    }
    const totalRel = point.total + reliabilityLoadMonthly;
    return {
      ...point,
      totalRel,
      profitRel: point.revenue - totalRel
    };
  });
}

// ─── FORMAT ─────────────────────────────────────────────────────
const DEFAULT_CURRENCY_CODE = 'EUR';
const CURRENCY_SYMBOLS = Object.freeze({
  EUR: '€',
  GBP: '£',
  USD: '$'
});
let currencyUnitTemplatesReady = false;

function normalizeCurrencyCode(value) {
  const next = String(value || '').trim().toUpperCase();
  return Object.prototype.hasOwnProperty.call(CURRENCY_SYMBOLS, next)
    ? next
    : DEFAULT_CURRENCY_CODE;
}

function getActiveCurrencyCode() {
  return normalizeCurrencyCode(getInputString('inp-currency', DEFAULT_CURRENCY_CODE));
}

function getActiveCurrencySymbol() {
  return CURRENCY_SYMBOLS[getActiveCurrencyCode()] || CURRENCY_SYMBOLS[DEFAULT_CURRENCY_CODE];
}

function refreshCurrencyUnits() {
  if (!currencyUnitTemplatesReady) {
    document.querySelectorAll('.calc-unit').forEach(unitEl => {
      const text = String(unitEl.textContent || '').trim();
      if (!/[€£$]/.test(text)) return;
      unitEl.dataset.currencyTemplate = text.replace(/[€£$]/g, '{symbol}');
    });
    currencyUnitTemplatesReady = true;
  }

  const symbol = getActiveCurrencySymbol();
  document.querySelectorAll('.calc-unit[data-currency-template]').forEach(unitEl => {
    unitEl.textContent = unitEl.dataset.currencyTemplate.replace('{symbol}', symbol);
  });
}

function fmt(v) {
  if (!isFinite(v)) return '—';
  const abs = Math.abs(v);
  const symbol = getActiveCurrencySymbol();
  const str = abs >= 1000 ? `${symbol}${(abs/1000).toFixed(1)}K` : `${symbol}${abs.toFixed(0)}`;
  return v < 0 ? `−${str}` : str;
}

// ─── ZONE DATA ──────────────────────────────────────────────────
function zoneFor(n, beN, ssEnd) {
  if (n < beN) return {
    name: 'Zone I · Loss Zone', color: '#d55e00',
    desc: 'Revenue cannot cover total cost. Below minimum viable scale. Pricing must increase or costs must be reduced.',
    insight: 'Increase client acquisition or reduce fixed costs. Minimum viable price is above current ARPU.'
  };
  if (n < ssEnd) return {
    name: 'Zone III · ROI Sweet Spot', color: '#009e73',
    desc: 'Economies of scale reduce amortized development burden. Infrastructure scaling is still manageable.',
    insight: 'Optimal zone for FinOps governance. Lock in CUDs now to extend this zone further right.'
  };
  return {
    name: 'Zone IV · Margin Compression', color: '#0072b2',
    desc: 'Infra cost growth is outpacing revenue gains. Trigger point for architectural review.',
    insight: 'Action required: Renegotiate CUDs, implement right-sizing, or revise pricing model.'
  };
}

// ─── DRAW ────────────────────────────────────────────────────────
function draw() {
  const container = document.getElementById('chart-container');
  const { nMax } = MODEL;
  const W = container.clientWidth;
  const focusMode = isChartInFocusMode();
  const minHeight = focusMode ? Math.max(420, Math.round(window.innerHeight * 0.58)) : 320;
  const maxHeight = focusMode ? Math.max(620, window.innerHeight - 120) : 560;
  const H = Math.round(Math.min(Math.max(W * (9/16), minHeight), maxHeight));

  const M = {
    top:    28,
    right:  Math.max(90, W * 0.11),
    bottom: 50,
    left:   Math.max(54, W * 0.075)
  };
  const iW = W - M.left - M.right;
  const iH = H - M.top - M.bottom;

  // Clear
  d3.select('#chart').selectAll('*').remove();
  const svg = d3.select('#chart').attr('width', W).attr('height', H);
  const g   = svg.append('g').attr('transform', `translate(${M.left},${M.top})`);

  const pts  = buildData();
  currentPts = pts;

  // Inflection points
  const be = pts.find(d => d.revenue >= d.total) || null;
  const beN = be ? be.n : Number.POSITIVE_INFINITY;
  const ssEnd = (() => {
    if (!be) return nMax;
    const minTotalPt = pts.reduce((minD, d) => d.total < minD.total ? d : minD, pts[0]);
    const lowerBound = beN + (nMax * 0.06);
    const candidate = Math.max(minTotalPt.n, lowerBound);
    return Math.min(nMax, candidate > beN ? candidate : beN + Math.max(120, nMax * 0.35));
  })();

  // Scales
  const xSc = d3.scaleLinear().domain([0, nMax]).range([0, iW]);
  const yMax = d3.max(pts, d => Math.max(
    d.total,
    d.revenue,
    Number.isFinite(d.totalRel) ? d.totalRel : Number.NEGATIVE_INFINITY
  )) * 1.08;
  const yMin = d3.min(pts, d => Math.min(
    d.profit,
    Number.isFinite(d.profitRel) ? d.profitRel : Number.POSITIVE_INFINITY
  )) * 1.1;
  const ySc  = d3.scaleLinear().domain([yMin, yMax]).range([iH, 0]);
  const hasReliabilityOverlay = pts.some(d => Number.isFinite(d.totalRel) && Number.isFinite(d.profitRel));
  currentScales = { xSc, ySc, beN: isFinite(beN) ? beN : null, ssEnd };

  // Defs
  const defs = svg.append('defs');
  const mkArrow = (id, color) => {
    const m = defs.append('marker')
      .attr('id', id).attr('markerWidth', 6).attr('markerHeight', 6)
      .attr('refX', 3).attr('refY', 3).attr('orient', 'auto');
    m.append('path').attr('d', 'M0,0 L6,3 L0,6 Z').attr('fill', color);
  };
  mkArrow('arrowCudUp', '#009e73');
  mkArrow('arrowCudDn', '#009e73');

  // Zone backgrounds
  const beX = be ? xSc(beN) : iW;
  const ssX = xSc(ssEnd);
  g.append('rect').attr('x', xSc(0)).attr('y', 0)
    .attr('width', beX).attr('height', iH)
    .attr('fill', 'rgba(213,94,0,0.05)');
  if (be) {
    g.append('rect').attr('x', beX).attr('y', 0)
      .attr('width', Math.max(0, ssX - beX)).attr('height', iH)
      .attr('fill', 'rgba(0,158,115,0.07)');
    g.append('rect').attr('x', ssX).attr('y', 0)
      .attr('width', Math.max(0, iW - ssX)).attr('height', iH)
      .attr('fill', 'rgba(0,114,178,0.05)');
  }

  // Zone dividers
  [be ? beN : null, be ? ssEnd : null].filter(nx => nx !== null && nx <= nMax).forEach(nx => {
    g.append('line')
      .attr('x1', xSc(nx)).attr('x2', xSc(nx))
      .attr('y1', 0).attr('y2', iH)
      .attr('stroke', '#ccc').attr('stroke-width', 1)
      .attr('stroke-dasharray', '4,3');
  });

  // Zone top labels
  const zLabelY = -10;
  const zoneLabels = be
    ? [
        { cx: (0 + beN) / 2,      text: 'I · LOSS',         color: '#d55e00' },
        { cx: (beN + ssEnd) / 2,  text: 'III · SWEET SPOT', color: '#009e73' },
        { cx: (ssEnd + nMax) / 2, text: 'IV · COMPRESSION', color: '#0072b2' },
      ]
    : [
        { cx: nMax / 2, text: 'I · LOSS', color: '#d55e00' },
      ];
  zoneLabels.forEach(l => {
    const lx = xSc(l.cx);
    if (lx < 0 || lx > iW) return;
    const zoneFontSize = Math.max(9.5, W * 0.0105);
    const estWidth = l.text.length * zoneFontSize * 0.58;
    const sidePad = 6;
    let anchor = 'middle';
    let safeX = lx;
    if (lx - (estWidth / 2) < sidePad) {
      anchor = 'start';
      safeX = sidePad;
    } else if (lx + (estWidth / 2) > iW - sidePad) {
      anchor = 'end';
      safeX = iW - sidePad;
    }
    g.append('text')
      .attr('x', safeX).attr('y', zLabelY)
      .attr('text-anchor', anchor)
      .attr('fill', l.color).attr('font-size', zoneFontSize)
      .attr('font-family', 'JetBrains Mono').attr('font-weight', '600').attr('letter-spacing', '0.08em')
      .attr('paint-order', 'stroke').attr('stroke', '#ffffff').attr('stroke-width', 2.6)
      .text(l.text);
  });

  // Grid
  g.append('g').call(
    d3.axisLeft(ySc).ticks(6).tickSize(-iW).tickFormat('')
  ).call(ag => {
    ag.select('.domain').remove();
    ag.selectAll('.tick line').attr('stroke','#e8e4df').attr('stroke-dasharray','3,3');
  });

  // Zero line
  g.append('line')
    .attr('x1', 0).attr('x2', iW)
    .attr('y1', ySc(0)).attr('y2', ySc(0))
    .attr('stroke', '#bbb').attr('stroke-width', 1);
  g.append('text')
    .attr('x', -5).attr('y', ySc(0) + 4)
    .attr('text-anchor', 'end').attr('fill', '#999')
    .attr('font-size', Math.max(8, W * 0.009))
    .attr('font-family', 'JetBrains Mono').text('€0');

  // Curves
  const curveDefs = [
    { id: 'dev',       key: 'dev',      color: '#d55e00', dash: null,  w: 2.5, label: 'Dev Cost (Amortized)', shortLabel: 'Dev Cost', available: true },
    { id: 'infra-raw', key: 'infraRaw', color: '#009e73', dash: null,  w: 2.5, label: 'Infra (On-Demand)', shortLabel: 'Infra (On-Demand)', available: true },
    { id: 'infra-cud', key: 'infraCud', color: '#009e73', dash: '7,4', w: 2,   label: 'Infra (CUDs)', shortLabel: 'Infra (CUDs)', available: true },
    { id: 'total',     key: 'total',    color: '#444444', dash: null,  w: 2.2, label: 'Total Cost / mo', shortLabel: 'Total Cost', available: true },
    { id: 'total-rel', key: 'totalRel', color: '#8a3d00', dash: '5,3', w: 2.2, label: 'Total Cost + Reliability', shortLabel: 'Total + Reliability', available: hasReliabilityOverlay },
    { id: 'revenue',   key: 'revenue',  color: '#0072b2', dash: null,  w: 2.5, label: 'Revenue / mo', shortLabel: 'Revenue', available: true },
    { id: 'profit',    key: 'profit',   color: '#7b2d8b', dash: '6,3', w: 2,   label: 'Profit / ROI', shortLabel: 'Profit / ROI', available: true },
    { id: 'profit-rel', key: 'profitRel', color: '#b33f7a', dash: '2,4', w: 2, label: 'Profit / ROI + Reliability', shortLabel: 'Profit + Reliability', available: hasReliabilityOverlay },
    { id: 'price-min', key: 'priceMin', color: '#555555', dash: '3,4', w: 1.5, label: 'Revenue Target / mo', shortLabel: 'Rev. Target / mo', available: true },
  ];

  ['total-rel', 'profit-rel'].forEach(curveId => {
    const btn = document.getElementById(`btn-${curveId}`);
    if (!btn) return;
    const available = curveDefs.some(curve => curve.id === curveId && curve.available);
    btn.disabled = !available;
    btn.classList.toggle('off', !available || hidden.has(curveId));
    btn.title = available
      ? 'Toggle reliability-adjusted curve visibility.'
      : 'Enable Reliability Economics and populate reliability inputs to activate this curve.';
  });

  const lineGen = key => d3.line()
    .defined(d => Number.isFinite(d[key]))
    .x(d => xSc(d.n))
    .y(d => ySc(d[key]))
    .curve(d3.curveCatmullRom.alpha(0.5));

  paths = {};
  curveDefs.forEach(c => {
    const isVisible = !hidden.has(c.id) && c.available;
    paths[c.id] = g.append('path')
      .datum(pts)
      .attr('fill', 'none')
      .attr('stroke', c.color)
      .attr('stroke-width', c.w)
      .attr('stroke-dasharray', c.dash || null)
      .attr('opacity', isVisible ? 0.92 : 0)
      .attr('d', lineGen(c.key));
  });

  // End-of-line labels
  const labelFontSize = Math.max(9.5, W * 0.0115);
  const labelX = Math.max(14, iW - 8);
  const usedYs = [];
  curveDefs.forEach(c => {
    if (!c.available) return;
    const last = pts[pts.length - 1];
    const yv   = last[c.key];
    if (!isFinite(yv)) return;
    let cy = ySc(yv);
    cy = Math.min(iH - 6, Math.max(10, cy));
    // nudge overlapping labels
    let tries = 0;
    while (usedYs.some(uy => Math.abs(uy - cy) < labelFontSize + 3) && tries < 20) {
      cy += (cy < iH / 2 ? -1 : 1) * (labelFontSize + 2);
      cy = Math.min(iH - 6, Math.max(10, cy));
      tries++;
    }
    if (cy < -6 || cy > iH + 6) return;
    usedYs.push(cy);
    const labelText = iW < 760 ? (c.shortLabel || c.label) : c.label;
    g.append('text')
      .attr('x', labelX).attr('y', cy + 4)
      .attr('text-anchor', 'end')
      .attr('fill', c.color)
      .attr('font-size', labelFontSize)
      .attr('font-weight', '500')
      .attr('font-family', 'Inter')
      .attr('paint-order', 'stroke').attr('stroke', '#ffffff').attr('stroke-width', 2.4)
      .attr('opacity', hidden.has(c.id) ? 0.28 : 1)
      .text(labelText);
  });

  // Break-even annotation
  if (be) {
    const beXpRaw = xSc(beN);
    const beXp = Math.min(iW - 7, Math.max(7, beXpRaw));
    const beYp = ySc(be.revenue);
    g.append('circle')
      .attr('cx', beXp).attr('cy', beYp).attr('r', 6)
      .attr('fill','white').attr('stroke','#cc79a7').attr('stroke-width', 2.2);
    const beCalloutX = Math.max(4, beXp - 72);
    const beCallout  = g.append('g').attr('transform', `translate(${beCalloutX},${Math.max(4, beYp - 44)})`);
    beCallout.append('rect')
      .attr('rx', 5).attr('width', 70).attr('height', 20)
      .attr('fill', 'white').attr('stroke', '#cc79a7').attr('stroke-width', 1.5);
    beCallout.append('text')
      .attr('x', 35).attr('y', 14).attr('text-anchor', 'middle')
      .attr('fill', '#cc79a7').attr('font-size', 9)
      .attr('font-family', 'JetBrains Mono').attr('font-weight', '500')
      .text('BREAK-EVEN');
    g.append('line')
      .attr('x1', beCalloutX + 35).attr('y1', Math.max(4, beYp - 44) + 20)
      .attr('x2', beXp).attr('y2', beYp - 7)
      .attr('stroke', '#cc79a7').attr('stroke-width', 1).attr('stroke-dasharray', '3,2');
  } else {
    const nx = Math.max(28, iW - 124);
    const ny = Math.max(18, iH * 0.18);
    const callout = g.append('g').attr('transform', `translate(${nx},${ny})`);
    callout.append('circle')
      .attr('cx', 8).attr('cy', 8).attr('r', 7)
      .attr('fill', '#fff').attr('stroke', '#d55e00').attr('stroke-width', 1.8);
    callout.append('line')
      .attr('x1', 3.8).attr('y1', 12.2)
      .attr('x2', 12.2).attr('y2', 3.8)
      .attr('stroke', '#d55e00').attr('stroke-width', 1.5);
    callout.append('text')
      .attr('x', 22).attr('y', 11)
      .attr('fill', '#d55e00')
      .attr('font-size', Math.max(8, W * 0.0092))
      .attr('font-family', 'JetBrains Mono')
      .attr('letter-spacing', '0.05em')
      .text('No break-even in range');
  }

  // CUD savings bracket
  const cudN  = Math.max(20, nMax * 0.62);
  const cudPt = pts.find(d => d.n >= cudN) || pts[Math.floor(pts.length * 0.6)];
  const y1 = ySc(cudPt.infraRaw), y2 = ySc(cudPt.infraCud);
  const cx = xSc(cudPt.n);
  if (Math.abs(y1 - y2) > 14) {
    g.append('line')
      .attr('x1', cx + 12).attr('x2', cx + 12)
      .attr('y1', y2 + 2).attr('y2', y1 - 2)
      .attr('stroke', '#009e73').attr('stroke-width', 1.5)
      .attr('marker-end', 'url(#arrowCudUp)');
    g.append('text')
      .attr('x', cx + 16).attr('y', (y1 + y2) / 2 + 4)
      .attr('fill', '#009e73').attr('font-size', Math.max(8, W * 0.009))
      .attr('font-family', 'JetBrains Mono').text('CUD savings');
  }

  // Axes
  const tickFontSize = Math.max(9, W * 0.011);
  g.append('g').attr('transform', `translate(0,${iH})`)
    .call(d3.axisBottom(xSc).ticks(Math.max(4, Math.floor(iW / 90)))
      .tickFormat(d => d >= 1000 ? `${d/1000}K` : d))
    .call(a => a.select('.domain').attr('stroke','#ccc'))
    .call(a => a.selectAll('text').attr('fill','#888').attr('font-size', tickFontSize));

  g.append('g')
    .call(d3.axisLeft(ySc).ticks(6)
      .tickFormat(d => Math.abs(d) >= 1000 ? `€${(d/1000).toFixed(0)}K` : `€${d.toFixed(0)}`))
    .call(a => a.select('.domain').attr('stroke','#ccc'))
    .call(a => a.selectAll('text').attr('fill','#888').attr('font-size', tickFontSize));

  const axisLabelSize = Math.max(9.5, W * 0.012);
  svg.append('text')
    .attr('x', M.left + iW / 2).attr('y', H - 8)
    .attr('text-anchor', 'middle').attr('fill', '#888')
    .attr('font-size', axisLabelSize).attr('font-family', 'JetBrains Mono')
    .text('Number of Clients (n)');
  svg.append('text')
    .attr('transform', 'rotate(-90)')
    .attr('x', -(M.top + iH / 2)).attr('y', 14)
    .attr('text-anchor', 'middle').attr('fill', '#888')
    .attr('font-size', axisLabelSize).attr('font-family', 'JetBrains Mono')
    .text('Cost / Revenue (€ per client)');

  // Hover dots
  hoverDots = {};
  curveDefs.forEach(c => {
    hoverDots[c.id] = g.append('circle')
      .attr('r', 4.5).attr('fill', c.color)
      .attr('stroke','white').attr('stroke-width', 1.5).attr('opacity', 0);
  });

  // Vertical cursor line
  const vLine = g.append('line')
    .attr('y1', 0).attr('y2', iH)
    .attr('stroke', '#999').attr('stroke-width', 1)
    .attr('stroke-dasharray', '4,3').attr('opacity', 0);

  // Bisector
  const bisect = d3.bisector(d => d.n).left;

  svg.append('rect')
    .attr('x', M.left).attr('y', M.top)
    .attr('width', iW).attr('height', iH)
    .attr('fill', 'transparent')
    .on('mousemove touchmove', function(event) {
      event.preventDefault();
      const coords = event.touches ? d3.pointer(event.touches[0], this) : d3.pointer(event, this);
      const xVal = xSc.invert(coords[0] - M.left);
      const idx  = Math.min(Math.max(bisect(pts, xVal), 0), pts.length - 1);
      const d    = pts[idx];

      vLine.attr('x1', xSc(d.n)).attr('x2', xSc(d.n)).attr('opacity', 0.7);

      curveDefs.forEach(c => {
        const yv = d[c.key];
        const cy = ySc(yv);
        if (c.available && !hidden.has(c.id) && isFinite(yv) && cy >= -10 && cy <= iH + 10) {
          hoverDots[c.id].attr('cx', xSc(d.n)).attr('cy', cy).attr('opacity', 1);
        } else {
          hoverDots[c.id].attr('opacity', 0);
        }
      });

      // Side panel
      document.getElementById('sp-n').textContent = `${Math.round(d.n).toLocaleString()} clients`;
      document.getElementById('sp-dev').textContent       = fmt(d.dev);
      document.getElementById('sp-infra-raw').textContent = fmt(d.infraRaw);
      document.getElementById('sp-infra-cud').textContent = fmt(d.infraCud);
      document.getElementById('sp-total').textContent     = fmt(d.total);
      document.getElementById('sp-total-rel').textContent = Number.isFinite(d.totalRel) ? fmt(d.totalRel) : '—';
      document.getElementById('sp-revenue').textContent   = fmt(d.revenue);

      const profEl = document.getElementById('sp-profit');
      profEl.textContent  = (d.profit >= 0 ? '+' : '') + fmt(d.profit);
      profEl.className    = 'readout-val ' + (d.profit >= 0 ? 'positive' : 'negative');
      const relProfitEl = document.getElementById('sp-profit-rel');
      if (Number.isFinite(d.profitRel)) {
        relProfitEl.textContent = (d.profitRel >= 0 ? '+' : '') + fmt(d.profitRel);
        relProfitEl.className = 'readout-val ' + (d.profitRel >= 0 ? 'positive' : 'negative');
      } else {
        relProfitEl.textContent = '—';
        relProfitEl.className = 'readout-val muted';
      }
      document.getElementById('sp-price-min').textContent = fmt(d.priceMin);

      const zone = zoneFor(d.n, beN, ssEnd);
      const badge = document.getElementById('sp-zone-badge');
      badge.textContent   = zone.name;
      badge.style.background  = zone.color + '18';
      badge.style.color       = zone.color;
      badge.style.borderColor = zone.color + '44';
      document.getElementById('sp-zone-desc').textContent = zone.desc;
      document.getElementById('sp-insight').textContent   = zone.insight;
    })
    .on('mouseleave touchend', () => {
      vLine.attr('opacity', 0);
      Object.values(hoverDots).forEach(dot => dot.attr('opacity', 0));
    });
}

// ─── RESPONSIVE REDRAW ───────────────────────────────────────────
let resizeTimer;
const chartResizeObserver = new ResizeObserver(() => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(draw, 80);
});
const chartContainerEl = document.getElementById('chart-container');
if (chartContainerEl) chartResizeObserver.observe(chartContainerEl);

// Initial draw
draw();

// ─── CALCULATOR LOGIC ────────────────────────────────────────────

// Default MODEL values for reset
const MODEL_DEFAULTS = { K:50000, a:0.45, c:0.8, b:1.28, g:0.68, ARPU:30, m:0.15, nMax:1000 };

// Track what the user has explicitly provided
const USER_PROVIDED = {
  nRef:false, currency:false, devPerClient:false, infraTotal:false, ARPU:false,
  startupTargetPrice:false, startupTargetClients:false,
  cudPct:false, margin:false, nMax:false,
  budgetMonthly:false, forecastGrowthPct:false, forecastBestEfficiencyPct:false, forecastWorstDriftPct:false,
  savingsIdentified:false, savingsRealized:false, costAvoidance:false,
  techDomains:false, costSaaS:false, costLicensing:false,
  costPrivateCloud:false, costDataCenter:false, costLabor:false,
  aiEnabled:false, aiPricingMode:false,
  aiRatePer1MInput:false, aiRatePer1MOutput:false, aiRatePer1MTotal:false,
  aiInputTokensM:false, aiOutputTokensM:false,
  aiRetryRatePct:false, aiPremiumMixPct:false,
  aiSharedOverheadMonthly:false, aiAllocationPolicy:false,
  reliabilityEnabled:false, sloTargetAvailabilityPct:false, sliObservedAvailabilityPct:false,
  incidentCountMonthly:false, mttrHours:false, incidentBlendedHourlyRate:false,
  criticalRevenuePerMinute:false, arrExposedMonthly:false,
  slaPenaltyRatePerBreachPointMonthly:false, reliabilityInvestmentMonthly:false
};

// Smart default n when user hasn't told us their scale yet
const DEFAULT_N_REF = 100;
const selectedProviders = new Set();
let selectedRecommendationCategory = 'all';
let activeUiIntent = UI_INTENT_DEFAULT;
const RECOMMENDATION_CATEGORY_LABELS = {
  all: 'All',
  infrastructure: 'Infrastructure',
  pricing: 'Pricing',
  marketing: 'Marketing',
  crm: 'CRM',
  governance: 'Governance'
};
const selectedTechDomains = new Set(DEFAULT_TECH_DOMAINS);
let lastInputs = {
  nRef: null, currency: DEFAULT_CURRENCY_CODE, devPerClient: null, infraTotal: null, ARPU: null,
  startupTargetPrice: null, startupTargetClients: null,
  effectiveARPU: null, arpuMode: 'missing',
  cudPct: null, margin: null, nMax: null,
  budgetMonthly: null, forecastGrowthPct: null, forecastBestEfficiencyPct: null, forecastWorstDriftPct: null,
  savingsIdentified: null, savingsRealized: null, costAvoidance: null,
  techDomains: [...DEFAULT_TECH_DOMAINS],
  costSaaS: null, costLicensing: null, costPrivateCloud: null, costDataCenter: null, costLabor: null,
  aiEnabled: false,
  aiPricingMode: 'blended',
  aiRatePer1MInput: null, aiRatePer1MOutput: null, aiRatePer1MTotal: null,
  aiInputTokensM: null, aiOutputTokensM: null,
  aiRetryRatePct: null, aiPremiumMixPct: null,
  aiSharedOverheadMonthly: null, aiAllocationPolicy: 'token-weighted',
  aiMetrics: null,
  reliabilityEnabled: false,
  sloTargetAvailabilityPct: null,
  sliObservedAvailabilityPct: null,
  incidentCountMonthly: null,
  mttrHours: null,
  incidentBlendedHourlyRate: null,
  criticalRevenuePerMinute: null,
  arrExposedMonthly: null,
  slaPenaltyRatePerBreachPointMonthly: null,
  reliabilityInvestmentMonthly: null,
  reliabilityMetrics: null
};

const DEMO_SCENARIOS = {
  healthy: {
    label: 'Healthy',
    summary: 'Review Health Zone, output indicators, and recommendation quality in a positive trajectory.',
    state: {
      v: SHARE_STATE_VERSION,
      ui: 'operations',
      um: 'operator',
      i: {
        nRef: 420,
        devPerClient: 210,
        infraTotal: 3600,
        ARPU: 95,
        startupTargetPrice: 96,
        startupTargetClients: 420,
        cudPct: 58,
        margin: 20,
        nMax: 3000,
        budgetMonthly: 9000,
        forecastGrowthPct: 18,
        forecastBestEfficiencyPct: 12,
        forecastWorstDriftPct: 4,
        savingsIdentified: 2800,
        savingsRealized: 2350,
        costAvoidance: 950,
        costSaaS: 620,
        costLicensing: 350,
        costPrivateCloud: 220,
        costDataCenter: 160,
        costLabor: 430,
        aiEnabled: 'on',
        aiPricingMode: 'blended',
        aiRatePer1MInput: 3,
        aiRatePer1MOutput: 9,
        aiRatePer1MTotal: 5,
        aiInputTokensM: 9,
        aiOutputTokensM: 6,
        aiRetryRatePct: 4,
        aiPremiumMixPct: 9,
        aiSharedOverheadMonthly: 700,
        aiAllocationPolicy: 'token-weighted',
        reliabilityEnabled: 'on',
        sloTargetAvailabilityPct: 99.9,
        sliObservedAvailabilityPct: 99.82,
        incidentCountMonthly: 2,
        mttrHours: 0.9,
        incidentBlendedHourlyRate: 95,
        criticalRevenuePerMinute: 24,
        arrExposedMonthly: 65000,
        slaPenaltyRatePerBreachPointMonthly: 3000,
        reliabilityInvestmentMonthly: 1800
      },
      td: [...VALID_TECH_DOMAIN_KEYS],
      p: ['aws', 'azure', 'gcp'],
      h: []
    }
  },
  unhealthy: {
    label: 'Unhealthy',
    summary: 'See red-zone behavior, weak unit economics, and remediation guidance in action.',
    state: {
      v: SHARE_STATE_VERSION,
      ui: 'operations',
      um: 'operator',
      i: {
        nRef: 55,
        devPerClient: 1200,
        infraTotal: 6400,
        ARPU: 18,
        startupTargetPrice: 20,
        startupTargetClients: 90,
        cudPct: 0,
        margin: 30,
        nMax: 1800,
        budgetMonthly: 4200,
        forecastGrowthPct: -12,
        forecastBestEfficiencyPct: 1,
        forecastWorstDriftPct: 35,
        savingsIdentified: 3600,
        savingsRealized: 280,
        costAvoidance: 60,
        costSaaS: 1500,
        costLicensing: 1200,
        costPrivateCloud: 1450,
        costDataCenter: 980,
        costLabor: 1800,
        aiEnabled: 'on',
        aiPricingMode: 'tiered',
        aiRatePer1MInput: 5,
        aiRatePer1MOutput: 18,
        aiRatePer1MTotal: 12,
        aiInputTokensM: 24,
        aiOutputTokensM: 17,
        aiRetryRatePct: 45,
        aiPremiumMixPct: 72,
        aiSharedOverheadMonthly: 3200,
        aiAllocationPolicy: 'premium-weighted',
        reliabilityEnabled: 'on',
        sloTargetAvailabilityPct: 99.9,
        sliObservedAvailabilityPct: 98.9,
        incidentCountMonthly: 11,
        mttrHours: 3.7,
        incidentBlendedHourlyRate: 140,
        criticalRevenuePerMinute: 110,
        arrExposedMonthly: 180000,
        slaPenaltyRatePerBreachPointMonthly: 12000,
        reliabilityInvestmentMonthly: 900
      },
      td: [...VALID_TECH_DOMAIN_KEYS],
      p: ['aws', 'azure', 'gcp'],
      h: []
    }
  },
  reliability: {
    label: 'Reliability (Release 4)',
    summary: 'SLA/SLO/SLI reliability economics scenario loaded with visible risk/downside trade-offs.',
    focusSelector: '#field-reliabilityEnabled',
    state: {
      v: SHARE_STATE_VERSION,
      ui: 'operations',
      um: 'operator',
      i: {
        nRef: 220,
        devPerClient: 330,
        infraTotal: 5200,
        ARPU: 58,
        startupTargetPrice: 62,
        startupTargetClients: 260,
        cudPct: 22,
        margin: 18,
        nMax: 2500,
        budgetMonthly: 9200,
        forecastGrowthPct: 9,
        forecastBestEfficiencyPct: 6,
        forecastWorstDriftPct: 11,
        savingsIdentified: 1700,
        savingsRealized: 620,
        costAvoidance: 340,
        costSaaS: 980,
        costLicensing: 560,
        costPrivateCloud: 430,
        costDataCenter: 250,
        costLabor: 760,
        aiEnabled: 'off',
        reliabilityEnabled: 'on',
        sloTargetAvailabilityPct: 99.9,
        sliObservedAvailabilityPct: 99.4,
        incidentCountMonthly: 5,
        mttrHours: 1.8,
        incidentBlendedHourlyRate: 120,
        criticalRevenuePerMinute: 40,
        arrExposedMonthly: 90000,
        slaPenaltyRatePerBreachPointMonthly: 5000,
        reliabilityInvestmentMonthly: 2100
      },
      td: [...VALID_TECH_DOMAIN_KEYS],
      p: ['aws', 'azure'],
      h: []
    }
  },
  reliabilityHealthy: {
    label: 'Reliability Healthy (Release 4)',
    summary: 'SLA/SLO/SLI reliability economics healthy case loaded with low breach-risk and stronger resilience posture.',
    focusSelector: '#field-reliabilityEnabled',
    state: {
      v: SHARE_STATE_VERSION,
      ui: 'operations',
      um: 'operator',
      i: {
        nRef: 260,
        devPerClient: 280,
        infraTotal: 4700,
        ARPU: 66,
        startupTargetPrice: 68,
        startupTargetClients: 260,
        cudPct: 34,
        margin: 18,
        nMax: 2500,
        budgetMonthly: 9000,
        forecastGrowthPct: 11,
        forecastBestEfficiencyPct: 8,
        forecastWorstDriftPct: 7,
        savingsIdentified: 1900,
        savingsRealized: 1250,
        costAvoidance: 480,
        costSaaS: 760,
        costLicensing: 420,
        costPrivateCloud: 300,
        costDataCenter: 190,
        costLabor: 640,
        aiEnabled: 'off',
        reliabilityEnabled: 'on',
        sloTargetAvailabilityPct: 99.9,
        sliObservedAvailabilityPct: 99.93,
        incidentCountMonthly: 1,
        mttrHours: 0.6,
        incidentBlendedHourlyRate: 100,
        criticalRevenuePerMinute: 28,
        arrExposedMonthly: 78000,
        slaPenaltyRatePerBreachPointMonthly: 4500,
        reliabilityInvestmentMonthly: 2600
      },
      td: [...VALID_TECH_DOMAIN_KEYS],
      p: ['aws', 'azure'],
      h: []
    }
  },
  reliabilityUnhealthy: {
    label: 'Reliability Unhealthy (Release 4)',
    summary: 'SLA/SLO/SLI reliability economics stress case loaded with elevated breach-risk and downside exposure.',
    focusSelector: '#field-reliabilityEnabled',
    state: {
      v: SHARE_STATE_VERSION,
      ui: 'operations',
      um: 'operator',
      i: {
        nRef: 180,
        devPerClient: 420,
        infraTotal: 5900,
        ARPU: 52,
        startupTargetPrice: 58,
        startupTargetClients: 220,
        cudPct: 12,
        margin: 18,
        nMax: 2500,
        budgetMonthly: 9600,
        forecastGrowthPct: 4,
        forecastBestEfficiencyPct: 3,
        forecastWorstDriftPct: 16,
        savingsIdentified: 1500,
        savingsRealized: 420,
        costAvoidance: 220,
        costSaaS: 1160,
        costLicensing: 620,
        costPrivateCloud: 520,
        costDataCenter: 290,
        costLabor: 880,
        aiEnabled: 'off',
        reliabilityEnabled: 'on',
        sloTargetAvailabilityPct: 99.9,
        sliObservedAvailabilityPct: 99.1,
        incidentCountMonthly: 9,
        mttrHours: 3.2,
        incidentBlendedHourlyRate: 145,
        criticalRevenuePerMinute: 95,
        arrExposedMonthly: 130000,
        slaPenaltyRatePerBreachPointMonthly: 9500,
        reliabilityInvestmentMonthly: 900
      },
      td: [...VALID_TECH_DOMAIN_KEYS],
      p: ['aws', 'azure'],
      h: []
    }
  }
};

const RECOMMENDATIONS = [
  { icon:'⚠️', title:'You are below break-even', desc:'Current client volume is below the minimum viable threshold; fixed and variable costs are not yet recovered.', action:'Action: Review pricing page and sales funnel conversion. Prioritise moving n above N_min within the next planning cycle.', providers:[], zones:['red'], priority:'high' },
  { icon:'📉', title:'CCER below 3×', desc:'Cloud Cost Efficiency Ratio is below FinOps benchmark. Revenue generated per euro of cloud spend is under target.', action:'Action: In your billing console, isolate top cost drivers and enforce unit economics guardrails per service.', providers:[], zones:['red','yellow'], priority:'high' },
  { icon:'🛑', title:'Contribution margin is negative', desc:'VCPU is equal to or higher than ARPU. Every incremental client currently destroys value.', action:'Action: Increase package price floor or reduce per-client infra usage before scaling customer acquisition.', providers:[], zones:['red'], priority:'high' },
  { icon:'💳', title:'CUDs/Savings Plans not fully applied', desc:'Discount gap is still material versus committed pricing options. Commitment strategy is likely under-utilised.', action:'Action: Review 12-month steady-state usage and map eligible workloads to commitment instruments.', providers:[], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🏷️', title:'Implement FinOps cost allocation tagging', desc:'Without consistent tags, accountability and optimisation loops remain weak across teams.', action:'Action: Enforce mandatory tags for owner, environment, product, and cost-center in IaC and policy checks.', providers:[], zones:['green'], priority:'low' },
  { icon:'🔮', title:'Set up 12-month cost forecasting', desc:'Proactive forecasting improves commitment timing, budget confidence, and board-level planning.', action:'Action: Build monthly forecast scenarios (base/growth/stress) and review variance at each month close.', providers:[], zones:['green'], priority:'low' },
  { icon:'🧾', title:'AWS Savings Plans coverage', desc:'Compute Savings Plans can reduce eligible compute spend significantly when baseline usage is stable.', action:'Action: AWS Console → Billing and Cost Management → Savings Plans → Recommendations.', providers:['aws'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'📏', title:'AWS right-sizing opportunities', desc:'Idle and oversized resources create avoidable waste in EC2, EBS, and managed services.', action:'Action: AWS Cost Explorer → Rightsizing Recommendations; prioritise top monthly impact accounts.', providers:['aws'], zones:['yellow','red'], priority:'medium' },
  { icon:'⚡', title:'Use Spot for fault-tolerant workloads', desc:'Spot capacity can materially reduce non-critical compute costs for resilient jobs.', action:'Action: EC2 Auto Scaling Groups → Mixed Instances Policy with Spot allocation strategies.', providers:['aws'], zones:['yellow','red'], priority:'medium' },
  { icon:'🚨', title:'Enable Cost Anomaly Detection', desc:'Unexpected spikes should be detected rapidly to reduce financial blast radius.', action:'Action: AWS Console → Cost Management → Cost Anomaly Detection → Create monitor and alerts.', providers:['aws'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🗄️', title:'S3 Intelligent-Tiering for cold data', desc:'Automatically shifting infrequently accessed objects reduces storage spend with minimal effort.', action:'Action: S3 Bucket → Management → Lifecycle rules and Intelligent-Tiering transition policy.', providers:['aws'], zones:['green'], priority:'low' },
  { icon:'📦', title:'Azure Reservations + Hybrid Benefit', desc:'Reserved capacity and license benefits can materially reduce long-running VM/database costs.', action:'Action: Azure Portal → Cost Management + Billing → Reservations → Purchase recommendations.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'🧠', title:'Azure Advisor cost recommendations', desc:'Advisor identifies right-size, idle shutdown, and architecture-level cost opportunities.', action:'Action: Azure Portal → Advisor → Cost tab; export recommendations into remediation backlog.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'🚨', title:'Azure budget alerts and controls', desc:'Budget and anomaly alerting strengthens accountability before overruns become systemic.', action:'Action: Azure Portal → Cost Management → Budgets → Create budget with action groups.', providers:['azure'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🏷️', title:'Azure Spot VMs for non-critical jobs', desc:'Spot VMs reduce compute spend for interruption-tolerant processing.', action:'Action: Azure Portal → Virtual Machines → Spot instance deployment for candidate workloads.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'📉', title:'GCP Resource-based CUDs', desc:'Resource-based commitments can reduce sustained baseline compute spend on eligible workloads.', action:'Action: Google Cloud Console → Billing → Committed Use Discounts → Purchase commitments.', providers:['gcp'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🔍', title:'Verify Sustained Use Discounts', desc:'Check whether workloads are reaching expected utilisation to realise automatic discount benefits.', action:'Action: GCP Billing export → BigQuery; validate sustained usage discount effectiveness by SKU.', providers:['gcp'], zones:['green','yellow'], priority:'low' },
  { icon:'🧹', title:'Use GCP Recommender for idle resources', desc:'Idle resources continue to consume spend without revenue contribution.', action:'Action: GCP Console → Recommender → Cost recommendations and cleanup actions.', providers:['gcp'], zones:['yellow','red'], priority:'high' },
  { icon:'📨', title:'Set Billing Budget alerts with Pub/Sub', desc:'Automated budget threshold events help trigger operational response workflows quickly.', action:'Action: GCP Console → Billing → Budgets & alerts → Enable Pub/Sub notifications.', providers:['gcp'], zones:['green','yellow','red'], priority:'high' },
  { icon:'⚙️', title:'BigQuery query cost controls', desc:'Query cost can drift quickly without governance on scan bytes and query patterns.', action:'Action: BigQuery → Reservations/Quotas + max bytes billed + scheduled query audits.', providers:['gcp'], zones:['yellow','red'], priority:'medium' },
  { icon:'💼', title:'OCI Universal Credits planning', desc:'Universal Credits can improve commitment flexibility when workloads shift across OCI services.', action:'Action: OCI Console → Billing and Cost Management → Usage and Credit Allocation review.', providers:['oci'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🆓', title:'OCI Always Free for dev/test', desc:'Move suitable non-production workloads to Always Free resources where practical.', action:'Action: OCI Console → Compute/Storage provisioning templates mapped to Always Free limits.', providers:['oci'], zones:['green'], priority:'low' },
  { icon:'🧾', title:'IBM Reserved Virtual Servers', desc:'Long-running workloads should be shifted to reservation models for lower unit costs.', action:'Action: IBM Cloud Console → Billing and Usage → Reservation planning for persistent workloads.', providers:['ibm'], zones:['yellow','red'], priority:'medium' },
  { icon:'🌱', title:'IBM sustainability + cost co-optimisation', desc:'Joint carbon and cost intelligence can identify high-impact remediation opportunities.', action:'Action: IBM Environmental Intelligence Suite + cost reports for optimisation prioritisation.', providers:['ibm'], zones:['green'], priority:'low' },
  { icon:'📦', title:'Alibaba subscription billing shift', desc:'Subscription billing can materially reduce compute costs versus pay-as-you-go baselines.', action:'Action: Alibaba Console → Billing → Resource Plans / Subscription migration candidates.', providers:['alibaba'], zones:['yellow','red'], priority:'medium' },
  { icon:'🧾', title:'Huawei ECS Reservations', desc:'Reservation strategies reduce long-run compute cost where workloads are predictable.', action:'Action: Huawei Cloud Console → Billing Center → Reserved Instances for ECS fleet.', providers:['huawei'], zones:['yellow','red'], priority:'medium' },
  { icon:'🏢', title:'On-Prem capacity rightsizing cadence', desc:'Without recurring capacity rightsizing, fixed data-center spend can drift away from real demand.', action:'Action: Data center ops console → host/cluster utilization review → right-size overprovisioned VM and storage pools.', providers:['onprem'], zones:['yellow','red'], priority:'high' },
  { icon:'📊', title:'On-Prem showback and cost allocation baseline', desc:'Service-level showback is required to expose who consumes compute, storage, and facility-backed resources.', action:'Action: Define service cost model and publish monthly showback with owner, environment, and service tags.', providers:['onprem'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🧭', title:'Adopt unified multi-cloud FinOps platform', desc:'Cross-cloud visibility and unit economics governance require a single cost operating model.', action:'Action: Integrate billing exports into a common platform (CloudHealth/OpenCost/warehouse model).', providers:['multi'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🌐', title:'Control inter-region / inter-cloud egress', desc:'Network egress charges often become hidden margin erosion drivers in multi-cloud topologies.', action:'Action: Build monthly egress map by service path; redesign data flows to reduce charge-heavy hops.', providers:['multi'], zones:['green','yellow','red'], priority:'medium' }
];

const OUTPUT_CARD_CATEGORY_MAP = {
  'out-beN': 'pricing',
  'out-minPrice': 'pricing',
  'out-vcpu': 'infrastructure',
  'out-margin': 'pricing',
  'out-ccer': 'infrastructure',
  'out-cudSave': 'infrastructure',
  'out-reqClients': 'marketing',
  'out-reqPrice': 'pricing',
  'out-targetRevenue': 'marketing',
  'out-budgetVariance': 'governance',
  'out-forecastBand': 'governance',
  'out-forecastSpread': 'governance',
  'out-realizedValue': 'governance',
  'out-realizationRatio': 'governance',
  'out-realizationGap': 'governance',
  'out-techCoverage': 'governance',
  'out-techNorm': 'infrastructure',
  'out-focusMaturity': 'governance',
  'out-aiTokenCost': 'infrastructure',
  'out-aiAllocatedCost': 'governance',
  'out-aiCostPerClient': 'pricing',
  'out-aiRetryInflation': 'infrastructure',
  'out-aiPremiumMix': 'pricing',
  'out-relDowntime': 'infrastructure',
  'out-relFailureCost': 'governance',
  'out-relAdjustedCost': 'governance',
  'out-relProfitImpact': 'pricing',
  'out-relArpuUplift': 'pricing',
  'out-relExtraClients': 'marketing',
  'out-relRiskBand': 'governance',
  'out-relDataConfidence': 'governance'
};

const PROVIDER_OFFICIAL_REFERENCE_MAP = {
  aws: [
    { label: 'AWS Cost Optimization pillar', url: OFFICIAL_REFERENCE_URLS.awsCostOptimization },
    { label: 'AWS rightsizing recommendations', url: OFFICIAL_REFERENCE_URLS.awsRightsizing }
  ],
  azure: [
    { label: 'Azure Cost Optimization', url: OFFICIAL_REFERENCE_URLS.azureCostOptimization },
    { label: 'Azure Advisor cost recommendations', url: OFFICIAL_REFERENCE_URLS.azureAdvisor }
  ],
  gcp: [
    { label: 'GCP billing budgets', url: OFFICIAL_REFERENCE_URLS.gcpBudgets },
    { label: 'GCP Recommender docs', url: OFFICIAL_REFERENCE_URLS.gcpRecommender }
  ],
  oci: [
    { label: 'OCI billing overview', url: OFFICIAL_REFERENCE_URLS.ociBilling },
    { label: 'OCI Always Free', url: OFFICIAL_REFERENCE_URLS.ociAlwaysFree }
  ],
  ibm: [
    { label: 'IBM Cloud billing docs', url: OFFICIAL_REFERENCE_URLS.ibmBilling },
    { label: 'IBM sustainability suite', url: OFFICIAL_REFERENCE_URLS.ibmSustainability }
  ],
  alibaba: [
    { label: 'Alibaba Cloud billing overview', url: OFFICIAL_REFERENCE_URLS.alibabaBilling }
  ],
  huawei: [
    { label: 'Huawei Cloud billing docs', url: OFFICIAL_REFERENCE_URLS.huaweiBilling }
  ],
  onprem: [
    { label: 'VMware vSphere resource management', url: OFFICIAL_REFERENCE_URLS.onPremVmwareResourceManagement, providers: ['onprem'] },
    { label: 'OpenCost documentation', url: OFFICIAL_REFERENCE_URLS.openCost, providers: ['onprem'] }
  ],
  multi: [
    { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation },
    { label: 'OpenCost documentation', url: OFFICIAL_REFERENCE_URLS.openCost }
  ]
};

const CATEGORY_OFFICIAL_REFERENCE_MAP = {
  infrastructure: [
    { label: 'FinOps workload optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsWorkloadOptimization },
    { label: 'FinOps rate optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsRateOptimization }
  ],
  pricing: [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
  ],
  marketing: [
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice },
    { label: 'Forecasting benchmark (M4)', url: OFFICIAL_REFERENCE_URLS.forecastingBenchmark }
  ],
  crm: [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice }
  ],
  governance: [
    { label: 'FinOps budget management capability', url: OFFICIAL_REFERENCE_URLS.finopsBudgetManagement },
    { label: 'FinOps anomaly management capability', url: OFFICIAL_REFERENCE_URLS.finopsAnomalyManagement },
    { label: 'Uncertainty guide (JCGM 100)', url: OFFICIAL_REFERENCE_URLS.uncertaintyGuide }
  ]
};

const OUTPUT_CARD_OFFICIAL_REFERENCE_MAP = {
  'out-beN': [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
  ],
  'out-minPrice': [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
  ],
  'out-vcpu': [
    { label: 'AWS rightsizing recommendations', url: OFFICIAL_REFERENCE_URLS.awsRightsizing },
    { label: 'Azure Advisor cost recommendations', url: OFFICIAL_REFERENCE_URLS.azureAdvisor },
    { label: 'GCP Recommender docs', url: OFFICIAL_REFERENCE_URLS.gcpRecommender }
  ],
  'out-margin': [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
  ],
  'out-ccer': [
    { label: 'AWS Cost Optimization pillar', url: OFFICIAL_REFERENCE_URLS.awsCostOptimization },
    { label: 'Azure Cost Optimization', url: OFFICIAL_REFERENCE_URLS.azureCostOptimization },
    { label: 'GCP Recommender docs', url: OFFICIAL_REFERENCE_URLS.gcpRecommender }
  ],
  'out-cudSave': [
    { label: 'GCP committed use discounts', url: OFFICIAL_REFERENCE_URLS.googleCud },
    { label: 'AWS Savings Plans', url: OFFICIAL_REFERENCE_URLS.awsSavingsPlans },
    { label: 'Azure reservations', url: OFFICIAL_REFERENCE_URLS.azureReservations }
  ],
  'out-reqClients': [
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice },
    { label: 'Forecasting benchmark (M4)', url: OFFICIAL_REFERENCE_URLS.forecastingBenchmark }
  ],
  'out-reqPrice': [
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
  ],
  'out-targetRevenue': [
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice },
    { label: 'Forecasting benchmark (M4)', url: OFFICIAL_REFERENCE_URLS.forecastingBenchmark }
  ],
  'out-budgetVariance': [
    { label: 'FinOps budget management capability', url: OFFICIAL_REFERENCE_URLS.finopsBudgetManagement },
    { label: 'Azure budget controls tutorial', url: OFFICIAL_REFERENCE_URLS.azureBudgets },
    { label: 'GCP budget alerts', url: OFFICIAL_REFERENCE_URLS.gcpBudgets }
  ],
  'out-forecastBand': [
    { label: 'FinOps forecasting capability', url: OFFICIAL_REFERENCE_URLS.finopsForecasting },
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice },
    { label: 'Forecasting benchmark (M4)', url: OFFICIAL_REFERENCE_URLS.forecastingBenchmark }
  ],
  'out-forecastSpread': [
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice },
    { label: 'Uncertainty guide (JCGM 100)', url: OFFICIAL_REFERENCE_URLS.uncertaintyGuide }
  ],
  'out-realizedValue': [
    { label: 'FinOps anomaly management capability', url: OFFICIAL_REFERENCE_URLS.finopsAnomalyManagement },
    { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation }
  ],
  'out-realizationRatio': [
    { label: 'FinOps anomaly management capability', url: OFFICIAL_REFERENCE_URLS.finopsAnomalyManagement },
    { label: 'FinOps forecasting capability', url: OFFICIAL_REFERENCE_URLS.finopsForecasting }
  ],
  'out-realizationGap': [
    { label: 'FinOps anomaly management capability', url: OFFICIAL_REFERENCE_URLS.finopsAnomalyManagement },
    { label: 'FinOps budget management capability', url: OFFICIAL_REFERENCE_URLS.finopsBudgetManagement }
  ],
  'out-techCoverage': [
    { label: 'Composite indicators handbook', url: COMPOSITE_INDEX_REFERENCE_URL },
    { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation }
  ],
  'out-techNorm': [
    { label: 'TDABC reference', url: TDABC_REFERENCE_URL },
    { label: 'Composite indicators handbook', url: COMPOSITE_INDEX_REFERENCE_URL }
  ],
  'out-focusMaturity': [
    { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation },
    { label: 'Composite indicators handbook', url: COMPOSITE_INDEX_REFERENCE_URL }
  ],
  'out-aiTokenCost': [
    { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
    { label: 'OpenAI rate-limit guidance', url: OFFICIAL_REFERENCE_URLS.openaiRateLimits }
  ],
  'out-aiAllocatedCost': [
    { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
    { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation }
  ],
  'out-aiCostPerClient': [
    { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics }
  ],
  'out-aiRetryInflation': [
    { label: 'OpenAI rate-limits guide', url: OFFICIAL_REFERENCE_URLS.openaiRateLimits },
    { label: 'FinOps workload optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsWorkloadOptimization }
  ],
  'out-aiPremiumMix': [
    { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
    { label: 'FinOps rate optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsRateOptimization }
  ],
  'out-relDowntime': [
    { label: 'Google SRE book', url: OFFICIAL_REFERENCE_URLS.sreBook },
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook }
  ],
  'out-relFailureCost': [
    { label: 'Google SRE book', url: OFFICIAL_REFERENCE_URLS.sreBook },
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook }
  ],
  'out-relAdjustedCost': [
    { label: 'Google SRE book', url: OFFICIAL_REFERENCE_URLS.sreBook },
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics }
  ],
  'out-relProfitImpact': [
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook },
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics }
  ],
  'out-relArpuUplift': [
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook },
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics }
  ],
  'out-relExtraClients': [
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook },
    { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice }
  ],
  'out-relRiskBand': [
    { label: 'Google SRE book', url: OFFICIAL_REFERENCE_URLS.sreBook },
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook }
  ],
  'out-relDataConfidence': [
    { label: 'Uncertainty guide (JCGM 100)', url: OFFICIAL_REFERENCE_URLS.uncertaintyGuide },
    { label: 'Google SRE workbook', url: OFFICIAL_REFERENCE_URLS.sreWorkbook }
  ]
};

const RECOMMENDATION_TITLE_REFERENCE_RULES = [
  {
    test: /below break-even|negative break-even/i,
    refs: [
      { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
      { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
    ]
  },
  {
    test: /ccer below|cloud cost efficiency/i,
    refs: [
      { label: 'AWS Cost Optimization pillar', url: OFFICIAL_REFERENCE_URLS.awsCostOptimization },
      { label: 'Azure Cost Optimization', url: OFFICIAL_REFERENCE_URLS.azureCostOptimization },
      { label: 'GCP Recommender docs', url: OFFICIAL_REFERENCE_URLS.gcpRecommender }
    ]
  },
  {
    test: /contribution margin is negative|reprice ai-heavy/i,
    refs: [
      { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
      { label: 'TDABC reference', url: TDABC_REFERENCE_URL }
    ]
  },
  {
    test: /cost allocation tagging/i,
    refs: [
      { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation },
      { label: 'NIST cloud definition', url: OFFICIAL_REFERENCE_URLS.nistCloud }
    ]
  },
  {
    test: /12-month cost forecasting|forecast/i,
    refs: [
      { label: 'FinOps forecasting capability', url: OFFICIAL_REFERENCE_URLS.finopsForecasting },
      { label: 'Forecasting principles', url: OFFICIAL_REFERENCE_URLS.forecastingPractice }
    ]
  },
  {
    test: /savings plans/i,
    refs: [
      { label: 'AWS Savings Plans', url: OFFICIAL_REFERENCE_URLS.awsSavingsPlans, providers: ['aws'] },
      { label: 'Azure reservations guidance', url: OFFICIAL_REFERENCE_URLS.azureReservations, providers: ['azure'] },
      { label: 'GCP committed use discounts', url: OFFICIAL_REFERENCE_URLS.googleCud, providers: ['gcp'] },
      { label: 'FinOps rate optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsRateOptimization }
    ]
  },
  {
    test: /right-sizing/i,
    refs: [
      { label: 'AWS rightsizing recommendations', url: OFFICIAL_REFERENCE_URLS.awsRightsizing }
    ]
  },
  {
    test: /spot/i,
    refs: [
      { label: 'AWS Spot instances', url: OFFICIAL_REFERENCE_URLS.awsSpot },
      { label: 'Azure Spot VMs', url: OFFICIAL_REFERENCE_URLS.azureSpot }
    ]
  },
  {
    test: /cost anomaly detection|anomaly/i,
    refs: [
      { label: 'AWS Cost Anomaly Detection', url: OFFICIAL_REFERENCE_URLS.awsAnomalyDetection },
      { label: 'FinOps anomaly management capability', url: OFFICIAL_REFERENCE_URLS.finopsAnomalyManagement }
    ]
  },
  {
    test: /intelligent-tiering/i,
    refs: [
      { label: 'S3 Intelligent-Tiering', url: OFFICIAL_REFERENCE_URLS.awsS3IntelligentTiering }
    ]
  },
  {
    test: /azure reservations|hybrid benefit/i,
    refs: [
      { label: 'Azure reservations guidance', url: OFFICIAL_REFERENCE_URLS.azureReservations }
    ]
  },
  {
    test: /azure advisor/i,
    refs: [
      { label: 'Azure Advisor cost recommendations', url: OFFICIAL_REFERENCE_URLS.azureAdvisor }
    ]
  },
  {
    test: /azure budget/i,
    refs: [
      { label: 'Azure budget controls tutorial', url: OFFICIAL_REFERENCE_URLS.azureBudgets }
    ]
  },
  {
    test: /resource-based cud/i,
    refs: [
      { label: 'GCP committed use discounts', url: OFFICIAL_REFERENCE_URLS.googleCud }
    ]
  },
  {
    test: /sustained use discounts/i,
    refs: [
      { label: 'GCP sustained use discounts', url: OFFICIAL_REFERENCE_URLS.gcpSud },
      { label: 'GCP billing export to BigQuery', url: OFFICIAL_REFERENCE_URLS.gcpBillingExport }
    ]
  },
  {
    test: /gcp recommender/i,
    refs: [
      { label: 'GCP Recommender docs', url: OFFICIAL_REFERENCE_URLS.gcpRecommender }
    ]
  },
  {
    test: /pub\/sub/i,
    refs: [
      { label: 'GCP budget Pub/Sub notifications', url: OFFICIAL_REFERENCE_URLS.gcpBudgetPubSub }
    ]
  },
  {
    test: /bigquery query cost controls/i,
    refs: [
      { label: 'BigQuery cost optimization best practices', url: OFFICIAL_REFERENCE_URLS.gcpBigQueryCosts },
      { label: 'BigQuery reservations overview', url: OFFICIAL_REFERENCE_URLS.gcpBigQueryReservations }
    ]
  },
  {
    test: /oci universal credits/i,
    refs: [
      { label: 'OCI billing overview', url: OFFICIAL_REFERENCE_URLS.ociBilling }
    ]
  },
  {
    test: /oci always free/i,
    refs: [
      { label: 'OCI Always Free', url: OFFICIAL_REFERENCE_URLS.ociAlwaysFree }
    ]
  },
  {
    test: /ibm reserved virtual servers/i,
    refs: [
      { label: 'IBM Cloud billing docs', url: OFFICIAL_REFERENCE_URLS.ibmBilling }
    ]
  },
  {
    test: /ibm sustainability/i,
    refs: [
      { label: 'IBM Environmental Intelligence Suite', url: OFFICIAL_REFERENCE_URLS.ibmSustainability }
    ]
  },
  {
    test: /alibaba subscription billing/i,
    refs: [
      { label: 'Alibaba Cloud billing overview', url: OFFICIAL_REFERENCE_URLS.alibabaBilling }
    ]
  },
  {
    test: /huawei ecs reservations/i,
    refs: [
      { label: 'Huawei Cloud billing docs', url: OFFICIAL_REFERENCE_URLS.huaweiBilling }
    ]
  },
  {
    test: /multi-cloud finops platform/i,
    refs: [
      { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation },
      { label: 'OpenCost documentation', url: OFFICIAL_REFERENCE_URLS.openCost }
    ]
  },
  {
    test: /on-prem|data center/i,
    refs: [
      { label: 'VMware vSphere resource management', url: OFFICIAL_REFERENCE_URLS.onPremVmwareResourceManagement, providers: ['onprem'] },
      { label: 'OpenCost documentation', url: OFFICIAL_REFERENCE_URLS.openCost, providers: ['onprem'] }
    ]
  },
  {
    test: /inter-region|inter-cloud egress/i,
    refs: [
      { label: 'AWS Cost Optimization pillar', url: OFFICIAL_REFERENCE_URLS.awsCostOptimization },
      { label: 'Azure Cost Optimization', url: OFFICIAL_REFERENCE_URLS.azureCostOptimization }
    ]
  },
  {
    test: /ai retry inflation/i,
    refs: [
      { label: 'OpenAI rate-limit guidance', url: OFFICIAL_REFERENCE_URLS.openaiRateLimits },
      { label: 'FinOps workload optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsWorkloadOptimization }
    ]
  },
  {
    test: /premium model routing|ai premium mix/i,
    refs: [
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing },
      { label: 'FinOps rate optimization capability', url: OFFICIAL_REFERENCE_URLS.finopsRateOptimization }
    ]
  },
  {
    test: /allocation telemetry|ai allocation/i,
    refs: [
      { label: 'FinOps allocation capability', url: OFFICIAL_REFERENCE_URLS.finopsAllocation },
      { label: 'OpenAI API pricing', url: OFFICIAL_REFERENCE_URLS.openaiPricing }
    ]
  }
];

const KNOWN_PROVIDER_KEYS = ['aws', 'azure', 'gcp', 'oci', 'ibm', 'alibaba', 'huawei', 'onprem', 'multi'];
const PROVIDER_REFERENCE_DETECTION_RULES = {
  aws: [/aws\.amazon\.com/i, /docs\.aws\.amazon\.com/i, /\baws\b/i],
  azure: [/learn\.microsoft\.com/i, /\bazure\b/i],
  gcp: [/cloud\.google\.com/i, /\bgcp\b/i, /google cloud/i, /bigquery/i],
  oci: [/oracle\.com/i, /docs\.oracle\.com/i, /\boci\b/i],
  ibm: [/cloud\.ibm\.com/i, /\bibm\b/i],
  alibaba: [/alibabacloud\.com/i, /\balibaba\b/i],
  huawei: [/huaweicloud\.com/i, /\bhuawei\b/i],
  onprem: [/vmware\.com/i, /on-?prem/i, /data center/i],
  multi: [/opencost\.io/i, /multi-cloud/i]
};

function normalizeProviderKeys(providers = []) {
  const seen = new Set();
  return (Array.isArray(providers) ? providers : [])
    .map(provider => String(provider || '').trim().toLowerCase())
    .filter(provider => KNOWN_PROVIDER_KEYS.includes(provider))
    .filter(provider => {
      if (seen.has(provider)) return false;
      seen.add(provider);
      return true;
    });
}

function getActiveProviderScope(overrideProviders = []) {
  const explicit = normalizeProviderKeys(overrideProviders);
  if (explicit.length) {
    return explicit.length >= 2 && !explicit.includes('multi')
      ? [...explicit, 'multi']
      : explicit;
  }

  const selected = normalizeProviderKeys(Array.from(selectedProviders));
  if (selected.length >= 2 && !selected.includes('multi')) {
    return [...selected, 'multi'];
  }
  return selected;
}

function detectReferenceProviders(ref) {
  const explicit = normalizeProviderKeys(ref && ref.providers ? ref.providers : []);
  if (explicit.length) return explicit;

  const haystack = `${ref?.label || ''} ${ref?.url || ''}`;
  return KNOWN_PROVIDER_KEYS.filter(provider => {
    const rules = PROVIDER_REFERENCE_DETECTION_RULES[provider] || [];
    return rules.some(rule => rule.test(haystack));
  });
}

function filterReferencesForProviderScope(refs = [], providerScope = []) {
  const normalizedRefs = normalizeOfficialReferences(refs);
  if (!normalizedRefs.length) return [];

  const scopedProviders = normalizeProviderKeys(providerScope);
  if (!scopedProviders.length) return normalizedRefs;

  const hasProviderSpecificRefs = normalizedRefs.some(ref => detectReferenceProviders(ref).length > 0);
  if (!hasProviderSpecificRefs) return normalizedRefs;

  const filtered = normalizedRefs.filter(ref => {
    const refProviders = detectReferenceProviders(ref);
    if (!refProviders.length) return true;
    return refProviders.some(provider => scopedProviders.includes(provider));
  });

  if (filtered.length) return filtered;

  const neutral = normalizedRefs.filter(ref => detectReferenceProviders(ref).length === 0);
  return neutral.length ? neutral : normalizedRefs;
}

function normalizeOfficialReferences(refs = []) {
  const seen = new Set();
  return (Array.isArray(refs) ? refs : [])
    .filter(ref => ref && typeof ref.url === 'string' && /^https:\/\//i.test(ref.url))
    .map(ref => ({
      label: String(ref.label || 'Official reference').trim(),
      url: ref.url.trim(),
      providers: normalizeProviderKeys(ref.providers || [])
    }))
    .filter(ref => {
      if (!ref.url || seen.has(ref.url)) return false;
      seen.add(ref.url);
      return true;
    });
}

function getCategoryOfficialReferences(categoryKey) {
  const normalizedCategory = normalizeRecommendationCategory(categoryKey || 'infrastructure');
  return normalizeOfficialReferences(CATEGORY_OFFICIAL_REFERENCE_MAP[normalizedCategory] || CATEGORY_OFFICIAL_REFERENCE_MAP.infrastructure);
}

function getProviderOfficialReferences(providers = []) {
  const refs = [];
  (Array.isArray(providers) ? providers : []).forEach(provider => {
    if (!PROVIDER_OFFICIAL_REFERENCE_MAP[provider]) return;
    refs.push(...PROVIDER_OFFICIAL_REFERENCE_MAP[provider]);
  });
  return normalizeOfficialReferences(refs);
}

function getOutputCardOfficialReferences(cardId, fallbackRefs = [], providerScope = []) {
  const refs = OUTPUT_CARD_OFFICIAL_REFERENCE_MAP[cardId] || fallbackRefs;
  if (refs && refs.length) return filterReferencesForProviderScope(refs, providerScope);
  return filterReferencesForProviderScope([
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'NIST cloud definition', url: OFFICIAL_REFERENCE_URLS.nistCloud }
  ], providerScope);
}

function getRecommendationTitleOfficialReferences(title = '', providerScope = []) {
  const value = String(title || '').trim();
  if (!value) return [];
  const match = RECOMMENDATION_TITLE_REFERENCE_RULES.find(rule => rule.test && rule.test.test(value));
  return match ? filterReferencesForProviderScope(match.refs || [], providerScope) : [];
}

function resolveRecommendationOfficialReferences(rec) {
  if (!rec) return [];
  const providerScope = getActiveProviderScope(rec.providers || []);
  const explicit = filterReferencesForProviderScope(rec.refs || [], providerScope);
  if (explicit.length) return explicit;

  const titleRefs = getRecommendationTitleOfficialReferences(rec.title || '', providerScope);
  if (titleRefs.length) return titleRefs;

  if (rec.cardId) {
    return getOutputCardOfficialReferences(rec.cardId, [], providerScope);
  }

  const providerRefs = getProviderOfficialReferences((rec.providers && rec.providers.length) ? rec.providers : providerScope);
  if (providerRefs.length) return providerRefs;

  const categoryRefs = filterReferencesForProviderScope(getCategoryOfficialReferences(rec.categoryKey || rec.category || 'infrastructure'), providerScope);
  return categoryRefs.length ? categoryRefs : normalizeOfficialReferences([
    { label: 'FinOps unit economics capability', url: OFFICIAL_REFERENCE_URLS.finopsUnitEconomics },
    { label: 'NIST cloud definition', url: OFFICIAL_REFERENCE_URLS.nistCloud }
  ]);
}

function buildRecommendationReferenceLinks(refs = []) {
  const normalized = normalizeOfficialReferences(refs);
  if (!normalized.length) return '';
  return `<div class="rec-links">${normalized.map(ref => `<a class="rec-link" href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.label} ↗</a>`).join('')}</div>`;
}

function priorityWeight(priority) {
  if (priority === 'high') return 0;
  if (priority === 'medium') return 1;
  return 2;
}

function normalizeRecommendationCategory(category) {
  return Object.prototype.hasOwnProperty.call(RECOMMENDATION_CATEGORY_LABELS, category)
    ? category
    : 'infrastructure';
}

function recommendationCategoryLabel(category) {
  const normalized = normalizeRecommendationCategory(category);
  return RECOMMENDATION_CATEGORY_LABELS[normalized] || RECOMMENDATION_CATEGORY_LABELS.infrastructure;
}

function inferRecommendationCategory(rec) {
  if (rec && rec.category) return normalizeRecommendationCategory(rec.category);
  const haystack = `${rec?.title || ''} ${rec?.desc || ''} ${rec?.action || ''}`.toLowerCase();

  if (/(crm|churn|renewal|upsell|cross-sell|retention)/.test(haystack)) return 'crm';
  if (/(pricing|price floor|arpu|package|fee increase|realised price)/.test(haystack)) return 'pricing';
  if (/(marketing|funnel|mql|sql|cac|demand generation|acquisition|sales motion)/.test(haystack)) return 'marketing';
  if (/(tagging|forecast|budget|anomaly|governance|allocation|guardrail|policy)/.test(haystack)) return 'governance';

  return 'infrastructure';
}

function updateRecommendationFilterButtons() {
  document.querySelectorAll('.rec-filter-btn').forEach(btn => {
    const key = btn.dataset.recCategory || 'all';
    const active = key === selectedRecommendationCategory;
    btn.classList.toggle('is-active', active);
    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}

function setRecommendationCategory(category) {
  selectedRecommendationCategory = normalizeRecommendationCategory(category || 'all');
  updateRecommendationFilterButtons();
  updateHealthAndRecommendations(lastInputs);
}

function initRecommendationCategoryFilters() {
  const filterButtons = Array.from(document.querySelectorAll('.rec-filter-btn'));
  if (!filterButtons.length) return;
  updateRecommendationFilterButtons();
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => setRecommendationCategory(btn.dataset.recCategory || 'all'));
  });
}

function buildStrategicRecommendations({ zoneKey, nSample, beN, arpuUsed, minCostN, minUnitCostPerClient }) {
  if (!zoneKey || arpuUsed === null || arpuUsed === undefined || !isFinite(arpuUsed)) return [];

  const strategic = [];
  const minCostGap = Math.max(0, minUnitCostPerClient - arpuUsed);
  const upliftPct = arpuUsed > 0 ? (minCostGap / arpuUsed) * 100 : 0;

  if (beN === null && minCostGap > 0) {
    strategic.push({
      icon: '💸',
      title: 'Raise realised ARPU above cost floor',
      desc: `Current ARPU (${fmtOut(arpuUsed, 2)} / client) is below the model floor (${fmtOut(minUnitCostPerClient, 2)} / client near n≈${minCostN.toLocaleString()}).`,
      action: `Action: Improve realised price by at least ${fmtOut(minCostGap, 2)} / client (${upliftPct.toFixed(1)}%) via packaging tiers, add-ons, annual commit discounts, or selective fee increases.`,
      category: 'pricing',
      providers: [],
      zones: [zoneKey],
      priority: 'high'
    });
    strategic.push({
      icon: '📣',
      title: 'Marketing + funnel acceleration toward efficient scale',
      desc: `Client volume still matters: unit cost bottoms near n≈${minCostN.toLocaleString()}. Demand generation should be aligned with this operating band.`,
      action: 'Action: Run a 90-day growth motion (paid + partner + referral), improve MQL→SQL→Win conversion in CRM, and review CAC payback against the ARPU gap weekly.',
      category: 'marketing',
      providers: [],
      zones: [zoneKey],
      priority: 'medium'
    });
    strategic.push({
      icon: '🤝',
      title: 'CRM retention and expansion revenue playbook',
      desc: 'When cost cuts are near limit, expansion and retention become the fastest margin levers.',
      action: `Action: Launch upsell/cross-sell journeys, contract renewals, and churn-prevention triggers to add at least ${fmtOut(minCostGap, 2)} / client in net revenue over the next cycle.`,
      category: 'crm',
      providers: [],
      zones: [zoneKey],
      priority: 'high'
    });
    return strategic;
  }

  if (beN !== null && nSample < beN) {
    const gapClients = Math.max(1, Math.round(beN - nSample));
    strategic.push({
      icon: '🚀',
      title: 'Close break-even client gap with GTM execution',
      desc: `You are ${gapClients.toLocaleString()} clients below break-even volume (${beN.toLocaleString()}).`,
      action: 'Action: Prioritise pipeline quality, onboarding speed, and CRM conversion stages to move qualified demand into paying clients faster while protecting margin.',
      category: 'marketing',
      providers: [],
      zones: [zoneKey],
      priority: 'high'
    });
  }

  return strategic;
}

function buildAiTokenRecommendations({ aiMetrics, arpuUsed }) {
  if (!aiMetrics || !aiMetrics.enabled) return [];

  const aiRecs = [];

  if (aiMetrics.aiRetryInflationPct !== null && aiMetrics.aiRetryInflationPct > 12) {
    aiRecs.push({
      icon: '🔁',
      title: 'Reduce AI retry inflation',
      desc: `Retry inflation is ${aiMetrics.aiRetryInflationPct.toFixed(1)}%, which is amplifying AI inference spend beyond first-pass expectations.`,
      action: 'Action: instrument prompt quality, timeout handling, and tool-call error paths; set retry budgets per workflow.',
      providers: [],
      zones: ['green', 'yellow', 'red'],
      priority: aiMetrics.aiRetryInflationPct > 20 ? 'high' : 'medium'
    });
  }

  if (aiMetrics.aiPremiumMixPct !== null && aiMetrics.aiPremiumMixPct > 35) {
    aiRecs.push({
      icon: '🧠',
      title: 'Tune premium model routing',
      desc: `Premium model mix is ${aiMetrics.aiPremiumMixPct.toFixed(1)}%, increasing weighted cost per request.`,
      action: 'Action: route low-complexity prompts to lower-cost models and keep premium models for high-value or low-confidence cases.',
      providers: [],
      zones: ['green', 'yellow', 'red'],
      priority: aiMetrics.aiPremiumMixPct > 55 ? 'high' : 'medium'
    });
  }

  if (aiMetrics.aiCostPerClient !== null && arpuUsed !== null && aiMetrics.aiCostPerClient > arpuUsed * 0.4) {
    aiRecs.push({
      icon: '💬',
      title: 'Reprice AI-heavy experience tiers',
      desc: `AI cost per client (${fmtOut(aiMetrics.aiCostPerClient, 2)}) is consuming a high share of ARPU (${fmtOut(arpuUsed, 2)}).`,
      action: 'Action: create AI usage-aware pricing tiers, enforce fair-use envelopes, and align premium features to token intensity.',
      providers: [],
      zones: ['green', 'yellow', 'red'],
      priority: 'high'
    });
  }

  if (aiMetrics.allocationConfidence === 'low') {
    aiRecs.push({
      icon: '🧾',
      title: 'Strengthen AI allocation telemetry',
      desc: 'Allocation confidence is low because token volume and/or rate visibility is incomplete.',
      action: 'Action: enforce team-level token telemetry and rate-card governance before publishing chargeback/showback outcomes.',
      providers: [],
      zones: ['green', 'yellow', 'red'],
      priority: 'medium'
    });
  }

  return aiRecs;
}

function buildOutputCardRecommendations({ zoneKey }) {
  const cards = Array.from(document.querySelectorAll('#calc-kpi-output-grid .calc-out-card')).filter(card => card && card.id && card.offsetParent !== null);
  if (!cards.length) return [];
  const providerScope = getActiveProviderScope();

  const signalInterpretation = {
    good: 'Interpretation: this metric is currently inside the preferred operating band.',
    warn: 'Interpretation: this metric is outside the preferred band and needs corrective action in this planning cycle.',
    bad: 'Interpretation: this metric is materially off-target and should be treated as an immediate remediation priority.',
    needs: 'Interpretation: this metric cannot be trusted yet because required inputs are missing.'
  };

  return cards.map(card => {
    const cardId = card.id;
    const config = OUTPUT_TOOLTIP_CONTENT[cardId] || null;
    const labelText = String((card.querySelector('.calc-out-label') || {}).textContent || '')
      .replace(/\s+/g, ' ')
      .trim();
    const displayTitle = (config && config.title) || labelText || cardId.replace(/^out-/, '');
    const guide = OUTPUT_ACTION_GUIDES[cardId] || {
      objective: 'Keep this indicator in a decision-ready range.',
      recommended: ['Review assumptions for this indicator and apply corrective actions.'],
      monitor: ['Re-check indicator trend in the next review cycle.'],
      inputs: ['Relevant calculator inputs for this indicator']
    };
    const signal = getOutputCardSignal(card);
    const valueText = ((card.querySelector('.calc-out-val') || {}).textContent || '—').trim();

    let priority = 'low';
    if (signal.key === 'bad') priority = 'high';
    else if (signal.key === 'warn' || signal.key === 'needs') priority = 'medium';

    let actionText = guide.recommended && guide.recommended.length ? guide.recommended[0] : 'Review this indicator with current assumptions.';
    if (signal.key === 'needs' && guide.inputs && guide.inputs.length) {
      actionText = `Provide ${guide.inputs[0]} and rerun calculations before using this metric in decisions.`;
    } else if (signal.key === 'good' && guide.monitor && guide.monitor.length) {
      actionText = `Keep current controls and verify ${guide.monitor[0]} remains stable at the next review.`;
    } else {
      const providerSpecificAction = getProviderSpecificOutputAction(cardId, signal.key, providerScope);
      if (providerSpecificAction) actionText = providerSpecificAction;
    }

    const categoryKey = OUTPUT_CARD_CATEGORY_MAP[cardId] || inferRecommendationCategory({ title: displayTitle, action: actionText });
    const refs = getOutputCardOfficialReferences(cardId, (config && config.refs) || [], providerScope);
    const icon = signal.key === 'bad' ? '🔴' : (signal.key === 'warn' ? '🟡' : (signal.key === 'needs' ? '⚪' : '🟢'));
    const monitorText = (guide.monitor && guide.monitor.length) ? guide.monitor[0] : displayTitle;
    const description = `${signalInterpretation[signal.key] || signalInterpretation.warn} Goal: ${guide.objective} Current value: ${valueText}.`;
    const recommendationAction = `Action: ${actionText} Confirm impact on ${monitorText} in the next run.`;

    return {
      icon,
      title: `${displayTitle} - ${signal.label}`,
      desc: description,
      action: recommendationAction,
      category: categoryKey,
      categoryKey,
      providers: [],
      zones: [zoneKey],
      priority,
      cardId,
      refs
    };
  });
}

function toggleProvider(provider) {
  const btn = document.querySelector(`[data-provider="${provider}"]`);
  if (selectedProviders.has(provider)) {
    selectedProviders.delete(provider);
    if (btn) btn.classList.remove('selected');
  } else {
    selectedProviders.add(provider);
    if (btn) btn.classList.add('selected');
  }
  updateHealthAndRecommendations(lastInputs);
}

function updateHealthAndRecommendations(inputs) {
  const {
    nRef,
    infraTotal,
    ARPU: arpuInp,
    effectiveARPU,
    arpuMode,
    budgetMonthly,
    forecastGrowthPct,
    forecastBestEfficiencyPct,
    forecastWorstDriftPct,
    savingsIdentified,
    savingsRealized,
    costAvoidance,
    aiEnabled,
    aiMetrics,
    reliabilityEnabled,
    reliabilityMetrics
  } = inputs || {};
  const nSample = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
  const hasInfra = infraTotal !== null && infraTotal !== undefined;
  const arpuUsed = (effectiveARPU !== null && effectiveARPU !== undefined && effectiveARPU > 0)
    ? effectiveARPU
    : ((arpuInp !== null && arpuInp !== undefined && arpuInp > 0) ? arpuInp : null);
  const hasARPU = arpuUsed !== null;
  const hasAnyCostInput = hasInfra;

  const bannerEl = document.getElementById('health-banner');
  const groupBadgeEl = document.getElementById('health-group-num');
  const titleEl  = document.getElementById('health-zone-title');
  const descEl   = document.getElementById('health-zone-desc');
  const scoreEl  = document.getElementById('health-score-value');
  const listEl   = document.getElementById('rec-list');

  if (!bannerEl || !titleEl || !descEl || !scoreEl || !listEl) return;

  if (!hasInfra || !hasARPU) {
    bannerEl.className = 'health-banner awaiting';
    if (groupBadgeEl) groupBadgeEl.style.background = '#7a7a8c';
    titleEl.textContent = 'Awaiting Inputs';
    descEl.innerHTML = '<ul class="health-zone-list"><li>Add Total Infra Cost and Revenue / Client (ARPU), or use Startup Planning (Target Price / Target Clients) to compute health score and recommendations.</li></ul>';
    scoreEl.textContent = '—';
    scoreEl.style.color = '#7a7a8c';
    listEl.innerHTML = '<div class="rec-empty">Recommendations will appear after health scoring data is available.</div>';
    renderIntentGuidedPath(inputs || {});
    return;
  }

  const { K, a, c, b, g, m } = MODEL;
  const dev      = K * Math.pow(nSample, -a);
  const infraRaw = c * Math.pow(nSample, b);
  const infraCud = g * c * Math.pow(nSample, b * 0.96);
  const total    = dev + infraRaw;
  const revenue  = arpuUsed * nSample;
  const vcpu     = infraRaw / nSample;
  const contribM = arpuUsed - vcpu;
  const ccer     = infraRaw > 0 ? revenue / infraRaw : Infinity;
  const cudSaveGapPct = infraRaw > 0 ? ((infraRaw - infraCud) / infraRaw) : 0;

  const economics = scanEconomicRange(arpuUsed, Math.max(20000, MODEL.nMax), MODEL);
  const beN = economics.breakEvenN;
  const minCostN = economics.minUnitCostN;
  const minUnitCostPerClient = economics.minUnitCostPerClient;

  const normalization = buildNormalizationSnapshot(inputs || {});
  const budgetBasisCost = normalization.totalMonthly > 0 ? normalization.totalMonthly : total;
  const hasBudget = budgetMonthly !== null && budgetMonthly !== undefined && budgetMonthly >= 0;
  const budgetVariance = hasBudget ? (budgetMonthly - budgetBasisCost) : null;
  const budgetVariancePct = hasBudget && budgetMonthly > 0 ? (budgetVariance / budgetMonthly) * 100 : null;

  const growthPct = forecastGrowthPct !== null && forecastGrowthPct !== undefined ? forecastGrowthPct : 0;
  const bestEfficiencyPct = Math.max(0, Math.min(95, forecastBestEfficiencyPct !== null && forecastBestEfficiencyPct !== undefined ? forecastBestEfficiencyPct : 0));
  const worstDriftPct = Math.max(0, forecastWorstDriftPct !== null && forecastWorstDriftPct !== undefined ? forecastWorstDriftPct : 0);
  const hasForecastSignal = [forecastGrowthPct, forecastBestEfficiencyPct, forecastWorstDriftPct].some(v => v !== null && v !== undefined && Number(v) !== 0);

  let forecastState = null;
  if (hasAnyCostInput && hasARPU && hasForecastSignal) {
    const forecastN = Math.max(1, Math.round(nSample * (1 + growthPct / 100)));
    const forecastDev = K * Math.pow(forecastN, -a);
    const forecastInfra = c * Math.pow(forecastN, b);
    const forecastTotal = forecastDev + forecastInfra;
    const forecastRevenue = arpuUsed * forecastN;
    const baselineMargin = forecastRevenue - forecastTotal;
    const bestMargin = forecastRevenue - (forecastTotal * (1 - (bestEfficiencyPct / 100)));
    const worstMargin = forecastRevenue - (forecastTotal * (1 + (worstDriftPct / 100)));
    const spread = bestMargin - worstMargin;
    const spreadPct = forecastRevenue > 0 ? (spread / forecastRevenue) * 100 : 0;
    forecastState = { forecastN, baselineMargin, worstMargin, spreadPct };
  }

  const identifiedUsed = savingsIdentified !== null && savingsIdentified !== undefined ? savingsIdentified : null;
  const totalRealizedValue =
    (savingsRealized !== null && savingsRealized !== undefined ? savingsRealized : 0) +
    (costAvoidance !== null && costAvoidance !== undefined ? costAvoidance : 0);
  const hasRealizationSignal = [savingsIdentified, savingsRealized, costAvoidance].some(v => v !== null && v !== undefined);
  const realizationRatioPct = identifiedUsed !== null && identifiedUsed > 0
    ? (totalRealizedValue / identifiedUsed) * 100
    : null;
  const realizationGap = identifiedUsed !== null && identifiedUsed > 0
    ? identifiedUsed - totalRealizedValue
    : null;

  const hasAiSignal = Boolean(aiEnabled && aiMetrics && aiMetrics.enabled && aiMetrics.aiTotalTokenCost !== null);
  const hasReliabilitySignal = Boolean(
    reliabilityEnabled &&
    reliabilityMetrics &&
    reliabilityMetrics.enabled &&
    reliabilityMetrics.expectedReliabilityFailureCostMonthly !== null
  );
  const reliabilityAdjustedProfitMonthly = hasReliabilitySignal
    ? (revenue - reliabilityMetrics.reliabilityAdjustedCostMonthly)
    : null;

  let score = 100;
  const failed = [];

  if (beN === null) {
    score -= 35;
    failed.push('No break-even point exists within the current model range.');
  } else if (nSample < beN) {
    score -= 35;
    failed.push(`Current clients (${Math.round(nSample).toLocaleString()}) are below break-even (${beN.toLocaleString()}).`);
  }
  if (isFinite(ccer) && ccer < 1) {
    score -= 30;
    failed.push(`CCER is ${ccer.toFixed(2)}× (<1×).`);
  } else if (isFinite(ccer) && ccer < 3) {
    score -= 15;
    failed.push(`CCER is ${ccer.toFixed(2)}× (below 3× benchmark).`);
  }
  if (contribM <= 0) {
    score -= 20;
    failed.push(`Contribution margin is negative (${fmtOut(contribM, 2)} / client).`);
  }
  if (cudSaveGapPct > 0.15) {
    score -= 5;
    failed.push(`Commitment saving gap is ${(cudSaveGapPct * 100).toFixed(1)}% of infra spend.`);
  }

  if (hasBudget && budgetMonthly > 0 && budgetVariance !== null && budgetVariance < 0) {
    if (budgetVariancePct < -10) {
      score -= 10;
      failed.push(`Budget variance is ${budgetVariancePct.toFixed(1)}% over budget.`);
    } else {
      score -= 5;
      failed.push(`Budget variance is ${budgetVariancePct.toFixed(1)}% over budget.`);
    }
  }

  if (forecastState) {
    if (forecastState.baselineMargin < 0) {
      score -= 10;
      failed.push('Forecast baseline margin is negative under current assumptions.');
    }
    if (forecastState.worstMargin < 0) {
      score -= 5;
      failed.push('Forecast worst-case margin is negative; downside resilience is weak.');
    }
    if (forecastState.spreadPct > 25) {
      score -= 8;
      failed.push(`Forecast spread is wide (${forecastState.spreadPct.toFixed(1)}% of forecast revenue).`);
    } else if (forecastState.spreadPct > 10) {
      score -= 4;
      failed.push(`Forecast spread is moderate (${forecastState.spreadPct.toFixed(1)}% of forecast revenue).`);
    }
  }

  if (hasRealizationSignal && realizationRatioPct !== null) {
    if (realizationRatioPct < 70) {
      score -= 10;
      failed.push(`Savings realization ratio is low (${realizationRatioPct.toFixed(1)}%).`);
    } else if (realizationRatioPct < 100) {
      score -= 4;
      failed.push(`Savings realization ratio is below target (${realizationRatioPct.toFixed(1)}%).`);
    }
    if (realizationGap !== null && identifiedUsed > 0 && realizationGap > identifiedUsed * 0.2) {
      score -= 4;
      failed.push('Residual value gap remains materially open against identified target.');
    }
  }

  if (normalization.selectedCount > 0) {
    if (normalization.coveragePct < 50) {
      score -= 8;
      failed.push(`Domain coverage is low (${normalization.coveragePct.toFixed(0)}%) for selected scope.`);
    } else if (normalization.coveragePct < 80) {
      score -= 4;
      failed.push(`Domain coverage is partial (${normalization.coveragePct.toFixed(0)}%) for selected scope.`);
    }

    if (normalization.confidence === 'Low') {
      score -= 6;
      failed.push('Normalization confidence is low due to incomplete selected-domain inputs.');
    } else if (normalization.confidence === 'Medium') {
      score -= 3;
      failed.push('Normalization confidence is medium; broaden selected-domain input completeness.');
    }
  }

  if (Boolean(aiEnabled)) {
    if (!hasAiSignal) {
      score -= 6;
      failed.push('AI token economics is enabled but key AI cost inputs are incomplete.');
    } else {
      if (hasARPU && aiMetrics.aiCostPerClient !== null && aiMetrics.aiCostPerClient > arpuUsed * 0.45) {
        score -= 8;
        failed.push('AI cost per client is high relative to ARPU.');
      } else if (hasARPU && aiMetrics.aiCostPerClient !== null && aiMetrics.aiCostPerClient > arpuUsed * 0.25) {
        score -= 4;
        failed.push('AI cost per client is elevated relative to ARPU.');
      }
      if (aiMetrics.aiRetryInflationPct > 20) {
        score -= 5;
        failed.push(`AI retry inflation is high (${aiMetrics.aiRetryInflationPct.toFixed(1)}%).`);
      } else if (aiMetrics.aiRetryInflationPct > 10) {
        score -= 3;
        failed.push(`AI retry inflation is above target (${aiMetrics.aiRetryInflationPct.toFixed(1)}%).`);
      }
      if (aiMetrics.aiPremiumMixPct > 45) {
        score -= 4;
        failed.push(`AI premium-model mix is high (${aiMetrics.aiPremiumMixPct.toFixed(1)}%).`);
      } else if (aiMetrics.aiPremiumMixPct > 25) {
        score -= 2;
        failed.push(`AI premium-model mix is elevated (${aiMetrics.aiPremiumMixPct.toFixed(1)}%).`);
      }
      if (aiMetrics.allocationConfidence === 'low') {
        score -= 4;
        failed.push('AI allocation confidence is low; strengthen telemetry before chargeback decisions.');
      } else if (aiMetrics.allocationConfidence === 'medium') {
        score -= 2;
        failed.push('AI allocation confidence is medium; validate allocation assumptions.');
      }
    }
  }

  if (Boolean(reliabilityEnabled)) {
    if (!hasReliabilitySignal) {
      score -= 8;
      failed.push('Reliability economics is enabled but required reliability inputs remain incomplete.');
    } else {
      if (reliabilityMetrics.reliabilityRiskBand === 'high') {
        score -= 10;
        failed.push('Reliability risk band is HIGH.');
      } else if (reliabilityMetrics.reliabilityRiskBand === 'medium') {
        score -= 5;
        failed.push('Reliability risk band is MEDIUM.');
      }

      if (reliabilityMetrics.reliabilityDataConfidence === 'low') {
        score -= 5;
        failed.push('Reliability data confidence is low.');
      } else if (reliabilityMetrics.reliabilityDataConfidence === 'medium') {
        score -= 2;
        failed.push('Reliability data confidence is medium.');
      }

      if (reliabilityAdjustedProfitMonthly !== null && reliabilityAdjustedProfitMonthly < 0) {
        score -= 8;
        failed.push('Reliability-adjusted profit is negative at current ARPU and cost posture.');
      }
    }
  }

  score = Math.max(0, Math.min(100, score));

  let zoneKey = 'green';
  let zoneTitle = '🟢 Green Zone — Healthy Economics';
  const zoneItems = failed.length
    ? [...failed]
    : ['Unit economics are healthy. Continue optimisation discipline and forecasting cadence.'];
  let zoneColor = '#009e73';

  if (score < 40) {
    zoneKey = 'red';
    zoneTitle = '🔴 Red Zone — Critical Action Needed';
    zoneColor = '#d55e00';
  } else if (score < 70) {
    zoneKey = 'yellow';
    zoneTitle = '🟡 Yellow Zone — Needs Improvement';
    zoneColor = '#b07800';
  }

  if (arpuMode === 'startup-price') {
    zoneItems.push('Planning mode: ARPU estimated from your target price assumption.');
  } else if (arpuMode === 'startup-clients') {
    zoneItems.push('Planning mode: ARPU estimated from your target clients assumption.');
  }

  bannerEl.className = `health-banner ${zoneKey}`;
  if (groupBadgeEl) groupBadgeEl.style.background = zoneColor;
  titleEl.textContent = zoneTitle;
  descEl.innerHTML = `<ul class="health-zone-list">${zoneItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
  scoreEl.textContent = String(Math.round(score));
  scoreEl.style.color = zoneColor;

  const providers = getActiveProviderScope();
  const outputCardRecommendations = buildOutputCardRecommendations({ zoneKey });
  const strategicRecommendations = buildStrategicRecommendations({
    zoneKey,
    nSample,
    beN,
    arpuUsed,
    minCostN,
    minUnitCostPerClient
  });
  const aiRecommendations = buildAiTokenRecommendations({ aiMetrics, arpuUsed });
  const activeIntent = getCurrentUiIntent();
  const scoped = [...outputCardRecommendations, ...strategicRecommendations, ...aiRecommendations, ...RECOMMENDATIONS]
    .map(rec => {
      const categoryKey = normalizeRecommendationCategory(rec.categoryKey || rec.category || inferRecommendationCategory(rec));
      const refs = resolveRecommendationOfficialReferences({ ...rec, categoryKey });
      return { ...rec, categoryKey, refs };
    })
    .filter(rec => rec.zones.includes(zoneKey))
    .filter(rec => rec.providers.length === 0 || providers.some(p => rec.providers.includes(p)))
    .sort((a, b) => {
      const priorityDelta = priorityWeight(a.priority) - priorityWeight(b.priority);
      if (priorityDelta !== 0) return priorityDelta;
      const intentDelta = recommendationIntentWeight(a.categoryKey, activeIntent) - recommendationIntentWeight(b.categoryKey, activeIntent);
      if (intentDelta !== 0) return intentDelta;
      return String(a.title || '').localeCompare(String(b.title || ''));
    });

  const filtered = scoped.filter(rec => {
    if (selectedRecommendationCategory === 'all') return true;
    return rec.categoryKey === selectedRecommendationCategory;
  });

  if (!filtered.length) {
    const selectedLabel = recommendationCategoryLabel(selectedRecommendationCategory).toLowerCase();
    if (selectedRecommendationCategory === 'all') {
      listEl.innerHTML = '<div class="rec-empty">No provider-specific recommendations match yet. Select one or more providers in Group D to refine actions.</div>';
    } else {
      listEl.innerHTML = `<div class="rec-empty">No ${selectedLabel} recommendations match your current zone/provider context. Try another category or switch back to All.</div>`;
    }
    applyGlossaryAutoLinks(document.getElementById('group-health'));
    renderIntentGuidedPath(inputs || {});
    return;
  }

  listEl.innerHTML = filtered.map(rec => {
    const providerTag = rec.providers.length ? rec.providers.join('/').toUpperCase() : 'UNIVERSAL';
    const priorityTag = rec.priority.toUpperCase();
    const categoryLabel = recommendationCategoryLabel(rec.categoryKey);
    const linksHtml = buildRecommendationReferenceLinks(rec.refs || []);
    return `
      <article class="rec-card ${rec.priority}">
        <div class="rec-head">
          <span class="rec-icon">${rec.icon}</span>
          <span class="rec-title">${rec.title}</span>
          <span class="rec-tag category-${rec.categoryKey}">${categoryLabel}</span>
          <span class="rec-tag">${providerTag}</span>
          <span class="rec-tag priority-${rec.priority}">${priorityTag}</span>
        </div>
        <p class="rec-desc">${rec.desc}</p>
        <p class="rec-action">→ ${rec.action}</p>
        ${linksHtml}
      </article>
    `;
  }).join('');
  applyGlossaryAutoLinks(document.getElementById('group-health'));
  renderIntentGuidedPath(inputs || {});
}

function setNumericFieldValidation(inputEl, message) {
  if (!inputEl) return;
  const fieldWrap = inputEl.closest('.calc-field, .startup-field');
  if (!fieldWrap) return;

  const hasError = Boolean(message);
  fieldWrap.classList.toggle('invalid', hasError);
  inputEl.setAttribute('aria-invalid', hasError ? 'true' : 'false');
  inputEl.setCustomValidity(hasError ? message : '');

  let errorEl = fieldWrap.querySelector('.calc-input-error');
  if (!hasError) {
    if (errorEl) errorEl.remove();
    return;
  }

  if (!errorEl) {
    errorEl = document.createElement('div');
    errorEl.className = 'calc-input-error';
    fieldWrap.appendChild(errorEl);
  }
  errorEl.textContent = message;
}

function getInp(id) {
  const input = document.getElementById(id);
  if (!input) return null;

  const rawValue = String(input.value ?? '').trim();
  if (rawValue === '') {
    setNumericFieldValidation(input, '');
    return null;
  }

  const num = Number(rawValue);
  if (!Number.isFinite(num)) {
    setNumericFieldValidation(input, 'Enter a valid number.');
    return null;
  }

  const minAttr = input.getAttribute('min');
  const maxAttr = input.getAttribute('max');
  if (minAttr !== null && minAttr !== '' && num < Number(minAttr)) {
    setNumericFieldValidation(input, `Value must be >= ${minAttr}.`);
    return null;
  }
  if (maxAttr !== null && maxAttr !== '' && num > Number(maxAttr)) {
    setNumericFieldValidation(input, `Value must be <= ${maxAttr}.`);
    return null;
  }

  setNumericFieldValidation(input, '');
  return num;
}

function getInputString(id, fallback = '') {
  const el = document.getElementById(id);
  if (!el) return fallback;
  const value = String(el.value || '').trim();
  return value || fallback;
}

function fmtOut(v, decimals=0) {
  if (!isFinite(v) || v === null) return null;
  const abs = Math.abs(v);
  const symbol = getActiveCurrencySymbol();
  const str = abs >= 1000 ? `${symbol}${(abs/1000).toFixed(1)}K` : `${symbol}${abs.toFixed(decimals)}`;
  return v < 0 ? `−${str}` : str;
}

function totalCostAtClients(n, model = MODEL) {
  const coreEconomics = window.FiceCalCoreEconomics;
  if (coreEconomics && typeof coreEconomics.totalCostAtClients === 'function') {
    return coreEconomics.totalCostAtClients(n, model);
  }

  const safeN = Math.max(1, n);
  return model.K * Math.pow(safeN, -model.a) + model.c * Math.pow(safeN, model.b);
}

function scanEconomicRange(arpu, maxN, model = MODEL) {
  const coreEconomics = window.FiceCalCoreEconomics;
  if (coreEconomics && typeof coreEconomics.scanEconomicRange === 'function') {
    return coreEconomics.scanEconomicRange(arpu, maxN, model);
  }

  const limit = Math.max(1, Math.round(maxN));
  const hasArpu = arpu !== null && arpu !== undefined && arpu > 0;
  let breakEvenN = null;
  let minUnitCost = Infinity;
  let minUnitCostN = 1;

  for (let n = 1; n <= limit; n++) {
    const total = totalCostAtClients(n, model);
    const unitCost = total / n;

    if (unitCost < minUnitCost) {
      minUnitCost = unitCost;
      minUnitCostN = n;
    }

    if (hasArpu && breakEvenN === null && (arpu * n) >= total) {
      breakEvenN = n;
    }
  }

  return {
    breakEvenN,
    minUnitCostN,
    minUnitCostPerClient: isFinite(minUnitCost) ? minUnitCost : null
  };
}

function minPriceAtClients(n, model = MODEL) {
  const coreEconomics = window.FiceCalCoreEconomics;
  if (coreEconomics && typeof coreEconomics.minPriceAtClients === 'function') {
    return coreEconomics.minPriceAtClients(n, model);
  }

  const safeN = Math.max(1, n);
  const total = totalCostAtClients(safeN, model);
  return (total / safeN) * (1 + model.m);
}

function findRequiredClientsForTargetPrice(targetPrice, maxN, model = MODEL) {
  if (!(targetPrice > 0)) return null;
  const limit = Math.max(1, Math.round(maxN));
  for (let n = 1; n <= limit; n++) {
    if (minPriceAtClients(n, model) <= targetPrice) return n;
  }
  return null;
}

function findRequiredClientsForTargetPriceWithReliability(targetPrice, maxN, reliabilityLoadMonthly = 0, model = MODEL) {
  if (!(targetPrice > 0)) return null;
  const limit = Math.max(1, Math.round(maxN));
  const reliabilityLoad = Math.max(0, Number(reliabilityLoadMonthly) || 0);
  for (let n = 1; n <= limit; n++) {
    const baseTotal = totalCostAtClients(n, model);
    const adjustedMinPrice = ((baseTotal + reliabilityLoad) / Math.max(1, n)) * (1 + model.m);
    if (adjustedMinPrice <= targetPrice) return n;
  }
  return null;
}

function getReliabilityCurveSignature(inputs = {}) {
  const metrics = inputs && inputs.reliabilityMetrics;
  const failureCost = metrics && metrics.expectedReliabilityFailureCostMonthly !== null
    ? Number(metrics.expectedReliabilityFailureCostMonthly).toFixed(2)
    : 'na';
  const investment = metrics && metrics.reliabilityInvestmentMonthly !== null
    ? Number(metrics.reliabilityInvestmentMonthly).toFixed(2)
    : 'na';
  return [
    inputs.reliabilityEnabled ? 'on' : 'off',
    inputs.sloTargetAvailabilityPct ?? '',
    inputs.sliObservedAvailabilityPct ?? '',
    inputs.incidentCountMonthly ?? '',
    inputs.mttrHours ?? '',
    inputs.incidentBlendedHourlyRate ?? '',
    inputs.criticalRevenuePerMinute ?? '',
    inputs.arrExposedMonthly ?? '',
    inputs.slaPenaltyRatePerBreachPointMonthly ?? '',
    inputs.reliabilityInvestmentMonthly ?? '',
    failureCost,
    investment
  ].join('|');
}

function buildNormalizationSnapshot(inputs) {
  const nSample = (inputs.nRef && inputs.nRef > 0) ? inputs.nRef : DEFAULT_N_REF;
  const selectedDomains = normalizeTechDomainSelection(inputs.techDomains);
  const selectedSet = new Set(selectedDomains);

  const rows = TECH_DOMAIN_SCHEMA.map(def => {
    const raw = inputs[def.inputKey];
    const provided = raw !== null && raw !== undefined && raw > 0;
    const monthly = provided ? raw : 0;
    const normalized = monthly / nSample;
    const inScope = selectedSet.has(def.key);
    return { ...def, provided, monthly, normalized, inScope };
  });

  const inScopeRows = rows.filter(row => row.inScope);
  const providedCount = rows.filter(row => row.provided).length;
  const providedInScopeCount = inScopeRows.filter(row => row.provided).length;
  const nonCloudProvidedCount = rows.filter(row => row.key !== 'cloud' && row.provided).length;
  const nonCloudInScope = inScopeRows.some(row => row.key !== 'cloud');
  const nonCloudProvidedInScope = inScopeRows.some(row => row.key !== 'cloud' && row.provided);
  const totalTrackedDomains = rows.length;
  const selectedCount = inScopeRows.length;
  const schemaCoveragePct = (providedCount / totalTrackedDomains) * 100;
  const coveragePct = selectedCount > 0 ? (providedInScopeCount / selectedCount) * 100 : 0;
  const totalMonthly = inScopeRows.reduce((sum, row) => sum + row.monthly, 0);
  const normalizedTotal = selectedCount > 0 ? (totalMonthly / nSample) : 0;

  let confidence = 'Low';
  if (coveragePct >= 80 && selectedCount >= 2 && nonCloudProvidedInScope) confidence = 'High';
  else if (coveragePct >= 50) confidence = 'Medium';

  const warnings = [];
  const advisories = [];
  if (!(inputs.nRef && inputs.nRef > 0) && totalMonthly > 0) {
    warnings.push(`Normalization uses default client baseline n=${DEFAULT_N_REF}. Add Current Client Count for exact unit cost comparability.`);
  }
  if (selectedCount === 1) {
    advisories.push('Single-domain mode is active. Select additional domains when you need portfolio comparability.');
  }
  if (!nonCloudInScope) {
    advisories.push('Only Cloud is in scope. Add SaaS/Licensing/Private Cloud/Data Center/Labor for broader FinOps 2026 alignment.');
  }
  if (selectedCount > 0 && providedInScopeCount < selectedCount) {
    const missingDomains = inScopeRows.filter(row => !row.provided).map(row => row.label);
    warnings.push(`Selected scope missing costs for: ${missingDomains.join(', ')}.`);
  }

  return {
    rows,
    inScopeRows,
    selectedDomains,
    nSample,
    providedCount,
    providedInScopeCount,
    nonCloudProvidedCount,
    nonCloudProvidedInScope,
    totalTrackedDomains,
    selectedCount,
    schemaCoveragePct,
    coveragePct,
    totalMonthly,
    normalizedTotal,
    confidence,
    warnings,
    advisories,
    formula: 'NTC/client = Σ(αᵈ × Cᵈ) / n (default αᵈ=1)'
  };
}

function updateNormalizationGuardrail(snapshot) {
  const guardrailEl = document.getElementById('portfolio-guardrail');
  if (!guardrailEl) return;

  guardrailEl.classList.remove('warn', 'good');
  if (!snapshot.selectedCount) {
    guardrailEl.textContent = 'Select at least one technology domain to compute scoped normalization.';
    return;
  }
  if (!snapshot.totalMonthly) {
    guardrailEl.textContent = 'Add monthly cost inputs for your selected scope to activate multi-technology normalization insights.';
    return;
  }

  if (snapshot.warnings.length) {
    guardrailEl.classList.add('warn');
    guardrailEl.textContent = snapshot.warnings.join(' ');
    return;
  }

  const advisoryText = snapshot.advisories.length ? ` ${snapshot.advisories.join(' ')}` : '';
  guardrailEl.classList.add('good');
  guardrailEl.textContent = `Normalization confidence is ${snapshot.confidence}. Scoped coverage ${(snapshot.coveragePct).toFixed(0)}% (${snapshot.providedInScopeCount}/${snapshot.selectedCount}) using ${snapshot.formula}.${advisoryText}`;
}

function renderPortfolioSummary(snapshot) {
  const bodyEl = document.getElementById('portfolio-summary-body');
  if (!bodyEl) return;

  if (!snapshot.selectedCount) {
    bodyEl.innerHTML = '<div class="portfolio-empty">Select at least one domain in scope to build portfolio normalization summary.</div>';
    return;
  }

  if (!snapshot.totalMonthly) {
    bodyEl.innerHTML = '<div class="portfolio-empty">Enter cost values for selected domains to compute scoped normalization and confidence.</div>';
    return;
  }

  const rowsHtml = snapshot.rows.map(row => {
    const scopeTag = row.inScope ? '<span class="portfolio-tag scope">in scope</span>' : '';
    const rowClass = row.inScope ? 'in-scope' : 'out-of-scope';
    return `
      <div class="portfolio-row ${rowClass}">
        <span>${row.label}${scopeTag}</span>
        <span>${fmtOut(row.monthly, 0)} / mo</span>
        <span>${fmtOut(row.normalized, 2)} / client</span>
        <span class="focus-col">${row.focusDimension}</span>
      </div>
    `;
  }).join('');

  bodyEl.innerHTML = `
    <div class="portfolio-row portfolio-head">
      <span>Domain</span>
      <span>Monthly cost</span>
      <span>Normalized</span>
      <span class="focus-col">FOCUS dimension</span>
    </div>
    ${rowsHtml}
    <div class="portfolio-row total">
      <span>Total selected scope</span>
      <span>${fmtOut(snapshot.totalMonthly, 0)} / mo</span>
      <span>${fmtOut(snapshot.normalizedTotal, 2)} / client</span>
      <span class="focus-col">coverage ${(snapshot.coveragePct).toFixed(0)}% · schema ${(snapshot.schemaCoveragePct).toFixed(0)}%</span>
    </div>
  `;
}

const OUTPUT_CARD_MISSING_INPUT_MAP = Object.freeze({
  'out-beN': ['inp-ARPU', 'inp-startupTargetPrice', 'inp-startupTargetClients'],
  'out-minPrice': ['inp-devPerClient', 'inp-infraTotal', 'inp-nRef'],
  'out-vcpu': ['inp-infraTotal', 'inp-nRef'],
  'out-margin': ['inp-ARPU', 'inp-startupTargetPrice', 'inp-infraTotal'],
  'out-ccer': ['inp-ARPU', 'inp-startupTargetPrice', 'inp-infraTotal'],
  'out-cudSave': ['inp-infraTotal', 'inp-cudPct'],
  'out-reqClients': ['inp-startupTargetPrice', 'inp-devPerClient', 'inp-infraTotal'],
  'out-reqPrice': ['inp-startupTargetClients', 'inp-devPerClient', 'inp-infraTotal'],
  'out-targetRevenue': ['inp-startupTargetPrice', 'inp-startupTargetClients', 'inp-devPerClient', 'inp-infraTotal'],
  'out-budgetVariance': ['inp-budgetMonthly', 'inp-devPerClient', 'inp-infraTotal'],
  'out-forecastBand': ['inp-forecastGrowthPct', 'inp-forecastBestEfficiencyPct', 'inp-forecastWorstDriftPct'],
  'out-forecastSpread': ['inp-forecastGrowthPct', 'inp-forecastBestEfficiencyPct', 'inp-forecastWorstDriftPct'],
  'out-realizedValue': ['inp-savingsRealized', 'inp-costAvoidance'],
  'out-realizationRatio': ['inp-savingsIdentified', 'inp-savingsRealized', 'inp-costAvoidance'],
  'out-realizationGap': ['inp-savingsIdentified', 'inp-savingsRealized', 'inp-costAvoidance'],
  'out-techCoverage': ['inp-techDomains', 'inp-costSaaS', 'inp-costLicensing', 'inp-costPrivateCloud', 'inp-costDataCenter', 'inp-costLabor'],
  'out-techNorm': ['inp-techDomains', 'inp-costSaaS', 'inp-costLicensing', 'inp-costPrivateCloud', 'inp-costDataCenter', 'inp-costLabor'],
  'out-focusMaturity': ['inp-techDomains', 'inp-costSaaS', 'inp-costLicensing', 'inp-costPrivateCloud', 'inp-costDataCenter', 'inp-costLabor'],
  'out-aiTokenCost': ['inp-aiEnabled', 'inp-aiRatePer1MTotal', 'inp-aiInputTokensM', 'inp-aiOutputTokensM'],
  'out-aiAllocatedCost': ['inp-aiEnabled', 'inp-aiRatePer1MTotal', 'inp-aiInputTokensM', 'inp-aiOutputTokensM', 'inp-aiSharedOverheadMonthly'],
  'out-aiCostPerClient': ['inp-aiEnabled', 'inp-aiInputTokensM', 'inp-aiOutputTokensM', 'inp-nRef'],
  'out-aiRetryInflation': ['inp-aiEnabled', 'inp-aiRetryRatePct'],
  'out-aiPremiumMix': ['inp-aiEnabled', 'inp-aiPremiumMixPct'],
  'out-relDowntime': ['inp-reliabilityEnabled', 'inp-sliObservedAvailabilityPct'],
  'out-relFailureCost': ['inp-reliabilityEnabled', 'inp-incidentCountMonthly', 'inp-mttrHours', 'inp-incidentBlendedHourlyRate', 'inp-criticalRevenuePerMinute', 'inp-arrExposedMonthly'],
  'out-relAdjustedCost': ['inp-reliabilityEnabled', 'inp-reliabilityInvestmentMonthly'],
  'out-relProfitImpact': ['inp-reliabilityEnabled', 'inp-ARPU', 'inp-startupTargetPrice'],
  'out-relArpuUplift': ['inp-reliabilityEnabled', 'inp-ARPU', 'inp-startupTargetPrice'],
  'out-relExtraClients': ['inp-reliabilityEnabled', 'inp-ARPU', 'inp-startupTargetPrice', 'inp-nRef'],
  'out-relRiskBand': ['inp-reliabilityEnabled', 'inp-sliObservedAvailabilityPct', 'inp-incidentCountMonthly'],
  'out-relDataConfidence': ['inp-reliabilityEnabled', 'inp-sliObservedAvailabilityPct', 'inp-incidentCountMonthly', 'inp-mttrHours']
});

const OUTPUT_MISSING_INPUT_KEYWORD_RULES = Object.freeze([
  { regex: /option\s*a|target price/i, inputId: 'inp-startupTargetPrice' },
  { regex: /option\s*b|target clients/i, inputId: 'inp-startupTargetClients' },
  { regex: /arpu|revenue\s*\/\s*client/i, inputId: 'inp-ARPU' },
  { regex: /dev\s*cost/i, inputId: 'inp-devPerClient' },
  { regex: /infra\s*cost/i, inputId: 'inp-infraTotal' },
  { regex: /monthly technology budget/i, inputId: 'inp-budgetMonthly' },
  { regex: /forecast/i, inputId: 'inp-forecastGrowthPct' },
  { regex: /identified savings/i, inputId: 'inp-savingsIdentified' },
  { regex: /realized savings/i, inputId: 'inp-savingsRealized' },
  { regex: /cost avoidance/i, inputId: 'inp-costAvoidance' },
  { regex: /selected domain|domain scope|selected-domain/i, inputId: 'inp-techDomains' },
  { regex: /ai cost tracking\s*=\s*on/i, inputId: 'inp-aiEnabled' },
  { regex: /token volume|token rates?/i, inputId: 'inp-aiRatePer1MTotal' },
  { regex: /retry rate/i, inputId: 'inp-aiRetryRatePct' },
  { regex: /premium model mix/i, inputId: 'inp-aiPremiumMixPct' },
  { regex: /shared overhead/i, inputId: 'inp-aiSharedOverheadMonthly' },
  { regex: /client count|\(n\)/i, inputId: 'inp-nRef' },
  { regex: /reliability economics\s*=\s*on/i, inputId: 'inp-reliabilityEnabled' },
  { regex: /observed sli availability/i, inputId: 'inp-sliObservedAvailabilityPct' },
  { regex: /reliability input|incident|mttr/i, inputId: 'inp-incidentCountMonthly' }
]);

let missingDataCtaHandlerBound = false;

function resolveMissingDataInputId(card, missingMsg = '') {
  if (!card) return '';
  const mappedIds = OUTPUT_CARD_MISSING_INPUT_MAP[card.id] || [];

  for (const inputId of mappedIds) {
    const inputEl = document.getElementById(inputId);
    if (!inputEl) continue;
    if (!isMeaningfulInputValue(inputEl, inputEl.value)) return inputId;
  }

  for (const inputId of mappedIds) {
    if (document.getElementById(inputId)) return inputId;
  }

  const message = String(missingMsg || '');
  for (const rule of OUTPUT_MISSING_INPUT_KEYWORD_RULES) {
    if (!rule.regex.test(message)) continue;
    if (document.getElementById(rule.inputId)) return rule.inputId;
  }

  return '';
}

function focusMissingDataInput(inputId) {
  if (!inputId) return;
  const inputEl = document.getElementById(inputId);
  if (!inputEl) return;

  const fieldWrap = inputEl.closest('.calc-field, .startup-field') || inputEl;
  fieldWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });

  window.setTimeout(() => {
    inputEl.focus({ preventScroll: true });
    if (typeof inputEl.select === 'function' && inputEl.tagName === 'INPUT') {
      inputEl.select();
    }
  }, 180);
}

function bindMissingDataCtaHandler() {
  if (missingDataCtaHandlerBound) return;
  missingDataCtaHandlerBound = true;

  document.addEventListener('click', event => {
    const ctaEl = event.target.closest && event.target.closest('.calc-out-missing-cta');
    if (!ctaEl) return;
    event.preventDefault();
    event.stopPropagation();
    focusMissingDataInput(ctaEl.dataset.focusInput || '');
  }, true);
}

function renderMissingDataCallout(card, missingMsg = '') {
  if (!card) return;
  const subEl = card.querySelector('.calc-out-sub');
  if (!subEl) return;

  const msg = String(missingMsg || '').trim();
  const messageText = msg ? `⚠ Needs: ${msg}. ` : '⚠ Needs: provide required input data. ';
  const focusInputId = resolveMissingDataInputId(card, msg);

  subEl.textContent = '';

  const msgEl = document.createElement('span');
  msgEl.className = 'calc-out-missing-msg';
  msgEl.textContent = messageText;
  subEl.appendChild(msgEl);

  if (!focusInputId) return;

  const ctaEl = document.createElement('button');
  ctaEl.type = 'button';
  ctaEl.className = 'calc-out-missing-cta';
  ctaEl.setAttribute('data-focus-input', focusInputId);
  ctaEl.setAttribute('aria-label', 'Click to fill missing data for this card');
  ctaEl.textContent = 'Click here to fill missing data';
  ctaEl.addEventListener('click', event => {
    event.preventDefault();
    event.stopPropagation();
    focusMissingDataInput(focusInputId);
  });
  subEl.appendChild(ctaEl);
}

// Set output card — val=null means "needs more data", val=string is a result
function setOut(id, val, cls='', cardState='', missingMsg='') {
  const el   = document.getElementById(id);
  const sub  = document.getElementById(id + '-sub');  // optional sub-element
  if (!el) return;

  const card = el.closest('.calc-out-card');
  card.classList.remove('live','live-warn','live-bad','needs-data');

  if (val === null) {
    // Not enough data — show what's needed
    el.textContent = '—';
    el.className   = 'calc-out-val muted';
    card.classList.add('needs-data');
    renderMissingDataCallout(card, missingMsg);
  } else {
    el.textContent = val;
    el.className   = 'calc-out-val' + (cls ? ' ' + cls : '');
    // Restore default sub text
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl) subEl.textContent = card.dataset.defaultSub || subEl.dataset.orig || subEl.textContent;
    if (cardState === 'bad')       card.classList.add('live-bad');
    else if (cardState === 'warn') card.classList.add('live-warn');
    else                           card.classList.add('live');
  }
}

// Store original sub texts on first run
function cacheSubTexts() {
  document.querySelectorAll('.calc-out-card').forEach(card => {
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl && !subEl.dataset.orig) subEl.dataset.orig = subEl.textContent;
  });
}

function buildOutputTooltipHtml(cardId, config) {
  const items = config.how.map(item => `<li>${item}</li>`).join('');
  const refs = getOutputCardOfficialReferences(cardId, config.refs || [], getActiveProviderScope());
  const links = refs.map(ref => `<a class="calc-out-tip-link" href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.label} ↗</a>`).join('');
  return `
    <div class="calc-out-tip-title">${config.title}</div>
    <p class="calc-out-tip-what">${config.what}</p>
    <div class="calc-out-tip-sub">How this is calculated</div>
    <ul class="calc-out-tip-list">${items}</ul>
    ${links}
    <button type="button" class="calc-out-tip-action-btn" data-solve-for="${cardId}">How to address this?</button>
  `;
}

function closeOutputCardTooltip(card) {
  if (!card) return;
  card.classList.remove('tip-open');
  const btn = card.querySelector('.calc-out-tip-btn');
  const panel = card.querySelector('.calc-out-tip');
  clearOutputCardTooltipPlacement(panel);
  if (btn) btn.setAttribute('aria-expanded', 'false');
  if (panel) panel.setAttribute('aria-hidden', 'true');
  if (activeOutputTipCard === card) activeOutputTipCard = null;
}

function closeAllOutputCardTooltips() {
  document.querySelectorAll('.calc-out-card.tip-open').forEach(closeOutputCardTooltip);
}

function toggleOutputCardTooltip(card) {
  if (!card) return;
  const isOpen = card.classList.contains('tip-open');
  if (isOpen) {
    closeOutputCardTooltip(card);
    return;
  }

  closeAllOutputCardTooltips();
  card.classList.add('tip-open');
  const btn = card.querySelector('.calc-out-tip-btn');
  const panel = card.querySelector('.calc-out-tip');
  if (btn) btn.setAttribute('aria-expanded', 'true');
  if (panel) panel.setAttribute('aria-hidden', 'false');
  activeOutputTipCard = card;
  positionOutputCardTooltip(card);
}

function initOutputCardTooltips() {
  const cards = Array.from(document.querySelectorAll('.calc-out-card'));
  if (!cards.length) return;
  ensureOutputSolutionPanel();

  cards.forEach(card => {
    const config = OUTPUT_TOOLTIP_CONTENT[card.id];
    if (!config) return;

    card.classList.add('tip-enabled');

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'calc-out-tip-btn';
    btn.textContent = 'i';
    btn.setAttribute('aria-label', `Explain ${config.title}`);
    btn.setAttribute('aria-expanded', 'false');

    const panel = document.createElement('div');
    panel.className = 'calc-out-tip';
    panel.id = `tip-${card.id}`;
    panel.setAttribute('role', 'tooltip');
    panel.setAttribute('aria-hidden', 'true');
    panel.innerHTML = buildOutputTooltipHtml(card.id, config);

    btn.setAttribute('aria-controls', panel.id);
    card.appendChild(btn);
    card.appendChild(panel);

    btn.addEventListener('click', event => {
      event.stopPropagation();
      toggleOutputCardTooltip(card);
    });

    card.addEventListener('click', event => {
      if (
        event.target.closest('.calc-out-tip-btn') ||
        event.target.closest('.calc-out-tip') ||
        event.target.closest('.calc-out-sub')
      ) return;
      toggleOutputCardTooltip(card);
    });

    panel.addEventListener('click', event => {
      event.stopPropagation();
    });

    const actionBtn = panel.querySelector('.calc-out-tip-action-btn');
    if (actionBtn) {
      actionBtn.addEventListener('click', event => {
        event.stopPropagation();
        openOutputSolutionPanel(card.id);
      });
    }
  });

  document.addEventListener('click', event => {
    if (event.target.closest('.calc-out-card.tip-enabled')) return;
    closeAllOutputCardTooltips();
  });

  if (!outputTooltipPositionListenersBound) {
    outputTooltipPositionListenersBound = true;
    window.addEventListener('resize', syncActiveOutputTooltipPlacement, { passive: true });
    window.addEventListener('scroll', syncActiveOutputTooltipPlacement, { passive: true, capture: true });
  }
}

function onInput(fieldId) {
  const input = document.getElementById('inp-' + fieldId);
  if (input) {
    const filled = isMeaningfulInputValue(input, input.value);
    const fieldWrap = input.closest('.calc-field, .startup-field');
    if (fieldWrap) fieldWrap.classList.toggle('has-value', filled);
    USER_PROVIDED[fieldId] = filled;
  }
  recalculate();
  updateProgressPills();
}

function isMeaningfulInputValue(input, rawValue) {
  if (!input) return false;
  const value = String(rawValue ?? '').trim();
  if (value === '') return false;
  const defaultValue = input.dataset.defaultValue;
  if (typeof defaultValue === 'string' && value === defaultValue) return false;

  if (input.type === 'number') {
    const numericValue = Number(value);
    if (!Number.isFinite(numericValue)) return false;
    const minAttr = input.getAttribute('min');
    const maxAttr = input.getAttribute('max');
    if (minAttr !== null && minAttr !== '' && numericValue < Number(minAttr)) return false;
    if (maxAttr !== null && maxAttr !== '' && numericValue > Number(maxAttr)) return false;
  }

  return true;
}

let progressInputLabelCache = null;
function getProgressInputLabel(inputId) {
  if (!progressInputLabelCache) progressInputLabelCache = {};
  if (progressInputLabelCache[inputId]) return progressInputLabelCache[inputId];

  const fallback = inputId.replace(/^inp-/, '');
  const labelEl = document.querySelector(`label[for="${inputId}"]`);
  if (!labelEl) {
    progressInputLabelCache[inputId] = fallback;
    return fallback;
  }

  const copy = labelEl.cloneNode(true);
  copy.querySelectorAll('.ftag, .calc-inline-help').forEach((node) => node.remove());
  const normalized = String(copy.textContent || '').replace(/\s+/g, ' ').trim();
  const label = normalized || fallback;
  progressInputLabelCache[inputId] = label;
  return label;
}

let progressPillNavigationBound = false;
function focusInputFromProgressPill(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;

  const featureScopeEl = input.closest('[data-feature]');
  const featureId = featureScopeEl && featureScopeEl.getAttribute('data-feature');
  if (featureId && !isFeatureRuntimeEnabled(featureId)) {
    openFeatureToggles(featureId);
    writeShareFeedback(`${getFeatureDisplayName(featureId)} is disabled. Enable it in Feature controls to fill this field.`, true);
    return;
  }

  const field = input.closest('.calc-field, .startup-field');
  const target = field || input;
  target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  window.setTimeout(() => {
    if (typeof input.focus === 'function') input.focus({ preventScroll: true });
  }, 220);
}

function bindProgressPillNavigation() {
  if (progressPillNavigationBound) return;
  const prog = document.getElementById('calc-progress');
  if (!prog) return;

  const handleActivate = (pill) => {
    if (!pill || pill.dataset.filled !== '0') return;
    const inputId = pill.dataset.targetInputId;
    if (!inputId) return;
    focusInputFromProgressPill(inputId);
  };

  prog.addEventListener('click', (event) => {
    const pill = event.target && event.target.closest ? event.target.closest('.cp-pill') : null;
    if (!pill) return;
    handleActivate(pill);
  });

  prog.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    const pill = event.target && event.target.closest ? event.target.closest('.cp-pill') : null;
    if (!pill) return;
    event.preventDefault();
    handleActivate(pill);
  });

  progressPillNavigationBound = true;
}

function updateProgressPills() {
  const ids = [
    'inp-nRef','inp-currency','inp-devPerClient','inp-infraTotal','inp-ARPU',
    'inp-startupTargetPrice','inp-startupTargetClients',
    'inp-cudPct','inp-margin','inp-nMax',
    'inp-budgetMonthly','inp-forecastGrowthPct','inp-forecastBestEfficiencyPct','inp-forecastWorstDriftPct',
    'inp-savingsIdentified','inp-savingsRealized','inp-costAvoidance',
    'inp-techDomains','inp-costSaaS','inp-costLicensing','inp-costPrivateCloud','inp-costDataCenter','inp-costLabor',
    'inp-aiEnabled','inp-aiPricingMode','inp-aiRatePer1MInput','inp-aiRatePer1MOutput','inp-aiRatePer1MTotal',
    'inp-aiInputTokensM','inp-aiOutputTokensM','inp-aiRetryRatePct','inp-aiPremiumMixPct',
    'inp-aiSharedOverheadMonthly','inp-aiAllocationPolicy',
    'inp-reliabilityEnabled','inp-sloTargetAvailabilityPct','inp-sliObservedAvailabilityPct',
    'inp-incidentCountMonthly','inp-mttrHours','inp-incidentBlendedHourlyRate',
    'inp-criticalRevenuePerMinute','inp-arrExposedMonthly',
    'inp-slaPenaltyRatePerBreachPointMonthly','inp-reliabilityInvestmentMonthly'
  ];
  const prog = document.getElementById('calc-progress');
  if (prog) prog.style.display = 'flex';
  bindProgressPillNavigation();
  let filled = 0;
  ids.forEach((id, i) => {
    const el   = document.getElementById(id);
    const pill = document.getElementById('cp-' + i);
    const has  = isMeaningfulInputValue(el, el ? el.value : '');
    const inputLabel = getProgressInputLabel(id);
    const tooltip = `${inputLabel} - ${has ? 'filled' : 'not filled (click to jump)'}`;
    if (has) filled++;
    if (pill) pill.classList.toggle('filled', has);
    if (pill) {
      pill.title = tooltip;
      pill.setAttribute('aria-label', tooltip);
      pill.dataset.tooltip = tooltip;
      pill.dataset.targetInputId = id;
      pill.dataset.filled = has ? '1' : '0';
      pill.tabIndex = has ? -1 : 0;
      pill.setAttribute('role', 'button');
    }
  });
  const dot  = document.getElementById('calc-dot');
  const text = document.getElementById('calc-status-text');
  if (filled === 0) {
    dot.classList.remove('active');
    text.classList.remove('active');
    text.textContent = 'Enter values above to begin';
  } else {
    dot.classList.add('active');
    text.classList.add('active');
    text.textContent = `${filled} of ${ids.length} fields filled · chart updated`;
  }
}

function recalculate() {
  cacheSubTexts();
  refreshCurrencyUnits();
  const previousReliabilityCurveSignature = getReliabilityCurveSignature(chartReliabilityInputs || {});

  const nRef         = getInp('inp-nRef');
  const currency     = normalizeCurrencyCode(getInputString('inp-currency', DEFAULT_CURRENCY_CODE));
  const devPerClient = getInp('inp-devPerClient');
  const infraTotal   = getInp('inp-infraTotal');
  const ARPU         = getInp('inp-ARPU');
  const startupTargetPrice   = getInp('inp-startupTargetPrice');
  const startupTargetClients = getInp('inp-startupTargetClients');
  const cudPct       = getInp('inp-cudPct');
  const marginPct    = getInp('inp-margin');
  const nMaxInp      = getInp('inp-nMax');
  const budgetMonthly = getInp('inp-budgetMonthly');
  const forecastGrowthPct = getInp('inp-forecastGrowthPct');
  const forecastBestEfficiencyPct = getInp('inp-forecastBestEfficiencyPct');
  const forecastWorstDriftPct = getInp('inp-forecastWorstDriftPct');
  const savingsIdentified = getInp('inp-savingsIdentified');
  const savingsRealized = getInp('inp-savingsRealized');
  const costAvoidance = getInp('inp-costAvoidance');
  const techDomains  = getSelectedTechDomains();
  const costSaaS        = getInp('inp-costSaaS');
  const costLicensing   = getInp('inp-costLicensing');
  const costPrivateCloud= getInp('inp-costPrivateCloud');
  const costDataCenter  = getInp('inp-costDataCenter');
  const costLabor       = getInp('inp-costLabor');
  const aiEnabled       = getInputString('inp-aiEnabled', 'off') === 'on';
  const aiPricingMode   = getInputString('inp-aiPricingMode', 'blended');
  const aiRatePer1MInput = getInp('inp-aiRatePer1MInput');
  const aiRatePer1MOutput = getInp('inp-aiRatePer1MOutput');
  const aiRatePer1MTotal = getInp('inp-aiRatePer1MTotal');
  const aiInputTokensM  = getInp('inp-aiInputTokensM');
  const aiOutputTokensM = getInp('inp-aiOutputTokensM');
  const aiRetryRatePct  = getInp('inp-aiRetryRatePct');
  const aiPremiumMixPct = getInp('inp-aiPremiumMixPct');
  const aiSharedOverheadMonthly = getInp('inp-aiSharedOverheadMonthly');
  const aiAllocationPolicy = getInputString('inp-aiAllocationPolicy', 'token-weighted');
  const reliabilityEnabled = getInputString('inp-reliabilityEnabled', 'off') === 'on';
  const sloTargetAvailabilityPct = getInp('inp-sloTargetAvailabilityPct');
  const sliObservedAvailabilityPct = getInp('inp-sliObservedAvailabilityPct');
  const incidentCountMonthly = getInp('inp-incidentCountMonthly');
  const mttrHours = getInp('inp-mttrHours');
  const incidentBlendedHourlyRate = getInp('inp-incidentBlendedHourlyRate');
  const criticalRevenuePerMinute = getInp('inp-criticalRevenuePerMinute');
  const arrExposedMonthly = getInp('inp-arrExposedMonthly');
  const slaPenaltyRatePerBreachPointMonthly = getInp('inp-slaPenaltyRatePerBreachPointMonthly');
  const reliabilityInvestmentMonthly = getInp('inp-reliabilityInvestmentMonthly');

  let derivations = [];
  let effectiveARPU = null;
  let arpuMode = 'missing';
  const nextModel = { ...MODEL_DEFAULTS };

  // ── Always-applicable fields ──────────────────────────────────
  if (nMaxInp !== null && nMaxInp >= 10) { nextModel.nMax = nMaxInp; }
  if (marginPct !== null) { nextModel.m = Math.max(0, marginPct / 100); }
  if (cudPct !== null) {
    nextModel.g = Math.max(0.01, 1 - cudPct / 100);
    derivations.push(`γ=${nextModel.g.toFixed(2)}`);
  }

  // ── Derive K from devPerClient ────────────────────────────────
  // Use actual nRef if given, otherwise use DEFAULT_N_REF as a calibration assumption
  if (devPerClient !== null && devPerClient >= 0) {
    const n = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
    nextModel.K = devPerClient * Math.pow(n, nextModel.a);
    derivations.push(`K=${nextModel.K.toFixed(0)}`);
  }

  // ── Derive c from infraTotal ──────────────────────────────────
  // KEY FIX: never calibrate against n=1 — use nRef or DEFAULT_N_REF
  if (infraTotal !== null && infraTotal >= 0) {
    const n = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
    nextModel.c = infraTotal / Math.pow(n, nextModel.b);
    derivations.push(`c=${nextModel.c.toFixed(4)} @ n=${n}`);
  }

  // ── ARPU source: manual OR startup planning assumptions ────────
  if (ARPU !== null && ARPU > 0) {
    nextModel.ARPU = ARPU;
    effectiveARPU = ARPU;
    arpuMode = 'manual';
  } else if (startupTargetPrice !== null && startupTargetPrice > 0) {
    nextModel.ARPU = startupTargetPrice;
    effectiveARPU = startupTargetPrice;
    arpuMode = 'startup-price';
    derivations.push(`ARPU≈${nextModel.ARPU.toFixed(2)} (price target)`);
  } else if (
    startupTargetClients !== null && startupTargetClients > 0 &&
    ((devPerClient !== null && devPerClient >= 0) || (infraTotal !== null && infraTotal >= 0))
  ) {
    nextModel.ARPU = minPriceAtClients(startupTargetClients, nextModel);
    effectiveARPU = nextModel.ARPU;
    arpuMode = 'startup-clients';
    derivations.push(`ARPU≈${nextModel.ARPU.toFixed(2)} @ ${Math.round(startupTargetClients)} clients`);
  }

  const changed = Object.keys(nextModel).some(key => Math.abs(nextModel[key] - MODEL[key]) > 1e-9);
  MODEL = nextModel;

  lastInputs = {
    nRef, currency, devPerClient, infraTotal, ARPU,
    startupTargetPrice, startupTargetClients,
    effectiveARPU, arpuMode,
    cudPct, margin: marginPct, nMax: nMaxInp,
    budgetMonthly, forecastGrowthPct, forecastBestEfficiencyPct, forecastWorstDriftPct,
    savingsIdentified, savingsRealized, costAvoidance,
    techDomains,
    costSaaS, costLicensing, costPrivateCloud, costDataCenter, costLabor,
    aiEnabled, aiPricingMode,
    aiRatePer1MInput, aiRatePer1MOutput, aiRatePer1MTotal,
    aiInputTokensM, aiOutputTokensM,
    aiRetryRatePct, aiPremiumMixPct,
    aiSharedOverheadMonthly, aiAllocationPolicy,
    aiMetrics: null,
    reliabilityEnabled,
    sloTargetAvailabilityPct,
    sliObservedAvailabilityPct,
    incidentCountMonthly,
    mttrHours,
    incidentBlendedHourlyRate,
    criticalRevenuePerMinute,
    arrExposedMonthly,
    slaPenaltyRatePerBreachPointMonthly,
    reliabilityInvestmentMonthly,
    reliabilityMetrics: null
  };

  chartReliabilityInputs = lastInputs;
  updateOutputCards(lastInputs);
  updateHealthAndRecommendations(lastInputs);
  const nextReliabilityCurveSignature = getReliabilityCurveSignature(chartReliabilityInputs || {});
  if (changed || previousReliabilityCurveSignature !== nextReliabilityCurveSignature) {
    draw();
  }

  const text = document.getElementById('calc-status-text');
  if (derivations.length && text) {
    text.textContent = `✓ Derived: ${derivations.join(' · ')} · chart updated`;
  }
}

function updateOutputCards(inputs) {
  const {
    nRef, devPerClient, infraTotal, ARPU: arpuInp, cudPct,
    startupTargetPrice, startupTargetClients, effectiveARPU, arpuMode,
    budgetMonthly, forecastGrowthPct, forecastBestEfficiencyPct, forecastWorstDriftPct,
    savingsIdentified, savingsRealized, costAvoidance,
    techDomains, costSaaS, costLicensing, costPrivateCloud, costDataCenter, costLabor,
    aiEnabled, aiPricingMode,
    aiRatePer1MInput, aiRatePer1MOutput, aiRatePer1MTotal,
    aiInputTokensM, aiOutputTokensM,
    aiRetryRatePct, aiPremiumMixPct,
    aiSharedOverheadMonthly, aiAllocationPolicy,
    reliabilityEnabled,
    sloTargetAvailabilityPct,
    sliObservedAvailabilityPct,
    incidentCountMonthly,
    mttrHours,
    incidentBlendedHourlyRate,
    criticalRevenuePerMinute,
    arrExposedMonthly,
    slaPenaltyRatePerBreachPointMonthly,
    reliabilityInvestmentMonthly
  } = inputs;
  const { K, a, c, b, g, m, nMax } = MODEL;

  // Use actual nRef if provided, otherwise DEFAULT_N_REF for display calculations
  const nSample   = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
  const arpuUsed  = (effectiveARPU !== null && effectiveARPU !== undefined && effectiveARPU > 0)
    ? effectiveARPU
    : ((arpuInp !== null && arpuInp > 0) ? arpuInp : null);
  const hasARPU   = arpuUsed !== null;
  const hasInfra  = infraTotal !== null && infraTotal >= 0;
  const hasDev    = devPerClient !== null && devPerClient >= 0;
  const hasNRef   = nRef !== null && nRef > 0;
  const hasStartupPrice   = startupTargetPrice !== null && startupTargetPrice > 0;
  const hasStartupClients = startupTargetClients !== null && startupTargetClients > 0;
  const hasAnyCostInput = hasInfra || hasDev;

  const dev      = K * Math.pow(nSample, -a);
  const infraRaw = c * Math.pow(nSample, b);
  const infraCud = g * c * Math.pow(nSample, b * 0.96);
  const total    = dev + infraRaw;
  const revenue  = hasARPU ? arpuUsed * nSample : 0;
  const vcpu     = infraRaw / nSample;
  const contribM = hasARPU ? (arpuUsed - vcpu) : null;
  const priceMin = (total / nSample) * (1 + m);
  const ccer     = hasARPU ? (infraRaw > 0 ? (revenue / infraRaw) : Infinity) : null;
  const cudSave  = infraRaw - infraCud;
  const searchMax = Math.max(20000, nMax);
  const economics = scanEconomicRange(arpuUsed, searchMax, MODEL);
  const reqClients = (hasStartupPrice && hasAnyCostInput)
    ? findRequiredClientsForTargetPrice(startupTargetPrice, searchMax, MODEL)
    : null;
  const reqPriceAtClients = (hasStartupClients && hasAnyCostInput)
    ? minPriceAtClients(startupTargetClients, MODEL)
    : null;
  const reqClientsFromClientsMode = (arpuMode === 'startup-clients' && reqPriceAtClients !== null)
    ? findRequiredClientsForTargetPrice(reqPriceAtClients, searchMax, MODEL)
    : null;
  const normalization = buildNormalizationSnapshot({
    nRef, infraTotal, techDomains,
    costSaaS, costLicensing, costPrivateCloud, costDataCenter, costLabor
  });

  // Break-even search
  const beN = economics.breakEvenN;

  // ── BREAK-EVEN ───────────────────────────────────────────────
  // Needs: at least one cost input (infra OR dev) AND ARPU
  // Without ARPU there is no revenue line; without any cost there's no cost line
  const beNeedsArpu  = !hasARPU;
  const beNeedsCost  = !hasInfra && !hasDev;

  if (beNeedsArpu && beNeedsCost) {
    setOut('oval-beN', null, '', '', 'Revenue/Client (ARPU) or Startup Target + one cost figure');
  } else if (beNeedsArpu) {
    setOut('oval-beN', null, '', '', 'Revenue/Client (ARPU) or Startup Target Price / Target Clients');
  } else if (beNeedsCost) {
    setOut('oval-beN', null, '', '', 'Dev Cost or Infra Cost');
  } else if (arpuMode === 'startup-price' && reqClients !== null) {
    const beClass = reqClients <= nSample ? 'good' : 'warn';
    setOut('oval-beN', `${reqClients.toLocaleString()} clients (startup est.)`, beClass, beClass === 'warn' ? 'warn' : '');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Estimated clients needed at your target price (includes margin target)';
  } else if (arpuMode === 'startup-clients' && reqClientsFromClientsMode !== null) {
    const beClass = reqClientsFromClientsMode <= nSample ? 'good' : 'warn';
    setOut('oval-beN', `${reqClientsFromClientsMode.toLocaleString()} clients (startup est.)`, beClass, beClass === 'warn' ? 'warn' : '');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Estimated clients needed based on your target clients pricing requirement';
  } else if (beN && beN <= nMax) {
    const beClass = beN <= nSample ? 'good' : 'warn';
    const beCard  = beN <= nSample ? '' : 'warn';
    const note    = !hasNRef ? ` (est. @ n=${DEFAULT_N_REF})` : '';
    setOut('oval-beN', `${beN.toLocaleString()} clients${note}`, beClass, beCard);
  } else {
    // Break-even exists but beyond chart range — model might be miscalibrated
    const hint = !hasNRef ? ` · add Client Count for accuracy` : '';
    setOut('oval-beN', beN === null ? 'Not reachable' : `> ${nMax.toLocaleString()} clients`, 'warn', 'warn');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Monthly revenue stays below total monthly cost across modeled range' + hint;
  }

  // ── MIN PRICE / CLIENT ────────────────────────────────────────
  if (!hasInfra && !hasDev) {
    setOut('oval-minPrice', null, '', '', 'Dev Cost or Infra Cost');
  } else {
    const note    = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    const mpOk    = hasARPU && priceMin < arpuUsed;
    const mpClass = mpOk ? 'good' : 'bad';
    setOut('oval-minPrice', fmtOut(priceMin, 2) + ' / client', mpClass, mpClass === 'bad' ? 'bad' : '');
    if (note) {
      const subEl = document.querySelector('#out-minPrice .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── VCPU ─────────────────────────────────────────────────────
  if (!hasInfra) {
    setOut('oval-vcpu', null, '', '', 'Total Infra Cost');
  } else {
    const note  = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    setOut('oval-vcpu', fmtOut(vcpu, 2) + ' / client', '');
    if (note) {
      const subEl = document.querySelector('#out-vcpu .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── CONTRIBUTION MARGIN ───────────────────────────────────────
  if (!hasInfra && !hasARPU) {
    setOut('oval-margin', null, '', '', 'Total Infra Cost + Revenue / Client (ARPU) or Startup Target');
  } else if (!hasInfra) {
    setOut('oval-margin', null, '', '', 'Total Infra Cost');
  } else if (!hasARPU) {
    setOut('oval-margin', null, '', '', 'Revenue / Client (ARPU) or Startup Target');
  } else {
    const cmClass = contribM !== null && contribM > 0 ? 'good' : 'bad';
    setOut('oval-margin', fmtOut(contribM, 2) + ' / client', cmClass, cmClass === 'bad' ? 'bad' : '');
  }

  // ── CCER ─────────────────────────────────────────────────────
  if (!hasInfra && !hasARPU) {
    setOut('oval-ccer', null, '', '', 'Total Infra Cost + Revenue / Client (ARPU) or Startup Target');
  } else if (!hasInfra) {
    setOut('oval-ccer', null, '', '', 'Total Infra Cost');
  } else if (!hasARPU) {
    setOut('oval-ccer', null, '', '', 'Revenue / Client (ARPU) or Startup Target');
  } else if (ccer === Infinity) {
    setOut('oval-ccer', '∞', 'good', '');
    const subEl = document.querySelector('#out-ccer .calc-out-sub');
    if (subEl) subEl.textContent = 'Infra cost is zero at current assumptions; cloud efficiency is effectively unbounded';
  } else if (ccer !== null) {
    const cc = ccer >= 3 ? 'good' : ccer >= 1 ? 'warn' : 'bad';
    setOut('oval-ccer', ccer.toFixed(2) + '×', cc, cc);
  } else {
    setOut('oval-ccer', null, '', '', 'Valid infra cost > 0');
  }

  // ── CUD SAVING ────────────────────────────────────────────────
  if (!hasInfra) {
    setOut('oval-cudSave', null, '', '', 'Total Infra Cost');
  } else {
    const note = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    setOut('oval-cudSave', fmtOut(cudSave) + ' / mo', cudSave > 0 ? 'good' : '', cudSave > 0 ? '' : 'warn');
    if (note) {
      const subEl = document.querySelector('#out-cudSave .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── STARTUP OPTION A: REQUIRED CLIENTS @ TARGET PRICE ─────────
  if (!hasStartupPrice && !hasARPU) {
    setOut('oval-reqClients', null, '', '', 'Option A: Target Price / Client');
  } else if (!hasAnyCostInput) {
    setOut('oval-reqClients', null, '', '', 'Dev Cost or Infra Cost');
  } else if (!hasStartupPrice) {
    setOut('oval-reqClients', null, '', '', 'Option A: Target Price / Client');
  } else if (reqClients === null) {
    setOut('oval-reqClients', `> ${searchMax.toLocaleString()} clients`, 'warn', 'warn');
    const subEl = document.querySelector('#out-reqClients .calc-out-sub');
    if (subEl) subEl.textContent = 'Target price appears too low for profitability in current range';
  } else {
    const cls = reqClients <= nSample ? 'good' : 'warn';
    setOut('oval-reqClients', `${reqClients.toLocaleString()} clients`, cls, cls === 'warn' ? 'warn' : '');
  }

  // ── STARTUP OPTION B: REQUIRED PRICE @ TARGET CLIENTS ─────────
  if (!hasStartupClients && !hasARPU) {
    setOut('oval-reqPrice', null, '', '', 'Option B: Target Clients');
  } else if (!hasAnyCostInput) {
    setOut('oval-reqPrice', null, '', '', 'Dev Cost or Infra Cost');
  } else if (!hasStartupClients) {
    setOut('oval-reqPrice', null, '', '', 'Option B: Target Clients');
  } else {
    const cls = hasStartupPrice && startupTargetPrice >= reqPriceAtClients ? 'good' : 'warn';
    setOut('oval-reqPrice', fmtOut(reqPriceAtClients, 2) + ' / client', cls, cls === 'warn' ? 'warn' : '');
  }

  // ── STARTUP REVENUE TARGET ─────────────────────────────────────
  let revenueTarget = null;
  if (hasStartupClients && reqPriceAtClients !== null) {
    const priceForRevenue = hasStartupPrice ? startupTargetPrice : reqPriceAtClients;
    revenueTarget = priceForRevenue * startupTargetClients;
  } else if (hasStartupPrice && reqClients !== null) {
    revenueTarget = startupTargetPrice * reqClients;
  }

  if (!hasAnyCostInput) {
    setOut('oval-targetRevenue', null, '', '', 'Dev Cost or Infra Cost');
  } else if (revenueTarget === null) {
    setOut('oval-targetRevenue', null, '', '', 'Option A or Option B startup input');
  } else {
    setOut('oval-targetRevenue', fmtOut(revenueTarget, 0) + ' / mo', 'good', '');
    const subEl = document.querySelector('#out-targetRevenue .calc-out-sub');
    if (subEl) {
      if (hasStartupPrice && hasStartupClients) {
        subEl.textContent = 'Based on your own target price and target clients assumptions';
      } else if (hasStartupPrice) {
        subEl.textContent = 'Based on your target price and computed required client count';
      } else {
        subEl.textContent = 'Based on your target clients and computed required price';
      }
      if (arpuMode === 'startup-clients' || arpuMode === 'startup-price') {
        subEl.textContent += ' (startup estimate mode)';
      }
    }
  }

  // ── BUDGET VARIANCE ────────────────────────────────────────────
  const budgetBasisCost = normalization.totalMonthly > 0 ? normalization.totalMonthly : total;
  const hasBudget = budgetMonthly !== null && budgetMonthly >= 0;

  if (!hasAnyCostInput) {
    setOut('oval-budgetVariance', null, '', '', 'Dev Cost or Infra Cost (plus optional multi-domain scope)');
  } else if (!hasBudget) {
    setOut('oval-budgetVariance', null, '', '', 'Monthly Technology Budget');
  } else if (!(budgetMonthly > 0)) {
    setOut('oval-budgetVariance', null, '', '', 'Monthly Technology Budget > 0');
  } else {
    const variance = budgetMonthly - budgetBasisCost;
    const variancePct = (variance / budgetMonthly) * 100;
    const cls = variance >= 0 ? 'good' : (variancePct >= -10 ? 'warn' : 'bad');
    const cardState = cls === 'good' ? '' : cls;
    const direction = variance >= 0 ? 'headroom' : 'overrun';
    setOut('oval-budgetVariance', `${fmtOut(variance, 0)} (${variancePct.toFixed(1)}%)`, cls, cardState);
    const subEl = document.querySelector('#out-budgetVariance .calc-out-sub');
    if (subEl) {
      const basisLabel = normalization.totalMonthly > 0 ? 'selected-domain monthly scope' : 'core modeled monthly cost';
      subEl.textContent = `Budget variance = Budget − Cost (${direction}) using ${basisLabel}`;
    }
  }

  // ── FORECASTING BAND ───────────────────────────────────────────
  const hasForecastSignal = [forecastGrowthPct, forecastBestEfficiencyPct, forecastWorstDriftPct]
    .some(v => v !== null && v !== 0);
  const growthPct = forecastGrowthPct !== null ? forecastGrowthPct : 0;
  const bestEfficiencyPct = Math.max(0, Math.min(95, forecastBestEfficiencyPct !== null ? forecastBestEfficiencyPct : 0));
  const worstDriftPct = Math.max(0, forecastWorstDriftPct !== null ? forecastWorstDriftPct : 0);

  if (!hasAnyCostInput || !hasARPU) {
    setOut('oval-forecastBand', null, '', '', 'Cost inputs + Revenue / Client (ARPU or startup mode)');
    setOut('oval-forecastSpread', null, '', '', 'Cost inputs + Revenue / Client (ARPU or startup mode)');
  } else if (!hasForecastSignal) {
    setOut('oval-forecastBand', null, '', '', 'Forecast Growth or Best/Worst scenario assumptions');
    setOut('oval-forecastSpread', null, '', '', 'Forecast Growth or Best/Worst scenario assumptions');
  } else {
    const forecastN = Math.max(1, Math.round(nSample * (1 + growthPct / 100)));
    const forecastDev = K * Math.pow(forecastN, -a);
    const forecastInfra = c * Math.pow(forecastN, b);
    const forecastTotal = forecastDev + forecastInfra;
    const forecastRevenue = arpuUsed * forecastN;
    const baselineMargin = forecastRevenue - forecastTotal;
    const bestMargin = forecastRevenue - (forecastTotal * (1 - (bestEfficiencyPct / 100)));
    const worstMargin = forecastRevenue - (forecastTotal * (1 + (worstDriftPct / 100)));
    const spread = bestMargin - worstMargin;
    const spreadPct = forecastRevenue > 0 ? (spread / forecastRevenue) * 100 : 0;

    const bandClass = baselineMargin >= 0 ? (worstMargin >= 0 ? 'good' : 'warn') : 'bad';
    const bandCard = bandClass === 'good' ? '' : bandClass;
    setOut(
      'oval-forecastBand',
      `Base ${fmtOut(baselineMargin, 0)} · Best ${fmtOut(bestMargin, 0)} · Worst ${fmtOut(worstMargin, 0)}`,
      bandClass,
      bandCard
    );
    const bandSub = document.querySelector('#out-forecastBand .calc-out-sub');
    if (bandSub) {
      bandSub.textContent = `Forecast at n=${forecastN.toLocaleString()} (growth ${growthPct.toFixed(1)}%)`;
    }

    const confidenceTier = spreadPct <= 10 ? 'High' : (spreadPct <= 25 ? 'Medium' : 'Low');
    const spreadClass = confidenceTier === 'High' ? 'good' : (confidenceTier === 'Medium' ? 'warn' : 'bad');
    const spreadCard = spreadClass === 'good' ? '' : spreadClass;
    setOut('oval-forecastSpread', `${fmtOut(spread, 0)} (${spreadPct.toFixed(1)}% rev) · ${confidenceTier}`, spreadClass, spreadCard);
    const spreadSub = document.querySelector('#out-forecastSpread .calc-out-sub');
    if (spreadSub) {
      spreadSub.textContent = 'Confidence band based on best/worst scenario distance';
    }
  }

  // ── VALUE REALIZATION LEDGER ───────────────────────────────────
  const hasRealizationSignal = [savingsIdentified, savingsRealized, costAvoidance].some(v => v !== null);
  const realizedSavingsUsed = savingsRealized !== null ? savingsRealized : 0;
  const costAvoidanceUsed = costAvoidance !== null ? costAvoidance : 0;
  const identifiedUsed = savingsIdentified !== null ? savingsIdentified : null;
  const totalRealizedValue = realizedSavingsUsed + costAvoidanceUsed;

  if (!hasRealizationSignal) {
    setOut('oval-realizedValue', null, '', '', 'Realized Savings and/or Cost Avoidance');
    setOut('oval-realizationRatio', null, '', '', 'Identified Savings Target + realized value inputs');
    setOut('oval-realizationGap', null, '', '', 'Identified Savings Target + realized value inputs');
  } else {
    const valueClass = totalRealizedValue > 0 ? 'good' : 'warn';
    setOut('oval-realizedValue', `${fmtOut(totalRealizedValue, 0)} / mo`, valueClass, valueClass === 'good' ? '' : 'warn');

    if (!(identifiedUsed !== null && identifiedUsed > 0)) {
      setOut('oval-realizationRatio', null, '', '', 'Identified Savings Target > 0');
      setOut('oval-realizationGap', null, '', '', 'Identified Savings Target > 0');
    } else {
      const ratioPct = (totalRealizedValue / identifiedUsed) * 100;
      const ratioClass = ratioPct >= 100 ? 'good' : (ratioPct >= 70 ? 'warn' : 'bad');
      const ratioCard = ratioClass === 'good' ? '' : ratioClass;
      setOut('oval-realizationRatio', `${ratioPct.toFixed(1)}%`, ratioClass, ratioCard);

      const residualGap = identifiedUsed - totalRealizedValue;
      const gapClass = residualGap <= 0 ? 'good' : (residualGap <= identifiedUsed * 0.2 ? 'warn' : 'bad');
      const gapCard = gapClass === 'good' ? '' : gapClass;
      setOut('oval-realizationGap', `${fmtOut(residualGap, 0)} / mo`, gapClass, gapCard);
      const gapSub = document.querySelector('#out-realizationGap .calc-out-sub');
      if (gapSub) {
        gapSub.textContent = residualGap <= 0
          ? 'Target exceeded — value captured above identified baseline'
          : 'Positive gap indicates value still to realize';
      }
    }
  }

  // ── R2 WAVE 1: MULTI-TECH NORMALIZATION OUTPUTS ───────────────
  const coverageClass = normalization.coveragePct >= 80
    ? 'good'
    : (normalization.coveragePct >= 50 ? 'warn' : 'bad');
  const coverageCardState = coverageClass === 'good' ? '' : (coverageClass === 'warn' ? 'warn' : 'bad');
  setOut(
    'oval-techCoverage',
    `${Math.round(normalization.coveragePct)}% (${normalization.providedInScopeCount}/${normalization.selectedCount})`,
    coverageClass,
    coverageCardState
  );

  if (normalization.totalMonthly <= 0 || normalization.selectedCount <= 0) {
    setOut('oval-techNorm', null, '', '', 'Monthly costs for selected domain scope');
    setOut('oval-focusMaturity', null, '', '', 'Selected-domain completeness for confidence scoring');
  } else {
    setOut('oval-techNorm', `${fmtOut(normalization.normalizedTotal, 2)} / client`, 'good', '');
    const confidenceClass = normalization.confidence === 'High'
      ? 'good'
      : (normalization.confidence === 'Medium' ? 'warn' : 'bad');
    const confidenceCardState = confidenceClass === 'good' ? '' : (confidenceClass === 'warn' ? 'warn' : 'bad');
    setOut('oval-focusMaturity', normalization.confidence, confidenceClass, confidenceCardState);
  }

  const aiEngine = window.FiceCalAiTokenEconomics;
  const aiMetrics = (aiEngine && typeof aiEngine.calculate === 'function')
    ? aiEngine.calculate({
      enabled: aiEnabled,
      pricingMode: aiPricingMode,
      ratePer1MInput: aiRatePer1MInput,
      ratePer1MOutput: aiRatePer1MOutput,
      ratePer1MTotal: aiRatePer1MTotal,
      inputTokensM: aiInputTokensM,
      outputTokensM: aiOutputTokensM,
      retryRatePct: aiRetryRatePct,
      premiumMixPct: aiPremiumMixPct,
      sharedOverheadMonthly: aiSharedOverheadMonthly,
      allocationPolicy: aiAllocationPolicy,
      nRef: nSample
    })
    : null;
  inputs.aiMetrics = aiMetrics;

  const aiGuardrailEl = document.getElementById('ai-token-guardrail');
  if (!aiEnabled) {
    setOut('oval-aiTokenCost', null, '', '', 'AI Cost Tracking = On');
    setOut('oval-aiAllocatedCost', null, '', '', 'AI Cost Tracking = On');
    setOut('oval-aiCostPerClient', null, '', '', 'AI Cost Tracking = On + Client Count');
    setOut('oval-aiRetryInflation', null, '', '', 'AI Cost Tracking = On');
    setOut('oval-aiPremiumMix', null, '', '', 'AI Cost Tracking = On');
    if (aiGuardrailEl) aiGuardrailEl.textContent = 'AI token economics remains inactive until AI Cost Tracking is set to On and token/rate inputs are provided.';
  } else if (!aiMetrics || aiMetrics.aiTotalTokenCost === null) {
    setOut('oval-aiTokenCost', null, '', '', 'Token volume + token rates');
    setOut('oval-aiAllocatedCost', null, '', '', 'Token volume + token rates + shared overhead');
    setOut('oval-aiCostPerClient', null, '', '', 'Client count + AI allocated cost');
    setOut('oval-aiRetryInflation', null, '', '', 'Retry rate %');
    setOut('oval-aiPremiumMix', null, '', '', 'Premium model mix %');
    if (aiGuardrailEl) aiGuardrailEl.textContent = 'Populate token rates and monthly token volumes to activate AI allocation outputs.';
  } else {
    const aiCostPerClientClass = (!hasARPU || aiMetrics.aiCostPerClient === null)
      ? 'warn'
      : (aiMetrics.aiCostPerClient <= arpuUsed * 0.25 ? 'good' : (aiMetrics.aiCostPerClient <= arpuUsed * 0.45 ? 'warn' : 'bad'));
    const aiCostPerClientCard = aiCostPerClientClass === 'good' ? '' : aiCostPerClientClass;
    const retryClass = aiMetrics.aiRetryInflationPct <= 10 ? 'good' : (aiMetrics.aiRetryInflationPct <= 20 ? 'warn' : 'bad');
    const premiumClass = aiMetrics.aiPremiumMixPct <= 25 ? 'good' : (aiMetrics.aiPremiumMixPct <= 45 ? 'warn' : 'bad');

    setOut('oval-aiTokenCost', `${fmtOut(aiMetrics.aiTotalTokenCost, 0)} / mo`, 'good', '');
    setOut('oval-aiAllocatedCost', `${fmtOut(aiMetrics.aiTotalAllocatedCost, 0)} / mo`, 'good', '');

    if (aiMetrics.aiCostPerClient === null) {
      setOut('oval-aiCostPerClient', null, '', '', 'Client count (n)');
    } else {
      setOut('oval-aiCostPerClient', `${fmtOut(aiMetrics.aiCostPerClient, 2)} / client`, aiCostPerClientClass, aiCostPerClientCard);
    }

    setOut('oval-aiRetryInflation', `${aiMetrics.aiRetryInflationPct.toFixed(1)}%`, retryClass, retryClass === 'good' ? '' : retryClass);
    setOut('oval-aiPremiumMix', `${aiMetrics.aiPremiumMixPct.toFixed(1)}%`, premiumClass, premiumClass === 'good' ? '' : premiumClass);

    const aiAllocSub = document.querySelector('#out-aiAllocatedCost .calc-out-sub');
    if (aiAllocSub) {
      aiAllocSub.textContent = `Allocation policy: ${aiMetrics.allocationPolicy} · confidence: ${aiMetrics.allocationConfidence.toUpperCase()}`;
    }
    if (aiGuardrailEl) {
      aiGuardrailEl.textContent = `AI token economics active: ${aiMetrics.tokenVolumeM.toFixed(1)}M monthly tokens, governance risk ${aiMetrics.tokenGovernanceRisk.toUpperCase()}, allocation confidence ${aiMetrics.allocationConfidence.toUpperCase()}.`;
    }
  }

  const reliabilityEngine = window.FiceCalReliabilityEconomics;
  const reliabilityMetrics = (reliabilityEngine && typeof reliabilityEngine.calculate === 'function')
    ? reliabilityEngine.calculate({
      enabled: reliabilityEnabled,
      sloTargetAvailabilityPct,
      sliObservedAvailabilityPct,
      incidentCountMonthly,
      mttrHours,
      incidentBlendedHourlyRate,
      criticalRevenuePerMinute,
      arrExposedMonthly,
      slaPenaltyRatePerBreachPointMonthly,
      reliabilityInvestmentMonthly,
      existingModeledCostMonthly: budgetBasisCost
    })
    : null;
  inputs.reliabilityMetrics = reliabilityMetrics;

  const reliabilityGuardrailEl = document.getElementById('reliability-guardrail');
  if (!reliabilityEnabled) {
    setOut('oval-relDowntime', null, '', '', 'Reliability Economics = On');
    setOut('oval-relFailureCost', null, '', '', 'Reliability Economics = On');
    setOut('oval-relAdjustedCost', null, '', '', 'Reliability Economics = On');
    setOut('oval-relProfitImpact', null, '', '', 'Reliability Economics = On');
    setOut('oval-relArpuUplift', null, '', '', 'Reliability Economics = On');
    setOut('oval-relExtraClients', null, '', '', 'Reliability Economics = On');
    setOut('oval-relRiskBand', null, '', '', 'Reliability Economics = On');
    setOut('oval-relDataConfidence', null, '', '', 'Reliability Economics = On');
    if (reliabilityGuardrailEl) {
      reliabilityGuardrailEl.textContent = 'Reliability economics remains inactive until enabled with SLO/SLI and incident context inputs.';
    }
  } else if (!reliabilityMetrics || reliabilityMetrics.expectedReliabilityFailureCostMonthly === null) {
    setOut('oval-relDowntime', null, '', '', 'Observed SLI Availability %');
    setOut('oval-relFailureCost', null, '', '', 'Reliability inputs for penalties, incident labor, and exposure');
    setOut('oval-relAdjustedCost', null, '', '', 'Baseline cost + reliability inputs');
    setOut('oval-relProfitImpact', null, '', '', 'Revenue / Client (ARPU) + reliability-adjusted cost');
    setOut('oval-relArpuUplift', null, '', '', 'Current ARPU + reliability-adjusted cost');
    setOut('oval-relExtraClients', null, '', '', 'Current ARPU + reliability-adjusted cost');
    setOut('oval-relRiskBand', null, '', '', 'Reliability signal inputs');
    setOut('oval-relDataConfidence', null, '', '', 'Reliability input completeness');
    if (reliabilityGuardrailEl) {
      reliabilityGuardrailEl.textContent = 'Populate reliability fields to activate SLA/SLO/SLI cost and risk outputs.';
    }
  } else {
    const downtimeClass = reliabilityMetrics.expectedDowntimeMinutes <= 45
      ? 'good'
      : (reliabilityMetrics.expectedDowntimeMinutes <= 180 ? 'warn' : 'bad');
    const riskClass = reliabilityMetrics.reliabilityRiskBand === 'high'
      ? 'bad'
      : (reliabilityMetrics.reliabilityRiskBand === 'medium' ? 'warn' : 'good');
    const confidenceClass = reliabilityMetrics.reliabilityDataConfidence === 'high'
      ? 'good'
      : (reliabilityMetrics.reliabilityDataConfidence === 'medium' ? 'warn' : 'bad');

    setOut(
      'oval-relDowntime',
      `${reliabilityMetrics.expectedDowntimeMinutes.toFixed(1)} min / mo`,
      downtimeClass,
      downtimeClass === 'good' ? '' : downtimeClass
    );
    setOut('oval-relFailureCost', `${fmtOut(reliabilityMetrics.expectedReliabilityFailureCostMonthly, 0)} / mo`, riskClass, riskClass === 'good' ? '' : riskClass);
    setOut('oval-relAdjustedCost', `${fmtOut(reliabilityMetrics.reliabilityAdjustedCostMonthly, 0)} / mo`, 'good', '');
    setOut('oval-relRiskBand', reliabilityMetrics.reliabilityRiskBand.toUpperCase(), riskClass, riskClass === 'good' ? '' : riskClass);
    setOut('oval-relDataConfidence', reliabilityMetrics.reliabilityDataConfidence.toUpperCase(), confidenceClass, confidenceClass === 'good' ? '' : confidenceClass);

    const reliabilityLoadMonthly =
      Math.max(0, Number(reliabilityMetrics.reliabilityInvestmentMonthly) || 0) +
      Math.max(0, Number(reliabilityMetrics.expectedReliabilityFailureCostMonthly) || 0);
    const reliabilityAdjustedProfitMonthly = hasARPU
      ? (revenue - reliabilityMetrics.reliabilityAdjustedCostMonthly)
      : null;
    const reliabilityRoiPct = hasARPU && reliabilityMetrics.reliabilityAdjustedCostMonthly > 0
      ? (reliabilityAdjustedProfitMonthly / reliabilityMetrics.reliabilityAdjustedCostMonthly) * 100
      : null;

    if (!hasARPU || reliabilityAdjustedProfitMonthly === null) {
      setOut('oval-relProfitImpact', null, '', '', 'Revenue / Client (ARPU)');
    } else {
      const relProfitClass = reliabilityAdjustedProfitMonthly >= 0
        ? 'good'
        : (reliabilityAdjustedProfitMonthly >= -(reliabilityMetrics.reliabilityAdjustedCostMonthly * 0.1) ? 'warn' : 'bad');
      const relProfitCard = relProfitClass === 'good' ? '' : relProfitClass;
      setOut('oval-relProfitImpact', `${fmtOut(reliabilityAdjustedProfitMonthly, 0)} / mo`, relProfitClass, relProfitCard);
      const relProfitSub = document.querySelector('#out-relProfitImpact .calc-out-sub');
      if (relProfitSub) {
        const roiText = reliabilityRoiPct === null ? 'ROI n/a' : `ROI ${reliabilityRoiPct.toFixed(1)}%`;
        relProfitSub.textContent = `Revenue ${fmtOut(revenue, 0)} − adjusted cost ${fmtOut(reliabilityMetrics.reliabilityAdjustedCostMonthly, 0)} (${roiText}).`;
      }
    }

    const requiredArpuWithReliability = (reliabilityMetrics.reliabilityAdjustedCostMonthly / Math.max(1, nSample)) * (1 + m);
    if (!hasARPU) {
      setOut('oval-relArpuUplift', null, '', '', 'Current ARPU');
    } else {
      const arpuUpliftNeeded = Math.max(0, requiredArpuWithReliability - arpuUsed);
      const arpuUpliftClass = arpuUpliftNeeded <= 0.01
        ? 'good'
        : (arpuUpliftNeeded <= Math.max(0.01, arpuUsed * 0.05) ? 'warn' : 'bad');
      setOut('oval-relArpuUplift', `${fmtOut(arpuUpliftNeeded, 2)} / client`, arpuUpliftClass, arpuUpliftClass === 'good' ? '' : arpuUpliftClass);
      const arpuUpliftSub = document.querySelector('#out-relArpuUplift .calc-out-sub');
      if (arpuUpliftSub) {
        arpuUpliftSub.textContent = `Target ARPU with ${(m * 100).toFixed(1)}% margin: ${fmtOut(requiredArpuWithReliability, 2)} / client (current ${fmtOut(arpuUsed, 2)} / client).`;
      }
    }

    if (!hasARPU || !hasAnyCostInput) {
      setOut('oval-relExtraClients', null, '', '', 'Current ARPU + core cost inputs');
    } else {
      const requiredClientsWithReliability = findRequiredClientsForTargetPriceWithReliability(
        arpuUsed,
        searchMax,
        reliabilityLoadMonthly,
        MODEL
      );
      if (requiredClientsWithReliability === null) {
        setOut('oval-relExtraClients', `> ${searchMax.toLocaleString()} clients`, 'bad', 'bad');
        const relClientsSub = document.querySelector('#out-relExtraClients .calc-out-sub');
        if (relClientsSub) {
          relClientsSub.textContent = 'Current ARPU appears too low to absorb reliability-adjusted cost in modeled range.';
        }
      } else {
        const extraClientsNeeded = Math.max(0, Math.ceil(requiredClientsWithReliability - nSample));
        const extraClientsClass = extraClientsNeeded === 0
          ? 'good'
          : (extraClientsNeeded <= Math.max(25, Math.ceil(nSample * 0.1)) ? 'warn' : 'bad');
        setOut('oval-relExtraClients', `${extraClientsNeeded.toLocaleString()} clients`, extraClientsClass, extraClientsClass === 'good' ? '' : extraClientsClass);
        const relClientsSub = document.querySelector('#out-relExtraClients .calc-out-sub');
        if (relClientsSub) {
          relClientsSub.textContent = `Required clients with reliability load: ${Math.ceil(requiredClientsWithReliability).toLocaleString()} (current ${Math.round(nSample).toLocaleString()}).`;
        }
      }
    }

    const adjustedSub = document.querySelector('#out-relAdjustedCost .calc-out-sub');
    if (adjustedSub) {
      adjustedSub.textContent = `Base ${fmtOut(budgetBasisCost, 0)} + investment ${fmtOut(reliabilityMetrics.reliabilityInvestmentMonthly, 0)} + expected failure ${fmtOut(reliabilityMetrics.expectedReliabilityFailureCostMonthly, 0)}.`;
    }
    if (reliabilityGuardrailEl) {
      reliabilityGuardrailEl.textContent = `Reliability economics active: risk ${reliabilityMetrics.reliabilityRiskBand.toUpperCase()} with ${reliabilityMetrics.reliabilityDataConfidence.toUpperCase()} data confidence.`;
    }
  }

  syncOutputCardSeverityAndOrder();

  renderPortfolioSummary(normalization);
  updateNormalizationGuardrail(normalization);
  updateValueGuardrail({
    hasAnyCostInput,
    hasARPU,
    hasBudget,
    hasForecastSignal,
    hasRealizationSignal
  });
  renderCfoForecastDashboard({
    hasAnyCostInput,
    hasARPU,
    hasBudget,
    hasForecastSignal,
    hasRealizationSignal,
    hasReliabilityEnabled: reliabilityEnabled,
    hasReliabilitySignal: Boolean(reliabilityMetrics && reliabilityMetrics.enabled && reliabilityMetrics.expectedReliabilityFailureCostMonthly !== null),
    reliabilityMetrics,
    nSample,
    arpuUsed,
    budgetMonthly,
    budgetBasisCost,
    growthPct,
    bestEfficiencyPct,
    worstDriftPct,
    identifiedUsed,
    totalRealizedValue,
    totalCoreCost: total,
    model: { K, a, c, b }
  });
}

function createCfoProjectionRows(state) {
  if (!state || !state.hasAnyCostInput) return [];
  const months = 12;
  const rows = [];
  const annualGrowthFactor = Math.max(0.05, 1 + (state.growthPct / 100));
  const growthIntervals = months - 1;
  const monthGrowth = growthIntervals > 0
    ? Math.pow(annualGrowthFactor, 1 / growthIntervals) - 1
    : 0;
  const scopeMultiplier = state.totalCoreCost > 0
    ? (state.budgetBasisCost / state.totalCoreCost)
    : 1;
  const identifiedMonthly = state.identifiedUsed !== null && state.identifiedUsed > 0 ? state.identifiedUsed : null;

  for (let idx = 1; idx <= months; idx++) {
    const clients = Math.max(1, state.nSample * Math.pow(1 + monthGrowth, idx - 1));
    const dev = state.model.K * Math.pow(clients, -state.model.a);
    const infra = state.model.c * Math.pow(clients, state.model.b);
    const modeledCost = (dev + infra) * scopeMultiplier;
    const budgetVariance = state.hasBudget ? state.budgetMonthly - modeledCost : null;
    const budgetVariancePct = state.hasBudget && state.budgetMonthly > 0
      ? (budgetVariance / state.budgetMonthly) * 100
      : null;
    const revenue = state.hasARPU ? state.arpuUsed * clients : null;
    const baseMargin = state.hasARPU ? revenue - modeledCost : null;
    const bestMargin = state.hasARPU
      ? revenue - (modeledCost * (1 - (state.bestEfficiencyPct / 100)))
      : null;
    const worstMargin = state.hasARPU
      ? revenue - (modeledCost * (1 + (state.worstDriftPct / 100)))
      : null;
    const cumulativeTarget = identifiedMonthly !== null ? identifiedMonthly * idx : null;
    const cumulativeRealized = state.totalRealizedValue * idx;
    const cumulativeGap = cumulativeTarget !== null ? cumulativeTarget - cumulativeRealized : null;

    rows.push({
      month: idx,
      clients,
      modeledCost,
      budgetVariance,
      budgetVariancePct,
      revenue,
      baseMargin,
      bestMargin,
      worstMargin,
      cumulativeTarget,
      cumulativeRealized,
      cumulativeGap
    });
  }

  return rows;
}

function renderCfoBudgetPanel(rows, state) {
  const budgetBarsEl = document.getElementById('qbv-budget-bars');
  if (!budgetBarsEl) return;

  if (!state.hasBudget || !(state.budgetMonthly > 0)) {
    budgetBarsEl.innerHTML = '<div class="qbv-placeholder">Provide Monthly Technology Budget to render budget vs modeled cost checkpoints.</div>';
    return;
  }

  const checkpoints = [rows[0], rows[5], rows[11]].filter(Boolean);
  const maxValue = Math.max(state.budgetMonthly, ...checkpoints.map(row => row.modeledCost));
  budgetBarsEl.innerHTML = checkpoints.map(row => {
    const budgetWidth = Math.max(2, (state.budgetMonthly / maxValue) * 100);
    const costWidth = Math.max(2, (row.modeledCost / maxValue) * 100);
    const varianceClass = row.budgetVariance >= 0 ? 'good' : 'bad';
    return `
      <div class="qbv-bar-row">
        <div class="qbv-bar-label">M${row.month}</div>
        <div class="qbv-bar-stack" title="Budget ${fmtOut(state.budgetMonthly, 0)} · Modeled ${fmtOut(row.modeledCost, 0)}">
          <div class="qbv-bar-track"><span class="qbv-bar-fill budget" style="width:${budgetWidth}%;"></span></div>
          <div class="qbv-bar-track"><span class="qbv-bar-fill cost" style="width:${costWidth}%;"></span></div>
        </div>
        <div class="qbv-bar-meta ${varianceClass}">${fmtOut(row.budgetVariance, 0)}</div>
      </div>
    `;
  }).join('');
}

function renderCfoReliabilityPanel(state) {
  const summaryEl = document.getElementById('qbv-reliability-summary');
  const barsEl = document.getElementById('qbv-reliability-bars');
  if (!summaryEl || !barsEl) return;

  const metrics = state && state.reliabilityMetrics;
  if (!state || !state.hasReliabilityEnabled) {
    summaryEl.textContent = 'Enable Reliability Economics to expose SLA/SLO/SLI downside composition.';
    barsEl.innerHTML = '<div class="qbv-placeholder">Reliability panel inactive until reliability economics is enabled.</div>';
    return;
  }

  if (!metrics || !metrics.enabled || metrics.expectedReliabilityFailureCostMonthly === null) {
    summaryEl.textContent = 'Populate reliability fields to compute expected failure cost composition.';
    barsEl.innerHTML = '<div class="qbv-placeholder">Need SLO/SLI, incident, and exposure assumptions.</div>';
    return;
  }

  const riskClass = metrics.reliabilityRiskBand === 'high'
    ? 'bad'
    : (metrics.reliabilityRiskBand === 'medium' ? 'warn' : 'good');
  const confidenceClass = metrics.reliabilityDataConfidence === 'high'
    ? 'good'
    : (metrics.reliabilityDataConfidence === 'medium' ? 'warn' : 'bad');

  summaryEl.innerHTML = `
    Expected failure cost <strong>${fmtOut(metrics.expectedReliabilityFailureCostMonthly, 0)} / mo</strong>
    against adjusted envelope <strong>${fmtOut(metrics.reliabilityAdjustedCostMonthly, 0)} / mo</strong>
    · <span class="qbv-risk-pill ${riskClass}">risk ${metrics.reliabilityRiskBand.toUpperCase()}</span>
    · <span class="qbv-risk-pill ${confidenceClass}">confidence ${metrics.reliabilityDataConfidence.toUpperCase()}</span>
  `;

  const components = [
    { label: 'Penalty', key: 'rel-penalty', value: metrics.expectedSlaPenaltyMonthly || 0 },
    { label: 'Incident labor', key: 'rel-incident', value: metrics.expectedIncidentLaborMonthly || 0 },
    { label: 'Downtime loss', key: 'rel-downtime', value: metrics.expectedRevenueAtRiskMonthly || 0 },
    { label: 'Churn risk', key: 'rel-churn', value: metrics.expectedChurnRiskMonthly || 0 }
  ];

  const maxValue = Math.max(1, ...components.map(item => item.value));
  barsEl.innerHTML = components.map(item => {
    const width = Math.max(2, (item.value / maxValue) * 100);
    return `
      <div class="qbv-bar-row">
        <div class="qbv-bar-label">${item.label}</div>
        <div class="qbv-bar-stack" title="${item.label}: ${fmtOut(item.value, 0)} / mo">
          <div class="qbv-bar-track"><span class="qbv-bar-fill ${item.key}" style="width:${width}%;"></span></div>
        </div>
        <div class="qbv-bar-meta">${fmtOut(item.value, 0)}</div>
      </div>
    `;
  }).join('');
}

function renderCfoForecastPanel(rows, state) {
  const svgEl = document.getElementById('qbv-forecast-svg');
  const legendEl = document.getElementById('qbv-forecast-legend');
  if (!svgEl || !legendEl) return;

  if (!state.hasARPU || !state.hasForecastSignal) {
    svgEl.innerHTML = '<text x="14" y="28" fill="#5d7290" font-size="11">Add ARPU/startup assumptions and forecast controls to render fan chart.</text>';
    legendEl.innerHTML = '<span class="qbv-placeholder">Forecast fan chart inactive until revenue and scenario assumptions are available.</span>';
    return;
  }

  const base = rows.map(row => row.baseMargin || 0);
  const best = rows.map(row => row.bestMargin || 0);
  const worst = rows.map(row => row.worstMargin || 0);
  const values = [...base, ...best, ...worst, 0];
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const padX = 26;
  const padY = 16;
  const width = 520;
  const height = 170;
  const spanX = width - (padX * 2);
  const spanY = height - (padY * 2);
  const den = maxV - minV || 1;

  const toPoint = (value, idx) => {
    const x = padX + ((idx / (rows.length - 1 || 1)) * spanX);
    const y = height - padY - (((value - minV) / den) * spanY);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  };

  const bestPts = best.map((v, idx) => toPoint(v, idx)).join(' ');
  const basePts = base.map((v, idx) => toPoint(v, idx)).join(' ');
  const worstPts = worst.map((v, idx) => toPoint(v, idx)).join(' ');
  const zeroY = (0 >= minV && 0 <= maxV)
    ? (height - padY - (((0 - minV) / den) * spanY)).toFixed(1)
    : null;

  svgEl.innerHTML = `
    ${zeroY !== null ? `<line x1="${padX}" y1="${zeroY}" x2="${width - padX}" y2="${zeroY}" stroke="rgba(30,56,94,0.22)" stroke-dasharray="4 4"></line>` : ''}
    <polyline fill="none" stroke="#009e73" stroke-width="2" points="${bestPts}"></polyline>
    <polyline fill="none" stroke="#0072b2" stroke-width="2" points="${basePts}"></polyline>
    <polyline fill="none" stroke="#d55e00" stroke-width="2" points="${worstPts}"></polyline>
  `;
  legendEl.innerHTML = `
    <span><span class="qbv-dot best"></span>Best margin</span>
    <span><span class="qbv-dot base"></span>Baseline margin</span>
    <span><span class="qbv-dot worst"></span>Worst margin</span>
  `;
}

function renderCfoRealizationPanel(rows, state) {
  const meterFillEl = document.getElementById('qbv-realization-meter-fill');
  const summaryEl = document.getElementById('qbv-realization-summary');
  const barsEl = document.getElementById('qbv-realization-bars');
  if (!meterFillEl || !summaryEl || !barsEl) return;

  if (!state.hasRealizationSignal) {
    meterFillEl.style.width = '0%';
    summaryEl.textContent = 'Add identified/realized/avoidance values to activate the burn-up ledger.';
    barsEl.innerHTML = '<div class="qbv-placeholder">No value realization checkpoints yet.</div>';
    return;
  }

  const annualTarget = state.identifiedUsed !== null && state.identifiedUsed > 0 ? state.identifiedUsed * 12 : null;
  const annualRealized = state.totalRealizedValue * 12;
  const pct = annualTarget !== null && annualTarget > 0 ? (annualRealized / annualTarget) * 100 : null;
  meterFillEl.style.width = pct !== null ? `${Math.min(100, Math.max(0, pct)).toFixed(1)}%` : '100%';
  summaryEl.textContent = annualTarget !== null
    ? `Annualized realization ${fmtOut(annualRealized, 0)} vs target ${fmtOut(annualTarget, 0)} (${pct.toFixed(1)}%)`
    : `Annualized realized value ${fmtOut(annualRealized, 0)} (set Identified Savings Target for completion ratio).`;

  const checkpoints = [rows[2], rows[5], rows[8], rows[11]].filter(Boolean);
  const maxValue = Math.max(
    1,
    ...checkpoints.map(row => row.cumulativeRealized || 0),
    ...checkpoints.map(row => row.cumulativeTarget || 0)
  );

  barsEl.innerHTML = checkpoints.map(row => {
    const target = row.cumulativeTarget || 0;
    const realized = row.cumulativeRealized || 0;
    const targetWidth = (target / maxValue) * 100;
    const realizedWidth = (realized / maxValue) * 100;
    return `
      <div class="qbv-bar-row">
        <div class="qbv-bar-label">M${row.month}</div>
        <div class="qbv-bar-stack">
          <div class="qbv-bar-track"><span class="qbv-bar-fill budget" style="width:${Math.max(2, targetWidth)}%;"></span></div>
          <div class="qbv-bar-track"><span class="qbv-bar-fill cost" style="width:${Math.max(2, realizedWidth)}%; background:rgba(0,158,115,0.65);"></span></div>
        </div>
        <div class="qbv-bar-meta">${row.cumulativeGap !== null ? fmtOut(row.cumulativeGap, 0) : '—'}</div>
      </div>
    `;
  }).join('');
}

function renderCfoPlanningTable(rows, state) {
  const tableBodyEl = document.getElementById('qbv-table-body');
  if (!tableBodyEl) return;

  if (!rows.length) {
    tableBodyEl.innerHTML = '<tr><td colspan="8" class="qbv-placeholder">Add cost inputs to generate your 12-month CFO planning view.</td></tr>';
    return;
  }

  let currentQuarter = null;
  const markup = [];

  rows.forEach((row) => {
    const quarter = `Q${Math.floor((row.month - 1) / 3) + 1}`;
    if (quarter !== currentQuarter) {
      currentQuarter = quarter;
      markup.push(`
        <tr class="qbv-quarter-sep">
          <td colspan="8">
            <div class="qbv-quarter-sep-line">
              <span class="qbv-quarter-sep-label">${quarter}</span>
            </div>
          </td>
        </tr>
      `);
    }

    markup.push(`
      <tr>
        <td>M${row.month}</td>
        <td>${Math.round(row.clients).toLocaleString()}</td>
        <td>${fmtOut(row.modeledCost, 0)} / mo</td>
        <td>${row.budgetVariance !== null ? `${fmtOut(row.budgetVariance, 0)} (${row.budgetVariancePct.toFixed(1)}%)` : '—'}</td>
        <td>${row.baseMargin !== null ? `${fmtOut(row.baseMargin, 0)} / mo` : '—'}</td>
        <td>${row.bestMargin !== null ? `${fmtOut(row.bestMargin, 0)} / mo` : '—'}</td>
        <td>${row.worstMargin !== null ? `${fmtOut(row.worstMargin, 0)} / mo` : '—'}</td>
        <td>${row.cumulativeGap !== null ? `${fmtOut(row.cumulativeGap, 0)}` : '—'}</td>
      </tr>
    `);
  });

  tableBodyEl.innerHTML = markup.join('');
}

function renderCfoForecastDashboard(state) {
  const noteEl = document.getElementById('qbv-dashboard-note');
  if (!noteEl) return;

  if (!state || !state.hasAnyCostInput) {
    qbvDashboardRows = [];
    renderCfoBudgetPanel([], { hasBudget: false, budgetMonthly: null });
    renderCfoForecastPanel([], { hasARPU: false, hasForecastSignal: false });
    renderCfoRealizationPanel([], { hasRealizationSignal: false, identifiedUsed: null, totalRealizedValue: 0 });
    renderCfoReliabilityPanel({ hasReliabilityEnabled: false, reliabilityMetrics: null });
    renderCfoPlanningTable([], {});
    noteEl.textContent = 'Add Dev Cost or Infra Cost to activate CFO visual planning outputs.';
    if (qbvExportBtnEl) qbvExportBtnEl.disabled = true;
    return;
  }

  const rows = createCfoProjectionRows(state);
  qbvDashboardRows = rows;
  renderCfoBudgetPanel(rows, state);
  renderCfoForecastPanel(rows, state);
  renderCfoRealizationPanel(rows, state);
  renderCfoReliabilityPanel(state);
  renderCfoPlanningTable(rows, state);

  if (!state.hasBudget) {
    noteEl.textContent = 'Set Monthly Technology Budget to unlock variance tracking in the CFO planning dashboard.';
  } else if (!state.hasARPU || !state.hasForecastSignal) {
    noteEl.textContent = 'Budgeting is active. Add ARPU and forecast assumptions to render best/base/worst margin scenarios.';
  } else if (state.hasReliabilityEnabled && state.hasReliabilitySignal) {
    noteEl.textContent = 'CFO dashboard active: reliability downside composition is now visible alongside budgeting, forecast fan, and cumulative value signals.';
  } else {
    noteEl.textContent = 'CFO dashboard active: use Month 1/6/12 budget checkpoints, scenario fan chart, and cumulative value gap to prepare forecast packs.';
  }

  if (qbvExportBtnEl) qbvExportBtnEl.disabled = rows.length === 0;
}

function initCfoDashboardExport() {
  if (!qbvExportBtnEl) return;
  qbvExportBtnEl.addEventListener('click', () => {
    if (!qbvDashboardRows.length) return;
    const headers = [
      'month',
      'clients',
      'modeled_cost',
      'budget_variance',
      'budget_variance_pct',
      'revenue',
      'base_margin',
      'best_margin',
      'worst_margin',
      'cumulative_target',
      'cumulative_realized',
      'cumulative_gap'
    ];
    const lines = qbvDashboardRows.map(row => [
      row.month,
      Math.round(row.clients),
      row.modeledCost.toFixed(2),
      row.budgetVariance !== null ? row.budgetVariance.toFixed(2) : '',
      row.budgetVariancePct !== null ? row.budgetVariancePct.toFixed(2) : '',
      row.revenue !== null ? row.revenue.toFixed(2) : '',
      row.baseMargin !== null ? row.baseMargin.toFixed(2) : '',
      row.bestMargin !== null ? row.bestMargin.toFixed(2) : '',
      row.worstMargin !== null ? row.worstMargin.toFixed(2) : '',
      row.cumulativeTarget !== null ? row.cumulativeTarget.toFixed(2) : '',
      row.cumulativeRealized.toFixed(2),
      row.cumulativeGap !== null ? row.cumulativeGap.toFixed(2) : ''
    ].join(','));
    const csv = [headers.join(','), ...lines].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cfo-forecast-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
}

function updateValueGuardrail(state) {
  const guardrailEl = document.getElementById('value-guardrail');
  if (!guardrailEl) return;

  const {
    hasAnyCostInput = false,
    hasARPU = false,
    hasBudget = false,
    hasForecastSignal = false,
    hasRealizationSignal = false
  } = state || {};

  if (!hasAnyCostInput) {
    guardrailEl.textContent = 'Add Dev Cost or Infra Cost first to enable budget and forecast value calculations.';
    return;
  }

  if (!hasBudget && !hasForecastSignal && !hasRealizationSignal) {
    guardrailEl.textContent = 'Set budget and at least one forecasting or realization input to activate Quantify Business Value controls.';
    return;
  }

  if (hasForecastSignal && !hasARPU) {
    guardrailEl.textContent = 'Forecast scenarios are configured. Add ARPU or startup planning assumptions to compute margin bands.';
    return;
  }

  guardrailEl.textContent = 'Quantify Business Value controls active: budgeting variance, forecast confidence band, and savings realization ledger are being updated live.';
}

function resetModel() {
  Object.assign(MODEL, MODEL_DEFAULTS);
  Object.keys(USER_PROVIDED).forEach(k => USER_PROVIDED[k] = false);
  selectedProviders.clear();
  document.querySelectorAll('.provider-btn.selected').forEach(btn => btn.classList.remove('selected'));
  lastInputs = {
    nRef: null, currency: DEFAULT_CURRENCY_CODE, devPerClient: null, infraTotal: null, ARPU: null,
    startupTargetPrice: null, startupTargetClients: null,
    effectiveARPU: null, arpuMode: 'missing',
    cudPct: null, margin: null, nMax: null,
    budgetMonthly: null, forecastGrowthPct: null, forecastBestEfficiencyPct: null, forecastWorstDriftPct: null,
    savingsIdentified: null, savingsRealized: null, costAvoidance: null,
    techDomains: [...DEFAULT_TECH_DOMAINS],
    costSaaS: null, costLicensing: null, costPrivateCloud: null, costDataCenter: null, costLabor: null,
    aiEnabled: false,
    aiPricingMode: 'blended',
    aiRatePer1MInput: null, aiRatePer1MOutput: null, aiRatePer1MTotal: null,
    aiInputTokensM: null, aiOutputTokensM: null,
    aiRetryRatePct: null, aiPremiumMixPct: null,
    aiSharedOverheadMonthly: null, aiAllocationPolicy: 'token-weighted',
    aiMetrics: null,
    reliabilityEnabled: false,
    sloTargetAvailabilityPct: null,
    sliObservedAvailabilityPct: null,
    incidentCountMonthly: null,
    mttrHours: null,
    incidentBlendedHourlyRate: null,
    criticalRevenuePerMinute: null,
    arrExposedMonthly: null,
    slaPenaltyRatePerBreachPointMonthly: null,
    reliabilityInvestmentMonthly: null,
    reliabilityMetrics: null
  };
  chartReliabilityInputs = lastInputs;
  const ids = [
    'inp-nRef','inp-currency','inp-devPerClient','inp-infraTotal','inp-ARPU',
    'inp-startupTargetPrice','inp-startupTargetClients',
    'inp-cudPct','inp-margin','inp-nMax',
    'inp-budgetMonthly','inp-forecastGrowthPct','inp-forecastBestEfficiencyPct','inp-forecastWorstDriftPct',
    'inp-savingsIdentified','inp-savingsRealized','inp-costAvoidance',
    'inp-techDomains','inp-costSaaS','inp-costLicensing','inp-costPrivateCloud','inp-costDataCenter','inp-costLabor',
    'inp-aiEnabled','inp-aiPricingMode','inp-aiRatePer1MInput','inp-aiRatePer1MOutput','inp-aiRatePer1MTotal',
    'inp-aiInputTokensM','inp-aiOutputTokensM','inp-aiRetryRatePct','inp-aiPremiumMixPct',
    'inp-aiSharedOverheadMonthly','inp-aiAllocationPolicy',
    'inp-reliabilityEnabled','inp-sloTargetAvailabilityPct','inp-sliObservedAvailabilityPct',
    'inp-incidentCountMonthly','inp-mttrHours','inp-incidentBlendedHourlyRate',
    'inp-criticalRevenuePerMinute','inp-arrExposedMonthly',
    'inp-slaPenaltyRatePerBreachPointMonthly','inp-reliabilityInvestmentMonthly'
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.type === 'hidden') {
        el.value = el.dataset.defaultValue || '';
      } else if (el.tagName === 'SELECT') {
        el.value = el.dataset.defaultValue || (el.options[0] ? el.options[0].value : '');
      } else {
        el.value = '';
      }
    }
    const field = el && el.closest('.calc-field, .startup-field');
    if (field) {
      field.classList.remove('has-value', 'invalid');
      const errorEl = field.querySelector('.calc-input-error');
      if (errorEl) errorEl.remove();
    }
    if (el) {
      el.removeAttribute('aria-invalid');
      if (typeof el.setCustomValidity === 'function') el.setCustomValidity('');
    }
  });
  for (let i = 0; i < ids.length; i++) {
    const p = document.getElementById('cp-' + i);
    if (p) p.classList.remove('filled');
  }
  refreshCurrencyUnits();
  const prog = document.getElementById('calc-progress');
  if (prog) prog.style.display = 'none';
  const dot  = document.getElementById('calc-dot');
  const text = document.getElementById('calc-status-text');
  if (dot)  dot.classList.remove('active');
  if (text) { text.classList.remove('active'); text.textContent = 'Enter values above to begin'; }

  // Restore original sub-texts and clear cards
  document.querySelectorAll('.calc-out-card').forEach(card => {
    card.classList.remove('live','live-warn','live-bad','needs-data');
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl && subEl.dataset.orig) subEl.textContent = subEl.dataset.orig;
    const valEl = card.querySelector('.calc-out-val');
    if (valEl) { valEl.textContent = '—'; valEl.className = 'calc-out-val muted'; }
  });
  setTechDomainSelection(DEFAULT_TECH_DOMAINS, false);
  draw();
  renderPortfolioSummary(buildNormalizationSnapshot(lastInputs));
  updateNormalizationGuardrail(buildNormalizationSnapshot(lastInputs));
  updateValueGuardrail({ hasAnyCostInput: false, hasARPU: false, hasBudget: false, hasForecastSignal: false, hasRealizationSignal: false });
  renderCfoForecastDashboard(null);
  updateHealthAndRecommendations(lastInputs);
  clearShareStateParam();
  writeShareFeedback('');
}

// ─── MCP MODAL LOGIC ────────────────────────────────────────────
function openMcpModal(triggerEl) {
  if (!mcpModalEl || !mcpModalDialogEl) return;
  lastMcpModalTrigger = triggerEl || document.activeElement;
  mcpModalEl.classList.add('is-open');
  mcpModalEl.setAttribute('aria-hidden', 'false');
  document.body.classList.add('modal-open');
  window.requestAnimationFrame(() => mcpModalDialogEl.focus());
}

function closeMcpModal() {
  if (!mcpModalEl || !mcpModalDialogEl) return;
  mcpModalEl.classList.remove('is-open');
  mcpModalEl.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('modal-open');
  if (lastMcpModalTrigger && typeof lastMcpModalTrigger.focus === 'function') {
    lastMcpModalTrigger.focus();
  }
}

function initMcpModal() {
  if (!mcpModalEl || !mcpModalDialogEl || !mcpModalOpeners.length) return;

  mcpModalOpeners.forEach(btn => {
    btn.addEventListener('click', () => openMcpModal(btn));
  });

  mcpModalEl.querySelectorAll('[data-mcp-close]').forEach(el => {
    el.addEventListener('click', closeMcpModal);
  });
}

// ─── CHART FOCUS MODE ─────────────────────────────────────────────
function fullscreenElement() {
  return document.fullscreenElement || document.webkitFullscreenElement || null;
}

function isChartInFocusMode() {
  const isFullscreen = chartSectionFocusEl && fullscreenElement() === chartSectionFocusEl;
  return !!isFullscreen || document.body.classList.contains('chart-focus-open');
}

function syncChartFocusButtonState(active) {
  if (!chartFocusToggleBtnEl) return;
  chartFocusToggleBtnEl.setAttribute('aria-pressed', active ? 'true' : 'false');
  chartFocusToggleBtnEl.setAttribute('aria-label', active ? 'Exit expanded chart view' : 'Expand chart view');
  if (chartFocusToggleTextEl) {
    chartFocusToggleTextEl.textContent = active ? 'Exit chart view' : 'Expand chart view';
  }
}

function openChartFocusMode(triggerEl) {
  if (!chartSectionFocusEl) return;
  lastChartFocusTrigger = triggerEl || document.activeElement;

  const openFallback = () => {
    document.body.classList.add('chart-focus-open');
    syncChartFocusButtonState(true);
    window.requestAnimationFrame(() => {
      draw();
      if (chartFocusCloseBtnEl) chartFocusCloseBtnEl.focus();
    });
  };

  const requestFullscreenFn = chartSectionFocusEl.requestFullscreen || chartSectionFocusEl.webkitRequestFullscreen;
  if (!requestFullscreenFn) {
    openFallback();
    return;
  }

  try {
    const maybePromise = requestFullscreenFn.call(chartSectionFocusEl);
    if (maybePromise && typeof maybePromise.then === 'function') {
      maybePromise
        .then(() => {
          syncChartFocusButtonState(true);
          window.requestAnimationFrame(draw);
        })
        .catch(openFallback);
    } else {
      syncChartFocusButtonState(true);
      window.requestAnimationFrame(draw);
    }
  } catch (_err) {
    openFallback();
  }
}

function closeChartFocusMode({ restoreFocus = true } = {}) {
  const activeFullscreen = chartSectionFocusEl && fullscreenElement() === chartSectionFocusEl;
  document.body.classList.remove('chart-focus-open');

  if (activeFullscreen) {
    restoreChartFocusOnExit = restoreFocus;
    const exitFullscreenFn = document.exitFullscreen || document.webkitExitFullscreen;
    if (exitFullscreenFn) {
      const maybePromise = exitFullscreenFn.call(document);
      if (maybePromise && typeof maybePromise.catch === 'function') {
        maybePromise.catch(() => {
          syncChartFocusButtonState(false);
          window.requestAnimationFrame(draw);
        });
      }
    }
    return;
  }

  syncChartFocusButtonState(false);
  window.requestAnimationFrame(draw);
  if (restoreFocus && lastChartFocusTrigger && typeof lastChartFocusTrigger.focus === 'function') {
    lastChartFocusTrigger.focus();
  }
}

function handleChartFocusFullscreenChange() {
  const active = chartSectionFocusEl && fullscreenElement() === chartSectionFocusEl;
  if (active) {
    document.body.classList.remove('chart-focus-open');
    syncChartFocusButtonState(true);
    window.requestAnimationFrame(() => {
      draw();
      if (chartFocusCloseBtnEl) chartFocusCloseBtnEl.focus();
    });
    return;
  }

  syncChartFocusButtonState(document.body.classList.contains('chart-focus-open'));
  window.requestAnimationFrame(draw);

  if (restoreChartFocusOnExit && lastChartFocusTrigger && typeof lastChartFocusTrigger.focus === 'function') {
    lastChartFocusTrigger.focus();
  }
  restoreChartFocusOnExit = false;
}

function initChartFocusMode() {
  if (!chartSectionFocusEl || !chartFocusToggleBtnEl || !chartFocusCloseBtnEl) return;
  syncChartFocusButtonState(false);

  chartFocusToggleBtnEl.addEventListener('click', () => {
    if (isChartInFocusMode()) closeChartFocusMode();
    else openChartFocusMode(chartFocusToggleBtnEl);
  });

  chartFocusCloseBtnEl.addEventListener('click', () => {
    closeChartFocusMode();
  });

  document.addEventListener('fullscreenchange', handleChartFocusFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleChartFocusFullscreenChange);

  document.addEventListener('click', (event) => {
    if (!document.body.classList.contains('chart-focus-open')) return;
    if (chartSectionFocusEl.contains(event.target) || chartFocusToggleBtnEl.contains(event.target)) return;
    closeChartFocusMode({ restoreFocus: false });
  });
}

// ─── CFO DASHBOARD FOCUS MODE ─────────────────────────────────────
function isQbvInFocusMode() {
  const isFullscreen = qbvDashboardEl && fullscreenElement() === qbvDashboardEl;
  return !!isFullscreen || document.body.classList.contains('cfo-focus-open');
}

function syncQbvFocusButtonState(active) {
  if (!qbvFocusToggleBtnEl) return;
  qbvFocusToggleBtnEl.setAttribute('aria-pressed', active ? 'true' : 'false');
  qbvFocusToggleBtnEl.setAttribute('aria-label', active ? 'Exit expanded CFO dashboard view' : 'Expand CFO dashboard view');
  if (qbvFocusToggleTextEl) qbvFocusToggleTextEl.textContent = active ? 'Exit dashboard view' : 'Expand dashboard';
}

function openQbvFocusMode(triggerEl) {
  if (!qbvDashboardEl) return;
  lastQbvFocusTrigger = triggerEl || document.activeElement;

  const openFallback = () => {
    document.body.classList.add('cfo-focus-open');
    syncQbvFocusButtonState(true);
    if (qbvFocusCloseBtnEl) window.requestAnimationFrame(() => qbvFocusCloseBtnEl.focus());
  };

  const requestFullscreenFn = qbvDashboardEl.requestFullscreen || qbvDashboardEl.webkitRequestFullscreen;
  if (!requestFullscreenFn) {
    openFallback();
    return;
  }

  try {
    const maybePromise = requestFullscreenFn.call(qbvDashboardEl);
    if (maybePromise && typeof maybePromise.then === 'function') {
      maybePromise
        .then(() => {
          syncQbvFocusButtonState(true);
          if (qbvFocusCloseBtnEl) window.requestAnimationFrame(() => qbvFocusCloseBtnEl.focus());
        })
        .catch(openFallback);
    } else {
      syncQbvFocusButtonState(true);
      if (qbvFocusCloseBtnEl) window.requestAnimationFrame(() => qbvFocusCloseBtnEl.focus());
    }
  } catch (_err) {
    openFallback();
  }
}

function closeQbvFocusMode({ restoreFocus = true } = {}) {
  const activeFullscreen = qbvDashboardEl && fullscreenElement() === qbvDashboardEl;
  document.body.classList.remove('cfo-focus-open');

  if (activeFullscreen) {
    restoreQbvFocusOnExit = restoreFocus;
    const exitFullscreenFn = document.exitFullscreen || document.webkitExitFullscreen;
    if (exitFullscreenFn) {
      const maybePromise = exitFullscreenFn.call(document);
      if (maybePromise && typeof maybePromise.catch === 'function') {
        maybePromise.catch(() => syncQbvFocusButtonState(false));
      }
    }
    return;
  }

  syncQbvFocusButtonState(false);
  if (restoreFocus && lastQbvFocusTrigger && typeof lastQbvFocusTrigger.focus === 'function') {
    lastQbvFocusTrigger.focus();
  }
}

function handleQbvFocusFullscreenChange() {
  const active = qbvDashboardEl && fullscreenElement() === qbvDashboardEl;
  if (active) {
    document.body.classList.remove('cfo-focus-open');
    syncQbvFocusButtonState(true);
    if (qbvFocusCloseBtnEl) window.requestAnimationFrame(() => qbvFocusCloseBtnEl.focus());
    return;
  }

  syncQbvFocusButtonState(document.body.classList.contains('cfo-focus-open'));
  if (restoreQbvFocusOnExit && lastQbvFocusTrigger && typeof lastQbvFocusTrigger.focus === 'function') {
    lastQbvFocusTrigger.focus();
  }
  restoreQbvFocusOnExit = false;
}

function initQbvFocusMode() {
  if (!qbvDashboardEl || !qbvFocusToggleBtnEl || !qbvFocusCloseBtnEl) return;
  syncQbvFocusButtonState(false);

  qbvFocusToggleBtnEl.addEventListener('click', () => {
    if (isQbvInFocusMode()) closeQbvFocusMode();
    else openQbvFocusMode(qbvFocusToggleBtnEl);
  });

  qbvFocusCloseBtnEl.addEventListener('click', () => {
    closeQbvFocusMode();
  });

  document.addEventListener('fullscreenchange', handleQbvFocusFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleQbvFocusFullscreenChange);

  document.addEventListener('click', (event) => {
    if (!document.body.classList.contains('cfo-focus-open')) return;
    if (qbvDashboardEl.contains(event.target) || qbvFocusToggleBtnEl.contains(event.target)) return;
    closeQbvFocusMode({ restoreFocus: false });
  });
}

// ─── FORMULA TOOLTIP LOGIC ───────────────────────────────────────
function closeFormulaCardTooltip(card) {
  if (!card) return;
  card.classList.remove('flip-down');
  card.classList.remove('active');
  card.setAttribute('aria-expanded', 'false');
  const tip = card.querySelector('.ftip');
  if (!tip) return;
  clearFormulaTooltipPlacement(card);
  tip.classList.remove('open');
  tip.setAttribute('aria-hidden', 'true');
}

function closeAllFormulaCardTooltips() {
  document.querySelectorAll('.formula-card.active').forEach(closeFormulaCardTooltip);
}

function toggleTip(card) {
  if (!card) return;
  const tip = card.querySelector('.ftip');
  if (!tip) return;

  const isOpen = card.classList.contains('active');
  closeAllFormulaCardTooltips();

  if (!isOpen) {
    card.classList.add('active');
    card.setAttribute('aria-expanded', 'true');
    tip.classList.add('open');
    tip.setAttribute('aria-hidden', 'false');
    tip.style.pointerEvents = 'none'; // keep clicks passing through
    positionFormulaTooltip(card);
  }
}

function initFormulaCardTooltips() {
  const cards = Array.from(document.querySelectorAll('.formula-card'));
  if (!cards.length) return;

  cards.forEach((card, idx) => {
    const tip = card.querySelector('.ftip');
    if (!tip) return;
    const tipId = tip.id || `formula-tip-${idx + 1}`;

    tip.id = tipId;
    tip.setAttribute('role', 'tooltip');
    tip.setAttribute('aria-hidden', card.classList.contains('active') ? 'false' : 'true');

    card.setAttribute('role', 'button');
    card.setAttribute('tabindex', '0');
    card.setAttribute('aria-controls', tipId);
    card.setAttribute('aria-expanded', card.classList.contains('active') ? 'true' : 'false');

    card.addEventListener('keydown', event => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      event.preventDefault();
      toggleTip(card);
    });
  });

  // Close tooltip when clicking outside
  document.addEventListener('click', event => {
    if (event.target.closest('.formula-card')) return;
    closeAllFormulaCardTooltips();
  });

  if (!formulaTooltipPositionListenersBound) {
    formulaTooltipPositionListenersBound = true;
    window.addEventListener('resize', syncActiveFormulaTooltipPlacement, { passive: true });
    window.addEventListener('scroll', syncActiveFormulaTooltipPlacement, { passive: true, capture: true });
  }
}

// Close tooltip on Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeOutputSolutionPanel();
    closeChartFocusMode();
    closeQbvFocusMode();
    closeMcpModal();
    closeAllOutputCardTooltips();
    closeAllFormulaCardTooltips();
  }
});

function initSectionNav() {
  const links = Array.from(document.querySelectorAll('[data-nav-link]'));
  if (!links.length) return;

  const items = links
    .map(link => {
      const href = link.getAttribute('href') || '';
      if (!href.startsWith('#')) return null;
      const target = document.querySelector(href);
      if (!target) return null;
      return { link, target };
    })
    .filter(Boolean);

  if (!items.length) return;

  function setActive(id) {
    items.forEach(({ link, target }) => {
      const active = target.id === id;
      link.classList.toggle('is-active', active);
      if (active) link.setAttribute('aria-current', 'page');
      else link.removeAttribute('aria-current');
    });
  }

  const hashTarget = window.location.hash ? window.location.hash.slice(1) : '';
  const initialId = items.some(({ target }) => target.id === hashTarget)
    ? hashTarget
    : items[0].target.id;
  setActive(initialId);

  if (typeof IntersectionObserver === 'undefined') return;

  const visible = new Map();
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) visible.set(entry.target.id, entry.intersectionRatio);
      else visible.delete(entry.target.id);
    });

    if (!visible.size) return;
    const top = Array.from(visible.entries()).sort((a, b) => b[1] - a[1])[0][0];
    setActive(top);
  }, {
    rootMargin: '-32% 0px -52% 0px',
    threshold: [0.2, 0.4, 0.6]
  });

  items.forEach(({ target }) => observer.observe(target));
}

const INFO_ICON_PATHS = Object.freeze({
  grid: '<rect x="2.5" y="2.5" width="11" height="11" rx="2"></rect><path d="M8 2.5v11M2.5 8h11"></path>',
  spark: '<path d="M8 1.8 9.8 6.2 14.2 8 9.8 9.8 8 14.2 6.2 9.8 1.8 8 6.2 6.2Z"></path>',
  users: '<path d="M5.6 7.4a2.2 2.2 0 1 0 0-4.4 2.2 2.2 0 0 0 0 4.4Zm4.9 1.8a1.8 1.8 0 1 0 0-3.6 1.8 1.8 0 0 0 0 3.6Z"></path><path d="M1.8 13c.4-1.8 1.8-2.8 3.8-2.8s3.4 1 3.8 2.8M8.6 13c.2-1.2 1.2-1.9 2.5-1.9 1.4 0 2.2.7 2.5 1.9"></path>',
  insights: '<path d="M2.5 13.2h11"></path><path d="M4.2 11V7.6M8 11V4.8M11.8 11V6.4"></path>',
  layers: '<path d="M8 2.2 13.5 5 8 7.8 2.5 5 8 2.2Z"></path><path d="M2.5 8 8 10.8 13.5 8M2.5 11 8 13.8 13.5 11"></path>',
  checklist: '<rect x="2.4" y="2.4" width="11.2" height="11.2" rx="2"></rect><path d="M5 5.5h5.5M5 8h5.5M5 10.5h3.6"></path><path d="M3.8 8.1 4.5 8.8 5.8 7.2"></path>',
  plug: '<path d="M6 2.3v3.3M10 2.3v3.3M4.8 5.6h6.4v1.1a3.2 3.2 0 0 1-2.7 3.2v2.8H7.5V9.9A3.2 3.2 0 0 1 4.8 6.7Z"></path>',
  toolbox: '<rect x="2.2" y="4.4" width="11.6" height="8.9" rx="2"></rect><path d="M6 4.4V3.3h4v1.1M2.2 8h11.6"></path>',
  briefcase: '<rect x="2.2" y="4.4" width="11.6" height="8.9" rx="2"></rect><path d="M6 4.4V3.1h4v1.3M2.2 8.1h11.6"></path>',
  roadmap: '<path d="M2.3 12.8V3.2h10.8l-2.1 2.4 2.1 2.4H5.1l-1.2 1.3h9.2"></path>',
  target: '<circle cx="8" cy="8" r="5.3"></circle><circle cx="8" cy="8" r="2.3"></circle><path d="M8 2.1v1.3M8 12.6v1.3M2.1 8h1.3M12.6 8h1.3"></path>',
  guide: '<path d="M3 3.1h4.8a2 2 0 0 1 2 2V13a2 2 0 0 0-2-2H3Z"></path><path d="M13 3.1H8.2a2 2 0 0 0-2 2"></path>',
  sliders: '<path d="M3 4.2h10M3 8h10M3 11.8h10"></path><circle cx="6" cy="4.2" r="1"></circle><circle cx="10" cy="8" r="1"></circle><circle cx="7.5" cy="11.8" r="1"></circle>',
  gauge: '<path d="M3 10a5 5 0 1 1 10 0"></path><path d="M8 8 10.6 6.2"></path>',
  shield: '<path d="M8 2.2 12.8 4v3.8c0 2.8-1.7 4.8-4.8 6-3.1-1.2-4.8-3.2-4.8-6V4Z"></path><path d="m6 8.1 1.3 1.3L10.3 6.4"></path>',
  coin: '<ellipse cx="8" cy="4.7" rx="4.2" ry="2.2"></ellipse><path d="M3.8 4.7v5.6c0 1.2 1.9 2.2 4.2 2.2s4.2-1 4.2-2.2V4.7"></path>',
  chart: '<path d="M2.4 12.8h11.2"></path><path d="M4.2 10.9 6.8 8.4l2.2 1.8 2.8-3"></path><circle cx="6.8" cy="8.4" r="0.8"></circle><circle cx="9" cy="10.2" r="0.8"></circle><circle cx="11.8" cy="7.2" r="0.8"></circle>'
});

function createInfoIconBadge(iconKey, tone) {
  const badge = document.createElement('span');
  badge.className = `info-icon-badge ${tone}`;
  badge.setAttribute('aria-hidden', 'true');

  const paths = INFO_ICON_PATHS[iconKey] || INFO_ICON_PATHS.grid;
  badge.innerHTML = `<svg class="info-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`;

  return badge;
}

function applyInformationIcons() {
  const iconMap = [
    ['.landing-card:nth-child(1) .landing-card-title', 'grid', 'blue'],
    ['.landing-card:nth-child(2) .landing-card-title', 'spark', 'green'],
    ['.landing-card:nth-child(3) .landing-card-title', 'users', 'amber'],

    ['#finops2026-title', 'insights', 'green'],
    ['.finops-2026-report-card:nth-child(1) h3', 'insights', 'blue'],
    ['.finops-2026-report-card:nth-child(2) h3', 'layers', 'green'],
    ['.finops-2026-report-card:nth-child(3) h3', 'checklist', 'amber'],

    ['#about-title', 'users', 'purple'],
    ['#cta-band-title', 'target', 'amber'],

    ['#mcp-section-title', 'plug', 'blue'],
    ['#roadmap-section-title', 'roadmap', 'green'],
    ['#model-assurance-title', 'shield', 'purple'],
    ['#mcp-section .mcp-card:nth-child(1) h3', 'toolbox', 'blue'],
    ['#mcp-section .mcp-card:nth-child(2) h3', 'plug', 'green'],
    ['#mcp-section .mcp-card:nth-child(3) h3', 'briefcase', 'amber'],
    ['#roadmap-section .mcp-card:nth-child(1) h3', 'insights', 'blue'],
    ['#roadmap-section .mcp-card:nth-child(2) h3', 'target', 'amber'],
    ['#roadmap-section .mcp-card:nth-child(3) h3', 'guide', 'green'],
    ['#model-assurance-section .mcp-card:nth-child(1) h3', 'checklist', 'blue'],
    ['#model-assurance-section .mcp-card:nth-child(2) h3', 'target', 'green'],
    ['#model-assurance-section .mcp-card:nth-child(3) h3', 'guide', 'amber'],

    ['#calculator-section .calc-body .calc-group:nth-child(1) .calc-group-label', 'chart', 'blue'],
    ['#calculator-section .calc-body .calc-group:nth-child(2) .calc-group-label', 'sliders', 'amber'],
    ['#calculator-section .calc-body .calc-group:nth-child(3) .calc-group-label', 'insights', 'green'],
    ['#calculator-section .calc-body .calc-group:nth-child(4) .calc-group-label', 'layers', 'purple'],
    ['#group-health .calc-group-label', 'shield', 'red'],

    ['#out-beN .calc-out-label', 'chart', 'blue'],
    ['#out-minPrice .calc-out-label', 'coin', 'amber'],
    ['#out-vcpu .calc-out-label', 'layers', 'purple'],
    ['#out-margin .calc-out-label', 'gauge', 'green'],
    ['#out-ccer .calc-out-label', 'target', 'blue'],
    ['#out-cudSave .calc-out-label', 'coin', 'green'],
    ['#out-reqClients .calc-out-label', 'users', 'purple'],
    ['#out-reqPrice .calc-out-label', 'coin', 'amber'],
    ['#out-targetRevenue .calc-out-label', 'chart', 'blue'],
    ['#out-budgetVariance .calc-out-label', 'target', 'blue'],
    ['#out-forecastBand .calc-out-label', 'chart', 'green'],
    ['#out-forecastSpread .calc-out-label', 'layers', 'blue'],
    ['#out-realizedValue .calc-out-label', 'coin', 'green'],
    ['#out-realizationRatio .calc-out-label', 'gauge', 'green'],
    ['#out-realizationGap .calc-out-label', 'target', 'amber'],
    ['#out-techCoverage .calc-out-label', 'grid', 'green'],
    ['#out-techNorm .calc-out-label', 'layers', 'green'],
    ['#out-focusMaturity .calc-out-label', 'shield', 'green'],

    ['.mcp-modal-card:nth-child(1) h4', 'toolbox', 'blue'],
    ['.mcp-modal-card:nth-child(2) h4', 'plug', 'green'],
    ['.mcp-modal-card:nth-child(3) h4', 'layers', 'purple'],
    ['.mcp-modal-card:nth-child(4) h4', 'guide', 'amber']
  ];

  iconMap.forEach(([selector, iconKey, tone]) => {
    document.querySelectorAll(selector).forEach((el) => {
      if (el.dataset.iconized === '1') return;

      const badge = createInfoIconBadge(iconKey, tone);
      if (el.classList.contains('calc-out-label')) {
        el.classList.add('with-icon');
      } else {
        el.classList.add('iconized-heading');
      }

      el.prepend(badge);
      el.dataset.iconized = '1';
    });
  });
}

function initInlineHelpHints() {
  const hints = Array.from(document.querySelectorAll('.calc-inline-help--hint[data-help]'));
  if (!hints.length || window.__inlineHelpHintsInitialized) return;
  const popover = document.createElement('div');
  popover.id = 'calc-inline-help-popover';
  popover.className = 'calc-inline-help-popover';
  popover.setAttribute('role', 'tooltip');
  popover.setAttribute('aria-hidden', 'true');
  document.body.appendChild(popover);

  hints.forEach((el) => {
    el.setAttribute('aria-haspopup', 'true');
    el.setAttribute('aria-controls', popover.id);
    el.setAttribute('aria-expanded', 'false');
  });

  let activeHint = null;

  const placePopover = (el) => {
    if (!el) return;
    const helpText = el.getAttribute('data-help') || '';
    popover.textContent = helpText;
    popover.classList.add('is-open');
    popover.dataset.placement = 'top';

    const rect = el.getBoundingClientRect();
    const tipRect = popover.getBoundingClientRect();
    const margin = 10;
    let left = rect.left + (rect.width / 2);
    let top = rect.top - 10;
    let placement = 'top';

    if ((top - tipRect.height) < margin) {
      placement = 'bottom';
      top = rect.bottom + 10;
    }

    const minLeft = margin + (tipRect.width / 2);
    const maxLeft = window.innerWidth - margin - (tipRect.width / 2);
    left = Math.min(maxLeft, Math.max(minLeft, left));

    popover.style.left = `${left}px`;
    popover.style.top = `${top}px`;
    popover.dataset.placement = placement;
  };

  const closeAll = () => {
    popover.classList.remove('is-open');
    popover.setAttribute('aria-hidden', 'true');
    hints.forEach((el) => {
      el.classList.remove('is-open');
      el.setAttribute('aria-expanded', 'false');
    });
    activeHint = null;
  };

  const showHint = (el, toggle = false) => {
    if (!el) return;
    const alreadyOpen = activeHint === el && popover.classList.contains('is-open');
    if (toggle && alreadyOpen) {
      closeAll();
      return;
    }
    hints.forEach((node) => {
      if (node !== el) {
        node.classList.remove('is-open');
        node.setAttribute('aria-expanded', 'false');
      }
    });
    el.classList.add('is-open');
    el.setAttribute('aria-expanded', 'true');
    activeHint = el;
    placePopover(el);
    popover.setAttribute('aria-hidden', 'false');
  };

  hints.forEach((el) => {
    el.addEventListener('mouseenter', () => showHint(el));
    el.addEventListener('focus', () => showHint(el));
    el.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      showHint(el, true);
    });

    el.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        showHint(el, true);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        closeAll();
        el.blur();
      }
    });
  });

  document.addEventListener('click', closeAll);
  document.addEventListener('focusin', (event) => {
    if (!event.target.closest('.calc-inline-help--hint[data-help]')) {
      closeAll();
    }
  });
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') closeAll();
  });
  window.addEventListener('resize', () => {
    if (activeHint) placePopover(activeHint);
  });
  window.addEventListener('scroll', () => {
    if (activeHint) placePopover(activeHint);
  }, true);

  window.__inlineHelpHintsInitialized = true;
}

function formatPageMetaDate(isoString) {
  const d = new Date(isoString);
  if (!Number.isFinite(d.getTime())) return null;
  const base = new Intl.DateTimeFormat('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
    timeZone: 'UTC'
  }).format(d);
  return `${base} (UTC)`;
}

function buildVersionIdFromCommit(isoString, sha) {
  const d = new Date(isoString);
  if (!Number.isFinite(d.getTime())) return null;
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(d.getUTCDate()).padStart(2, '0');
  const shortSha = typeof sha === 'string' && sha.length >= 7 ? sha.slice(0, 7) : 'unknown';
  return `gh-${yyyy}.${mm}.${dd}-${shortSha}`;
}

function resolvePageMetaSource() {
  const host = String(window.location.hostname || '').toLowerCase();
  const pathname = String(window.location.pathname || '/').replace(/^\/+/, '') || 'index.html';

  if (host === 'duksh.github.io' || host.endsWith('.github.io')) {
    return { owner: 'duksh', repo: 'duksh.github.io', path: pathname };
  }

  return { owner: 'duksh', repo: 'finops-calculator', path: 'index.html' };
}

async function updatePageMetadataFromGitHub() {
  const timeEl = document.getElementById('page-last-updated');
  const versionEl = document.getElementById('page-version-id');
  if (!timeEl || !versionEl) return;

  const applyFallback = () => {
    const fallbackDate = new Date(document.lastModified);
    if (!Number.isFinite(fallbackDate.getTime())) return;
    const iso = fallbackDate.toISOString();
    const formatted = formatPageMetaDate(iso);
    const fallbackVersion = buildVersionIdFromCommit(iso, 'local');
    if (formatted) {
      timeEl.textContent = formatted;
      timeEl.setAttribute('datetime', iso);
    }
    if (fallbackVersion) versionEl.textContent = fallbackVersion;
  };

  try {
    const source = resolvePageMetaSource();
    const apiUrl = `https://api.github.com/repos/${source.owner}/${source.repo}/commits?path=${encodeURIComponent(source.path)}&per_page=1&page=1`;
    const res = await fetch(apiUrl, {
      headers: {
        'Accept': 'application/vnd.github+json'
      }
    });
    if (!res.ok) throw new Error(`GitHub commit lookup failed: ${res.status}`);
    const data = await res.json();
    const latest = Array.isArray(data) ? data[0] : null;
    const iso = latest?.commit?.committer?.date;
    const sha = latest?.sha;
    const formatted = formatPageMetaDate(iso);
    const versionId = buildVersionIdFromCommit(iso, sha);

    if (!formatted || !versionId) {
      applyFallback();
      return;
    }

    timeEl.textContent = formatted;
    timeEl.setAttribute('datetime', iso);
    versionEl.textContent = versionId;
  } catch (err) {
    applyFallback();
  }
}

initOutputCardTooltips();
initFormulaCardTooltips();
bindMissingDataCtaHandler();
cacheSubTexts();
refreshCurrencyUnits();
applyInformationIcons();
initInlineHelpHints();
applyGlossaryAutoLinks();
bindGlossaryHoverTooltips();
preloadGlossaryDefinitions();
updatePageMetadataFromGitHub();
setTechDomainSelection(DEFAULT_TECH_DOMAINS, false);
initRecommendationCategoryFilters();
setUiIntent(getStoredUiIntent(), { recalcAfter: false, syncMode: true, persist: false, syncRecommendations: true });
initRelease4ReliabilityDiscovery();
initCfoDashboardExport();
initQbvFocusMode();
initMcpModal();
initChartFocusMode();
initSectionNav();
renderCfoForecastDashboard(null);
if (!loadSharedStateFromUrl()) {
  updateHealthAndRecommendations(lastInputs);
}
initFeatureRuntime();
</script>
</body>
</html>
