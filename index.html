<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Economics Framework — FinOps DBA Research</title>
<meta name="description" content="Interactive FinOps and cloud economics calculator to estimate break-even clients, pricing floor, CCER posture, and optimization recommendations before scaling.">
<link rel="canonical" href="https://duksh.github.io/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Cloud Economics Framework">
<meta property="og:title" content="FinOps & Cloud Economics Calculator">
<meta property="og:description" content="Quantify break-even, minimum viable pricing, CCER, and cloud efficiency with a live FinOps calculator and visualization.">
<meta property="og:url" content="https://duksh.github.io/">
<meta property="og:image" content="https://duksh.github.io/github-finops-cal-image-01.jpg">
<meta property="og:image:width" content="1280">
<meta property="og:image:height" content="640">
<meta property="og:image:alt" content="Preview card for the FinOps and Cloud Economics calculator with model outputs and charts.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="FinOps & Cloud Economics Calculator">
<meta name="twitter:description" content="Interactive model for break-even, pricing floor, CCER, and FinOps recommendations.">
<meta name="twitter:image" content="https://duksh.github.io/github-finops-cal-image-01.jpg">
<meta name="twitter:image:alt" content="Preview card for the FinOps and Cloud Economics calculator.">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z2K1ZEDJV2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-Z2K1ZEDJV2');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ─── RESET & TOKENS ────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #f5f7fc;
  --surface:   #ffffff;
  --border:    #d6deeb;
  --text:      #1b2136;
  --muted:     #5f6b84;
  --light:     #eef3fb;

  --accent-blue: #0072b2;
  --accent-cyan: #00a5c8;
  --accent-green: #009e73;
  --accent-amber: #e69f00;
  --accent-rose: #d55e00;

  /* Okabe-Ito colorblind-safe */
  --dev:       #d55e00;
  --infra-raw: #009e73;
  --infra-cud: #009e73;
  --total:     #444444;
  --revenue:   #0072b2;
  --profit:    #7b2d8b;
  --price-min: #555555;

  --page-pad-x: clamp(10px, 3vw, 24px);
  --page-pad-y: clamp(12px, 3vw, 40px);
  --sticky-nav-h: 54px;
  --radius: 8px;
  --shadow: 0 2px 16px rgba(0,0,0,0.07);
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
  scroll-padding-top: calc(var(--sticky-nav-h) + 18px);
}

body {
  background:
    radial-gradient(circle at 10% 0%, rgba(86,180,233,0.14) 0%, rgba(86,180,233,0) 28%),
    radial-gradient(circle at 92% 18%, rgba(0,158,115,0.12) 0%, rgba(0,158,115,0) 30%),
    radial-gradient(circle at 80% 92%, rgba(230,159,0,0.12) 0%, rgba(230,159,0,0) 28%),
    linear-gradient(180deg, #f7fbff 0%, var(--bg) 38%, #fff8ef 100%);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  line-height: 1.5;
  padding: calc(var(--page-pad-y) + var(--sticky-nav-h) + 8px) var(--page-pad-x) 48px;
}
body.modal-open { overflow: hidden; }

button:focus-visible,
a:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}

.skip-link {
  position: fixed;
  top: 8px;
  left: var(--page-pad-x);
  z-index: 120;
  transform: translateY(-140%);
  background: #0e3358;
  color: #fff;
  text-decoration: none;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  transition: transform 0.18s ease;
}
.skip-link:focus-visible {
  transform: translateY(0);
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}

.sticky-top-nav {
  position: fixed;
  top: max(8px, env(safe-area-inset-top));
  left: var(--page-pad-x);
  right: var(--page-pad-x);
  z-index: 110;
}
.sticky-top-nav-inner {
  max-width: 1200px;
  margin: 0 auto;
  min-height: var(--sticky-nav-h);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border: 1px solid rgba(22, 36, 64, 0.2);
  border-radius: 12px;
  background: linear-gradient(120deg, rgba(255,255,255,0.94) 0%, rgba(241,250,255,0.9) 48%, rgba(244,255,249,0.9) 100%);
  backdrop-filter: blur(7px);
  box-shadow: 0 10px 24px rgba(18, 30, 55, 0.16);
}
.sticky-top-brand {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  border-radius: 999px;
  padding: 4px 7px;
  flex-shrink: 0;
  transition: background 0.18s ease;
}
.sticky-top-brand:hover { background: rgba(0, 114, 178, 0.08); }
.sticky-top-brand:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.sticky-top-logo {
  width: 24px;
  height: 24px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  background: linear-gradient(135deg, #0072b2 0%, #009e73 100%);
  box-shadow: 0 2px 6px rgba(0, 84, 128, 0.35);
}
.sticky-top-logo svg {
  width: 14px;
  height: 14px;
}
.sticky-top-brand-text {
  flex-shrink: 0;
  font-size: 10.5px;
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #27425c;
}
.sticky-top-nav-list {
  list-style: none;
  display: flex;
  align-items: center;
  gap: 6px;
  overflow-x: auto;
  padding: 1px;
  margin: 0;
  scrollbar-width: none;
}
.sticky-top-nav-list::-webkit-scrollbar { display: none; }
.sticky-top-nav-link {
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  text-decoration: none;
  font-size: 11px;
  font-weight: 600;
  color: #33405b;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 6px 11px;
  transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
}
.sticky-top-nav-link:hover {
  background: rgba(0, 114, 178, 0.08);
  color: #005b90;
}
.sticky-top-nav-link.is-active,
.sticky-top-nav-link[aria-current='page'] {
  border-color: rgba(0, 114, 178, 0.35);
  background: rgba(0, 114, 178, 0.12);
  color: #00507d;
}
.sticky-top-nav-link:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
@media (max-width: 780px) {
  .sticky-top-brand-text { display: none; }
  .sticky-top-nav-inner { padding: 7px 8px; }
}

.section-anchor { scroll-margin-top: calc(var(--sticky-nav-h) + 22px); }

/* ─── PAPER ─────────────────────────────────────────────────────── */
.paper {
  max-width: 1200px;
  margin: 0 auto;
  background: linear-gradient(180deg, #ffffff 0%, #fcfdff 100%);
  border: 1px solid rgba(17, 38, 74, 0.12);
  border-radius: 12px;
  box-shadow: 0 24px 54px rgba(19, 37, 68, 0.14);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}
.paper::before {
  content: '';
  position: absolute;
  inset: 0 0 auto 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-cyan) 30%, var(--accent-green) 62%, var(--accent-amber) 100%);
  z-index: 1;
  pointer-events: none;
}

/* ─── LANDING FLOW ORDER ────────────────────────────────────────── */
.paper > .landing-intro { order: 1; }
.paper > .credibility-section { order: 2; }
.paper > .cta-band { order: 3; }
.paper > .mcp-section { order: 4; }
.paper > .calc-section { order: 5; }
.paper > .fig-header { order: 6; }
.paper > .controls { order: 7; }
.paper > .chart-section { order: 8; }
.paper > .zones-strip { order: 9; }
.paper > .formulas-section { order: 10; }
.paper > .fig-footer { order: 11; }

/* ─── LANDING INTRO ─────────────────────────────────────────────── */
.landing-intro {
  position: relative;
  overflow: hidden;
  padding: clamp(20px, 4vw, 40px) clamp(16px, 4vw, 36px);
  background:
    radial-gradient(circle at 88% 8%, rgba(0,114,178,0.22) 0%, transparent 40%),
    radial-gradient(circle at 8% 88%, rgba(0,158,115,0.22) 0%, transparent 38%),
    linear-gradient(135deg, #eef7ff 0%, #f3fbf7 45%, #fff4ea 100%);
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
}
.landing-intro::before,
.landing-intro::after {
  content: '';
  position: absolute;
  border-radius: 999px;
  pointer-events: none;
}
.landing-intro::before {
  width: 220px;
  height: 220px;
  top: -95px;
  right: -70px;
  background: radial-gradient(circle, rgba(66,133,244,0.28) 0%, rgba(66,133,244,0) 70%);
}
.landing-intro::after {
  width: 210px;
  height: 210px;
  bottom: -110px;
  left: -90px;
  background: radial-gradient(circle, rgba(52,168,83,0.22) 0%, rgba(52,168,83,0) 72%);
}
.landing-kicker {
  display: inline-flex;
  align-items: center;
  border: 1px solid rgba(0,114,178,0.28);
  border-radius: 999px;
  padding: 5px 10px;
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(3px);
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1.1vw, 10px);
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #0072b2;
  margin-bottom: 10px;
}
.landing-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(24px, 4vw, 42px);
  line-height: 1.12;
  font-weight: 400;
  color: #171b33;
  text-wrap: balance;
  max-width: 900px;
}
.landing-subtitle {
  margin-top: 10px;
  max-width: 880px;
  font-size: clamp(12px, 1.4vw, 15px);
  color: #3f4658;
  line-height: 1.65;
}
.landing-grid {
  margin-top: clamp(16px, 2.8vw, 26px);
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}
@media (max-width: 900px) {
  .landing-grid { grid-template-columns: 1fr; }
}
.landing-card {
  position: relative;
  border: 1px solid rgba(28, 39, 72, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(2px);
  box-shadow: 0 8px 22px rgba(20, 33, 58, 0.07);
  padding: 13px 14px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.landing-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(20, 33, 58, 0.12);
}
.landing-card::before {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 3px;
  border-radius: 10px 10px 0 0;
}
.landing-card:nth-child(1) {
  background: linear-gradient(180deg, rgba(0,114,178,0.08) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(1)::before {
  background: linear-gradient(90deg, #0072b2, #56b4e9);
}
.landing-card:nth-child(2) {
  background: linear-gradient(180deg, rgba(0,158,115,0.08) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(2)::before {
  background: linear-gradient(90deg, #009e73, #34a853);
}
.landing-card:nth-child(3) {
  background: linear-gradient(180deg, rgba(230,159,0,0.1) 0%, rgba(255,255,255,0.9) 58%);
}
.landing-card:nth-child(3)::before {
  background: linear-gradient(90deg, #e69f00, #ff8f1f);
}
.landing-card-title {
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: #1f2a49;
  margin-bottom: 8px;
}
.landing-card:nth-child(1) .landing-card-title { color: #005a8f; }
.landing-card:nth-child(2) .landing-card-title { color: #0f7358; }
.landing-card:nth-child(3) .landing-card-title { color: #8f5f00; }
.landing-card-list {
  list-style: none;
  display: grid;
  gap: 7px;
}
.landing-card-list li {
  position: relative;
  padding-left: 14px;
  font-size: 12px;
  color: #44495a;
  line-height: 1.55;
}
.landing-card-list li::before {
  content: '•';
  position: absolute;
  left: 0;
  color: #009e73;
  font-weight: 700;
}
.landing-card:nth-child(1) .landing-card-list li::before { color: #0072b2; }
.landing-card:nth-child(3) .landing-card-list li::before { color: #e69f00; }
.landing-card-link {
  margin-top: 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  padding: 5px 10px;
  border: 1px solid rgba(0,114,178,0.28);
  background: rgba(255,255,255,0.86);
  color: #005a8f;
  transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease;
}
.landing-card-link:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
  filter: brightness(1.02);
}
.landing-card-link.features {
  border-color: rgba(0,158,115,0.34);
  color: #0f7358;
}
.landing-card-link.users {
  border-color: rgba(230,159,0,0.4);
  color: #8f5f00;
}

/* ─── CREDIBILITY SECTION ───────────────────────────────────────── */
.credibility-section {
  position: relative;
  isolation: isolate;
  padding: clamp(18px, 3.2vw, 30px) clamp(16px, 4vw, 36px);
  border-bottom: 1px solid var(--border);
  background:
    radial-gradient(circle at 80% 18%, rgba(0,114,178,0.14) 0%, rgba(0,114,178,0) 36%),
    radial-gradient(circle at 14% 82%, rgba(0,158,115,0.12) 0%, rgba(0,158,115,0) 34%),
    linear-gradient(145deg, #f9fcff 0%, #edf5ff 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 14px;
}
.credibility-section::before {
  content: "";
  position: absolute;
  inset: 10px clamp(12px, 3vw, 20px);
  border-radius: 18px;
  border: 1px solid rgba(24, 41, 70, 0.1);
  background: rgba(255,255,255,0.55);
  z-index: -1;
}
.cred-avatar {
  width: 118px;
  height: 118px;
  border-radius: 22px;
  overflow: hidden;
  border: 3px solid rgba(255,255,255,0.92);
  box-shadow: 0 12px 28px rgba(0, 114, 178, 0.28);
  background: #fff;
}
.cred-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.cred-content {
  max-width: 950px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid rgba(24, 41, 70, 0.14);
  border-radius: 16px;
  background: rgba(255,255,255,0.88);
  box-shadow: 0 14px 28px rgba(17, 35, 66, 0.08);
  padding: clamp(12px, 2.8vw, 24px);
}
.cred-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: #005f95;
  margin-bottom: 4px;
}
.cred-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(22px, 2.7vw, 38px);
  line-height: 1.18;
  color: #18223d;
  max-width: 26ch;
  text-wrap: balance;
}
.cred-text {
  margin-top: 10px;
  font-size: clamp(16px, 1.55vw, 29px);
  line-height: 1.58;
  color: #2f3a52;
  max-width: 72ch;
}
.cred-links {
  margin-top: 14px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}
.cred-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 999px;
  border: 1px solid rgba(0,114,178,0.2);
  padding: 9px 16px;
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  text-decoration: none;
  background: linear-gradient(90deg, #0072b2, #009e73);
  box-shadow: 0 6px 14px rgba(0,114,178,0.25);
}
.cred-link:hover { filter: brightness(1.04); }
.cred-link:focus-visible {
  outline: 3px solid rgba(0,114,178,0.34);
  outline-offset: 2px;
}

/* ─── CTA BAND ──────────────────────────────────────────────────── */
.cta-band {
  padding: 14px clamp(16px, 4vw, 36px) 20px;
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
  background:
    radial-gradient(circle at 88% 14%, rgba(0,114,178,0.24) 0%, rgba(0,114,178,0) 36%),
    radial-gradient(circle at 14% 80%, rgba(0,158,115,0.2) 0%, rgba(0,158,115,0) 38%),
    linear-gradient(145deg, #fff9ef 0%, #edf9ff 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.cta-shell {
  width: min(980px, 100%);
  border: 1px solid rgba(24, 41, 70, 0.16);
  border-radius: 18px;
  background: rgba(255,255,255,0.82);
  box-shadow: 0 14px 30px rgba(17, 35, 66, 0.1);
  padding: clamp(14px, 3vw, 24px);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.cta-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(21px, 2.2vw, 32px);
  line-height: 1.2;
  color: #18213a;
  text-align: center;
}
.cta-sub {
  max-width: 66ch;
  text-align: center;
  color: #364464;
  font-size: clamp(14px, 1.35vw, 18px);
  line-height: 1.52;
}
.cta-actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
}
.cta-btn {
  border: none;
  border-radius: 999px;
  background: linear-gradient(92deg, var(--accent-blue) 0%, var(--accent-cyan) 45%, var(--accent-green) 100%);
  color: #fff;
  min-height: 48px;
  padding: 12px 22px;
  font-size: 17px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  box-shadow: 0 10px 22px rgba(0,114,178,0.3);
  transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
}
.cta-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(0,114,178,0.34);
  filter: brightness(1.03);
}
.cta-btn:focus-visible {
  outline: 3px solid rgba(0,114,178,0.34);
  outline-offset: 3px;
}
.cta-btn.cta-btn-secondary {
  background: rgba(255,255,255,0.98);
  border: 1px solid rgba(0,114,178,0.28);
  color: #004f7c;
  box-shadow: 0 7px 18px rgba(24, 41, 70, 0.12);
}
.cta-note {
  font-size: clamp(14px, 1.2vw, 16px);
  color: #2f3d58;
  text-align: center;
  max-width: 70ch;
  border-radius: 12px;
  border: 1px dashed rgba(0,114,178,0.26);
  background: rgba(250,252,255,0.85);
  padding: 9px 12px;
}

@media (max-width: 640px) {
  .cred-title { font-size: clamp(22px, 6.2vw, 30px); }
  .cred-text {
    font-size: clamp(15px, 4.2vw, 17px);
    line-height: 1.55;
  }
  .cta-btn {
    width: 100%;
    justify-content: center;
    font-size: 16px;
  }
  .cta-actions {
    width: 100%;
  }
}

/* ─── MCP SECTION ──────────────────────────────────────────────── */
.mcp-section {
  border-bottom: 1px solid rgba(30, 59, 105, 0.12);
  padding: clamp(16px, 3vw, 28px) clamp(16px, 4vw, 36px);
  background:
    radial-gradient(circle at 10% 15%, rgba(86,180,233,0.2) 0%, rgba(86,180,233,0) 40%),
    radial-gradient(circle at 92% 22%, rgba(0,158,115,0.12) 0%, rgba(0,158,115,0) 35%),
    linear-gradient(145deg, #f5fbff 0%, #f0fff8 52%, #fff8eb 100%);
}
.mcp-shell {
  border: 1px solid rgba(24, 41, 71, 0.14);
  border-radius: 14px;
  background: rgba(255,255,255,0.9);
  box-shadow: 0 16px 34px rgba(17, 35, 66, 0.1);
  padding: clamp(14px, 2.5vw, 24px);
}
.mcp-head {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
}
.mcp-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #0f6789;
}
.mcp-title {
  margin-top: 6px;
  font-family: 'Source Serif 4', serif;
  font-size: clamp(19px, 2.6vw, 30px);
  font-weight: 400;
  line-height: 1.18;
  color: #16213e;
}
.mcp-subtitle {
  margin-top: 8px;
  color: #445067;
  font-size: clamp(12px, 1.5vw, 14px);
  line-height: 1.62;
  max-width: 760px;
}
.mcp-head-actions {
  display: inline-flex;
  gap: 8px;
  flex-wrap: wrap;
}
.mcp-chip-btn {
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: #005a8f;
  font-size: 11px;
  font-weight: 600;
  padding: 7px 12px;
  cursor: pointer;
}
.mcp-chip-btn:hover { background: rgba(0,114,178,0.08); }
.mcp-chip-link {
  border: 1px solid rgba(0,158,115,0.35);
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: #0f7358;
  font-size: 11px;
  font-weight: 600;
  padding: 7px 12px;
  text-decoration: none;
}
.mcp-chip-link:hover { background: rgba(0,158,115,0.08); }
.mcp-grid {
  margin-top: 14px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 920px) {
  .mcp-grid { grid-template-columns: 1fr; }
}
.mcp-card {
  border: 1px solid rgba(25, 40, 68, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.96);
  padding: 12px 13px;
}
.mcp-card h3 {
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: #1e3458;
  margin-bottom: 7px;
}
.mcp-list {
  list-style: none;
  display: grid;
  gap: 7px;
}
.mcp-list li {
  font-size: 12px;
  color: #42506a;
  line-height: 1.5;
}
.mcp-list code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.16);
  border-radius: 5px;
  padding: 1px 5px;
}

/* ─── MCP MODAL ─────────────────────────────────────────────────── */
.mcp-modal {
  position: fixed;
  inset: 0;
  z-index: 170;
  display: none;
}
.mcp-modal.is-open { display: block; }
.mcp-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(13, 25, 45, 0.58);
  backdrop-filter: blur(3px);
}
.mcp-modal-dialog {
  position: relative;
  max-width: min(820px, calc(100vw - 28px));
  margin: clamp(16px, 5vh, 52px) auto;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(160deg, #ffffff 0%, #f8fbff 60%, #f6fff9 100%);
  box-shadow: 0 30px 60px rgba(8, 21, 44, 0.35);
  padding: clamp(16px, 2.6vw, 24px);
  max-height: calc(100vh - 28px);
  overflow: auto;
}
.mcp-modal-dialog:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.mcp-modal-close {
  position: sticky;
  top: 0;
  float: right;
  border: 1px solid rgba(20, 39, 68, 0.16);
  border-radius: 999px;
  width: 30px;
  height: 30px;
  background: #fff;
  color: #2c3954;
  cursor: pointer;
  font-size: 19px;
  line-height: 1;
}
.mcp-modal-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(20px, 3vw, 30px);
  font-weight: 400;
  line-height: 1.2;
  color: #17223f;
  margin-bottom: 6px;
}
.mcp-modal-subtitle {
  font-size: 13px;
  color: #45516a;
  line-height: 1.65;
  margin-bottom: 14px;
}
.mcp-modal-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 740px) {
  .mcp-modal-grid { grid-template-columns: 1fr; }
}
.mcp-modal-card {
  border: 1px solid rgba(22, 38, 67, 0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.96);
  padding: 11px 12px;
}
.mcp-modal-card h4 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: #1e3458;
  margin-bottom: 6px;
}
.mcp-modal-card ul {
  list-style: none;
  display: grid;
  gap: 6px;
}
.mcp-modal-card li {
  font-size: 12px;
  color: #43506b;
  line-height: 1.55;
}
.mcp-modal-card code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.15);
  border-radius: 5px;
  padding: 1px 4px;
}

/* ─── FIGURE HEADER ─────────────────────────────────────────────── */
.fig-header {
  padding: clamp(16px, 3vw, 28px) clamp(16px, 4vw, 36px) clamp(14px, 2vw, 20px);
  border-top: 1px solid rgba(30, 59, 105, 0.1);
  border-bottom: 1px solid rgba(30, 59, 105, 0.1);
  background:
    linear-gradient(180deg, rgba(0,114,178,0.05) 0%, rgba(255,255,255,0.9) 100%);
}
.fig-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1.2vw, 11px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}
.fig-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(16px, 3vw, 26px);
  font-weight: 400;
  color: var(--text);
  margin-bottom: 6px;
  line-height: 1.25;
}
.fig-caption {
  font-size: clamp(11px, 1.5vw, 13px);
  color: var(--muted);
  max-width: 680px;
  line-height: 1.6;
}

/* ─── CONTROLS BAR ──────────────────────────────────────────────── */
.controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  padding: clamp(10px, 1.5vw, 14px) clamp(16px, 4vw, 36px);
  background: linear-gradient(180deg, #eef5ff 0%, #f8fbff 100%);
  border-bottom: 1px solid var(--border);
}
.controls-label {
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  letter-spacing: 0.12em;
  white-space: nowrap;
  flex-shrink: 0;
}
.btns-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  border-radius: 20px;
  border: 1.5px solid transparent;
  background: transparent;
  font-size: clamp(10px, 1.3vw, 12px);
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: opacity 0.18s, background 0.18s;
  white-space: nowrap;
  user-select: none;
  line-height: 1;
}
.toggle-btn .swatch {
  width: 18px;
  height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}
.toggle-btn.off { opacity: 0.32; }
.toggle-btn:hover { opacity: 1 !important; background: rgba(0,0,0,0.03); }

/* ─── CHART + SIDE PANEL ────────────────────────────────────────── */
.chart-section {
  display: grid;
  grid-template-columns: 1fr 210px;
  background: linear-gradient(180deg, #fcfdff 0%, #f9fcff 100%);
}
@media (max-width: 660px) {
  .chart-section {
    grid-template-columns: 1fr;
  }
  .side-panel {
    border-left: none !important;
    border-top: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  .side-panel .divider { display: none; }
  .side-panel .insight-box { grid-column: 1 / -1; }
}

.chart-container {
  position: relative;
  overflow: hidden;
  padding: clamp(12px, 2vw, 20px) 0 clamp(8px, 1vw, 12px) 0;
  min-width: 0;
}
.chart-container svg { display: block; width: 100%; }

/* ─── SIDE PANEL ────────────────────────────────────────────────── */
.side-panel {
  border-left: 1px solid var(--border);
  padding: clamp(14px, 2vw, 20px) clamp(12px, 1.5vw, 18px);
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}
.panel-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 10px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 2px;
}
.readout-n {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(16px, 2.5vw, 22px);
  font-weight: 500;
  color: var(--text);
}
.zone-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: clamp(10px, 1.2vw, 12px);
  font-weight: 500;
  background: var(--light);
  color: var(--text);
  border: 1px solid transparent;
}
.zone-desc-text {
  font-size: clamp(10px, 1.2vw, 11.5px);
  color: var(--muted);
  line-height: 1.55;
  margin-top: 4px;
}
.readout-grid { display: flex; flex-direction: column; gap: 9px; }
.readout-row { display: flex; flex-direction: column; gap: 1px; }
.readout-label {
  font-size: clamp(9px, 1.1vw, 10.5px);
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.readout-swatch {
  width: 11px; height: 11px;
  border-radius: 3px;
  flex-shrink: 0;
}
.readout-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(12px, 1.6vw, 14px);
  font-weight: 500;
  color: var(--text);
}
.readout-val.positive { color: #009e73; }
.readout-val.negative { color: #d55e00; }
.divider { height: 1px; background: var(--border); flex-shrink: 0; }
.insight-box {
  background: var(--light);
  border-radius: var(--radius);
  padding: 10px 12px;
}
.insight-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 9.5px);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 5px;
}

/* ─── ZONES STRIP ───────────────────────────────────────────────── */
.zones-strip {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  border-top: 1px solid var(--border);
  background: linear-gradient(90deg, rgba(0,114,178,0.04), rgba(0,158,115,0.04));
}
@media (max-width: 580px) {
  .zones-strip { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 340px) {
  .zones-strip { grid-template-columns: 1fr; }
}
.zone-cell {
  padding: clamp(10px, 1.5vw, 14px) clamp(12px, 2vw, 16px);
  border-right: 1px solid var(--border);
}
.zone-cell:nth-child(1) { background: rgba(213,94,0,0.045); }
.zone-cell:nth-child(2) { background: rgba(120,120,120,0.03); }
.zone-cell:nth-child(3) { background: rgba(0,158,115,0.05); }
.zone-cell:nth-child(4) { background: rgba(0,114,178,0.05); }
.zone-cell:last-child { border-right: none; }
.zone-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8px, 1vw, 9px);
  letter-spacing: 0.15em;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 3px;
}
.zone-cell-title {
  font-size: clamp(11px, 1.5vw, 13px);
  font-weight: 600;
  margin-bottom: 4px;
}
.zone-cell-desc {
  font-size: clamp(10px, 1.2vw, 11px);
  color: var(--muted);
  line-height: 1.5;
}

/* ─── FORMULAS ──────────────────────────────────────────────────── */
.formulas-section {
  padding: clamp(16px, 2.5vw, 20px) clamp(16px, 4vw, 36px) clamp(18px, 2.5vw, 24px);
  border-top: 1px solid var(--border);
  background: linear-gradient(180deg, #f0f6ff 0%, #f7fbff 100%);
}
.formulas-header {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1.1vw, 10px);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 14px;
}
.formulas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 30%, 200px), 1fr));
  gap: 10px;
}
.formula-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: clamp(10px, 1.5vw, 12px) clamp(10px, 1.5vw, 14px);
}
.f-label {
  font-size: clamp(9px, 1.1vw, 10.5px);
  color: var(--muted);
  margin-bottom: 5px;
}
.f-eq {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(10px, 1.3vw, 12px);
  color: var(--text);
  line-height: 1.6;
}
.f-eq .hl  { color: #0072b2; font-weight: 500; }
.f-eq .hl2 { color: #d55e00; font-weight: 500; }

/* ─── FOOTER ────────────────────────────────────────────────────── */
.fig-footer {
  padding: clamp(14px, 2vw, 20px) clamp(16px, 4vw, 36px);
  border-top: 2px solid var(--border);
  background: linear-gradient(180deg, #edf4ff 0%, #e9f2ff 100%);
  border-radius: 0 0 12px 12px;
}
.fig-footer-top {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 14px;
}
.fig-source {
  font-size: clamp(9px, 1.1vw, 11px);
  color: var(--muted);
  line-height: 1.5;
}
.fig-note {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(9px, 1vw, 10px);
  color: var(--muted);
  white-space: nowrap;
}
.fig-note-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: var(--muted);
  text-decoration: none;
}
.fig-note-link:hover { color: #0072b2; }
.fig-note-link svg {
  width: 13px;
  height: 13px;
  fill: currentColor;
}
.fig-page-meta {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px dashed rgba(0, 114, 178, 0.22);
  display: flex;
  flex-wrap: wrap;
  gap: 8px 14px;
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(8.8px, 1vw, 10px);
  color: #55647d;
}
.fig-page-meta strong {
  color: #2f4668;
  font-weight: 600;
}

/* References section */
.fig-refs {
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.fig-refs-title {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
  font-family: 'JetBrains Mono', monospace;
}
.fig-refs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 6px 24px;
}
.fig-ref-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
}
.fig-ref-num {
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  color: #0072b2;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 2px;
  width: 18px;
}
.fig-ref-text {
  font-size: clamp(8.5px, 1vw, 10px);
  color: var(--muted);
  line-height: 1.55;
}
.fig-ref-text a {
  color: #0072b2;
  text-decoration: none;
  word-break: break-all;
}
.fig-ref-text a:hover { text-decoration: underline; }
.ref-tag {
  display: inline-block;
  font-size: 8px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 4px;
  border-radius: 3px;
  vertical-align: middle;
  margin-right: 2px;
  letter-spacing: 0.04em;
}
.ref-tag.econ  { background: rgba(0,114,178,0.1); color: #0072b2; }
.ref-tag.finops { background: rgba(0,158,115,0.1); color: #009e73; }
.ref-tag.cloud  { background: rgba(213,94,0,0.1); color: #d55e00; }

/* ─── CALCULATOR SECTION ────────────────────────────────────────── */
.calc-section {
  border-top: 2px solid rgba(0,114,178,0.2);
}

/* Header */
.calc-header {
  padding: clamp(16px,2.5vw,24px) clamp(16px,4vw,36px) clamp(12px,1.8vw,18px);
  background: linear-gradient(180deg, #ffffff 0%, #f5f9ff 100%);
  border-bottom: 1px solid var(--border);
}
.calc-title-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.calc-title {
  font-family: 'Source Serif 4', serif;
  font-size: clamp(16px, 2.2vw, 22px);
  font-weight: 400;
  color: var(--text);
  margin-bottom: 4px;
  line-height: 1.2;
}
.calc-subtitle {
  font-size: clamp(11px, 1.3vw, 13px);
  color: var(--muted);
  line-height: 1.6;
  max-width: 600px;
}
.share-feedback {
  margin-top: 8px;
  min-height: 16px;
  font-size: 11px;
  color: #0f7358;
}
.share-feedback.error { color: #a64300; }
.calc-deeplink {
  margin-top: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  color: #0072b2;
  text-decoration: none;
  border: 1px solid rgba(0,114,178,0.25);
  border-radius: 999px;
  padding: 4px 10px;
  background: rgba(0,114,178,0.07);
}
.calc-deeplink:hover {
  background: rgba(0,114,178,0.12);
  border-color: rgba(0,114,178,0.35);
}
.badge-calc {
  display: inline-block;
  background: rgba(0,114,178,0.1);
  color: #0072b2;
  border-radius: 4px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.calc-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}
.share-btn {
  flex-shrink: 0;
  padding: 8px 14px;
  border: 1.5px solid rgba(0,114,178,0.35);
  border-radius: 8px;
  background: rgba(0,114,178,0.08);
  color: #005a8f;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.share-btn:hover { background: rgba(0,114,178,0.13); border-color: rgba(0,114,178,0.5); }
.share-btn:focus-visible,
.reset-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 2px;
}
.reset-btn {
  flex-shrink: 0;
  padding: 8px 16px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--surface);
  color: var(--muted);
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.reset-btn:hover { border-color: #d55e00; color: #d55e00; background: rgba(213,94,0,0.04); }
@media (max-width: 680px) {
  .calc-actions {
    width: 100%;
    flex-direction: row;
    justify-content: flex-end;
  }
}

/* Body wrapper */
.calc-body {
  padding: clamp(16px,2.5vw,24px) clamp(16px,4vw,36px);
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: linear-gradient(180deg, #eef5ff 0%, #f6fbff 52%, #fff8ef 100%);
}

/* ── Step groups ── */
.calc-group {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 22px rgba(14, 35, 72, 0.06);
}
.calc-group-title {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 18px;
  background: linear-gradient(180deg, #f2f7ff 0%, #edf4ff 100%);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.calc-group-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px; height: 24px;
  border-radius: 50%;
  background: var(--text);
  color: white;
  font-size: 12px;
  font-weight: 700;
  flex-shrink: 0;
  line-height: 1;
}
.calc-group-label {
  font-size: clamp(12px, 1.5vw, 14px);
  font-weight: 600;
  color: var(--text);
}
.calc-group-hint {
  font-size: 11px;
  font-weight: 400;
  color: var(--muted);
}

/* ── Input fields grid ── */
.calc-fields {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 0;
}
.calc-field {
  padding: clamp(14px,2vw,18px) clamp(14px,1.8vw,18px);
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  position: relative;
  transition: background 0.2s;
}
.calc-field:nth-last-child(-n+4):nth-child(4n+1),
.calc-field:last-child { border-right: none; }
@media (max-width: 600px) { .calc-field { border-right: none; } }

.calc-field.has-value,
.startup-field.has-value { background: rgba(0,114,178,0.025); }
.calc-field.has-value::before,
.startup-field.has-value::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px; height: 100%;
  background: #0072b2;
  border-radius: 0 0 0 12px;
}

/* Field label row */
.calc-label {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  font-size: clamp(11px, 1.35vw, 13px);
  font-weight: 600;
  color: var(--text);
  margin-bottom: 9px;
  cursor: default;
  line-height: 1.3;
}
.ftag {
  font-size: 9px;
  font-weight: 500;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--light);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 5px;
  letter-spacing: 0.04em;
  white-space: nowrap;
}

/* Input box */
.calc-input-wrap {
  display: flex;
  align-items: stretch;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  background: var(--surface);
  transition: border-color 0.18s, box-shadow 0.18s;
  height: 38px;
}
.calc-input-wrap:focus-within {
  border-color: #0072b2;
  box-shadow: 0 0 0 3px rgba(0,114,178,0.12);
}
.calc-input-wrap input {
  flex: 1;
  min-width: 0;
  border: none;
  outline: none;
  padding: 0 10px;
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  color: var(--text);
  background: transparent;
  appearance: textfield;
  -moz-appearance: textfield;
}
.calc-input-wrap input::-webkit-inner-spin-button,
.calc-input-wrap input::-webkit-outer-spin-button { -webkit-appearance: none; }
.calc-input-wrap input::placeholder { color: #ccc; font-weight: 400; font-size: 13px; }
.calc-unit {
  padding: 0 10px;
  font-size: 10.5px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  background: var(--light);
  border-left: 1px solid var(--border);
  display: flex;
  align-items: center;
  white-space: nowrap;
  flex-shrink: 0;
}
.calc-hint {
  margin-top: 7px;
  font-size: 10.5px;
  color: var(--muted);
  line-height: 1.45;
}

/* Startup planner (ARPU unknown) */
.startup-planner {
  border-top: 1px dashed var(--border);
  background: linear-gradient(180deg, rgba(0,114,178,0.03), rgba(0,158,115,0.03));
}
.startup-title {
  padding: 10px 18px 8px;
  font-size: 11px;
  color: #2f415f;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.startup-help {
  margin: 0 18px 10px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px dashed rgba(0, 114, 178, 0.32);
  background: rgba(255,255,255,0.78);
}
.startup-help-title {
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #005a8f;
  margin-bottom: 6px;
}
.startup-help-list {
  margin: 0;
  padding-left: 16px;
  font-size: 11px;
  color: #4b5263;
  line-height: 1.5;
}
.startup-help-list li { margin: 2px 0; }
.startup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.startup-field {
  padding: clamp(14px,2vw,18px) clamp(14px,1.8vw,18px);
  border-right: 1px solid var(--border);
  border-top: 1px solid var(--border);
  position: relative;
  transition: background 0.2s;
}
.startup-field:last-child { border-right: none; }
@media (max-width: 600px) {
  .startup-field { border-right: none; }
}

/* ── Output cards ── */
.calc-outputs {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  padding: 16px 18px;
}
@media (max-width: 700px) { .calc-outputs { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 420px) { .calc-outputs { grid-template-columns: 1fr; } }

.calc-out-card {
  background: linear-gradient(180deg, #f8fbff 0%, #eef5ff 100%);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 13px 14px 11px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 0;
  overflow: visible;
  transition: border-color 0.22s, background 0.22s, box-shadow 0.22s;
  position: relative;
}
.calc-out-card.tip-enabled { cursor: pointer; }
.calc-out-card.tip-open { z-index: 8; }
.calc-out-card.live {
  border-color: #009e73;
  background: rgba(0,158,115,0.05);
  box-shadow: 0 0 0 1px rgba(0,158,115,0.15);
}
.calc-out-card.live-warn {
  border-color: #e69f00;
  background: rgba(230,159,0,0.05);
  box-shadow: 0 0 0 1px rgba(230,159,0,0.15);
}
.calc-out-card.live-bad {
  border-color: #d55e00;
  background: rgba(213,94,0,0.05);
  box-shadow: 0 0 0 1px rgba(213,94,0,0.15);
}

.calc-out-label {
  font-size: 9.5px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  padding-right: 26px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.calc-out-tip-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1px solid rgba(0,114,178,0.34);
  background: rgba(255,255,255,0.95);
  color: #005a8f;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  line-height: 1;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(13, 31, 60, 0.12);
}
.calc-out-tip-btn:hover { background: rgba(0,114,178,0.1); }
.calc-out-tip-btn:focus-visible {
  outline: 2px solid #56b4e9;
  outline-offset: 1px;
}

.calc-out-tip {
  position: absolute;
  top: 30px;
  right: 8px;
  width: min(340px, calc(100vw - 54px));
  border: 1px solid rgba(0,114,178,0.3);
  border-radius: 10px;
  background: linear-gradient(180deg, #ffffff 0%, #f3f9ff 100%);
  box-shadow: 0 16px 34px rgba(11, 28, 58, 0.24);
  padding: 10px 11px;
  display: none;
  z-index: 20;
}
.calc-out-card.tip-open .calc-out-tip { display: block; }
.calc-out-tip-title {
  font-family: 'Source Serif 4', serif;
  font-size: 14px;
  color: #16213e;
  line-height: 1.25;
}
.calc-out-tip-what {
  margin-top: 5px;
  font-size: 11px;
  line-height: 1.5;
  color: #405070;
}
.calc-out-tip-sub {
  margin-top: 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #005a8f;
}
.calc-out-tip-list {
  margin-top: 6px;
  padding-left: 14px;
  display: grid;
  gap: 4px;
}
.calc-out-tip-list li {
  font-size: 10.5px;
  line-height: 1.45;
  color: #2f3c57;
}
.calc-out-tip code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: #005a8f;
  background: rgba(0,114,178,0.08);
  border: 1px solid rgba(0,114,178,0.14);
  border-radius: 4px;
  padding: 1px 4px;
}

/* THE FIX: value can never overflow its box */
.calc-out-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(14px, 2vw, 18px);
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
  word-break: break-word;
  overflow-wrap: anywhere;
  min-width: 0;
}
.calc-out-val.good { color: #009e73; }
.calc-out-val.warn { color: #b07800; }
.calc-out-val.bad  { color: #d55e00; }
.calc-out-val.muted { color: var(--muted); font-weight: 400; font-size: 13px; }

.calc-out-sub {
  font-size: 10px;
  color: var(--muted);
  line-height: 1.4;
  margin-top: 1px;
}

/* Status bar */
.calc-status-bar {
  padding: 0 18px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 28px;
}
.calc-status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #ccc;
  flex-shrink: 0;
  transition: background 0.3s;
}
.calc-status-dot.active { background: #009e73; }
.calc-status-text {
  font-size: 11px;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  transition: color 0.3s;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.calc-status-text.active { color: #009e73; }

.calc-out-card.needs-data {
  border-color: var(--border);
  background: var(--light);
  opacity: 0.75;
}
.calc-out-card.needs-data .calc-out-label { color: var(--muted); }
.calc-out-card.needs-data .calc-out-sub {
  color: #b07800;
  font-style: italic;
}

/* Progress pills — show how many fields are filled */
.calc-progress {
  display: flex;
  gap: 4px;
  align-items: center;
  padding: 0 18px 14px;
}
.cp-label { font-size: 10px; color: var(--muted); margin-right: 4px; }
.cp-pill {
  width: 28px; height: 5px;
  border-radius: 3px;
  background: var(--border);
  transition: background 0.3s;
}
.cp-pill.filled { background: #0072b2; }


/* ── GROUP D: PROVIDERS ── */
.provider-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  padding: 16px 18px;
}
.provider-btn {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  min-height: 42px;
  padding: 0 11px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: linear-gradient(180deg, #ffffff 0%, #f5f8ff 100%);
  color: #575b66;
  font-size: clamp(11px, 1.25vw, 13px);
  font-weight: 500;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.18s ease;
}
.provider-btn:hover {
  border-color: #5a5a8a;
  color: #5a5a8a;
  background: rgba(90,90,138,0.07);
}
.provider-btn.selected {
  border-color: #5a5a8a;
  color: #42426d;
  background: rgba(90,90,138,0.12);
  box-shadow: 0 0 0 2px rgba(90,90,138,0.15);
}
.provider-btn .check {
  display: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #5a5a8a;
  color: #fff;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  line-height: 16px;
  text-align: center;
  margin-left: auto;
}
.provider-btn.selected .check { display: inline-block; }
.provider-label {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.provider-logo {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 8.5px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  flex-shrink: 0;
}
.provider-logo.aws { background: #232f3e; color: #ff9900; }
.provider-logo.azure { background: #0078d4; color: #fff; }
.provider-logo.gcp {
  color: #fff;
  background: conic-gradient(#ea4335 0 25%, #fbbc05 25% 50%, #34a853 50% 75%, #4285f4 75% 100%);
}
.provider-logo.oci { background: #c74634; color: #fff; }
.provider-logo.ibm { background: #052fad; color: #fff; }
.provider-logo.alibaba { background: #ff6a00; color: #fff; }
.provider-logo.huawei { background: #cf0a2c; color: #fff; }
.provider-logo.multi { background: #5a5a8a; color: #fff; }

/* ── GROUP E: HEALTH + RECOMMENDATIONS ── */
.health-wrap {
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.health-banner {
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: linear-gradient(180deg, #f7fbff 0%, #eef5ff 100%);
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 14px;
  flex-wrap: wrap;
}
.health-banner.awaiting { border-color: var(--border); }
.health-banner.green {
  border-color: #009e73;
  background: rgba(0,158,115,0.08);
}
.health-banner.yellow {
  border-color: #e69f00;
  background: rgba(230,159,0,0.08);
}
.health-banner.red {
  border-color: #d55e00;
  background: rgba(213,94,0,0.08);
}
.health-zone-title {
  font-size: clamp(14px, 1.7vw, 18px);
  font-weight: 700;
  line-height: 1.25;
}
.health-zone-desc {
  margin-top: 6px;
  color: var(--muted);
  font-size: clamp(11px, 1.3vw, 13px);
  line-height: 1.55;
  max-width: 760px;
}
.health-score {
  min-width: 130px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}
.health-score-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.11em;
  color: var(--muted);
}
.health-score-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: clamp(24px, 3vw, 34px);
  font-weight: 700;
  line-height: 1.1;
}

.rec-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 10px;
}
.rec-card {
  border: 1.5px solid var(--border);
  border-radius: 11px;
  background: linear-gradient(180deg, #ffffff 0%, #f5f9ff 100%);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.rec-card.high { border-left: 4px solid #d55e00; }
.rec-card.medium { border-left: 4px solid #e69f00; }
.rec-card.low { border-left: 4px solid #009e73; }

.rec-head {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
}
.rec-icon { font-size: 15px; }
.rec-title {
  font-size: clamp(12px, 1.35vw, 13px);
  font-weight: 600;
  color: var(--text);
}
.rec-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 1px 5px;
  border-radius: 4px;
  border: 1px solid var(--border);
  color: var(--muted);
  background: #fff;
}
.rec-tag.priority-high { color: #d55e00; border-color: rgba(213,94,0,0.4); background: rgba(213,94,0,0.1); }
.rec-tag.priority-medium { color: #b07800; border-color: rgba(176,120,0,0.4); background: rgba(230,159,0,0.1); }
.rec-tag.priority-low { color: #009e73; border-color: rgba(0,158,115,0.4); background: rgba(0,158,115,0.1); }

.rec-desc {
  color: var(--muted);
  font-size: 11px;
  line-height: 1.55;
}
.rec-action {
  font-size: 11px;
  color: #2a2f44;
  line-height: 1.45;
}
.rec-empty {
  grid-column: 1 / -1;
  padding: 11px 12px;
  border-radius: 9px;
  border: 1px dashed var(--border);
  color: var(--muted);
  font-size: 11px;
  background: #faf9f7;
}


/* ─── FORMULA CARD TOOLTIPS ─────────────────────────────────────── */
.formula-card {
  position: relative;
  cursor: pointer;
  transition: box-shadow 0.18s, border-color 0.18s;
}
.formula-card:hover,
.formula-card.active {
  border-color: #0072b2;
  box-shadow: 0 0 0 3px rgba(0,114,178,0.1);
}
.formula-card .info-btn {
  position: absolute;
  top: 8px; right: 8px;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--light);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 11px;
  font-weight: 700;
  line-height: 16px;
  text-align: center;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  user-select: none;
  flex-shrink: 0;
}
.formula-card:hover .info-btn,
.formula-card.active .info-btn {
  background: #0072b2;
  color: white;
  border-color: #0072b2;
}

/* Tooltip panel */
.ftip {
  display: none;
  position: absolute;
  z-index: 100;
  bottom: calc(100% + 10px);
  left: 0;
  width: clamp(220px, 32vw, 320px);
  background: #fff;
  border: 1.5px solid #0072b2;
  border-radius: 10px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.13);
  padding: 14px 16px 12px;
  pointer-events: none;
}
.ftip.open { display: block; }

/* Flip tooltip to below if card is in top half */
.formula-card.flip-down .ftip {
  bottom: auto;
  top: calc(100% + 10px);
}

/* Arrow */
.ftip::before {
  content: '';
  position: absolute;
  bottom: -7px; left: 20px;
  width: 12px; height: 12px;
  background: #fff;
  border-right: 1.5px solid #0072b2;
  border-bottom: 1.5px solid #0072b2;
  transform: rotate(45deg);
}
.formula-card.flip-down .ftip::before {
  bottom: auto;
  top: -7px;
  border-right: none; border-bottom: none;
  border-left: 1.5px solid #0072b2;
  border-top: 1.5px solid #0072b2;
}

.ftip-title {
  font-family: 'Source Serif 4', serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}
.ftip-desc {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.6;
  margin-bottom: 10px;
}
.ftip-vars {
  display: flex;
  flex-direction: column;
  gap: 5px;
  border-top: 1px solid var(--border);
  padding-top: 9px;
}
.ftip-var {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  align-items: baseline;
}
.ftip-sym {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  color: #0072b2;
  white-space: nowrap;
}
.ftip-sym.hl2 { color: #d55e00; }
.ftip-def {
  font-size: 11px;
  color: var(--muted);
  line-height: 1.45;
}

@media (prefers-reduced-motion: reduce) {
  html { scroll-behavior: auto; }
  *, *::before, *::after {
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
  }
}
</style>
</head>
<body>
<a class="skip-link" href="#calculator-section">Skip to calculator</a>
<nav class="sticky-top-nav" aria-label="Quick section navigation">
  <div class="sticky-top-nav-inner">
    <a class="sticky-top-brand" href="#introduction-section" aria-label="Go to page overview">
      <span class="sticky-top-logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
          <path d="M7.6 17.5H17a3.2 3.2 0 0 0 .8-6.3 5 5 0 0 0-9.7-.7A3.5 3.5 0 0 0 7.6 17.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 7.7v7.2M9.6 12.5 12 15l2.4-2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      <span class="sticky-top-brand-text">FinOps Calculator by Duksh</span>
    </a>
    <ul class="sticky-top-nav-list">
      <li><a class="sticky-top-nav-link" data-nav-link href="#introduction-section">Overview</a></li>
      <li><a class="sticky-top-nav-link" href="document.html">Document</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#about-section">About</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#mcp-section">MCP</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#roadmap-section">Roadmap</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#calculator-section">Calculator</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#group-health">Health</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#chart-section">Chart</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#formulas-section">Formulas</a></li>
      <li><a class="sticky-top-nav-link" data-nav-link href="#references-section">References</a></li>
    </ul>
  </div>
</nav>
<div class="paper">

  <!-- LANDING INTRO -->
  <section class="landing-intro section-anchor" id="introduction-section">
    <div class="landing-kicker">FinOps &amp; Cloud Economics Calculator by Duksh</div>
    <h1 class="landing-title">A practical FinOps calculator to quantify break-even, pricing floor, and cloud efficiency before you scale.</h1>
    <p class="landing-subtitle">
      This page combines a live calculator and an interactive economics visualization to help teams convert cloud spend into clear operating decisions.
      Enter a few inputs and immediately see viability thresholds, contribution margin, CCER posture, and recommendation-driven next actions.
    </p>

    <div class="landing-grid">
      <article class="landing-card">
        <h2 class="landing-card-title">What this tool provides</h2>
        <ul class="landing-card-list">
          <li>Instant break-even and minimum viable client projections.</li>
          <li>Per-client cost and minimum pricing guardrails.</li>
          <li>Provider-aware recommendations based on health zone signals.</li>
        </ul>
        <a class="landing-card-link" href="#calculator-section">Go to Calculator &darr;</a>
      </article>

      <article class="landing-card">
        <h2 class="landing-card-title">Features &amp; advantages</h2>
        <ul class="landing-card-list">
          <li>Real-time recalculation with no refresh cycle or tooling setup.</li>
          <li>Zone-based visual storytelling for strategy and stakeholder alignment.</li>
          <li>Academic formula transparency to support credibility and governance.</li>
        </ul>
        <a class="landing-card-link features" href="#chart-section">Go to Chart &darr;</a>
      </article>

      <article class="landing-card">
        <h2 class="landing-card-title">Target users</h2>
        <ul class="landing-card-list">
          <li>FinOps practitioners and cloud cost optimization teams.</li>
          <li>SaaS founders, product leaders, and cloud solution architects.</li>
          <li>CTOs, CFOs, and operations teams validating unit economics at scale.</li>
        </ul>
        <a class="landing-card-link users" href="#formulas-section">Go to Formulas &darr;</a>
      </article>
    </div>
  </section>

  <!-- CREDIBILITY -->
  <section class="credibility-section section-anchor" id="about-section" aria-labelledby="about-title" aria-describedby="about-summary">
    <div class="cred-avatar">
      <img src="https://avatars.githubusercontent.com/u/586947?v=4" alt="Duksh Koonjoobeeharry profile photo">
    </div>
    <div class="cred-content">
      <p class="cred-kicker">Built by</p>
      <h2 class="cred-title" id="about-title">Duksh Koonjoobeeharry — FinOps &amp; AWS/GCP Cloud Solution Developer, DBA Researcher</h2>
      <p class="cred-text" id="about-summary">
        I design cloud-financial models and architecture strategies that connect technical decisions to business outcomes.
        This calculator reflects practical FinOps implementation, multi-cloud design thinking, and research-backed cost modelling for real-world decision support.
      </p>
      <div class="cred-links">
        <a class="cred-link" href="https://www.linkedin.com/in/duksh/" target="_blank" rel="noopener noreferrer" aria-label="Open Duksh's LinkedIn profile in a new tab">LinkedIn · duksh</a>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta-band" aria-labelledby="cta-band-title" aria-describedby="cta-band-description cta-band-note">
    <div class="cta-shell">
      <h2 class="cta-title" id="cta-band-title">Choose your next step</h2>
      <p class="cta-sub" id="cta-band-description">Jump straight into the live calculator, or explore the MCP version if you want assistants and workflows to consume the same FinOps logic programmatically.</p>
      <div class="cta-actions" role="group" aria-label="Primary call-to-action buttons">
        <button class="cta-btn" aria-describedby="cta-band-note" onclick="document.getElementById('calculator-section').scrollIntoView({behavior:'smooth', block:'start'})">Get Started — Open the FinOps Calculator</button>
        <button class="cta-btn cta-btn-secondary" type="button" data-mcp-open aria-haspopup="dialog" aria-controls="mcp-modal" aria-describedby="cta-band-note">Learn more about FinOps MCP</button>
      </div>
      <p class="cta-note" id="cta-band-note">Need agent-ready workflows? The same calculator model is available as MCP tools that assistants can call directly.</p>
    </div>
  </section>

  <!-- MCP OVERVIEW -->
  <section class="mcp-section section-anchor" id="mcp-section" aria-labelledby="mcp-section-title">
    <div class="mcp-shell">
      <div class="mcp-head">
        <div>
          <div class="mcp-kicker">FinOps Calculator MCP</div>
          <h2 class="mcp-title" id="mcp-section-title">Use this model from AI assistants, not just from the browser UI.</h2>
          <p class="mcp-subtitle">
            The FinOps calculator is also available as a Model Context Protocol (MCP) server so teams can request break-even, health, and recommendation outputs programmatically from Cursor, Windsurf, Claude Desktop, and other MCP-capable tools.
          </p>
        </div>
        <div class="mcp-head-actions">
          <button class="mcp-chip-btn" type="button" data-mcp-open aria-haspopup="dialog" aria-controls="mcp-modal">Learn more</button>
          <a class="mcp-chip-link" href="https://github.com/duksh/finops-calculator-mcp" target="_blank" rel="noopener noreferrer">Open MCP Repo ↗</a>
        </div>
      </div>

      <div class="mcp-grid">
        <article class="mcp-card">
          <h3>Available tools</h3>
          <ul class="mcp-list">
            <li><code>finops.calculate</code> returns normalized inputs, outputs, health, and recommendations.</li>
            <li><code>finops.health</code> returns zone, score, and failed checks only.</li>
            <li><code>finops.recommend</code> returns prioritized actions by zone/provider.</li>
            <li><code>finops.state.encode</code> / <code>finops.state.decode</code> handles shareable state tokens.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>How to connect</h3>
          <ul class="mcp-list">
            <li>Clone the MCP repo and run <code>npm run test</code> in <code>server/</code>.</li>
            <li>Register server command: <code>node .../server/index.js</code> in your MCP client config.</li>
            <li>Reload your assistant and verify all five FinOps tools appear.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>Best-fit use cases</h3>
          <ul class="mcp-list">
            <li>Turn pricing and cloud assumptions into quick scenario comparisons.</li>
            <li>Embed FinOps checks in architecture reviews and governance workflows.</li>
            <li>Generate recommendation summaries without re-entering calculator inputs.</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <!-- ROADMAP PROMO -->
  <section class="mcp-section section-anchor" id="roadmap-section" aria-labelledby="roadmap-section-title">
    <div class="mcp-shell">
      <div class="mcp-head">
        <div>
          <div class="mcp-kicker">Product Roadmap</div>
          <h2 class="mcp-title" id="roadmap-section-title">See what features are coming next for the FinOps Calculator.</h2>
          <p class="mcp-subtitle">
            Explore the public quarterly roadmap to understand upcoming capabilities across FinOps, ITAM, GreenOps,
            and AI economics, including how each release improves decision quality, governance, and execution speed.
          </p>
        </div>
        <div class="mcp-head-actions">
          <a class="mcp-chip-link" href="https://duksh.github.io/finops-roadmap.html" target="_blank" rel="noopener noreferrer">Open Public Roadmap ↗</a>
          <a class="mcp-chip-link" href="https://github.com/duksh/finops-calculator/blob/main/docs/roadmap/2026-roadmap.md" target="_blank" rel="noopener noreferrer">Open Detailed Plan ↗</a>
        </div>
      </div>

      <div class="mcp-grid">
        <article class="mcp-card">
          <h3>What you will find</h3>
          <ul class="mcp-list">
            <li>Quarter-by-quarter feature themes from model trust to enterprise readiness.</li>
            <li>Target outcomes tied to calculator accuracy, explainability, and operational impact.</li>
            <li>Milestone KPIs to track adoption, savings realization, and governance maturity.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>Why it matters</h3>
          <ul class="mcp-list">
            <li>Helps stakeholders align on what is shipping and why.</li>
            <li>Provides a transparent view of planned model and platform improvements.</li>
            <li>Connects roadmap priorities to measurable FinOps value delivery.</li>
          </ul>
        </article>

        <article class="mcp-card">
          <h3>How to use it</h3>
          <ul class="mcp-list">
            <li>Share the public page for quick executive and partner visibility.</li>
            <li>Use the detailed plan in GitHub for backlog and release management.</li>
            <li>Revisit each quarter to compare roadmap promises against delivered capabilities.</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <!-- ═══ LIVE CALCULATOR ════════════════════════════════════════ -->
  <div class="calc-section section-anchor" id="calculator-section">
    <div class="calc-header" id="live-calculator">
      <div class="calc-title-row">
        <div class="calc-title-main">
          <div class="fig-label" style="margin-bottom:5px">⚙︎ Interactive Model — Live Parameter Calculator</div>
          <h2 class="calc-title">Enter what you know. I'll calculate the rest for you.</h2>
          <p class="calc-subtitle">Type in any business figure and the model instantly derives all other parameters and <strong>redraws the chart</strong>. Fields show <span class="badge-calc">calculated</span> when auto-derived from your inputs.</p>
          <a class="calc-deeplink" href="#live-calculator">🔗 Share this section</a>
          <div class="share-feedback" id="share-feedback" aria-live="polite"></div>
        </div>
        <div class="calc-actions">
          <button class="share-btn" id="share-state-btn" type="button" onclick="copyShareStateLink()" aria-label="Copy a shareable link with current calculator state">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="4" width="7" height="7" rx="1"/><rect x="1" y="1" width="7" height="7" rx="1"/></svg>
            Copy state link
          </button>
          <button class="reset-btn" type="button" onclick="resetModel()">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 6A5 5 0 1 0 3 2.5"/><polyline points="1,1 1,4 4,4"/></svg>
            Reset defaults
          </button>
        </div>
      </div>
    </div>

    <div class="calc-body">

      <!-- ── GROUP A ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num">A</span>
          <span class="calc-group-label">Your Current Business Snapshot</span>
          <span class="calc-group-hint">Start here — enter what you already know</span>
        </div>
        <div class="calc-fields">

          <div class="calc-field" id="field-nRef">
            <label class="calc-label" for="inp-nRef">
              Current Client Count
              <span class="ftag">reference&nbsp;n</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-nRef" inputmode="numeric" min="1" max="100000" step="1" placeholder="e.g. 100" oninput="onInput('nRef')">
              <span class="calc-unit">clients</span>
            </div>
            <div class="calc-hint">How many clients right now? All curves calibrate from this point.</div>
          </div>

          <div class="calc-field" id="field-devPerClient">
            <label class="calc-label" for="inp-devPerClient">
              Dev Cost / Client
              <span class="ftag" style="color:var(--dev);border-color:var(--dev);background:rgba(213,94,0,0.06)">● orange curve</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-devPerClient" inputmode="decimal" min="0" step="1" placeholder="e.g. 500" oninput="onInput('devPerClient')">
              <span class="calc-unit">€ / client</span>
            </div>
            <div class="calc-hint">Your dev cost per client at n. Derives <strong>K</strong> (platform build constant).</div>
          </div>

          <div class="calc-field" id="field-infraTotal">
            <label class="calc-label" for="inp-infraTotal">
              Total Infra Cost
              <span class="ftag" style="color:var(--infra-raw);border-color:var(--infra-raw);background:rgba(0,158,115,0.06)">● green curve</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-infraTotal" inputmode="decimal" min="0" step="1" placeholder="e.g. 2400" oninput="onInput('infraTotal')">
              <span class="calc-unit">€ / month</span>
            </div>
            <div class="calc-hint">Your current total cloud bill at n. Derives <strong>c</strong> (infra base coefficient).</div>
          </div>

          <div class="calc-field" id="field-ARPU">
            <label class="calc-label" for="inp-ARPU">
              Revenue / Client (ARPU)
              <span class="ftag" style="color:var(--revenue);border-color:var(--revenue);background:rgba(0,114,178,0.06)">● blue line</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-ARPU" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 30" oninput="onInput('ARPU')">
              <span class="calc-unit">€ / client</span>
            </div>
            <div class="calc-hint">Average monthly revenue per client. If unknown, leave blank and use Startup Planning below.</div>
          </div>

        </div>

        <div class="startup-planner">
          <div class="startup-title">Startup planning mode (if ARPU is unknown) — fill either option</div>
          <div class="startup-help">
            <div class="startup-help-title">How to use (new entrepreneur)</div>
            <ul class="startup-help-list">
              <li><strong>Option A:</strong> enter a realistic market price to estimate how many clients you need.</li>
              <li><strong>Option B:</strong> enter your acquisition target to estimate the minimum price per client.</li>
              <li>You can fill both options to compare scenarios and set a safer revenue target.</li>
            </ul>
          </div>
          <div class="startup-grid">
            <div class="startup-field" id="field-startupTargetPrice">
              <label class="calc-label" for="inp-startupTargetPrice">
                Option A — Target Price / Client
                <span class="ftag" style="color:#0072b2;border-color:#0072b2;background:rgba(0,114,178,0.06)">price-first</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-startupTargetPrice" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 35" oninput="onInput('startupTargetPrice')">
                <span class="calc-unit">€ / client</span>
              </div>
              <div class="calc-hint">If you know what the market can pay, we estimate how many clients you need to hit profitability.</div>
            </div>

            <div class="startup-field" id="field-startupTargetClients">
              <label class="calc-label" for="inp-startupTargetClients">
                Option B — Target Clients
                <span class="ftag" style="color:#009e73;border-color:#009e73;background:rgba(0,158,115,0.06)">clients-first</span>
              </label>
              <div class="calc-input-wrap">
                <input type="number" id="inp-startupTargetClients" inputmode="numeric" min="1" step="1" placeholder="e.g. 80" oninput="onInput('startupTargetClients')">
                <span class="calc-unit">clients</span>
              </div>
              <div class="calc-hint">If you know your acquisition target, we estimate the minimum viable price and monthly revenue target.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── GROUP B ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#888">B</span>
          <span class="calc-group-label">Optional — Fine-Tune the Model</span>
          <span class="calc-group-hint">Leave blank to use smart defaults</span>
        </div>
        <div class="calc-fields">

          <div class="calc-field" id="field-cudPct">
            <label class="calc-label" for="inp-cudPct">
              CUD Discount
              <span class="ftag" style="color:var(--infra-cud);border-color:var(--infra-cud);background:rgba(0,158,115,0.08)">-- dashed green</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-cudPct" inputmode="numeric" min="0" max="100" step="1" placeholder="32" oninput="onInput('cudPct')">
              <span class="calc-unit">%</span>
            </div>
            <div class="calc-hint">Your CUD / Savings Plan rate. Default: 32%. GCP typically 20–55%.</div>
          </div>

          <div class="calc-field" id="field-margin">
            <label class="calc-label" for="inp-margin">
              Target Margin
              <span class="ftag">min price line</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-margin" inputmode="numeric" min="0" max="100" step="1" placeholder="15" oninput="onInput('margin')">
              <span class="calc-unit">%</span>
            </div>
            <div class="calc-hint">Profit margin above cost recovery per client. Default: 15%.</div>
          </div>

          <div class="calc-field" id="field-nMax">
            <label class="calc-label" for="inp-nMax">
              Chart Scale (max n)
              <span class="ftag">x-axis</span>
            </label>
            <div class="calc-input-wrap">
              <input type="number" id="inp-nMax" inputmode="numeric" min="10" max="100000" step="10" placeholder="1000" oninput="onInput('nMax')">
              <span class="calc-unit">clients</span>
            </div>
            <div class="calc-hint">Max clients on the x-axis. Zoom out for large-scale projections.</div>
          </div>

        </div>
      </div>

      <!-- ── GROUP C ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#009e73">C</span>
          <span class="calc-group-label">Auto-Calculated Results</span>
          <span class="calc-group-hint">Updates instantly as you type</span>
        </div>

        <div class="calc-outputs">

          <div class="calc-out-card" id="out-beN">
            <div class="calc-out-label">Break-Even Clients</div>
            <div class="calc-out-val muted" id="oval-beN">—</div>
            <div class="calc-out-sub">Minimum clients to cover all costs</div>
          </div>

          <div class="calc-out-card" id="out-minPrice">
            <div class="calc-out-label">Min. Price / Client</div>
            <div class="calc-out-val muted" id="oval-minPrice">—</div>
            <div class="calc-out-sub">Floor price at your current n</div>
          </div>

          <div class="calc-out-card" id="out-vcpu">
            <div class="calc-out-label">VCPU at n</div>
            <div class="calc-out-val muted" id="oval-vcpu">—</div>
            <div class="calc-out-sub">Variable Cost Per User (infra ÷ n)</div>
          </div>

          <div class="calc-out-card" id="out-margin">
            <div class="calc-out-label">Contribution Margin</div>
            <div class="calc-out-val muted" id="oval-margin">—</div>
            <div class="calc-out-sub">ARPU − VCPU per client</div>
          </div>

          <div class="calc-out-card" id="out-ccer">
            <div class="calc-out-label">CCER at n</div>
            <div class="calc-out-val muted" id="oval-ccer">—</div>
            <div class="calc-out-sub">Revenue ÷ Cloud Spend (target &gt; 3×)</div>
          </div>

          <div class="calc-out-card" id="out-cudSave">
            <div class="calc-out-label">CUD Monthly Saving</div>
            <div class="calc-out-val muted" id="oval-cudSave">—</div>
            <div class="calc-out-sub">On-demand vs committed at n</div>
          </div>

          <div class="calc-out-card" id="out-reqClients">
            <div class="calc-out-label">Required Clients @ Target Price</div>
            <div class="calc-out-val muted" id="oval-reqClients">—</div>
            <div class="calc-out-sub">Use Option A to estimate client volume needed for profitability</div>
          </div>

          <div class="calc-out-card" id="out-reqPrice">
            <div class="calc-out-label">Required Price @ Target Clients</div>
            <div class="calc-out-val muted" id="oval-reqPrice">—</div>
            <div class="calc-out-sub">Use Option B to estimate minimum price per client</div>
          </div>

          <div class="calc-out-card" id="out-targetRevenue">
            <div class="calc-out-label">Target Monthly Revenue</div>
            <div class="calc-out-val muted" id="oval-targetRevenue">—</div>
            <div class="calc-out-sub">Revenue level implied by your startup planning assumptions</div>
          </div>

        </div>

        <!-- Progress + status bar -->
        <div class="calc-progress" id="calc-progress" style="display:none">
          <span class="cp-label">INPUTS FILLED</span>
          <div class="cp-pill" id="cp-0"></div>
          <div class="cp-pill" id="cp-1"></div>
          <div class="cp-pill" id="cp-2"></div>
          <div class="cp-pill" id="cp-3"></div>
          <div class="cp-pill" id="cp-4"></div>
          <div class="cp-pill" id="cp-5"></div>
          <div class="cp-pill" id="cp-6"></div>
          <div class="cp-pill" id="cp-7"></div>
          <div class="cp-pill" id="cp-8"></div>
        </div>
        <div class="calc-status-bar" id="calc-status-bar">
          <div class="calc-status-dot" id="calc-dot"></div>
          <span class="calc-status-text" id="calc-status-text">Enter values above to begin</span>
        </div>

      </div>

      <!-- ── GROUP D ──────────────────────────────────────────── -->
      <div class="calc-group">
        <div class="calc-group-title">
          <span class="calc-group-num" style="background:#5a5a8a">D</span>
          <span class="calc-group-label">Your Cloud Provider(s)</span>
          <span class="calc-group-hint">Select one or more providers to personalise recommendations</span>
        </div>
        <div class="provider-grid">
          <button class="provider-btn" data-provider="aws" onclick="toggleProvider('aws')"><span class="provider-logo aws" aria-hidden="true">aws</span><span class="provider-label">AWS</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="azure" onclick="toggleProvider('azure')"><span class="provider-logo azure" aria-hidden="true">az</span><span class="provider-label">Microsoft Azure</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="gcp" onclick="toggleProvider('gcp')"><span class="provider-logo gcp" aria-hidden="true">gcp</span><span class="provider-label">Google Cloud (GCP)</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="oci" onclick="toggleProvider('oci')"><span class="provider-logo oci" aria-hidden="true">oci</span><span class="provider-label">Oracle Cloud (OCI)</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="ibm" onclick="toggleProvider('ibm')"><span class="provider-logo ibm" aria-hidden="true">ibm</span><span class="provider-label">IBM Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="alibaba" onclick="toggleProvider('alibaba')"><span class="provider-logo alibaba" aria-hidden="true">ali</span><span class="provider-label">Alibaba Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="huawei" onclick="toggleProvider('huawei')"><span class="provider-logo huawei" aria-hidden="true">hw</span><span class="provider-label">Huawei Cloud</span><span class="check">✓</span></button>
          <button class="provider-btn" data-provider="multi" onclick="toggleProvider('multi')"><span class="provider-logo multi" aria-hidden="true">∞</span><span class="provider-label">Multi-Cloud</span><span class="check">✓</span></button>
        </div>
      </div>

      <!-- ── GROUP E ──────────────────────────────────────────── -->
      <div class="calc-group section-anchor" id="group-health">
        <div class="calc-group-title" id="health-title-row">
          <span class="calc-group-num" id="health-group-num" style="background:#7a7a8c">E</span>
          <span class="calc-group-label">Health Zone &amp; Recommendations</span>
          <span class="calc-group-hint">Live FinOps posture based on break-even, CCER, contribution margin, and commitment coverage</span>
        </div>
        <div class="health-wrap">
          <div class="health-banner awaiting" id="health-banner">
            <div>
              <div class="health-zone-title" id="health-zone-title">Awaiting Inputs</div>
              <div class="health-zone-desc" id="health-zone-desc">Add at least Infra Cost and ARPU to compute your FinOps health zone and recommendations.</div>
            </div>
            <div class="health-score">
              <span class="health-score-label">HEALTH SCORE</span>
              <span class="health-score-value" id="health-score-value">—</span>
            </div>
          </div>
          <div class="rec-list" id="rec-list">
            <div class="rec-empty">Recommendations will appear here once enough data is available.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- HEADER -->
  <div class="fig-header">
    <div class="fig-label">Figure 1 · Interactive Cost &amp; Profitability Curves</div>
    <h2 class="fig-title">Cloud Economics Visualization — Explore Scale, Cost Curves, and Profitability Thresholds</h2>
    <p class="fig-caption">Use this section after filling the calculator to inspect how development decay, infrastructure growth, CUD effects, and pricing floors evolve across client volume. Hover over the chart to inspect values at any point.</p>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <span class="controls-label">SHOW/HIDE:</span>
    <div class="btns-wrap">
      <button class="toggle-btn" id="btn-dev"       onclick="toggle('dev')"       style="color:var(--dev);      border-color:var(--dev)"><span class="swatch" style="background:var(--dev)"></span>Dev Cost / Client</button>
      <button class="toggle-btn" id="btn-infra-raw" onclick="toggle('infra-raw')" style="color:var(--infra-raw);border-color:var(--infra-raw)"><span class="swatch" style="background:var(--infra-raw)"></span>Infra (On-Demand)</button>
      <button class="toggle-btn" id="btn-infra-cud" onclick="toggle('infra-cud')" style="color:var(--infra-cud);border-color:var(--infra-cud)"><span class="swatch" style="background:linear-gradient(90deg,var(--infra-cud) 55%,transparent 55%) repeat-x left/9px 3px"></span>Infra (With CUDs)</button>
      <button class="toggle-btn" id="btn-total"     onclick="toggle('total')"     style="color:var(--total);    border-color:var(--total)"><span class="swatch" style="background:var(--total)"></span>Total Cost / Client</button>
      <button class="toggle-btn" id="btn-revenue"   onclick="toggle('revenue')"   style="color:var(--revenue);  border-color:var(--revenue)"><span class="swatch" style="background:var(--revenue)"></span>Revenue</button>
      <button class="toggle-btn" id="btn-profit"    onclick="toggle('profit')"    style="color:var(--profit);   border-color:var(--profit)"><span class="swatch" style="background:linear-gradient(90deg,var(--profit) 60%,transparent 60%) repeat-x left/10px 3px"></span>Profit / ROI</button>
      <button class="toggle-btn" id="btn-price-min" onclick="toggle('price-min')" style="color:var(--price-min);border-color:var(--price-min)"><span class="swatch" style="background:linear-gradient(90deg,var(--price-min) 40%,transparent 40%) repeat-x left/7px 3px"></span>Min. Price / Client</button>
    </div>
  </div>

  <!-- CHART + SIDE PANEL -->
  <div class="chart-section section-anchor" id="chart-section">
    <div class="chart-container" id="chart-container">
      <svg id="chart"></svg>
    </div>
    <div class="side-panel">
      <div>
        <div class="panel-title">Client Count</div>
        <div class="readout-n" id="sp-n">— clients</div>
      </div>
      <div class="divider"></div>
      <div>
        <div class="panel-title">Current Zone</div>
        <div id="sp-zone-badge" class="zone-badge">Hover chart →</div>
        <div id="sp-zone-desc" class="zone-desc-text"></div>
      </div>
      <div class="divider"></div>
      <div class="readout-grid">
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--dev)"></span>Dev Cost / Client</div>
          <div class="readout-val" id="sp-dev">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--infra-raw)"></span>Infra (On-Demand)</div>
          <div class="readout-val" id="sp-infra-raw">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--infra-cud)"></span>Infra (CUDs)</div>
          <div class="readout-val" id="sp-infra-cud">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--total)"></span>Total Cost / Client</div>
          <div class="readout-val" id="sp-total">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--revenue)"></span>Revenue</div>
          <div class="readout-val" id="sp-revenue">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--profit)"></span>Profit / Loss</div>
          <div class="readout-val" id="sp-profit">—</div>
        </div>
        <div class="readout-row">
          <div class="readout-label"><span class="readout-swatch" style="background:var(--price-min);border:1px solid #bbb"></span>Min. Price / Client</div>
          <div class="readout-val" id="sp-price-min">—</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="insight-box">
        <div class="insight-label">Key Insight</div>
        <div id="sp-insight" class="zone-desc-text">Move cursor over chart to see contextual insights.</div>
      </div>
    </div>
  </div>

  <!-- ZONES STRIP -->
  <div class="zones-strip">
    <div class="zone-cell">
      <div class="zone-num">Zone I</div>
      <div class="zone-cell-title" style="color:var(--dev)">Loss Zone</div>
      <div class="zone-cell-desc">Fixed costs dominate. Revenue cannot cover total cost of service. Below minimum viable scale.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Threshold</div>
      <div class="zone-cell-title" style="color:var(--total)">Break-Even</div>
      <div class="zone-cell-desc">N<sub>min</sub> = Fixed Cost ÷ (ARPU − VCPU). Minimum clients for sustainable operations.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Zone III</div>
      <div class="zone-cell-title" style="color:var(--profit)">ROI Sweet Spot</div>
      <div class="zone-cell-desc">Economies of scale reduce per-client dev cost while infra scales efficiently with CUDs.</div>
    </div>
    <div class="zone-cell">
      <div class="zone-num">Zone IV</div>
      <div class="zone-cell-title" style="color:var(--revenue)">Margin Compression</div>
      <div class="zone-cell-desc">Infra cost growth outpaces revenue. Trigger: CUD renegotiation, right-sizing, or architecture review.</div>
    </div>
  </div>

  <!-- FORMULAS -->
  <div class="formulas-section section-anchor" id="formulas-section">
    <div class="formulas-header">Core FinOps Equations Referenced in Figure 1 — <span style="font-weight:400;letter-spacing:0">click any card for a full explanation</span></div>
    <div class="formulas-grid">

      <!-- 1 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Minimum Viable Clients</div>
        <div class="f-eq">N<span class="hl">min</span> = FC ÷ (<span class="hl2">ARPU</span> − VCPU)</div>
        <div class="ftip">
          <div class="ftip-title">Minimum Viable Clients (N<sub>min</sub>)</div>
          <div class="ftip-desc">The smallest number of clients a cloud service provider needs to cover all fixed operating costs and break even. Below this threshold, the business runs at a loss regardless of how efficiently the infrastructure is managed.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">N<sub>min</sub></span><span class="ftip-def">Minimum number of clients required to reach break-even</span></div>
            <div class="ftip-var"><span class="ftip-sym">FC</span><span class="ftip-def">Fixed Costs — recurring costs independent of client count (e.g. base infrastructure, salaries, licences)</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">ARPU</span><span class="ftip-def">Average Revenue Per User — the average monthly revenue generated by each client</span></div>
            <div class="ftip-var"><span class="ftip-sym">VCPU</span><span class="ftip-def">Variable Cost Per User — the cloud infrastructure cost attributable to each individual client</span></div>
            <div class="ftip-var"><span class="ftip-sym">ARPU − VCPU</span><span class="ftip-def">Contribution Margin — what each new client contributes toward covering fixed costs after paying for their own usage</span></div>
          </div>
        </div>
      </div>

      <!-- 2 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Dev Cost Decay (Economies of Scale)</div>
        <div class="f-eq">DC(n) = <span class="hl2">K</span> · n<sup>−α</sup>,  α ∈ (0,1)</div>
        <div class="ftip">
          <div class="ftip-title">Development Cost Decay</div>
          <div class="ftip-desc">As you onboard more clients, the fixed development investment (platform build, R&D, engineering) is spread across a larger base — so the cost per client decreases following a power-law decay curve. This is the core driver of the orange curve in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">DC(n)</span><span class="ftip-def">Development cost per client at scale n</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">K</span><span class="ftip-def">Initial development cost constant — the total platform build cost when n = 1</span></div>
            <div class="ftip-var"><span class="ftip-sym">n</span><span class="ftip-def">Number of clients currently onboarded</span></div>
            <div class="ftip-var"><span class="ftip-sym">−α</span><span class="ftip-def">Decay exponent (0 &lt; α &lt; 1). Higher α means faster cost reduction per client as scale grows</span></div>
          </div>
        </div>
      </div>

      <!-- 3 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Infra Cost — On-Demand</div>
        <div class="f-eq">IC(n) = <span class="hl2">c</span> · n<sup>β</sup>,  β &gt; 1</div>
        <div class="ftip">
          <div class="ftip-title">Infrastructure Cost (On-Demand Pricing)</div>
          <div class="ftip-desc">When paying full on-demand cloud rates (no commitments), infrastructure costs grow super-linearly with clients — each new client adds slightly more cost than the previous one due to usage patterns and resource contention. This is the green curve in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">IC(n)</span><span class="ftip-def">Total infrastructure cost at n clients on on-demand pricing</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">c</span><span class="ftip-def">Base cost coefficient — the infrastructure cost for the first client</span></div>
            <div class="ftip-var"><span class="ftip-sym">β</span><span class="ftip-def">Scaling exponent (β &gt; 1). Represents super-linear growth — each client incrementally increases cost faster than the last</span></div>
          </div>
        </div>
      </div>

      <!-- 4 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Infra Cost — With CUDs</div>
        <div class="f-eq">IC<span class="hl">cud</span>(n) = γ · c · n<sup>β·0.96</sup></div>
        <div class="ftip">
          <div class="ftip-title">Infrastructure Cost with Committed Use Discounts (CUDs)</div>
          <div class="ftip-desc">By committing to a certain level of cloud resource usage over 1 or 3 years, providers receive significant discounts (typically 20–55% depending on the platform and resource type). This shifts the entire infrastructure cost curve downward — extending the ROI sweet spot to the right. This is the dashed green curve in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym hl2">IC<sub>cud</sub>(n)</span><span class="ftip-def">Infrastructure cost at n clients after applying CUD/Reserved Instance discounts</span></div>
            <div class="ftip-var"><span class="ftip-sym">IC(n)</span><span class="ftip-def">Baseline on-demand infrastructure cost (from the formula above)</span></div>
            <div class="ftip-var"><span class="ftip-sym">γ</span><span class="ftip-def">CUD discount factor (0 &lt; γ &lt; 1). A γ of 0.72 means a 28% cost reduction through commitments. Lower γ = deeper discount</span></div>
            <div class="ftip-var"><span class="ftip-sym">CUDs</span><span class="ftip-def">Committed Use Discounts — GCP's discount model for pre-committing compute resources. AWS equivalent: Savings Plans / Reserved Instances. Azure: Reserved Instances</span></div>
          </div>
        </div>
      </div>

      <!-- 5 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Minimum Price per Client</div>
        <div class="f-eq">MP(n) = TC(n) · (1 + <span class="hl2">m</span>)</div>
        <div class="ftip">
          <div class="ftip-title">Minimum Price per Client (P<sub>min</sub>)</div>
          <div class="ftip-desc">The floor price a provider must charge each client to remain profitable at a given scale. Pricing below this level leads to operating losses. As n increases, TC(n) often declines in this model due to development cost decay, enabling more competitive pricing while protecting margins. This is the dotted black line in the chart.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">MP(n)</span><span class="ftip-def">Minimum monthly price per client to achieve break-even plus target margin</span></div>
            <div class="ftip-var"><span class="ftip-sym">TC(n)</span><span class="ftip-def">Total cost per client at n clients — the sum of development and infrastructure components</span></div>
            <div class="ftip-var"><span class="ftip-sym">n</span><span class="ftip-def">Current number of clients — as this grows, per-client cost falls</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">m</span><span class="ftip-def">Target profit margin per client — added on top of cost recovery to ensure profitability (e.g. 15% margin)</span></div>
          </div>
        </div>
      </div>

      <!-- 6 -->
      <div class="formula-card" onclick="toggleTip(this)">
        <span class="info-btn">i</span>
        <div class="f-label">Cloud Cost Efficiency Ratio</div>
        <div class="f-eq">CCER = <span class="hl">Revenue</span> ÷ Total Cloud Spend</div>
        <div class="ftip">
          <div class="ftip-title">Cloud Cost Efficiency Ratio (CCER)</div>
          <div class="ftip-desc">A FinOps north-star KPI that measures how much revenue is generated for every euro spent on cloud infrastructure. A CCER of 4.5 means €4.50 in revenue for every €1 of cloud spend. Tracking CCER over time reveals whether cost optimization initiatives are improving business performance — not just reducing spend.</div>
          <div class="ftip-vars">
            <div class="ftip-var"><span class="ftip-sym">CCER</span><span class="ftip-def">Cloud Cost Efficiency Ratio — the primary FinOps ROI metric for service providers</span></div>
            <div class="ftip-var"><span class="ftip-sym hl2">Revenue</span><span class="ftip-def">Total recurring revenue from all active clients in the measurement period</span></div>
            <div class="ftip-var"><span class="ftip-sym">Total Cloud Spend</span><span class="ftip-def">All cloud-related costs: compute, storage, networking, managed services, licences, and support</span></div>
            <div class="ftip-var"><span class="ftip-sym">Target</span><span class="ftip-def">A CCER &gt; 3.0 is generally considered healthy for cloud-native SaaS. Below 1.0 means the business is unprofitable from a cloud economics standpoint</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER WITH ACADEMIC REFERENCES -->
  <div class="fig-footer section-anchor" id="references-section">
    <div class="fig-footer-top">
      <span class="fig-source">
        <strong>Source:</strong> Conceptual model derived from cloud economics literature and empirical FinOps practice.
        Mathematical formulations (power-law cost scaling, break-even analysis) adapted from foundational cloud economics research [1][2].
        FinOps framework principles follow the FinOps Foundation standard [3][4]. CUD discount modelling based on Google Cloud documentation [7] and comparative cloud pricing research [8].
        All parameter values are illustrative and for research purposes only.
      </span>
      <span class="fig-note">
        <a class="fig-note-link" href="https://www.linkedin.com/in/duksh/" target="_blank" rel="noopener noreferrer" aria-label="DK Koonjoobeeharry on LinkedIn">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.45 20.45h-3.56v-5.58c0-1.33-.03-3.03-1.85-3.03-1.85 0-2.13 1.45-2.13 2.94v5.67H9.35V9h3.42v1.56h.05c.48-.9 1.64-1.85 3.37-1.85 3.6 0 4.26 2.37 4.26 5.46v6.28zM5.34 7.43a2.07 2.07 0 1 1 0-4.14 2.07 2.07 0 0 1 0 4.14zM7.12 20.45H3.56V9h3.56v11.45zM22.22 0H1.77C.79 0 0 .78 0 1.74v20.52C0 23.22.79 24 1.77 24h20.45c.98 0 1.78-.78 1.78-1.74V1.74C24 .78 23.2 0 22.22 0z"/></svg>
          <span>DK Koonjoobeeharry · DBA Research · Open University of Mauritius</span>
        </a>
      </span>
    </div>

    <div class="fig-refs">
      <div class="fig-refs-title">Academic &amp; Primary References</div>
      <div class="fig-refs-grid">

        <div class="fig-ref-item">
          <span class="fig-ref-num">[1]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Harms, R. &amp; Yamartino, M. (2010). <em>The Economics of the Cloud</em>. Microsoft Corp. White Paper.
            Establishes the three economies of scale in cloud: data centre size, demand pooling, and multi-tenancy — foundational basis for the infrastructure cost curves.
            <br><a href="https://news.microsoft.com/download/archived/presskits/cloud/docs/The-Economics-of-the-Cloud.pdf" target="_blank">↗ microsoft.com/Economics-of-the-Cloud.pdf</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[2]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Bayrak, E., Conley, J.P. &amp; Wilkie, S. (2011). The Economics of Cloud Computing.
            <em>Korean Economic Review</em>, 27(2), 203–230.
            Peer-reviewed survey of cloud cost structure and fixed vs. variable cost modelling — supports the power-law DC(n) and IC(n) formulations.
            <br><a href="https://irbe.library.vanderbilt.edu/server/api/core/bitstreams/26dba360-5fee-457a-aef2-7706b4f0505a/content" target="_blank">↗ Vanderbilt University · Working Paper 11-W18</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[3]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Bryant, J. (2022). Driving into the Cloud: What is FinOps?
            <em>ITNOW</em>, 64(3), 54–55. Oxford University Press.
            Peer-reviewed definition and lifecycle model of FinOps as a cloud financial management discipline — basis for the CCER and Min Price metrics.
            <br><a href="https://doi.org/10.1093/combul/bwac097" target="_blank">↗ doi.org/10.1093/combul/bwac097</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[4]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            Nawrocki, P. &amp; Smendowski, M. (2024). FinOps-driven optimization of cloud resource usage for HPC using machine learning.
            <em>Journal of Computational Science</em>, 78, 102269. ScienceDirect.
            Academic study applying FinOps cost forecasting and resource reservation planning — validates the CUD optimisation model.
            <br><a href="https://www.sciencedirect.com/science/article/abs/pii/S1877750324000851" target="_blank">↗ sciencedirect.com · doi.org/10.1016/j.jocs.2024.102269</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[5]</span>
          <span class="fig-ref-text">
            <span class="ref-tag econ">ECON</span>
            Bourreau, M., de Streel, A. &amp; Graef, I. (2024). <em>The Economics of the Cloud</em>. TSE Working Paper No. 1520.
            Toulouse School of Economics / Microsoft Commission. Comprehensive economic analysis of cloud pricing, committed-spend discounts, and egress fees.
            <br><a href="https://www.tse-fr.eu/sites/default/files/TSE/documents/doc/wp/2024/wp_tse_1520.pdf" target="_blank">↗ tse-fr.eu · WP-TSE-1520</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[6]</span>
          <span class="fig-ref-text">
            <span class="ref-tag finops">FINOPS</span>
            FinOps Foundation. (2024). <em>State of FinOps Report</em>. Annual practitioner survey (700+ respondents).
            Industry benchmark for cloud cost efficiency metrics, CCER thresholds, and FinOps maturity adoption rates cited in this model.
            <br><a href="https://data.finops.org/" target="_blank">↗ data.finops.org</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[7]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            Google Cloud. (2024). <em>Resource-based Committed Use Discounts</em>. Google Cloud Compute Engine Documentation.
            Primary source for CUD discount rates (up to 57% for 3-year, 37% for 1-year commitments) used to parameterise the γ discount factor.
            <br><a href="https://cloud.google.com/compute/docs/instances/signing-up-committed-use-discounts" target="_blank">↗ cloud.google.com/compute/docs/committed-use-discounts</a>
          </span>
        </div>

        <div class="fig-ref-item">
          <span class="fig-ref-num">[8]</span>
          <span class="fig-ref-text">
            <span class="ref-tag cloud">CLOUD</span>
            GSA / ITVMO. (2023). <em>Cloud Optimization Through Discounts and Consolidated Billing</em>. U.S. General Services Administration.
            Government-published comparative analysis of AWS Savings Plans, Azure Reservations, and GCP CUDs — supports the cross-cloud CUD benchmarking in this model.
            <br><a href="https://itvmo.gsa.gov/assets/files/FinOps-Optimization-Through-Discounts.pdf" target="_blank">↗ itvmo.gsa.gov · FinOps-Optimization-Through-Discounts.pdf</a>
          </span>
        </div>

      </div>
    </div>

    <div class="fig-page-meta" aria-label="Page metadata">
      <span><strong>Last updated:</strong> <time datetime="2026-02-16T14:15:00+04:00">16 Feb 2026, 14:15 (UTC+04:00)</time></span>
      <span><strong>Version ID:</strong> v2026.02.16-01</span>
    </div>
  </div>

</div><!-- /.paper -->

<div class="mcp-modal" id="mcp-modal" aria-hidden="true">
  <div class="mcp-modal-backdrop" data-mcp-close></div>
  <div class="mcp-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="mcp-modal-title" tabindex="-1">
    <button class="mcp-modal-close" type="button" data-mcp-close aria-label="Close MCP details">×</button>
    <h2 class="mcp-modal-title" id="mcp-modal-title">FinOps Calculator MCP — Quick Guide</h2>
    <p class="mcp-modal-subtitle">
      This MCP exposes the same FinOps logic used on this page, so agents can compute outputs and recommendations in automation flows.
    </p>

    <div class="mcp-modal-grid">
      <article class="mcp-modal-card">
        <h4>Install</h4>
        <ul>
          <li>Clone <code>github.com/duksh/finops-calculator-mcp</code>.</li>
          <li>Run <code>npm run check</code> and <code>npm run test</code> in <code>server/</code>.</li>
          <li>Start server via <code>npm run start</code>.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Connect</h4>
        <ul>
          <li>Add MCP config with command <code>node</code>.</li>
          <li>Set args to absolute path ending in <code>/server/index.js</code>.</li>
          <li>Reload client and confirm tools are discovered.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Key tools</h4>
        <ul>
          <li><code>finops.calculate</code> for full scenario outputs.</li>
          <li><code>finops.health</code> for score-only checks in workflows.</li>
          <li><code>finops.recommend</code> for zone/provider action plans.</li>
        </ul>
      </article>

      <article class="mcp-modal-card">
        <h4>Example prompts</h4>
        <ul>
          <li>"Run <code>finops.calculate</code> for ARPU 35, infra 2400, dev 500."</li>
          <li>"Run <code>finops.health</code> and explain why zone is yellow."</li>
          <li>"Encode this state and return a share token."</li>
        </ul>
      </article>
    </div>
  </div>
</div>

<script>
// ─── STATE ──────────────────────────────────────────────────────
const hidden = new Set();
let paths = {}, hoverDots = {}, currentPts = [], currentScales = {};
const SHARE_STATE_VERSION = 1;
const SHAREABLE_INPUT_KEYS = [
  'nRef', 'devPerClient', 'infraTotal', 'ARPU',
  'startupTargetPrice', 'startupTargetClients',
  'cudPct', 'margin', 'nMax'
];
const SHAREABLE_CURVE_KEYS = ['dev', 'infra-raw', 'infra-cud', 'total', 'revenue', 'profit', 'price-min'];
let shareFeedbackTimer = null;
const mcpModalEl = document.getElementById('mcp-modal');
const mcpModalDialogEl = mcpModalEl ? mcpModalEl.querySelector('.mcp-modal-dialog') : null;
const mcpModalOpeners = Array.from(document.querySelectorAll('[data-mcp-open]'));
let lastMcpModalTrigger = null;
const OUTPUT_TOOLTIP_CONTENT = {
  'out-beN': {
    title: 'Break-Even Clients',
    what: 'This shows the first client volume where the model turns sustainable (revenue meets/exceeds total monthly cost).',
    how: [
      'Model scans client counts and finds the first <code>n</code> where <code>Revenue(n) >= TotalCost(n)</code>.',
      '<code>Revenue(n) = ARPU × n</code> (manual ARPU or startup-derived ARPU).',
      '<code>TotalCost(n) = DevCost(n) + InfraCost(n)</code>.'
    ]
  },
  'out-minPrice': {
    title: 'Minimum Price per Client',
    what: 'This is the minimum monthly unit price needed at current scale to recover cost and hit target margin.',
    how: [
      'Calculated at current client count <code>n</code> (or default estimate when n is missing).',
      '<code>MinPrice(n) = (TotalCost(n) / n) × (1 + margin)</code>.',
      'If ARPU is below this number, margin pressure appears.'
    ]
  },
  'out-vcpu': {
    title: 'VCPU at n',
    what: 'This is variable cloud cost per client at the current scale.',
    how: [
      'Uses current infra cost curve at selected <code>n</code>.',
      '<code>VCPU = InfraCost(n) / n</code>.',
      'It is used directly in contribution margin and break-even logic.'
    ]
  },
  'out-margin': {
    title: 'Contribution Margin',
    what: 'This shows unit economics headroom per client after variable cloud cost.',
    how: [
      '<code>ContributionMargin = ARPU − VCPU</code>.',
      'Positive margin means each additional client contributes toward fixed+growth costs.',
      'Negative margin means each new client currently destroys margin.'
    ]
  },
  'out-ccer': {
    title: 'CCER at n',
    what: 'Cloud Cost Efficiency Ratio compares generated revenue against cloud spend at the same scale.',
    how: [
      '<code>CCER = Revenue / InfraCost</code>.',
      '<code>Revenue = ARPU × n</code>.',
      'A common benchmark is <code>> 3×</code> for healthy cloud efficiency.'
    ]
  },
  'out-cudSave': {
    title: 'CUD Monthly Saving',
    what: 'Estimated monthly savings from commitment discounts versus on-demand infra pricing.',
    how: [
      '<code>Saving = InfraOnDemand(n) − InfraWithCUD(n)</code>.',
      'Infra with CUD uses your discount % input through commitment factor <code>γ</code>.',
      'Higher discounts and larger scale usually increase this saving.'
    ]
  },
  'out-reqClients': {
    title: 'Required Clients @ Target Price',
    what: 'Given Option A target price, this estimates how many clients are needed to become viable.',
    how: [
      'Model scans upward and finds smallest <code>n</code> where <code>MinPrice(n) <= TargetPrice</code>.',
      'Uses your current cost calibration + margin target.',
      'If not reachable in range, it returns a warning threshold.'
    ]
  },
  'out-reqPrice': {
    title: 'Required Price @ Target Clients',
    what: 'Given Option B target clients, this is the minimum viable unit price.',
    how: [
      'Computed directly at your target client count.',
      '<code>RequiredPrice = MinPrice(targetClients)</code>.',
      'This helps validate go-to-market price assumptions.'
    ]
  },
  'out-targetRevenue': {
    title: 'Target Monthly Revenue',
    what: 'This is the monthly revenue level implied by your startup planning assumptions.',
    how: [
      'If both target price and target clients are provided: <code>RevenueTarget = price × clients</code>.',
      'If only one startup option is provided, missing value is derived from model first.',
      'Reflects the current calibration of cost, scale, and margin settings.'
    ]
  }
};
let activeOutputTipCard = null;

// ─── TOGGLE ─────────────────────────────────────────────────────
function toggle(id) {
  const btn = document.getElementById(`btn-${id}`);
  if (hidden.has(id)) {
    hidden.delete(id);
    if (paths[id]) paths[id].attr('opacity', 0.92);
    btn.classList.remove('off');
  } else {
    hidden.add(id);
    if (paths[id]) paths[id].attr('opacity', 0);
    btn.classList.add('off');
  }
}

function encodeShareState(payload) {
  try {
    const json = JSON.stringify(payload);
    const bytes = new TextEncoder().encode(json);
    let bin = '';
    bytes.forEach(b => { bin += String.fromCharCode(b); });
    return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  } catch (err) {
    return null;
  }
}

function decodeShareState(encoded) {
  try {
    const base = String(encoded || '').replace(/-/g, '+').replace(/_/g, '/');
    const padded = base + '='.repeat((4 - (base.length % 4)) % 4);
    const bin = atob(padded);
    const bytes = Uint8Array.from(bin, ch => ch.charCodeAt(0));
    const parsed = JSON.parse(new TextDecoder().decode(bytes));
    return (parsed && typeof parsed === 'object') ? parsed : null;
  } catch (err) {
    return null;
  }
}

function writeShareFeedback(message, isError = false) {
  const el = document.getElementById('share-feedback');
  if (!el) return;
  if (shareFeedbackTimer) {
    clearTimeout(shareFeedbackTimer);
    shareFeedbackTimer = null;
  }
  el.textContent = message || '';
  el.classList.toggle('error', !!isError);
  if (message) {
    shareFeedbackTimer = setTimeout(() => {
      el.textContent = '';
      el.classList.remove('error');
      shareFeedbackTimer = null;
    }, isError ? 5500 : 3200);
  }
}

function collectShareState() {
  const inputState = {};
  SHAREABLE_INPUT_KEYS.forEach(key => {
    const el = document.getElementById(`inp-${key}`);
    if (!el) return;
    const value = el.value.trim();
    if (value !== '') inputState[key] = value;
  });

  return {
    v: SHARE_STATE_VERSION,
    i: inputState,
    p: Array.from(selectedProviders),
    h: Array.from(hidden).filter(id => SHAREABLE_CURVE_KEYS.includes(id))
  };
}

function buildShareStateUrl() {
  const state = collectShareState();
  const hasData = Object.keys(state.i).length > 0 || state.p.length > 0 || state.h.length > 0;
  if (!hasData) return null;

  const encoded = encodeShareState(state);
  if (!encoded) return null;

  const url = new URL(window.location.href);
  url.searchParams.set('state', encoded);
  url.hash = 'group-health';
  return url;
}

function copyShareStateLink() {
  const urlObj = buildShareStateUrl();
  if (!urlObj) {
    writeShareFeedback('Add at least one value before creating a share link.', true);
    return;
  }

  const shareUrl = urlObj.toString();
  const replacePath = `${urlObj.pathname}${urlObj.search}${urlObj.hash}`;
  window.history.replaceState({}, '', replacePath);

  const fallback = () => {
    window.prompt('Copy this calculator state link:', shareUrl);
    writeShareFeedback('Share link ready. Copy it from the dialog.', false);
  };

  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl)
      .then(() => writeShareFeedback('Share link copied. Your colleague will open the same state.', false))
      .catch(fallback);
  } else {
    fallback();
  }
}

function normaliseSharedInput(el, rawValue) {
  if (!el) return '';
  const value = String(rawValue ?? '').trim();
  if (!value) return '';
  const num = Number(value);
  if (!isFinite(num)) return '';

  const min = el.getAttribute('min');
  const max = el.getAttribute('max');
  if (min !== null && min !== '' && num < Number(min)) return '';
  if (max !== null && max !== '' && num > Number(max)) return '';
  return value;
}

function applySharedState(state) {
  if (!state || typeof state !== 'object') return false;

  const inputState = (state.i && typeof state.i === 'object') ? state.i : {};
  SHAREABLE_INPUT_KEYS.forEach(key => {
    const el = document.getElementById(`inp-${key}`);
    if (!el) return;
    const hasKey = Object.prototype.hasOwnProperty.call(inputState, key);
    const safeValue = hasKey ? normaliseSharedInput(el, inputState[key]) : '';
    el.value = safeValue;
    USER_PROVIDED[key] = safeValue !== '';
    const wrap = el.closest('.calc-field, .startup-field');
    if (wrap) wrap.classList.toggle('has-value', safeValue !== '');
  });

  const validProviders = new Set(Array.from(document.querySelectorAll('.provider-btn')).map(btn => btn.dataset.provider));
  selectedProviders.clear();
  document.querySelectorAll('.provider-btn.selected').forEach(btn => btn.classList.remove('selected'));
  if (Array.isArray(state.p)) {
    state.p.forEach(provider => {
      if (!validProviders.has(provider)) return;
      selectedProviders.add(provider);
      const btn = document.querySelector(`[data-provider="${provider}"]`);
      if (btn) btn.classList.add('selected');
    });
  }

  const hiddenFromState = Array.isArray(state.h) ? state.h : [];
  hidden.clear();
  SHAREABLE_CURVE_KEYS.forEach(curveId => {
    const shouldHide = hiddenFromState.includes(curveId);
    if (shouldHide) hidden.add(curveId);
    const btn = document.getElementById(`btn-${curveId}`);
    if (btn) btn.classList.toggle('off', shouldHide);
  });

  recalculate();
  updateProgressPills();
  draw();
  return true;
}

function scrollToHealthSectionFromSharedState() {
  const healthSection = document.getElementById('group-health');
  if (!healthSection) return;

  const url = new URL(window.location.href);
  if (url.hash !== '#group-health') {
    const replacePath = `${url.pathname}${url.search}#group-health`;
    window.history.replaceState({}, '', replacePath);
  }

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      healthSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
}

function loadSharedStateFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const encoded = params.get('state');
  if (!encoded) return false;

  const decoded = decodeShareState(encoded);
  if (!decoded) {
    writeShareFeedback('Shared state link is invalid or corrupted.', true);
    return false;
  }

  const applied = applySharedState(decoded);
  if (applied) {
    writeShareFeedback('Shared calculator state loaded. Jumped to Health & Recommendations.', false);
    scrollToHealthSectionFromSharedState();
  }
  return applied;
}

function clearShareStateParam() {
  const url = new URL(window.location.href);
  if (!url.searchParams.has('state')) return;
  url.searchParams.delete('state');
  const replacePath = `${url.pathname}${url.search}${url.hash}`;
  window.history.replaceState({}, '', replacePath);
}

// ─── MODEL PARAMS (live, updated by calculator) ──────────────────
let MODEL = { K:50000, a:0.45, c:0.8, b:1.28, g:0.68, ARPU:30, m:0.15, nMax:1000 };

// ─── DATA MODEL ─────────────────────────────────────────────────
function buildData() {
  const { K, a, c, b, g, ARPU, m, nMax } = MODEL;
  const N = 300;
  return d3.range(N + 1).map(i => {
    const n       = Math.max(1, (i / N) * nMax);
    const dev      = K * Math.pow(n, -a);
    const infraRaw = c * Math.pow(n, b);
    const infraCud = g * c * Math.pow(n, b * 0.96);
    const total    = dev + infraRaw;
    const revenue  = ARPU;
    const profit   = revenue - total;
    const priceMin = total * (1 + m);
    return { n, dev, infraRaw, infraCud, total, revenue, profit, priceMin };
  });
}

// ─── FORMAT ─────────────────────────────────────────────────────
function fmt(v) {
  if (!isFinite(v)) return '—';
  const abs = Math.abs(v);
  const str = abs >= 1000 ? `€${(abs/1000).toFixed(1)}K` : `€${abs.toFixed(0)}`;
  return v < 0 ? `−${str}` : str;
}

// ─── ZONE DATA ──────────────────────────────────────────────────
function zoneFor(n, beN, ssEnd) {
  if (n < beN) return {
    name: 'Zone I · Loss Zone', color: '#d55e00',
    desc: 'Revenue cannot cover total cost. Below minimum viable scale. Pricing must increase or costs must be reduced.',
    insight: 'Increase client acquisition or reduce fixed costs. Minimum viable price is above current ARPU.'
  };
  if (n < ssEnd) return {
    name: 'Zone III · ROI Sweet Spot', color: '#009e73',
    desc: 'Economies of scale reducing dev cost per client. Infrastructure scaling is still manageable.',
    insight: 'Optimal zone for FinOps governance. Lock in CUDs now to extend this zone further right.'
  };
  return {
    name: 'Zone IV · Margin Compression', color: '#0072b2',
    desc: 'Infra cost growth is outpacing revenue gains. Trigger point for architectural review.',
    insight: 'Action required: Renegotiate CUDs, implement right-sizing, or revise pricing model.'
  };
}

// ─── DRAW ────────────────────────────────────────────────────────
function draw() {
  const container = document.getElementById('chart-container');
  const { nMax } = MODEL;
  const W = container.clientWidth;
  const H = Math.round(Math.min(Math.max(W * (9/16), 320), 560));

  const M = {
    top:    28,
    right:  Math.max(90, W * 0.11),
    bottom: 50,
    left:   Math.max(54, W * 0.075)
  };
  const iW = W - M.left - M.right;
  const iH = H - M.top - M.bottom;

  // Clear
  d3.select('#chart').selectAll('*').remove();
  const svg = d3.select('#chart').attr('width', W).attr('height', H);
  const g   = svg.append('g').attr('transform', `translate(${M.left},${M.top})`);

  const pts  = buildData();
  currentPts = pts;

  // Inflection points
  const be = pts.find(d => d.revenue >= d.total) || null;
  const beN = be ? be.n : Number.POSITIVE_INFINITY;
  const ssEnd = (() => {
    if (!be) return nMax;
    const minTotalPt = pts.reduce((minD, d) => d.total < minD.total ? d : minD, pts[0]);
    const lowerBound = beN + (nMax * 0.06);
    const candidate = Math.max(minTotalPt.n, lowerBound);
    return Math.min(nMax, candidate > beN ? candidate : beN + Math.max(120, nMax * 0.35));
  })();

  // Scales
  const xSc = d3.scaleLinear().domain([0, nMax]).range([0, iW]);
  const yMax = d3.max(pts, d => Math.max(d.total, d.revenue)) * 1.08;
  const yMin = d3.min(pts, d => d.profit) * 1.1;
  const ySc  = d3.scaleLinear().domain([yMin, yMax]).range([iH, 0]);
  currentScales = { xSc, ySc, beN: isFinite(beN) ? beN : null, ssEnd };

  // Defs
  const defs = svg.append('defs');
  const mkArrow = (id, color) => {
    const m = defs.append('marker')
      .attr('id', id).attr('markerWidth', 6).attr('markerHeight', 6)
      .attr('refX', 3).attr('refY', 3).attr('orient', 'auto');
    m.append('path').attr('d', 'M0,0 L6,3 L0,6 Z').attr('fill', color);
  };
  mkArrow('arrowCudUp', '#009e73');
  mkArrow('arrowCudDn', '#009e73');

  // Zone backgrounds
  const beX = be ? xSc(beN) : iW;
  const ssX = xSc(ssEnd);
  g.append('rect').attr('x', xSc(0)).attr('y', 0)
    .attr('width', beX).attr('height', iH)
    .attr('fill', 'rgba(213,94,0,0.05)');
  if (be) {
    g.append('rect').attr('x', beX).attr('y', 0)
      .attr('width', Math.max(0, ssX - beX)).attr('height', iH)
      .attr('fill', 'rgba(0,158,115,0.07)');
    g.append('rect').attr('x', ssX).attr('y', 0)
      .attr('width', Math.max(0, iW - ssX)).attr('height', iH)
      .attr('fill', 'rgba(0,114,178,0.05)');
  }

  // Zone dividers
  [be ? beN : null, be ? ssEnd : null].filter(nx => nx !== null && nx <= nMax).forEach(nx => {
    g.append('line')
      .attr('x1', xSc(nx)).attr('x2', xSc(nx))
      .attr('y1', 0).attr('y2', iH)
      .attr('stroke', '#ccc').attr('stroke-width', 1)
      .attr('stroke-dasharray', '4,3');
  });

  // Zone top labels
  const zLabelY = -10;
  const zoneLabels = be
    ? [
        { cx: (0 + beN) / 2,      text: 'I · LOSS',         color: '#d55e00' },
        { cx: (beN + ssEnd) / 2,  text: 'III · SWEET SPOT', color: '#009e73' },
        { cx: (ssEnd + nMax) / 2, text: 'IV · COMPRESSION', color: '#0072b2' },
      ]
    : [
        { cx: nMax / 2, text: 'I · LOSS', color: '#d55e00' },
      ];
  zoneLabels.forEach(l => {
    const lx = xSc(l.cx);
    if (lx < 0 || lx > iW) return;
    g.append('text')
      .attr('x', lx).attr('y', zLabelY)
      .attr('text-anchor', 'middle')
      .attr('fill', l.color).attr('font-size', Math.max(8, W * 0.009))
      .attr('font-family', 'JetBrains Mono').attr('letter-spacing', '0.1em')
      .text(l.text);
  });

  // Grid
  g.append('g').call(
    d3.axisLeft(ySc).ticks(6).tickSize(-iW).tickFormat('')
  ).call(ag => {
    ag.select('.domain').remove();
    ag.selectAll('.tick line').attr('stroke','#e8e4df').attr('stroke-dasharray','3,3');
  });

  // Zero line
  g.append('line')
    .attr('x1', 0).attr('x2', iW)
    .attr('y1', ySc(0)).attr('y2', ySc(0))
    .attr('stroke', '#bbb').attr('stroke-width', 1);
  g.append('text')
    .attr('x', -5).attr('y', ySc(0) + 4)
    .attr('text-anchor', 'end').attr('fill', '#999')
    .attr('font-size', Math.max(8, W * 0.009))
    .attr('font-family', 'JetBrains Mono').text('€0');

  // Curves
  const curveDefs = [
    { id: 'dev',       key: 'dev',      color: '#d55e00', dash: null,  w: 2.5, label: 'Dev Cost/Client' },
    { id: 'infra-raw', key: 'infraRaw', color: '#009e73', dash: null,  w: 2.5, label: 'Infra (On-Demand)' },
    { id: 'infra-cud', key: 'infraCud', color: '#009e73', dash: '7,4', w: 2,   label: 'Infra (CUDs)' },
    { id: 'total',     key: 'total',    color: '#444444', dash: null,  w: 2.2, label: 'Total Cost/Client' },
    { id: 'revenue',   key: 'revenue',  color: '#0072b2', dash: null,  w: 2.5, label: 'Revenue' },
    { id: 'profit',    key: 'profit',   color: '#7b2d8b', dash: '6,3', w: 2,   label: 'Profit / ROI' },
    { id: 'price-min', key: 'priceMin', color: '#555555', dash: '3,4', w: 1.5, label: 'Min Price/Client' },
  ];

  const lineGen = key => d3.line()
    .defined(d => isFinite(d[key]))
    .x(d => xSc(d.n))
    .y(d => ySc(d[key]))
    .curve(d3.curveCatmullRom.alpha(0.5));

  paths = {};
  curveDefs.forEach(c => {
    paths[c.id] = g.append('path')
      .datum(pts)
      .attr('fill', 'none')
      .attr('stroke', c.color)
      .attr('stroke-width', c.w)
      .attr('stroke-dasharray', c.dash || null)
      .attr('opacity', hidden.has(c.id) ? 0 : 0.92)
      .attr('d', lineGen(c.key));
  });

  // End-of-line labels
  const labelFontSize = Math.max(8.5, W * 0.011);
  const usedYs = [];
  curveDefs.forEach(c => {
    const last = pts[pts.length - 1];
    const yv   = last[c.key];
    if (!isFinite(yv)) return;
    let cy = ySc(yv);
    // nudge overlapping labels
    let tries = 0;
    while (usedYs.some(uy => Math.abs(uy - cy) < labelFontSize + 3) && tries < 20) {
      cy += (cy < iH / 2 ? -1 : 1) * (labelFontSize + 2);
      tries++;
    }
    if (cy < -6 || cy > iH + 6) return;
    usedYs.push(cy);
    g.append('text')
      .attr('x', iW + 5).attr('y', cy + 4)
      .attr('fill', c.color)
      .attr('font-size', labelFontSize)
      .attr('font-weight', '500')
      .attr('font-family', 'Inter')
      .attr('opacity', hidden.has(c.id) ? 0.3 : 1)
      .text(c.label);
  });

  // Break-even annotation
  if (be) {
    const beXp = xSc(beN);
    const beYp = ySc(be.revenue);
    g.append('circle')
      .attr('cx', beXp).attr('cy', beYp).attr('r', 6)
      .attr('fill','white').attr('stroke','#cc79a7').attr('stroke-width', 2.2);
    const beCalloutX = Math.max(4, beXp - 72);
    const beCallout  = g.append('g').attr('transform', `translate(${beCalloutX},${Math.max(4, beYp - 44)})`);
    beCallout.append('rect')
      .attr('rx', 5).attr('width', 70).attr('height', 20)
      .attr('fill', 'white').attr('stroke', '#cc79a7').attr('stroke-width', 1.5);
    beCallout.append('text')
      .attr('x', 35).attr('y', 14).attr('text-anchor', 'middle')
      .attr('fill', '#cc79a7').attr('font-size', 9)
      .attr('font-family', 'JetBrains Mono').attr('font-weight', '500')
      .text('BREAK-EVEN');
    g.append('line')
      .attr('x1', beCalloutX + 35).attr('y1', Math.max(4, beYp - 44) + 20)
      .attr('x2', beXp).attr('y2', beYp - 7)
      .attr('stroke', '#cc79a7').attr('stroke-width', 1).attr('stroke-dasharray', '3,2');
  }

  // CUD savings bracket
  const cudN  = Math.max(20, nMax * 0.62);
  const cudPt = pts.find(d => d.n >= cudN) || pts[Math.floor(pts.length * 0.6)];
  const y1 = ySc(cudPt.infraRaw), y2 = ySc(cudPt.infraCud);
  const cx = xSc(cudPt.n);
  if (Math.abs(y1 - y2) > 14) {
    g.append('line')
      .attr('x1', cx + 12).attr('x2', cx + 12)
      .attr('y1', y2 + 2).attr('y2', y1 - 2)
      .attr('stroke', '#009e73').attr('stroke-width', 1.5)
      .attr('marker-end', 'url(#arrowCudUp)');
    g.append('text')
      .attr('x', cx + 16).attr('y', (y1 + y2) / 2 + 4)
      .attr('fill', '#009e73').attr('font-size', Math.max(8, W * 0.009))
      .attr('font-family', 'JetBrains Mono').text('CUD savings');
  }

  // Axes
  const tickFontSize = Math.max(9, W * 0.011);
  g.append('g').attr('transform', `translate(0,${iH})`)
    .call(d3.axisBottom(xSc).ticks(Math.max(4, Math.floor(iW / 90)))
      .tickFormat(d => d >= 1000 ? `${d/1000}K` : d))
    .call(a => a.select('.domain').attr('stroke','#ccc'))
    .call(a => a.selectAll('text').attr('fill','#888').attr('font-size', tickFontSize));

  g.append('g')
    .call(d3.axisLeft(ySc).ticks(6)
      .tickFormat(d => Math.abs(d) >= 1000 ? `€${(d/1000).toFixed(0)}K` : `€${d.toFixed(0)}`))
    .call(a => a.select('.domain').attr('stroke','#ccc'))
    .call(a => a.selectAll('text').attr('fill','#888').attr('font-size', tickFontSize));

  const axisLabelSize = Math.max(9.5, W * 0.012);
  svg.append('text')
    .attr('x', M.left + iW / 2).attr('y', H - 8)
    .attr('text-anchor', 'middle').attr('fill', '#888')
    .attr('font-size', axisLabelSize).attr('font-family', 'JetBrains Mono')
    .text('Number of Clients (n)');
  svg.append('text')
    .attr('transform', 'rotate(-90)')
    .attr('x', -(M.top + iH / 2)).attr('y', 14)
    .attr('text-anchor', 'middle').attr('fill', '#888')
    .attr('font-size', axisLabelSize).attr('font-family', 'JetBrains Mono')
    .text('Cost / Revenue (€ per client)');

  // Hover dots
  hoverDots = {};
  curveDefs.forEach(c => {
    hoverDots[c.id] = g.append('circle')
      .attr('r', 4.5).attr('fill', c.color)
      .attr('stroke','white').attr('stroke-width', 1.5).attr('opacity', 0);
  });

  // Vertical cursor line
  const vLine = g.append('line')
    .attr('y1', 0).attr('y2', iH)
    .attr('stroke', '#999').attr('stroke-width', 1)
    .attr('stroke-dasharray', '4,3').attr('opacity', 0);

  // Bisector
  const bisect = d3.bisector(d => d.n).left;

  svg.append('rect')
    .attr('x', M.left).attr('y', M.top)
    .attr('width', iW).attr('height', iH)
    .attr('fill', 'transparent')
    .on('mousemove touchmove', function(event) {
      event.preventDefault();
      const coords = event.touches ? d3.pointer(event.touches[0], this) : d3.pointer(event, this);
      const xVal = xSc.invert(coords[0] - M.left);
      const idx  = Math.min(Math.max(bisect(pts, xVal), 0), pts.length - 1);
      const d    = pts[idx];

      vLine.attr('x1', xSc(d.n)).attr('x2', xSc(d.n)).attr('opacity', 0.7);

      curveDefs.forEach(c => {
        const yv = d[c.key];
        const cy = ySc(yv);
        if (isFinite(yv) && cy >= -10 && cy <= iH + 10) {
          hoverDots[c.id].attr('cx', xSc(d.n)).attr('cy', cy).attr('opacity', 1);
        } else {
          hoverDots[c.id].attr('opacity', 0);
        }
      });

      // Side panel
      document.getElementById('sp-n').textContent = `${Math.round(d.n).toLocaleString()} clients`;
      document.getElementById('sp-dev').textContent       = fmt(d.dev);
      document.getElementById('sp-infra-raw').textContent = fmt(d.infraRaw);
      document.getElementById('sp-infra-cud').textContent = fmt(d.infraCud);
      document.getElementById('sp-total').textContent     = fmt(d.total);
      document.getElementById('sp-revenue').textContent   = fmt(d.revenue);

      const profEl = document.getElementById('sp-profit');
      profEl.textContent  = (d.profit >= 0 ? '+' : '') + fmt(d.profit);
      profEl.className    = 'readout-val ' + (d.profit >= 0 ? 'positive' : 'negative');
      document.getElementById('sp-price-min').textContent = fmt(d.priceMin) + '/client';

      const zone = zoneFor(d.n, beN, ssEnd);
      const badge = document.getElementById('sp-zone-badge');
      badge.textContent   = zone.name;
      badge.style.background  = zone.color + '18';
      badge.style.color       = zone.color;
      badge.style.borderColor = zone.color + '44';
      document.getElementById('sp-zone-desc').textContent = zone.desc;
      document.getElementById('sp-insight').textContent   = zone.insight;
    })
    .on('mouseleave touchend', () => {
      vLine.attr('opacity', 0);
      Object.values(hoverDots).forEach(dot => dot.attr('opacity', 0));
    });
}

// ─── RESPONSIVE REDRAW ───────────────────────────────────────────
let resizeTimer;
const chartResizeObserver = new ResizeObserver(() => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(draw, 80);
});
const chartContainerEl = document.getElementById('chart-container');
if (chartContainerEl) chartResizeObserver.observe(chartContainerEl);

// Initial draw
draw();

// ─── CALCULATOR LOGIC ────────────────────────────────────────────

// Default MODEL values for reset
const MODEL_DEFAULTS = { K:50000, a:0.45, c:0.8, b:1.28, g:0.68, ARPU:30, m:0.15, nMax:1000 };

// Track what the user has explicitly provided
const USER_PROVIDED = {
  nRef:false, devPerClient:false, infraTotal:false, ARPU:false,
  startupTargetPrice:false, startupTargetClients:false,
  cudPct:false, margin:false, nMax:false
};

// Smart default n when user hasn't told us their scale yet
const DEFAULT_N_REF = 100;
const selectedProviders = new Set();
let lastInputs = {
  nRef: null, devPerClient: null, infraTotal: null, ARPU: null,
  startupTargetPrice: null, startupTargetClients: null,
  effectiveARPU: null, arpuMode: 'missing',
  cudPct: null, margin: null, nMax: null
};

const RECOMMENDATIONS = [
  { icon:'⚠️', title:'You are below break-even', desc:'Current client volume is below the minimum viable threshold; fixed and variable costs are not yet recovered.', action:'Action: Review pricing page and sales funnel conversion. Prioritise moving n above N_min within the next planning cycle.', providers:[], zones:['red'], priority:'high' },
  { icon:'📉', title:'CCER below 3×', desc:'Cloud Cost Efficiency Ratio is below FinOps benchmark. Revenue generated per euro of cloud spend is under target.', action:'Action: In your billing console, isolate top cost drivers and enforce unit economics guardrails per service.', providers:[], zones:['red','yellow'], priority:'high' },
  { icon:'🛑', title:'Contribution margin is negative', desc:'VCPU is equal to or higher than ARPU. Every incremental client currently destroys value.', action:'Action: Increase package price floor or reduce per-client infra usage before scaling customer acquisition.', providers:[], zones:['red'], priority:'high' },
  { icon:'💳', title:'CUDs/Savings Plans not fully applied', desc:'Discount gap is still material versus committed pricing options. Commitment strategy is likely under-utilised.', action:'Action: Review 12-month steady-state usage and map eligible workloads to commitment instruments.', providers:[], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🏷️', title:'Implement FinOps cost allocation tagging', desc:'Without consistent tags, accountability and optimisation loops remain weak across teams.', action:'Action: Enforce mandatory tags for owner, environment, product, and cost-center in IaC and policy checks.', providers:[], zones:['green'], priority:'low' },
  { icon:'🔮', title:'Set up 12-month cost forecasting', desc:'Proactive forecasting improves commitment timing, budget confidence, and board-level planning.', action:'Action: Build monthly forecast scenarios (base/growth/stress) and review variance at each month close.', providers:[], zones:['green'], priority:'low' },
  { icon:'🧾', title:'AWS Savings Plans coverage', desc:'Compute Savings Plans can reduce eligible compute spend significantly when baseline usage is stable.', action:'Action: AWS Console → Billing and Cost Management → Savings Plans → Recommendations.', providers:['aws'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'📏', title:'AWS right-sizing opportunities', desc:'Idle and oversized resources create avoidable waste in EC2, EBS, and managed services.', action:'Action: AWS Cost Explorer → Rightsizing Recommendations; prioritise top monthly impact accounts.', providers:['aws'], zones:['yellow','red'], priority:'medium' },
  { icon:'⚡', title:'Use Spot for fault-tolerant workloads', desc:'Spot capacity can materially reduce non-critical compute costs for resilient jobs.', action:'Action: EC2 Auto Scaling Groups → Mixed Instances Policy with Spot allocation strategies.', providers:['aws'], zones:['yellow','red'], priority:'medium' },
  { icon:'🚨', title:'Enable Cost Anomaly Detection', desc:'Unexpected spikes should be detected rapidly to reduce financial blast radius.', action:'Action: AWS Console → Cost Management → Cost Anomaly Detection → Create monitor and alerts.', providers:['aws'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🗄️', title:'S3 Intelligent-Tiering for cold data', desc:'Automatically shifting infrequently accessed objects reduces storage spend with minimal effort.', action:'Action: S3 Bucket → Management → Lifecycle rules and Intelligent-Tiering transition policy.', providers:['aws'], zones:['green'], priority:'low' },
  { icon:'📦', title:'Azure Reservations + Hybrid Benefit', desc:'Reserved capacity and license benefits can materially reduce long-running VM/database costs.', action:'Action: Azure Portal → Cost Management + Billing → Reservations → Purchase recommendations.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'🧠', title:'Azure Advisor cost recommendations', desc:'Advisor identifies right-size, idle shutdown, and architecture-level cost opportunities.', action:'Action: Azure Portal → Advisor → Cost tab; export recommendations into remediation backlog.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'🚨', title:'Azure budget alerts and controls', desc:'Budget and anomaly alerting strengthens accountability before overruns become systemic.', action:'Action: Azure Portal → Cost Management → Budgets → Create budget with action groups.', providers:['azure'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🏷️', title:'Azure Spot VMs for non-critical jobs', desc:'Spot VMs reduce compute spend for interruption-tolerant processing.', action:'Action: Azure Portal → Virtual Machines → Spot instance deployment for candidate workloads.', providers:['azure'], zones:['yellow','red'], priority:'medium' },
  { icon:'📉', title:'GCP Resource-based CUDs', desc:'Resource-based commitments can reduce sustained baseline compute spend on eligible workloads.', action:'Action: Google Cloud Console → Billing → Committed Use Discounts → Purchase commitments.', providers:['gcp'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🔍', title:'Verify Sustained Use Discounts', desc:'Check whether workloads are reaching expected utilisation to realise automatic discount benefits.', action:'Action: GCP Billing export → BigQuery; validate sustained usage discount effectiveness by SKU.', providers:['gcp'], zones:['green','yellow'], priority:'low' },
  { icon:'🧹', title:'Use GCP Recommender for idle resources', desc:'Idle resources continue to consume spend without revenue contribution.', action:'Action: GCP Console → Recommender → Cost recommendations and cleanup actions.', providers:['gcp'], zones:['yellow','red'], priority:'high' },
  { icon:'📨', title:'Set Billing Budget alerts with Pub/Sub', desc:'Automated budget threshold events help trigger operational response workflows quickly.', action:'Action: GCP Console → Billing → Budgets & alerts → Enable Pub/Sub notifications.', providers:['gcp'], zones:['green','yellow','red'], priority:'high' },
  { icon:'⚙️', title:'BigQuery query cost controls', desc:'Query cost can drift quickly without governance on scan bytes and query patterns.', action:'Action: BigQuery → Reservations/Quotas + max bytes billed + scheduled query audits.', providers:['gcp'], zones:['yellow','red'], priority:'medium' },
  { icon:'💼', title:'OCI Universal Credits planning', desc:'Universal Credits can improve commitment flexibility when workloads shift across OCI services.', action:'Action: OCI Console → Billing and Cost Management → Usage and Credit Allocation review.', providers:['oci'], zones:['green','yellow','red'], priority:'medium' },
  { icon:'🆓', title:'OCI Always Free for dev/test', desc:'Move suitable non-production workloads to Always Free resources where practical.', action:'Action: OCI Console → Compute/Storage provisioning templates mapped to Always Free limits.', providers:['oci'], zones:['green'], priority:'low' },
  { icon:'🧾', title:'IBM Reserved Virtual Servers', desc:'Long-running workloads should be shifted to reservation models for lower unit costs.', action:'Action: IBM Cloud Console → Billing and Usage → Reservation planning for persistent workloads.', providers:['ibm'], zones:['yellow','red'], priority:'medium' },
  { icon:'🌱', title:'IBM sustainability + cost co-optimisation', desc:'Joint carbon and cost intelligence can identify high-impact remediation opportunities.', action:'Action: IBM Environmental Intelligence Suite + cost reports for optimisation prioritisation.', providers:['ibm'], zones:['green'], priority:'low' },
  { icon:'📦', title:'Alibaba subscription billing shift', desc:'Subscription billing can materially reduce compute costs versus pay-as-you-go baselines.', action:'Action: Alibaba Console → Billing → Resource Plans / Subscription migration candidates.', providers:['alibaba'], zones:['yellow','red'], priority:'medium' },
  { icon:'🧾', title:'Huawei ECS Reservations', desc:'Reservation strategies reduce long-run compute cost where workloads are predictable.', action:'Action: Huawei Cloud Console → Billing Center → Reserved Instances for ECS fleet.', providers:['huawei'], zones:['yellow','red'], priority:'medium' },
  { icon:'🧭', title:'Adopt unified multi-cloud FinOps platform', desc:'Cross-cloud visibility and unit economics governance require a single cost operating model.', action:'Action: Integrate billing exports into a common platform (CloudHealth/OpenCost/warehouse model).', providers:['multi'], zones:['green','yellow','red'], priority:'high' },
  { icon:'🌐', title:'Control inter-region / inter-cloud egress', desc:'Network egress charges often become hidden margin erosion drivers in multi-cloud topologies.', action:'Action: Build monthly egress map by service path; redesign data flows to reduce charge-heavy hops.', providers:['multi'], zones:['green','yellow','red'], priority:'medium' }
];

function priorityWeight(priority) {
  if (priority === 'high') return 0;
  if (priority === 'medium') return 1;
  return 2;
}

function toggleProvider(provider) {
  const btn = document.querySelector(`[data-provider="${provider}"]`);
  if (selectedProviders.has(provider)) {
    selectedProviders.delete(provider);
    if (btn) btn.classList.remove('selected');
  } else {
    selectedProviders.add(provider);
    if (btn) btn.classList.add('selected');
  }
  updateHealthAndRecommendations(lastInputs);
}

function updateHealthAndRecommendations(inputs) {
  const { nRef, infraTotal, ARPU: arpuInp, effectiveARPU, arpuMode } = inputs || {};
  const nSample  = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
  const hasInfra = infraTotal !== null && infraTotal !== undefined;
  const arpuUsed = (effectiveARPU !== null && effectiveARPU !== undefined && effectiveARPU > 0)
    ? effectiveARPU
    : ((arpuInp !== null && arpuInp !== undefined && arpuInp > 0) ? arpuInp : null);
  const hasARPU  = arpuUsed !== null;

  const bannerEl = document.getElementById('health-banner');
  const groupBadgeEl = document.getElementById('health-group-num');
  const titleEl  = document.getElementById('health-zone-title');
  const descEl   = document.getElementById('health-zone-desc');
  const scoreEl  = document.getElementById('health-score-value');
  const listEl   = document.getElementById('rec-list');

  if (!bannerEl || !titleEl || !descEl || !scoreEl || !listEl) return;

  if (!hasInfra || !hasARPU) {
    bannerEl.className = 'health-banner awaiting';
    if (groupBadgeEl) groupBadgeEl.style.background = '#7a7a8c';
    titleEl.textContent = 'Awaiting Inputs';
    descEl.textContent = 'Add Total Infra Cost and Revenue / Client (ARPU), or use Startup Planning (Target Price / Target Clients) to compute health score and recommendations.';
    scoreEl.textContent = '—';
    scoreEl.style.color = '#7a7a8c';
    listEl.innerHTML = '<div class="rec-empty">Recommendations will appear after health scoring data is available.</div>';
    return;
  }

  const { K, a, c, b, g } = MODEL;
  const dev      = K * Math.pow(nSample, -a);
  const infraRaw = c * Math.pow(nSample, b);
  const infraCud = g * c * Math.pow(nSample, b * 0.96);
  const total    = dev + infraRaw;
  const revenue  = arpuUsed * nSample;
  const vcpu     = infraRaw / nSample;
  const contribM = arpuUsed - vcpu;
  const ccer     = infraRaw > 0 ? revenue / infraRaw : 0;
  const cudSaveGapPct = infraRaw > 0 ? ((infraRaw - infraCud) / infraRaw) : 0;

  const pts = buildData();
  const be = pts.find(d => d.revenue >= d.total);
  const beN = be ? Math.round(be.n) : null;

  let score = 100;
  const failed = [];

  if (beN === null) {
    score -= 35;
    failed.push('No break-even point exists within the current model range.');
  } else if (nSample < beN) {
    score -= 35;
    failed.push(`Current clients (${Math.round(nSample).toLocaleString()}) are below break-even (${beN.toLocaleString()}).`);
  }
  if (ccer < 1) {
    score -= 30;
    failed.push(`CCER is ${ccer.toFixed(2)}× (<1×).`);
  } else if (ccer < 3) {
    score -= 15;
    failed.push(`CCER is ${ccer.toFixed(2)}× (below 3× benchmark).`);
  }
  if (contribM <= 0) {
    score -= 20;
    failed.push(`Contribution margin is negative (${fmtOut(contribM, 2)} / client).`);
  }
  if (cudSaveGapPct > 0.15) {
    score -= 5;
    failed.push(`Commitment saving gap is ${(cudSaveGapPct * 100).toFixed(1)}% of infra spend.`);
  }

  score = Math.max(0, Math.min(100, score));

  let zoneKey = 'green';
  let zoneTitle = '🟢 Green Zone — Healthy Economics';
  let zoneDesc = failed.length
    ? failed.join(' ')
    : 'Unit economics are healthy. Continue optimisation discipline and forecasting cadence.';
  let zoneColor = '#009e73';

  if (score < 40) {
    zoneKey = 'red';
    zoneTitle = '🔴 Red Zone — Critical Action Needed';
    zoneColor = '#d55e00';
  } else if (score < 70) {
    zoneKey = 'yellow';
    zoneTitle = '🟡 Yellow Zone — Needs Improvement';
    zoneColor = '#b07800';
  }

  if (arpuMode === 'startup-price') {
    zoneDesc += ' Planning mode: ARPU estimated from your target price assumption.';
  } else if (arpuMode === 'startup-clients') {
    zoneDesc += ' Planning mode: ARPU estimated from your target clients assumption.';
  }

  bannerEl.className = `health-banner ${zoneKey}`;
  if (groupBadgeEl) groupBadgeEl.style.background = zoneColor;
  titleEl.textContent = zoneTitle;
  descEl.textContent = zoneDesc;
  scoreEl.textContent = String(Math.round(score));
  scoreEl.style.color = zoneColor;

  const providers = Array.from(selectedProviders);
  const filtered = RECOMMENDATIONS
    .filter(rec => rec.zones.includes(zoneKey))
    .filter(rec => rec.providers.length === 0 || providers.some(p => rec.providers.includes(p)))
    .sort((a, b) => priorityWeight(a.priority) - priorityWeight(b.priority));

  if (!filtered.length) {
    listEl.innerHTML = '<div class="rec-empty">No provider-specific recommendations match yet. Select one or more providers in Group D to refine actions.</div>';
    return;
  }

  listEl.innerHTML = filtered.map(rec => {
    const providerTag = rec.providers.length ? rec.providers.join('/').toUpperCase() : 'UNIVERSAL';
    const priorityTag = rec.priority.toUpperCase();
    return `
      <article class="rec-card ${rec.priority}">
        <div class="rec-head">
          <span class="rec-icon">${rec.icon}</span>
          <span class="rec-title">${rec.title}</span>
          <span class="rec-tag">${providerTag}</span>
          <span class="rec-tag priority-${rec.priority}">${priorityTag}</span>
        </div>
        <p class="rec-desc">${rec.desc}</p>
        <p class="rec-action">→ ${rec.action}</p>
      </article>
    `;
  }).join('');
}

function getInp(id) {
  const v = parseFloat(document.getElementById(id).value);
  return isNaN(v) ? null : v;
}

function fmtOut(v, decimals=0) {
  if (!isFinite(v) || v === null) return null;
  const abs = Math.abs(v);
  const str = abs >= 1000 ? `€${(abs/1000).toFixed(1)}K` : `€${abs.toFixed(decimals)}`;
  return v < 0 ? `−${str}` : str;
}

function minPriceAtClients(n, model = MODEL) {
  const safeN = Math.max(1, n);
  const total = model.K * Math.pow(safeN, -model.a) + model.c * Math.pow(safeN, model.b);
  return (total / safeN) * (1 + model.m);
}

function findRequiredClientsForTargetPrice(targetPrice, maxN, model = MODEL) {
  if (!(targetPrice > 0)) return null;
  const limit = Math.max(1, Math.round(maxN));
  for (let n = 1; n <= limit; n++) {
    if (minPriceAtClients(n, model) <= targetPrice) return n;
  }
  return null;
}

// Set output card — val=null means "needs more data", val=string is a result
function setOut(id, val, cls='', cardState='', missingMsg='') {
  const el   = document.getElementById(id);
  const sub  = document.getElementById(id + '-sub');  // optional sub-element
  if (!el) return;

  const card = el.closest('.calc-out-card');
  card.classList.remove('live','live-warn','live-bad','needs-data');

  if (val === null) {
    // Not enough data — show what's needed
    el.textContent = '—';
    el.className   = 'calc-out-val muted';
    card.classList.add('needs-data');
    // Write the missing message into the sub-line
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl && missingMsg) subEl.textContent = '⚠ Needs: ' + missingMsg;
  } else {
    el.textContent = val;
    el.className   = 'calc-out-val' + (cls ? ' ' + cls : '');
    // Restore default sub text
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl) subEl.textContent = card.dataset.defaultSub || subEl.dataset.orig || subEl.textContent;
    if (cardState === 'bad')       card.classList.add('live-bad');
    else if (cardState === 'warn') card.classList.add('live-warn');
    else                           card.classList.add('live');
  }
}

// Store original sub texts on first run
function cacheSubTexts() {
  document.querySelectorAll('.calc-out-card').forEach(card => {
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl && !subEl.dataset.orig) subEl.dataset.orig = subEl.textContent;
  });
}

function buildOutputTooltipHtml(config) {
  const items = config.how.map(item => `<li>${item}</li>`).join('');
  return `
    <div class="calc-out-tip-title">${config.title}</div>
    <p class="calc-out-tip-what">${config.what}</p>
    <div class="calc-out-tip-sub">How this is calculated</div>
    <ul class="calc-out-tip-list">${items}</ul>
  `;
}

function closeOutputCardTooltip(card) {
  if (!card) return;
  card.classList.remove('tip-open');
  const btn = card.querySelector('.calc-out-tip-btn');
  const panel = card.querySelector('.calc-out-tip');
  if (btn) btn.setAttribute('aria-expanded', 'false');
  if (panel) panel.setAttribute('aria-hidden', 'true');
  if (activeOutputTipCard === card) activeOutputTipCard = null;
}

function closeAllOutputCardTooltips() {
  document.querySelectorAll('.calc-out-card.tip-open').forEach(closeOutputCardTooltip);
}

function toggleOutputCardTooltip(card) {
  if (!card) return;
  const isOpen = card.classList.contains('tip-open');
  if (isOpen) {
    closeOutputCardTooltip(card);
    return;
  }

  closeAllOutputCardTooltips();
  card.classList.add('tip-open');
  const btn = card.querySelector('.calc-out-tip-btn');
  const panel = card.querySelector('.calc-out-tip');
  if (btn) btn.setAttribute('aria-expanded', 'true');
  if (panel) panel.setAttribute('aria-hidden', 'false');
  activeOutputTipCard = card;
}

function initOutputCardTooltips() {
  const cards = Array.from(document.querySelectorAll('.calc-out-card'));
  if (!cards.length) return;

  cards.forEach(card => {
    const config = OUTPUT_TOOLTIP_CONTENT[card.id];
    if (!config) return;

    card.classList.add('tip-enabled');

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'calc-out-tip-btn';
    btn.textContent = 'i';
    btn.setAttribute('aria-label', `Explain ${config.title}`);
    btn.setAttribute('aria-expanded', 'false');

    const panel = document.createElement('div');
    panel.className = 'calc-out-tip';
    panel.id = `tip-${card.id}`;
    panel.setAttribute('role', 'tooltip');
    panel.setAttribute('aria-hidden', 'true');
    panel.innerHTML = buildOutputTooltipHtml(config);

    btn.setAttribute('aria-controls', panel.id);
    card.appendChild(btn);
    card.appendChild(panel);

    btn.addEventListener('click', event => {
      event.stopPropagation();
      toggleOutputCardTooltip(card);
    });

    card.addEventListener('click', event => {
      if (event.target.closest('.calc-out-tip-btn') || event.target.closest('.calc-out-tip')) return;
      toggleOutputCardTooltip(card);
    });

    panel.addEventListener('click', event => {
      event.stopPropagation();
    });
  });

  document.addEventListener('click', event => {
    if (event.target.closest('.calc-out-card.tip-enabled')) return;
    closeAllOutputCardTooltips();
  });
}

function onInput(fieldId) {
  const input = document.getElementById('inp-' + fieldId);
  if (input) {
    const filled = input.value.trim() !== '';
    const fieldWrap = input.closest('.calc-field, .startup-field');
    if (fieldWrap) fieldWrap.classList.toggle('has-value', filled);
    USER_PROVIDED[fieldId] = filled;
  }
  recalculate();
  updateProgressPills();
}

function updateProgressPills() {
  const ids = [
    'inp-nRef','inp-devPerClient','inp-infraTotal','inp-ARPU',
    'inp-startupTargetPrice','inp-startupTargetClients',
    'inp-cudPct','inp-margin','inp-nMax'
  ];
  const prog = document.getElementById('calc-progress');
  if (prog) prog.style.display = 'flex';
  let filled = 0;
  ids.forEach((id, i) => {
    const el   = document.getElementById(id);
    const pill = document.getElementById('cp-' + i);
    const has  = el && el.value.trim() !== '';
    if (has) filled++;
    if (pill) pill.classList.toggle('filled', has);
  });
  const dot  = document.getElementById('calc-dot');
  const text = document.getElementById('calc-status-text');
  if (filled === 0) {
    dot.classList.remove('active');
    text.classList.remove('active');
    text.textContent = 'Enter values above to begin';
  } else {
    dot.classList.add('active');
    text.classList.add('active');
    text.textContent = `${filled} of ${ids.length} fields filled · chart updated`;
  }
}

function recalculate() {
  cacheSubTexts();

  const nRef         = getInp('inp-nRef');
  const devPerClient = getInp('inp-devPerClient');
  const infraTotal   = getInp('inp-infraTotal');
  const ARPU         = getInp('inp-ARPU');
  const startupTargetPrice   = getInp('inp-startupTargetPrice');
  const startupTargetClients = getInp('inp-startupTargetClients');
  const cudPct       = getInp('inp-cudPct');
  const marginPct    = getInp('inp-margin');
  const nMaxInp      = getInp('inp-nMax');

  let changed = false;
  let derivations = [];
  let effectiveARPU = null;
  let arpuMode = 'missing';

  // ── Always-applicable fields ──────────────────────────────────
  if (nMaxInp !== null && nMaxInp >= 10) { MODEL.nMax = nMaxInp; changed = true; }
  if (marginPct !== null)               { MODEL.m = Math.max(0, marginPct / 100); changed = true; }
  if (cudPct !== null)                  { MODEL.g = Math.max(0.01, 1 - cudPct / 100); changed = true; derivations.push(`γ=${MODEL.g.toFixed(2)}`); }

  // ── Derive K from devPerClient ────────────────────────────────
  // Use actual nRef if given, otherwise use DEFAULT_N_REF as a calibration assumption
  if (devPerClient !== null && devPerClient > 0) {
    const n = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
    MODEL.K = devPerClient * Math.pow(n, MODEL.a);
    changed = true;
    derivations.push(`K=${MODEL.K.toFixed(0)}`);
  }

  // ── Derive c from infraTotal ──────────────────────────────────
  // KEY FIX: never calibrate against n=1 — use nRef or DEFAULT_N_REF
  if (infraTotal !== null && infraTotal > 0) {
    const n = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
    MODEL.c = infraTotal / Math.pow(n, MODEL.b);
    changed = true;
    derivations.push(`c=${MODEL.c.toFixed(4)} @ n=${n}`);
  }

  // ── ARPU source: manual OR startup planning assumptions ────────
  if (ARPU !== null && ARPU > 0) {
    MODEL.ARPU = ARPU;
    effectiveARPU = ARPU;
    arpuMode = 'manual';
    changed = true;
  } else if (startupTargetPrice !== null && startupTargetPrice > 0) {
    MODEL.ARPU = startupTargetPrice;
    effectiveARPU = startupTargetPrice;
    arpuMode = 'startup-price';
    changed = true;
    derivations.push(`ARPU≈${MODEL.ARPU.toFixed(2)} (price target)`);
  } else if (
    startupTargetClients !== null && startupTargetClients > 0 &&
    ((devPerClient !== null && devPerClient > 0) || (infraTotal !== null && infraTotal > 0))
  ) {
    MODEL.ARPU = minPriceAtClients(startupTargetClients, MODEL);
    effectiveARPU = MODEL.ARPU;
    arpuMode = 'startup-clients';
    changed = true;
    derivations.push(`ARPU≈${MODEL.ARPU.toFixed(2)} @ ${Math.round(startupTargetClients)} clients`);
  }

  lastInputs = {
    nRef, devPerClient, infraTotal, ARPU,
    startupTargetPrice, startupTargetClients,
    effectiveARPU, arpuMode,
    cudPct, margin: marginPct, nMax: nMaxInp
  };

  if (changed) { draw(); }
  updateOutputCards(lastInputs);
  updateHealthAndRecommendations(lastInputs);

  const text = document.getElementById('calc-status-text');
  if (derivations.length && text) {
    text.textContent = `✓ Derived: ${derivations.join(' · ')} · chart updated`;
  }
}

function updateOutputCards(inputs) {
  const {
    nRef, devPerClient, infraTotal, ARPU: arpuInp, cudPct,
    startupTargetPrice, startupTargetClients, effectiveARPU, arpuMode
  } = inputs;
  const { K, a, c, b, g, m, nMax } = MODEL;

  // Use actual nRef if provided, otherwise DEFAULT_N_REF for display calculations
  const nSample   = (nRef && nRef > 0) ? nRef : DEFAULT_N_REF;
  const arpuUsed  = (effectiveARPU !== null && effectiveARPU !== undefined && effectiveARPU > 0)
    ? effectiveARPU
    : ((arpuInp !== null && arpuInp > 0) ? arpuInp : null);
  const hasARPU   = arpuUsed !== null;
  const hasInfra  = infraTotal !== null;
  const hasDev    = devPerClient !== null;
  const hasNRef   = nRef !== null && nRef > 0;
  const hasStartupPrice   = startupTargetPrice !== null && startupTargetPrice > 0;
  const hasStartupClients = startupTargetClients !== null && startupTargetClients > 0;
  const hasAnyCostInput = hasInfra || hasDev;

  const dev      = K * Math.pow(nSample, -a);
  const infraRaw = c * Math.pow(nSample, b);
  const infraCud = g * c * Math.pow(nSample, b * 0.96);
  const total    = dev + infraRaw;
  const revenue  = hasARPU ? arpuUsed * nSample : 0;
  const vcpu     = infraRaw / nSample;
  const contribM = hasARPU ? (arpuUsed - vcpu) : null;
  const priceMin = (total / nSample) * (1 + m);
  const ccer     = infraRaw > 0 ? (revenue / infraRaw) : null;
  const cudSave  = infraRaw - infraCud;
  const searchMax = Math.max(20000, nMax);
  const reqClients = (hasStartupPrice && hasAnyCostInput)
    ? findRequiredClientsForTargetPrice(startupTargetPrice, searchMax, MODEL)
    : null;
  const reqPriceAtClients = (hasStartupClients && hasAnyCostInput)
    ? minPriceAtClients(startupTargetClients, MODEL)
    : null;
  const reqClientsFromClientsMode = (arpuMode === 'startup-clients' && reqPriceAtClients !== null)
    ? findRequiredClientsForTargetPrice(reqPriceAtClients, searchMax, MODEL)
    : null;

  // Break-even search
  const pts = buildData();
  const be  = pts.find(d => d.revenue >= d.total);
  const beN = be ? Math.round(be.n) : null;

  // ── BREAK-EVEN ───────────────────────────────────────────────
  // Needs: at least one cost input (infra OR dev) AND ARPU
  // Without ARPU there is no revenue line; without any cost there's no cost line
  const beNeedsArpu  = !hasARPU;
  const beNeedsCost  = !hasInfra && !hasDev;

  if (beNeedsArpu && beNeedsCost) {
    setOut('oval-beN', null, '', '', 'Revenue/Client (ARPU) or Startup Target + one cost figure');
  } else if (beNeedsArpu) {
    setOut('oval-beN', null, '', '', 'Revenue/Client (ARPU) or Startup Target Price / Target Clients');
  } else if (beNeedsCost) {
    setOut('oval-beN', null, '', '', 'Dev Cost or Infra Cost');
  } else if (arpuMode === 'startup-price' && reqClients !== null) {
    const beClass = reqClients <= nSample ? 'good' : 'warn';
    setOut('oval-beN', `${reqClients.toLocaleString()} clients (startup est.)`, beClass, beClass === 'warn' ? 'warn' : '');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Estimated clients needed at your target price (includes margin target)';
  } else if (arpuMode === 'startup-clients' && reqClientsFromClientsMode !== null) {
    const beClass = reqClientsFromClientsMode <= nSample ? 'good' : 'warn';
    setOut('oval-beN', `${reqClientsFromClientsMode.toLocaleString()} clients (startup est.)`, beClass, beClass === 'warn' ? 'warn' : '');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Estimated clients needed based on your target clients pricing requirement';
  } else if (beN && beN <= nMax) {
    const beClass = beN <= nSample ? 'good' : 'warn';
    const beCard  = beN <= nSample ? '' : 'warn';
    const note    = !hasNRef ? ` (est. @ n=${DEFAULT_N_REF})` : '';
    setOut('oval-beN', `${beN.toLocaleString()} clients${note}`, beClass, beCard);
  } else {
    // Break-even exists but beyond chart range — model might be miscalibrated
    const hint = !hasNRef ? ` · add Client Count for accuracy` : '';
    setOut('oval-beN', beN === null ? 'Not reachable' : `> ${nMax.toLocaleString()} clients`, 'warn', 'warn');
    const subEl = document.querySelector('#out-beN .calc-out-sub');
    if (subEl) subEl.textContent = 'Revenue per client stays below total cost per client across range' + hint;
  }

  // ── MIN PRICE / CLIENT ────────────────────────────────────────
  if (!hasInfra && !hasDev) {
    setOut('oval-minPrice', null, '', '', 'Dev Cost or Infra Cost');
  } else {
    const note    = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    const mpOk    = hasARPU && priceMin < arpuUsed;
    const mpClass = mpOk ? 'good' : 'bad';
    setOut('oval-minPrice', fmtOut(priceMin, 2) + ' / client', mpClass, mpClass === 'bad' ? 'bad' : '');
    if (note) {
      const subEl = document.querySelector('#out-minPrice .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── VCPU ─────────────────────────────────────────────────────
  if (!hasInfra) {
    setOut('oval-vcpu', null, '', '', 'Total Infra Cost');
  } else {
    const note  = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    setOut('oval-vcpu', fmtOut(vcpu, 2) + ' / client', '');
    if (note) {
      const subEl = document.querySelector('#out-vcpu .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── CONTRIBUTION MARGIN ───────────────────────────────────────
  if (!hasInfra && !hasARPU) {
    setOut('oval-margin', null, '', '', 'Total Infra Cost + Revenue / Client (ARPU) or Startup Target');
  } else if (!hasInfra) {
    setOut('oval-margin', null, '', '', 'Total Infra Cost');
  } else if (!hasARPU) {
    setOut('oval-margin', null, '', '', 'Revenue / Client (ARPU) or Startup Target');
  } else {
    const cmClass = contribM !== null && contribM > 0 ? 'good' : 'bad';
    setOut('oval-margin', fmtOut(contribM, 2) + ' / client', cmClass, cmClass === 'bad' ? 'bad' : '');
  }

  // ── CCER ─────────────────────────────────────────────────────
  if (!hasInfra && !hasARPU) {
    setOut('oval-ccer', null, '', '', 'Total Infra Cost + Revenue / Client (ARPU) or Startup Target');
  } else if (!hasInfra) {
    setOut('oval-ccer', null, '', '', 'Total Infra Cost');
  } else if (!hasARPU) {
    setOut('oval-ccer', null, '', '', 'Revenue / Client (ARPU) or Startup Target');
  } else if (ccer !== null) {
    const cc = ccer >= 3 ? 'good' : ccer >= 1 ? 'warn' : 'bad';
    setOut('oval-ccer', ccer.toFixed(2) + '×', cc, cc);
  } else {
    setOut('oval-ccer', null, '', '', 'Valid infra cost > 0');
  }

  // ── CUD SAVING ────────────────────────────────────────────────
  if (!hasInfra) {
    setOut('oval-cudSave', null, '', '', 'Total Infra Cost');
  } else {
    const note = !hasNRef ? ` · est. @ n=${DEFAULT_N_REF}` : '';
    setOut('oval-cudSave', fmtOut(cudSave) + ' / mo', cudSave > 0 ? 'good' : '', cudSave > 0 ? '' : 'warn');
    if (note) {
      const subEl = document.querySelector('#out-cudSave .calc-out-sub');
      if (subEl) subEl.textContent = subEl.dataset.orig + note;
    }
  }

  // ── STARTUP OPTION A: REQUIRED CLIENTS @ TARGET PRICE ─────────
  if (!hasStartupPrice && !hasARPU) {
    setOut('oval-reqClients', null, '', '', 'Option A: Target Price / Client');
  } else if (!hasAnyCostInput) {
    setOut('oval-reqClients', null, '', '', 'Dev Cost or Infra Cost');
  } else if (!hasStartupPrice) {
    setOut('oval-reqClients', null, '', '', 'Option A: Target Price / Client');
  } else if (reqClients === null) {
    setOut('oval-reqClients', `> ${searchMax.toLocaleString()} clients`, 'warn', 'warn');
    const subEl = document.querySelector('#out-reqClients .calc-out-sub');
    if (subEl) subEl.textContent = 'Target price appears too low for profitability in current range';
  } else {
    const cls = reqClients <= nSample ? 'good' : 'warn';
    setOut('oval-reqClients', `${reqClients.toLocaleString()} clients`, cls, cls === 'warn' ? 'warn' : '');
  }

  // ── STARTUP OPTION B: REQUIRED PRICE @ TARGET CLIENTS ─────────
  if (!hasStartupClients && !hasARPU) {
    setOut('oval-reqPrice', null, '', '', 'Option B: Target Clients');
  } else if (!hasAnyCostInput) {
    setOut('oval-reqPrice', null, '', '', 'Dev Cost or Infra Cost');
  } else if (!hasStartupClients) {
    setOut('oval-reqPrice', null, '', '', 'Option B: Target Clients');
  } else {
    const cls = hasStartupPrice && startupTargetPrice >= reqPriceAtClients ? 'good' : 'warn';
    setOut('oval-reqPrice', fmtOut(reqPriceAtClients, 2) + ' / client', cls, cls === 'warn' ? 'warn' : '');
  }

  // ── STARTUP REVENUE TARGET ─────────────────────────────────────
  let revenueTarget = null;
  if (hasStartupClients && reqPriceAtClients !== null) {
    const priceForRevenue = hasStartupPrice ? startupTargetPrice : reqPriceAtClients;
    revenueTarget = priceForRevenue * startupTargetClients;
  } else if (hasStartupPrice && reqClients !== null) {
    revenueTarget = startupTargetPrice * reqClients;
  }

  if (!hasAnyCostInput) {
    setOut('oval-targetRevenue', null, '', '', 'Dev Cost or Infra Cost');
  } else if (revenueTarget === null) {
    setOut('oval-targetRevenue', null, '', '', 'Option A or Option B startup input');
  } else {
    setOut('oval-targetRevenue', fmtOut(revenueTarget, 0) + ' / mo', 'good', '');
    const subEl = document.querySelector('#out-targetRevenue .calc-out-sub');
    if (subEl) {
      if (hasStartupPrice && hasStartupClients) {
        subEl.textContent = 'Based on your own target price and target clients assumptions';
      } else if (hasStartupPrice) {
        subEl.textContent = 'Based on your target price and computed required client count';
      } else {
        subEl.textContent = 'Based on your target clients and computed required price';
      }
      if (arpuMode === 'startup-clients' || arpuMode === 'startup-price') {
        subEl.textContent += ' (startup estimate mode)';
      }
    }
  }
}

function resetModel() {
  Object.assign(MODEL, MODEL_DEFAULTS);
  Object.keys(USER_PROVIDED).forEach(k => USER_PROVIDED[k] = false);
  selectedProviders.clear();
  document.querySelectorAll('.provider-btn.selected').forEach(btn => btn.classList.remove('selected'));
  lastInputs = {
    nRef: null, devPerClient: null, infraTotal: null, ARPU: null,
    startupTargetPrice: null, startupTargetClients: null,
    effectiveARPU: null, arpuMode: 'missing',
    cudPct: null, margin: null, nMax: null
  };
  const ids = [
    'inp-nRef','inp-devPerClient','inp-infraTotal','inp-ARPU',
    'inp-startupTargetPrice','inp-startupTargetClients',
    'inp-cudPct','inp-margin','inp-nMax'
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
    const field = el && el.closest('.calc-field, .startup-field');
    if (field) field.classList.remove('has-value');
  });
  for (let i = 0; i < ids.length; i++) {
    const p = document.getElementById('cp-' + i);
    if (p) p.classList.remove('filled');
  }
  const prog = document.getElementById('calc-progress');
  if (prog) prog.style.display = 'none';
  const dot  = document.getElementById('calc-dot');
  const text = document.getElementById('calc-status-text');
  if (dot)  dot.classList.remove('active');
  if (text) { text.classList.remove('active'); text.textContent = 'Enter values above to begin'; }

  // Restore original sub-texts and clear cards
  document.querySelectorAll('.calc-out-card').forEach(card => {
    card.classList.remove('live','live-warn','live-bad','needs-data');
    const subEl = card.querySelector('.calc-out-sub');
    if (subEl && subEl.dataset.orig) subEl.textContent = subEl.dataset.orig;
    const valEl = card.querySelector('.calc-out-val');
    if (valEl) { valEl.textContent = '—'; valEl.className = 'calc-out-val muted'; }
  });
  draw();
  updateHealthAndRecommendations(lastInputs);
  clearShareStateParam();
  writeShareFeedback('');
}

// ─── MCP MODAL LOGIC ────────────────────────────────────────────
function openMcpModal(triggerEl) {
  if (!mcpModalEl || !mcpModalDialogEl) return;
  lastMcpModalTrigger = triggerEl || document.activeElement;
  mcpModalEl.classList.add('is-open');
  mcpModalEl.setAttribute('aria-hidden', 'false');
  document.body.classList.add('modal-open');
  window.requestAnimationFrame(() => mcpModalDialogEl.focus());
}

function closeMcpModal() {
  if (!mcpModalEl || !mcpModalDialogEl) return;
  mcpModalEl.classList.remove('is-open');
  mcpModalEl.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('modal-open');
  if (lastMcpModalTrigger && typeof lastMcpModalTrigger.focus === 'function') {
    lastMcpModalTrigger.focus();
  }
}

function initMcpModal() {
  if (!mcpModalEl || !mcpModalDialogEl || !mcpModalOpeners.length) return;

  mcpModalOpeners.forEach(btn => {
    btn.addEventListener('click', () => openMcpModal(btn));
  });

  mcpModalEl.querySelectorAll('[data-mcp-close]').forEach(el => {
    el.addEventListener('click', closeMcpModal);
  });
}

// ─── FORMULA TOOLTIP LOGIC ───────────────────────────────────────
function toggleTip(card) {
  const tip    = card.querySelector('.ftip');
  const isOpen = card.classList.contains('active');

  // Close all open tips first
  document.querySelectorAll('.formula-card.active').forEach(c => {
    c.classList.remove('active');
    c.querySelector('.ftip').classList.remove('open');
  });

  if (!isOpen) {
    // Determine if tooltip should flip downward (card in upper half of page)
    const rect      = card.getBoundingClientRect();
    const midWindow = window.innerHeight / 2;
    card.classList.toggle('flip-down', rect.top < midWindow);
    card.classList.add('active');
    tip.classList.add('open');
    tip.style.pointerEvents = 'none'; // keep clicks passing through
  }
}

// Close tooltip when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.formula-card')) {
    document.querySelectorAll('.formula-card.active').forEach(c => {
      c.classList.remove('active');
      c.querySelector('.ftip').classList.remove('open');
    });
  }
});

// Close tooltip on Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeMcpModal();
    closeAllOutputCardTooltips();
    document.querySelectorAll('.formula-card.active').forEach(c => {
      c.classList.remove('active');
      c.querySelector('.ftip').classList.remove('open');
    });
  }
});

function initSectionNav() {
  const links = Array.from(document.querySelectorAll('[data-nav-link]'));
  if (!links.length) return;

  const items = links
    .map(link => {
      const href = link.getAttribute('href') || '';
      if (!href.startsWith('#')) return null;
      const target = document.querySelector(href);
      if (!target) return null;
      return { link, target };
    })
    .filter(Boolean);

  if (!items.length) return;

  function setActive(id) {
    items.forEach(({ link, target }) => {
      const active = target.id === id;
      link.classList.toggle('is-active', active);
      if (active) link.setAttribute('aria-current', 'page');
      else link.removeAttribute('aria-current');
    });
  }

  const hashTarget = window.location.hash ? window.location.hash.slice(1) : '';
  const initialId = items.some(({ target }) => target.id === hashTarget)
    ? hashTarget
    : items[0].target.id;
  setActive(initialId);

  if (typeof IntersectionObserver === 'undefined') return;

  const visible = new Map();
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) visible.set(entry.target.id, entry.intersectionRatio);
      else visible.delete(entry.target.id);
    });

    if (!visible.size) return;
    const top = Array.from(visible.entries()).sort((a, b) => b[1] - a[1])[0][0];
    setActive(top);
  }, {
    rootMargin: '-32% 0px -52% 0px',
    threshold: [0.2, 0.4, 0.6]
  });

  items.forEach(({ target }) => observer.observe(target));
}

initOutputCardTooltips();
cacheSubTexts();
initMcpModal();
initSectionNav();
if (!loadSharedStateFromUrl()) {
  updateHealthAndRecommendations(lastInputs);
}
</script>
</body>
</html>
