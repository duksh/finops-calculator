name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v4.0.0)"
        required: true
        type: string
      target:
        description: "Branch or commit SHA to release from"
        required: true
        default: "main"
        type: string
      title:
        description: "Release title (leave blank to use tag)"
        required: false
        type: string
      notes:
        description: "Optional release notes body (markdown). If empty, GitHub auto-generates notes."
        required: false
        type: string
      draft:
        description: "Create as draft"
        required: true
        default: true
        type: boolean
      prerelease:
        description: "Mark as prerelease"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Validate tag format
        shell: bash
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version: '${{ inputs.version }}'"
            echo "Use format like v4.0.0 (optional suffixes allowed)."
            exit 1
          fi

      - name: Checkout target
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target }}
          fetch-depth: 0

      - name: Ensure release tag does not already exist remotely
        shell: bash
        run: |
          if git ls-remote --exit-code --tags origin "refs/tags/${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Tag '${{ inputs.version }}' already exists on origin."
            exit 1
          fi

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          release_name="${{ inputs.title }}"
          if [[ -z "$release_name" ]]; then
            release_name="${{ inputs.version }}"
          fi
          echo "release_name=$release_name" >> "$GITHUB_OUTPUT"

          if [[ -n "${{ inputs.notes }}" ]]; then
            echo "generate_notes=false" >> "$GITHUB_OUTPUT"
          else
            echo "generate_notes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "${{ inputs.version }}"
          git push origin "${{ inputs.version }}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          target_commitish: ${{ inputs.target }}
          name: ${{ steps.meta.outputs.release_name }}
          body: ${{ inputs.notes }}
          generate_release_notes: ${{ steps.meta.outputs.generate_notes == 'true' }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
